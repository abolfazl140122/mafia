<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§ - ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¢ÙˆØ§ØªØ§Ø±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --wood-dark: #1a140f;
            --wood-texture-url: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            --panel-bg-gradient: linear-gradient(145deg, #3c3022, #1e170f);
            --panel-border: #5c4a3a;
            --text-gold: #ffc947;
            --text-light: #e0dacc;
            --green-confirm: #28a745;
            --blue-select: #007bff;
            --disabled-color: #555;
            --panel-glow: rgba(255, 201, 71, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--wood-dark);
            background-image: var(--wood-texture-url);
            color: var(--text-light);
            padding: 20px;
            overflow-y: auto; /* Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¯Ø± ØµÙØ­Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ */
        }

        .shop-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: var(--panel-bg-gradient);
            border-radius: 24px;
            border: 2px solid var(--panel-border);
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), 0 0 25px var(--panel-glow);
        }

        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--panel-border);
            padding-bottom: 20px;
            margin-bottom: 25px;
        }

        .shop-title {
            font-size: 2rem;
            font-weight: 900;
            color: var(--text-gold);
            text-shadow: 0 0 5px var(--panel-glow), 2px 2px 4px #000;
        }

        .back-button {
            background: linear-gradient(145deg, rgba(80, 50, 48, 0.8), rgba(56, 33, 32, 0.9));
            color: var(--text-light);
            border: 1px solid var(--panel-border);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-button:hover {
            border-color: var(--text-gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        #user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 8px;
            border: 1px solid var(--panel-border);
        }
        #user-coins { font-weight: 700; font-size: 1.1rem; color: var(--text-gold); }
        .coin-icon { width: 24px; height: 24px; }

        /* Loading Spinner */
        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px 0;
        }
        .loader {
            border: 6px solid var(--panel-border);
            border-top: 6px solid var(--text-gold);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Avatar Grid */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 20px;
        }

        /* Avatar Card */
        .avatar-card {
            background-color: rgba(0,0,0,0.2);
            border: 2px solid var(--panel-border);
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .avatar-card:hover {
            transform: translateY(-5px);
            border-color: var(--text-gold);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }
        .avatar-card.selected {
            border-color: var(--green-confirm);
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.7);
        }
        .avatar-card.locked::after {
            content: 'ğŸ”’';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            background-color: rgba(0,0,0,0.7);
            padding: 5px;
            border-radius: 50%;
        }

        .avatar-image {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 3px solid var(--panel-border);
            object-fit: cover;
            margin: 0 auto 10px auto;
            background-color: #333;
        }
        .avatar-card.selected .avatar-image { border-color: var(--green-confirm); }

        .avatar-name {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .avatar-action-btn {
            width: 100%;
            padding: 8px;
            font-size: 0.9rem;
            font-weight: 700;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* Button States */
        .btn-buy { background-color: var(--text-gold); color: var(--wood-dark); }
        .btn-select { background-color: var(--blue-select); color: white; }
        .btn-equipped { background-color: var(--green-confirm); color: white; }
        .btn-disabled { background-color: var(--disabled-color); color: #aaa; cursor: not-allowed; }

        .price-tag {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>

    <div class="shop-container">
        <header class="shop-header">
            <a href="./main.html" class="back-button">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„Ø§Ø¨ÛŒ</a>
            <h1 class="shop-title">ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¢ÙˆØ§ØªØ§Ø±</h1>
            <div id="user-info" style="visibility: hidden;">
                <span id="user-coins">0</span>
                <img src="https://i.imgur.com/2s2EaGj.png" alt="Ø³Ú©Ù‡" class="coin-icon">
            </div>
        </header>

        <main id="avatar-grid-container">
            <div class="loader-container" id="loader">
                <div class="loader"></div>
            </div>
            <div class="avatar-grid" id="avatar-grid">
                <!-- Avatar cards will be inserted here by JavaScript -->
            </div>
        </main>
    </div>

    <!-- Template for an avatar card -->
    <template id="avatar-card-template">
        <div class="avatar-card">
            <img class="avatar-image" src="" alt="Ø¢ÙˆØ§ØªØ§Ø±">
            <p class="avatar-name">Ù†Ø§Ù… Ø¢ÙˆØ§ØªØ§Ø±</p>
            <button class="avatar-action-btn">
                <!-- Content set by JS -->
            </button>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
          authDomain: "mafia-9fcbf.firebaseapp.com",
          projectId: "mafia-9fcbf",
          storageBucket: "mafia-9fcbf.appspot.com",
          messagingSenderId: "471627157488",
          appId: "1:471627157488:web:92f008548a5596619a5735",
          measurementId: "G-0PDHDWC6NV"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loader = document.getElementById('loader');
        const avatarGrid = document.getElementById('avatar-grid');
        const userCoinsEl = document.getElementById('user-coins');
        const userInfoEl = document.getElementById('user-info');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadShop(user);
            } else {
                window.location.href = './login.html';
            }
        });

        async function loadShop(user) {
            loader.style.display = 'flex';
            avatarGrid.innerHTML = ''; // Clear previous items

            try {
                // Fetch user data and all avatars simultaneously for speed
                const userDocRef = doc(db, 'users', user.uid);
                const [userDocSnap, avatarsSnapshot] = await Promise.all([
                    getDoc(userDocRef),
                    getDocs(collection(db, 'avatars'))
                ]);

                if (!userDocSnap.exists()) {
                    console.error("User document not found!");
                    // You might want to create a default document here
                    alert("Ø®Ø·Ø§ Ø¯Ø± ÛŒØ§ÙØªÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±!");
                    return;
                }

                const userData = userDocSnap.data();
                const avatars = [];
                avatarsSnapshot.forEach(doc => {
                    avatars.push({ id: doc.id, ...doc.data() });
                });

                // Update UI with user's coin balance
                userCoinsEl.textContent = userData.coins || 0;
                userInfoEl.style.visibility = 'visible';
                
                renderAvatars(avatars, userData, user.uid);

            } catch (error) {
                console.error("Error loading shop data: ", error);
                alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡. Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.");
            } finally {
                loader.style.display = 'none';
            }
        }

        function renderAvatars(avatars, userData, userId) {
            const template = document.getElementById('avatar-card-template');
            const ownedAvatars = userData.ownedAvatars || [];
            const currentAvatar = userData.currentAvatarUrl || '';
            const userCoins = userData.coins || 0;

            avatars.forEach(avatar => {
                const card = template.content.cloneNode(true).firstElementChild;
                
                card.querySelector('.avatar-image').src = avatar.imageUrl;
                card.querySelector('.avatar-name').textContent = avatar.name;

                const actionButton = card.querySelector('.avatar-action-btn');
                const isOwned = ownedAvatars.includes(avatar.id);
                const isEquipped = currentAvatar === avatar.imageUrl;

                if (isEquipped) {
                    card.classList.add('selected');
                    actionButton.textContent = 'Ù…Ø¬Ù‡Ø² Ø´Ø¯Ù‡';
                    actionButton.className = 'avatar-action-btn btn-equipped';
                    actionButton.disabled = true;
                } else if (isOwned) {
                    actionButton.textContent = 'Ø§Ù†ØªØ®Ø§Ø¨';
                    actionButton.className = 'avatar-action-btn btn-select';
                    actionButton.onclick = () => equipAvatar(userId, avatar.imageUrl);
                } else { // Not owned
                    actionButton.innerHTML = `
                        <div class="price-tag">
                            <span>${avatar.price}</span>
                            <img src="https://i.imgur.com/2s2EaGj.png" alt="Ø³Ú©Ù‡" style="width:16px; height:16px;">
                        </div>
                    `;
                    if (userCoins >= avatar.price) {
                        actionButton.className = 'avatar-action-btn btn-buy';
                        actionButton.onclick = () => buyAvatar(userId, avatar.id, avatar.price);
                    } else {
                        card.classList.add('locked');
                        actionButton.className = 'avatar-action-btn btn-disabled';
                        actionButton.disabled = true;
                    }
                }
                avatarGrid.appendChild(card);
            });
        }

        async function buyAvatar(userId, avatarId, price) {
            const confirmed = confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø®Ø±ÛŒØ¯ Ø§ÛŒÙ† Ø¢ÙˆØ§ØªØ§Ø± Ø¨Ù‡ Ù‚ÛŒÙ…Øª ${price} Ø³Ú©Ù‡ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`);
            if (!confirmed) return;

            const userDocRef = doc(db, 'users', userId);

            try {
                // First, get current user data to ensure we don't overwrite anything
                const userDocSnap = await getDoc(userDocRef);
                if (!userDocSnap.exists()) throw new Error("User not found");
                
                const currentCoins = userDocSnap.data().coins || 0;
                if (currentCoins < price) {
                    alert("Ø³Ú©Ù‡ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø§ÛŒÙ† Ø¢ÙˆØ§ØªØ§Ø± Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!");
                    return;
                }

                await updateDoc(userDocRef, {
                    coins: currentCoins - price,
                    ownedAvatars: arrayUnion(avatarId)
                });
                
                alert("Ø¢ÙˆØ§ØªØ§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯!");
                loadShop(auth.currentUser); // Reload the shop to reflect changes
                
            } catch (error) {
                console.error("Error purchasing avatar: ", error);
                alert("Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ø®Ø±ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
            }
        }
        
        async function equipAvatar(userId, avatarUrl) {
            const userDocRef = doc(db, 'users', userId);
            try {
                await updateDoc(userDocRef, {
                    currentAvatarUrl: avatarUrl
                });
                alert("Ø¢ÙˆØ§ØªØ§Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ø¬Ù‡Ø² Ø´Ø¯!");
                loadShop(auth.currentUser); // Reload the shop to update the "equipped" status
            } catch (error) {
                console.error("Error equipping avatar: ", error);
                alert("Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ø§Ù†ØªØ®Ø§Ø¨ Ø¢ÙˆØ§ØªØ§Ø±. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
            }
        }

    </script>
</body>
</html>
