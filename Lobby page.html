<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>شهر مافیا - لیست لابی‌ها</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gold: #ffc947;
            --dark-red: #8c4843;
            --darker-red: #5a2c2a;
            --admin-red: #c0392b; /* رنگ برای دکمه ادمین */
            --admin-red-hover: #e74c3c;
            --admin-edit-bg: #504436; 
            --admin-edit-bg-hover: #615342;
            --admin-edit-border: #c5a687;
            --text-light: #f0e6d2;
            --text-secondary: #c5a687;
            --bg-dark: #1a140e;
            --border-color: #5c4a3a;
            /* [ویژگی جدید] رنگ‌های وضعیت لابی */
            --status-waiting: #2ecc71;
            --status-ingame: #e74c3c;
            --status-full: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-dark);
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #background-blurry {
            position: fixed;
            top: -20px;
            left: -20px;
            width: calc(100% + 40px);
            height: calc(100% + 40px);
            background-image: url('https://up.20script.ir/file/6195-file-000000001500622f9419de6c322df297-1-.jpg');
            background-size: cover;
            background-position: center center;
            filter: blur(8px) brightness(0.6);
            z-index: -1;
        }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 2000; transition: opacity 0.5s ease;
        }
        .loader-logo-wrapper {
            position: relative; width: 180px; height: 180px;
            display: flex; justify-content: center; align-items: center;
        }
        .loader-logo-wrapper::before {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 120%; height: 120%;
            background: radial-gradient(circle, rgba(255, 201, 71, 0.4) 0%, rgba(255, 201, 71, 0) 70%);
            transform: translate(-50%, -50%); animation: pulse-glow 3s infinite ease-in-out;
        }
        .loader-logo { width: 120px; height: auto; animation: fadeIn 2s forwards; opacity: 0; }
        @keyframes pulse-glow {
            0%, 100% { transform: translate(-50%, -50%) scale(0.9); opacity: 0.7; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
        }
        @keyframes fadeIn { to { opacity: 1; } }
        #loading-text { margin-top: 25px; font-size: 1.1rem; font-weight: 700; color: var(--text-light); }
        
        #music-download-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.95); backdrop-filter: blur(10px); display: flex;
            flex-direction: column; justify-content: center; align-items: center; z-index: 1999;
            opacity: 0; visibility: hidden; transition: all 0.5s ease;
        }
        #music-download-overlay.visible { opacity: 1; visibility: visible; }
        .download-panel { width: 90%; max-width: 350px; text-align: center; }
        .download-title { font-size: 1.4rem; font-weight: 900; color: var(--primary-gold); margin-bottom: 20px; }
        .progress-bar-container { width: 100%; height: 20px; background-color: rgba(0, 0, 0, 0.4); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--dark-red), var(--primary-gold)); border-radius: 10px; transition: width 0.3s ease-out; }
        #progress-text { margin-top: 15px; font-size: 1rem; font-weight: 700; color: var(--text-light); }

        .main-container {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            padding: 15px; padding-bottom: 90px;
        }

        header {
            width: 100%; display: flex; align-items: center;
            gap: 10px; margin-bottom: 15px;
        }
        .search-bar { flex-grow: 1; position: relative; }
        .search-bar input {
            width: 100%; padding: 12px 20px 12px 50px; background-color: rgba(0,0,0,0.5);
            border: 1px solid var(--border-color); border-radius: 25px; color: var(--text-light);
            font-size: 1rem; transition: all 0.3s ease;
        }
        .search-bar input:focus { outline: none; border-color: var(--primary-gold); box-shadow: 0 0 10px rgba(255, 201, 71, 0.3); }
        .search-bar .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        .back-button {
            padding: 12px; background: linear-gradient(145deg, #443a2e, #2a2118);
            border: 1px solid var(--border-color); border-radius: 50%; color: var(--text-light);
            font-size: 1.2rem; cursor: pointer; line-height: 1; transform: scaleX(-1);
        }

        /* --- [ویژگی جدید] فیلتر و مرتب‌سازی پیشرفته --- */
        .filters-container {
            display: flex; flex-wrap: wrap; justify-content: space-between;
            align-items: center; gap: 10px; margin-bottom: 20px;
        }
        .filter-buttons { display: flex; gap: 8px; flex-grow: 1; }
        .filter-btn {
            background-color: rgba(0,0,0,0.3); border: 1px solid var(--border-color);
            color: var(--text-secondary); padding: 8px 12px; border-radius: 20px;
            font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease;
        }
        .filter-btn.active {
            background-color: var(--primary-gold); color: var(--bg-dark);
            border-color: var(--primary-gold); font-weight: 700;
        }
        .sort-dropdown select {
            background-color: rgba(0,0,0,0.5); border: 1px solid var(--border-color);
            color: var(--text-light); padding: 8px 15px; border-radius: 20px;
            font-family: 'Vazirmatn', sans-serif; font-size: 0.8rem;
        }
        .sort-dropdown select:focus { outline: none; border-color: var(--primary-gold); }
        
        #lobby-list {
            flex-grow: 1; overflow-y: auto; display: flex;
            flex-direction: column; gap: 15px; padding-right: 5px;
        }
        #lobby-list::-webkit-scrollbar { width: 6px; }
        #lobby-list::-webkit-scrollbar-track { background: transparent; }
        #lobby-list::-webkit-scrollbar-thumb { background-color: var(--primary-gold); border-radius: 10px; }
        
        .lobby-card {
            background: linear-gradient(160deg, #2a2118, var(--bg-dark)); border: 1px solid var(--border-color);
            border-radius: 16px; padding: 15px; display: flex; flex-direction: column; gap: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4); opacity: 0; transform: translateY(20px);
            animation: slideInUp 0.5s forwards; transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative; overflow: hidden; /* برای افکت‌های بصری */
        }
        .lobby-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.5), 0 0 15px rgba(255, 201, 71, 0.2); }
        @keyframes slideInUp { to { opacity: 1; transform: translateY(0); } }

        /* --- [ویژگی جدید] افکت‌های بصری زنده --- */
        .lobby-card.status-in-game::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: 3px;
            background: linear-gradient(90deg, transparent, rgba(255, 82, 82, 0.7), transparent);
            animation: scanline 4s linear infinite;
        }
        @keyframes scanline {
            0% { transform: translateY(-10px); }
            100% { transform: translateY(calc(100% + 10px)); }
        }
        .player-count .player-count-number.player-joined-glow {
            animation: text-glow 1.5s ease-out;
        }
        @keyframes text-glow {
            0%, 100% { color: var(--text-light); text-shadow: none; }
            50% { color: var(--primary-gold); text-shadow: 0 0 10px var(--primary-gold); }
        }

        .lobby-card-header { display: flex; justify-content: space-between; align-items: center; }
        .lobby-info { display: flex; gap: 15px; align-items: center; }
        .lobby-name-wrapper { display: flex; align-items: center; gap: 8px; }
        .lobby-name { font-size: 1.3rem; font-weight: 900; color: var(--primary-gold); }
        .lock-icon { font-size: 1rem; color: var(--primary-gold); }
        
        /* --- [ویژگی جدید] نمایش وضعیت لابی --- */
        .lobby-status {
            padding: 4px 12px; border-radius: 15px; font-size: 0.8rem;
            font-weight: 700; color: white;
        }
        .lobby-status.waiting { background-color: var(--status-waiting); }
        .lobby-status.in-game { background-color: var(--status-ingame); }
        .lobby-status.full { background-color: var(--status-full); }

        .player-count {
            display: flex; align-items: center; gap: 8px; font-size: 1.1rem;
            font-weight: 700; background-color: rgba(0,0,0,0.3);
            padding: 5px 10px; border-radius: 20px;
        }

        /* --- [ویژگی جدید] توضیحات لابی --- */
        .lobby-details {
            display: flex; justify-content: space-between; align-items: center;
            padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);
        }
        .lobby-scenario {
            background: rgba(255, 201, 71, 0.1); color: var(--primary-gold);
            padding: 4px 12px; border-radius: 15px; font-size: 0.8rem;
            font-weight: 700; border: 1px solid rgba(255, 201, 71, 0.3);
        }
        .lobby-description {
            font-size: 0.85rem; color: var(--text-secondary); font-style: italic;
            flex-grow: 1; text-align: right; padding-right: 15px;
        }

        .lobby-card-footer { display: flex; justify-content: space-between; align-items: center; }
        .creator-and-players { display: flex; flex-direction: column; gap: 8px; }
        .lobby-creator { font-size: 0.9rem; color: var(--text-secondary); }
        
        /* --- [ویژگی جدید] نمایش آواتار بازیکنان --- */
        .player-avatars { display: flex; align-items: center; }
        .player-avatar {
            width: 30px; height: 30px; border-radius: 50%;
            border: 2px solid var(--border-color); object-fit: cover;
            background-color: var(--bg-dark);
        }
        .player-avatar:not(:first-child) { margin-right: -12px; }

        .admin-password-container {
            display: flex; align-items: center; justify-content: space-between;
            background-color: rgba(0, 0, 0, 0.4); border: 1px solid var(--border-color);
            border-radius: 6px; padding: 4px 8px; margin-top: 6px; cursor: pointer;
        }
        .admin-password-text { font-size: 0.8rem; color: #f39c12; font-family: monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        .admin-edit-icon { font-size: 0.9rem; color: var(--text-secondary); padding-left: 8px; }
        
        .lobby-actions { display: flex; gap: 10px; }
        .lobby-btn {
            padding: 8px 20px; font-size: 1rem; font-weight: 700;
            border-radius: 8px; cursor: pointer; border: none;
            transition: all 0.3s ease; font-family: 'Vazirmatn', sans-serif;
        }
        .btn-join { color: white; background: linear-gradient(145deg, var(--dark-red), var(--darker-red)); border: 1px solid var(--primary-gold); }
        .btn-join:hover { background: linear-gradient(145deg, #a1534d, #6b3431); transform: translateY(-2px); }
        .btn-join:disabled { background: linear-gradient(145deg, #616161, #3a3a3a); border-color: #888; cursor: not-allowed; opacity: 0.7; }
        .btn-join:disabled:hover { transform: none; }
        /* ... بقیه استایل‌های دکمه‌ها ... */

        #create-lobby-fab {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 60px; height: 60px; background: linear-gradient(145deg, var(--primary-gold), #c89c36);
            color: var(--bg-dark); border-radius: 50%; border: none; font-size: 2.5rem;
            font-weight: 900; line-height: 60px; text-align: center; cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 201, 71, 0.4); transition: all 0.3s ease; z-index: 999;
        }
        #create-lobby-fab:hover { transform: translateX(-50%) scale(1.1); }
        #create-lobby-fab:active { transform: translateX(-50%) scale(0.95); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); display: flex; justify-content: center;
            align-items: center; z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: linear-gradient(145deg, #3c3022, var(--bg-dark));
            border: 2px solid var(--border-color); border-radius: 16px;
            padding: 25px 30px; width: 90%; max-width: 380px; text-align: center;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.visible .modal-content { transform: scale(1) translateY(0); }
        .modal-title { font-size: 1.5rem; font-weight: 900; color: var(--primary-gold); margin-bottom: 20px; }
        .modal-input-group { width: 100%; margin-bottom: 20px; }
        .modal-input, .modal-select, .modal-textarea {
            width: 100%; padding: 12px 15px; background-color: rgba(0,0,0,0.4);
            border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-light);
            font-family: 'Vazirmatn', sans-serif; font-size: 1rem; text-align: center; margin-bottom: 15px;
        }
        .modal-textarea { resize: vertical; min-height: 60px; text-align: right; padding: 10px; }
        .modal-select { padding-right: 15px; margin-bottom: 0; }
        .modal-input:focus, .modal-select:focus, .modal-textarea:focus { outline: none; border-color: var(--primary-gold); }
        /* ... بقیه استایل‌های مودال ... */
        .password-toggle-group { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px; cursor: pointer; }
        .password-toggle-group label { color: var(--text-secondary); font-weight: 700; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #332a20; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: var(--text-light); transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-gold); }
        input:checked + .slider:before { transform: translateX(22px); background-color: var(--bg-dark); }
        #lobby-password-input { margin-top: 15px; display: none; }
    </style>
</head>
<body>

    <div id="background-blurry"></div>
    <audio id="background-music" loop></audio>
    
    <!-- [ویژگی جدید] افکت‌های صوتی -->
    <audio id="sfx-click" src="https://raw.githubusercontent.com/abolfazl140122/mafia/main/click-124467.mp3" preload="auto"></audio>
    <audio id="sfx-swoosh" src="https://raw.githubusercontent.com/abolfazl140122/mafia/main/whoosh-6316.mp3" preload="auto"></audio>
    <audio id="sfx-success" src="https://raw.githubusercontent.com/abolfazl140122/mafia/main/success-fanfare-trumpets-6185.mp3" preload="auto"></audio>

    <div id="music-download-overlay">
        <!-- ... محتوای پنل دانلود موسیقی ... -->
    </div>
    <div id="loading-overlay">
        <!-- ... محتوای لودینگ ... -->
    </div>

    <div class="main-container">
        <header>
            <button class="back-button sfx-click" onclick="window.location.href='./main.html'" title="بازگشت">➤</button>
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="جستجوی نام لابی، سازنده یا سناریو...">
                <span class="search-icon">🔍</span>
            </div>
        </header>

        <!-- [ویژگی جدید] فیلتر و مرتب‌سازی پیشرفته -->
        <div class="filters-container">
            <div class="filter-buttons">
                <button class="filter-btn sfx-click active" data-filter="all">همه</button>
                <button class="filter-btn sfx-click" data-filter="open">آزاد</button>
                <button class="filter-btn sfx-click" data-filter="private">خصوصی</button>
                <button class="filter-btn sfx-click" data-filter="not-full">خالی</button>
            </div>
            <div class="sort-dropdown">
                <select id="sort-select" class="sfx-click">
                    <option value="newest">جدیدترین</option>
                    <option value="most-players">بیشترین بازیکن</option>
                    <option value="least-players">کمترین بازیکن</option>
                </select>
            </div>
        </div>

        <div id="lobby-list">
            <!-- لابی‌ها به صورت داینامیک اینجا اضافه می‌شوند -->
        </div>
    </div>
    
    <button id="create-lobby-fab" class="sfx-click" title="ساخت لابی جدید">+</button>

    <!-- Modal برای ساخت لابی جدید -->
    <div id="create-lobby-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">ساخت لابی جدید</h2>
            <div class="modal-input-group">
                <input type="text" id="lobby-name-input" class="modal-input" placeholder="نام لابی خود را وارد کنید" maxlength="30">
                
                <!-- [ویژگی جدید] فیلد توضیحات لابی -->
                <textarea id="lobby-description-input" class="modal-textarea" placeholder="توضیحات کوتاه (اختیاری)" maxlength="100"></textarea>

                <select id="lobby-scenario-select" class="modal-select">
                    <option value="کلاسیک">سناریو: کلاسیک</option>
                    <option value="شب‌های مافیا">سناریو: شب‌های مافیا</option>
                    <option value="زودیاک">سناریو: زودیاک</option>
                    <option value="ارتش سری">سناریو: ارتش سری</option>
                </select>
                <div class="password-toggle-group">
                    <label for="private-lobby-toggle">لابی خصوصی (با رمز)</label>
                    <label class="switch">
                        <input type="checkbox" id="private-lobby-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <input type="password" id="lobby-password-input" class="modal-input" placeholder="رمز عبور را وارد کنید" maxlength="20">
            </div>
            <div class="modal-buttons">
                <button id="create-lobby-confirm-btn" class="modal-button primary sfx-click">ساختن</button>
                <button id="create-lobby-cancel-btn" class="modal-button secondary sfx-click">انصراف</button>
            </div>
        </div>
    </div>

    <!-- Modal سفارشی برای هشدارها و تاییدها -->
    <div id="custom-alert-modal" class="modal-overlay">
       <!-- ... محتوای مودال هشدار ... -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, where, getDocs, deleteDoc, doc, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // ... کانفیگ فایربیس ...
        const firebaseConfig = { /* ... */ };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const lobbyList = document.getElementById('lobby-list');
        const createLobbyFab = document.getElementById('create-lobby-fab');
        const searchInput = document.getElementById('search-input');
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const lobbyNameInput = document.getElementById('lobby-name-input');
        const lobbyScenarioSelect = document.getElementById('lobby-scenario-select');
        // [ویژگی جدید] فیلد توضیحات
        const lobbyDescriptionInput = document.getElementById('lobby-description-input');
        const privateLobbyToggle = document.getElementById('private-lobby-toggle');
        const lobbyPasswordInput = document.getElementById('lobby-password-input');
        const createLobbyConfirmBtn = document.getElementById('create-lobby-confirm-btn');
        const createLobbyCancelBtn = document.getElementById('create-lobby-cancel-btn');
        const customAlertModal = document.getElementById('custom-alert-modal');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // [ویژگی جدید] عناصر فیلتر و مرتب‌سازی
        const filterButtonsContainer = document.querySelector('.filter-buttons');
        const sortSelect = document.getElementById('sort-select');

        let currentUser = null;
        let currentUserIsAdmin = false;
        let allLobbiesData = new Map();

        // [ویژگی جدید] متغیرهای وضعیت فیلتر
        let activeFilter = 'all';
        let activeSort = 'newest';
        
        // ... توابع موسیقی، مودال‌ها، debounce و غیره ...

        // [ویژگی جدید] پخش افکت صوتی
        function playSound(soundId) {
            try {
                const sound = document.getElementById(soundId);
                sound.currentTime = 0;
                sound.volume = soundId === 'sfx-click' ? 0.4 : 0.6;
                sound.play();
            } catch (e) {
                console.warn(`Could not play sound: ${soundId}`, e);
            }
        }
        
        function renderLobbyCard(lobbyData, index) {
            const card = document.createElement('div');
            card.className = 'lobby-card';
            card.dataset.id = lobbyData.id;
            card.style.animationDelay = `${index * 0.07}s`;

            const isOwner = currentUser && currentUser.uid === lobbyData.creatorId;
            const canAdminDelete = currentUserIsAdmin && !isOwner;
            const isPrivate = lobbyData.password && lobbyData.password.length > 0;

            // [ویژگی جدید] منطق وضعیت لابی
            let statusText = 'در انتظار بازیکن';
            let statusClass = 'waiting';
            let joinButtonText = 'پیوستن';
            let joinButtonDisabled = false;

            if (lobbyData.status === 'in-game') {
                statusText = 'در حال بازی';
                statusClass = 'in-game';
                joinButtonText = 'تماشا'; // یا 'در حال بازی'
                joinButtonDisabled = true; // فعلا غیرفعال
                card.classList.add('status-in-game');
            } else if (lobbyData.status === 'full') {
                statusText = 'لابی پر است';
                statusClass = 'full';
                joinButtonText = 'لابی پر است';
                joinButtonDisabled = true;
            }

            let actionButtonsHTML = '';
            if (isOwner) {
                actionButtonsHTML += `<button class="lobby-btn btn-delete sfx-click" data-action="delete">حذف لابی</button>`;
            } else if (canAdminDelete) {
                actionButtonsHTML += `<button class="lobby-btn btn-admin-delete sfx-click" data-action="admin-delete">بستن لابی</button>`;
            }
            actionButtonsHTML += `<button class="lobby-btn btn-join sfx-click" data-action="join" ${joinButtonDisabled ? 'disabled' : ''}>${joinButtonText}</button>`;
            
            let adminControlsHTML = '';
            if (currentUserIsAdmin && isPrivate) {
                // ... کد کنترل‌های ادمین ...
            }
            
            // [ویژگی جدید] نمایش آواتار بازیکنان (شبیه‌سازی شده)
            let avatarsHTML = '<div class="player-avatars">';
            (lobbyData.players || [{avatarUrl: 'https://i.pravatar.cc/150?u=' + lobbyData.creatorId}]).slice(0, 5).forEach(player => {
                avatarsHTML += `<img src="${player.avatarUrl}" alt="player avatar" class="player-avatar" title="${player.displayName || 'بازیکن'}">`;
            });
            avatarsHTML += '</div>';

            card.innerHTML = `
                <div class="lobby-card-header">
                    <div class="lobby-info">
                        <div class="lobby-name-wrapper">
                            ${isPrivate ? '<span class="lock-icon">🔒</span>' : ''}
                            <h3 class="lobby-name">${lobbyData.lobbyName}</h3>
                        </div>
                        <span class="lobby-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="player-count">
                        <span>👤</span> <span class="player-count-number">${lobbyData.playerCount || 1}/${lobbyData.maxPlayers || 12}</span>
                    </div>
                </div>

                <div class="lobby-details">
                    <span class="lobby-scenario">${lobbyData.scenario || 'کلاسیک'}</span>
                    ${lobbyData.description ? `<p class="lobby-description">${lobbyData.description}</p>` : ''}
                </div>

                <div class="lobby-card-footer">
                    <div class="creator-and-players">
                        <span class="lobby-creator">سازنده: ${lobbyData.creatorName}</span>
                        ${avatarsHTML}
                    </div>
                    <div class="lobby-actions">${actionButtonsHTML}</div>
                </div>
            `;
            
            // ... event listener های قبلی کارت ...

            return card;
        }
        
        // [ویژگی جدید] تابع اصلی برای رندر، فیلتر و مرتب‌سازی
        function updateAndRenderLobbies() {
            let lobbiesArray = Array.from(allLobbiesData.values());

            // 1. فیلتر کردن
            lobbiesArray = lobbiesArray.filter(lobby => {
                const isFull = (lobby.playerCount || 1) >= (lobby.maxPlayers || 12);
                const isPrivate = lobby.password && lobby.password.length > 0;
                
                if (activeFilter === 'open' && isPrivate) return false;
                if (activeFilter === 'private' && !isPrivate) return false;
                if (activeFilter === 'not-full' && isFull) return false;
                return true;
            });
            
            // 2. مرتب‌سازی
            lobbiesArray.sort((a, b) => {
                if (activeSort === 'most-players') {
                    return (b.playerCount || 1) - (a.playerCount || 1);
                }
                if (activeSort === 'least-players') {
                    return (a.playerCount || 1) - (b.playerCount || 1);
                }
                // پیش‌فرض: جدیدترین
                return b.createdAt.toMillis() - a.createdAt.toMillis();
            });

            // 3. رندر کردن
            lobbyList.innerHTML = ''; 
            lobbiesArray.forEach((lobbyData, index) => {
                const cardElement = renderLobbyCard(lobbyData, index);
                lobbyList.appendChild(cardElement);
            });
            
            updateLobbyListState(lobbiesArray.length);
            filterLobbies(); // اعمال فیلتر جستجو
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // ... کد قبلی ...

                const lobbiesRef = collection(db, 'Lobbys_list');
                const q = query(lobbiesRef, orderBy("createdAt", "desc"));

                onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        const lobbyData = { id: change.doc.id, ...change.doc.data() };
                        
                        // [ویژگی جدید] شبیه‌سازی دیتا برای دمو
                        if (!lobbyData.status) {
                            if (lobbyData.playerCount >= lobbyData.maxPlayers) lobbyData.status = 'full';
                            else if (lobbyData.playerCount > 5 && Math.random() > 0.6) lobbyData.status = 'in-game';
                            else lobbyData.status = 'waiting';
                        }
                        if (!lobbyData.players) {
                            lobbyData.players = Array.from({ length: lobbyData.playerCount }, (_, i) => ({
                                avatarUrl: `https://i.pravatar.cc/150?u=player${i}${lobbyData.id}`,
                                displayName: `بازیکن ${i + 1}`
                            }));
                        }

                        if (change.type === "added" || change.type === "modified") {
                           const oldData = allLobbiesData.get(lobbyData.id);
                           allLobbiesData.set(lobbyData.id, lobbyData);
                           
                           // [ویژگی جدید] انیمیشن درخشش هنگام پیوستن بازیکن
                           if (oldData && lobbyData.playerCount > oldData.playerCount) {
                               const card = lobbyList.querySelector(`.lobby-card[data-id="${lobbyData.id}"]`);
                               const countEl = card?.querySelector('.player-count-number');
                               if (countEl) {
                                   countEl.classList.add('player-joined-glow');
                                   setTimeout(() => countEl.classList.remove('player-joined-glow'), 1500);
                               }
                           }
                        }
                        if (change.type === "removed") {
                           allLobbiesData.delete(lobbyData.id);
                        }
                    });

                    updateAndRenderLobbies(); // تابع جدید را فراخوانی می‌کند

                    if (loadingOverlay.style.opacity !== '0') {
                        // ... مخفی کردن لودینگ ...
                    }
                });
            } else {
                window.location.href = './login.html';
            }
        });
        
        function updateLobbyListState(count) {
             // ... کد به‌روز شده برای نمایش پیام وقتی هیچ لابی وجود ندارد ...
        }

        async function createLobby() {
            const lobbyName = lobbyNameInput.value.trim();
            const description = lobbyDescriptionInput.value.trim(); // [ویژگی جدید] دریافت توضیحات
            const scenario = lobbyScenarioSelect.value;
            const isPrivate = privateLobbyToggle.checked;
            const password = lobbyPasswordInput.value;

            // ... ولیدیشن‌های قبلی ...
            
            const lobbyData = {
                lobbyName, scenario, description,
                creatorId: currentUser.uid,
                creatorName: currentUser.displayName || 'کاربر ناشناس',
                createdAt: serverTimestamp(),
                playerCount: 1, maxPlayers: 12,
                status: 'waiting', // وضعیت اولیه
            };
            
            if (isPrivate) lobbyData.password = password;

            try {
                await addDoc(collection(db, 'Lobbys_list'), lobbyData);
                hideModal(createLobbyModal);
                playSound('sfx-success'); // [ویژگی جدید] پخش صدای موفقیت
                // ... ریست کردن فیلدها ...
                lobbyDescriptionInput.value = '';
            } catch (error) {
                 // ... هندل خطا ...
            }
        }
        
        // ... تابع deleteLobby ...

        function filterLobbies() {
            // ... این تابع اکنون فقط برای فیلتر مبتنی بر جستجو استفاده می‌شود ...
        }

        // --- Event Listeners ---
        createLobbyFab.addEventListener('click', () => {
            showModal(createLobbyModal);
            playSound('sfx-swoosh'); // [ویژگی جدید] پخش صدای باز شدن
        });
        // ... بقیه event listener های قبلی ...
        
        // [ویژگی جدید] Event Listener برای دکمه‌های فیلتر
        filterButtonsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                filterButtonsContainer.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                activeFilter = e.target.dataset.filter;
                updateAndRenderLobbies();
            }
        });
        
        // [ویژگی جدید] Event Listener برای منوی مرتب‌سازی
        sortSelect.addEventListener('change', (e) => {
            activeSort = e.target.value;
            updateAndRenderLobbies();
        });

        // [ویژگی جدید] Event listener برای پخش صدای کلیک
        document.addEventListener('click', (e) => {
            if (e.target.closest('.sfx-click')) {
                playSound('sfx-click');
            }
        });

    </script>
</body>
</html>