<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§Ø®Øª Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ - Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&family=Lalezar&display=swap" rel="stylesheet">

    <style>
        /* --- MAFIA CITY THEME - REGISTRATION PAGE (MATCHING LOGIN PAGE) --- */

        /* --- ROOT VARIABLES (Consistent Theming) --- */
        :root {
            --mafia-dark-wood: #1e1a17;
            --mafia-panel-brown: #3a322d;
            --mafia-panel-border: #2c2521;
            --mafia-gold-accent: #e6b800;
            --mafia-gold-glow: rgba(230, 184, 0, 0.6);
            --mafia-gold-dark: #a88700;
            --mafia-text-light: #e8e0d9;
            --mafia-text-dark: #1a1a1a;
            --mafia-success-green: #28a745;
            --mafia-success-green-glow: rgba(40, 167, 69, 0.7);
            --mafia-error-red: #dc3545;
            --mafia-error-red-glow: rgba(220, 53, 69, 0.7);
            --mafia-input-bg: #2a2420;
            --glitch-color-1: #ff4848; /* Red */
            --glitch-color-2: #48ffff; /* Cyan */
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes panelIntro {
            0% { 
                opacity: 0; 
                transform: translateY(40px) scale(0.95);
                filter: blur(5px);
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        @keyframes backgroundPan {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- GLITCH TEXT ANIMATION (EXACTLY LIKE LOGIN PAGE) --- */
        @keyframes glitch-anim-1 {
            0% { clip-path: inset(21% 0 76% 0); }
            10% { clip-path: inset(92% 0 2% 0); }
            20% { clip-path: inset(55% 0 7% 0); }
            30% { clip-path: inset(18% 0 73% 0); }
            40% { clip-path: inset(93% 0 4% 0); }
            50% { clip-path: inset(37% 0 52% 0); }
            60% { clip-path: inset(98% 0 1% 0); }
            70% { clip-path: inset(69% 0 22% 0); }
            80% { clip-path: inset(95% 0 5% 0); }
            90% { clip-path: inset(25% 0 58% 0); }
            100% { clip-path: inset(1% 0 98% 0); }
        }

        @keyframes glitch-anim-2 {
            0% { clip-path: inset(89% 0 3% 0); }
            10% { clip-path: inset(62% 0 32% 0); }
            20% { clip-path: inset(10% 0 88% 0); }
            30% { clip-path: inset(84% 0 2% 0); }
            40% { clip-path: inset(15% 0 84% 0); }
            50% { clip-path: inset(79% 0 18% 0); }
            60% { clip-path: inset(48% 0 50% 0); }
            70% { clip-path: inset(9% 0 89% 0); }
            80% { clip-path: inset(73% 0 13% 0); }
            90% { clip-path: inset(44% 0 45% 0); }
            100% { clip-path: inset(85% 0 4% 0); }
        }

        @keyframes glitch-skew {
            0% { transform: skewX(0deg); }
            10% { transform: skewX(3deg); }
            20% { transform: skewX(-4deg); }
            30% { transform: skewX(1deg); }
            40% { transform: skewX(0deg); }
            50% { transform: skewX(-2deg); }
            60% { transform: skewX(5deg); }
            70% { transform: skewX(-3deg); }
            80% { transform: skewX(2deg); }
            90% { transform: skewX(-1deg); }
            100% { transform: skewX(0deg); }
        }

        /* --- GENERAL & BODY STYLES --- */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--mafia-dark-wood);
            background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            color: var(--mafia-text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
            animation: fadeIn 1s ease-out;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background-image: url('https://www.transparenttextures.com/patterns/foggy-birds.png');
            opacity: 0.05;
            z-index: 0;
            animation: backgroundPan 180s linear infinite;
        }
        
        /* --- TYPOGRAPHY & TITLE --- */
        .title-font {
            font-family: 'Lalezar', cursive;
        }
        
        h1, h2, h3 {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* Glitch Title Styling */
        .glitch {
            position: relative;
            color: var(--mafia-text-light);
            font-size: 3rem; /* Adjusted for Registration panel */
            animation: glitch-skew 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) 1s both infinite;
            letter-spacing: 2px;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.7);
        }
        
        @media (min-width: 500px) {
            .glitch { font-size: 3.5rem; }
        }

        .glitch::before,
        .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
        }

        .glitch::before {
            left: 2px;
            text-shadow: -2px 0 var(--glitch-color-1);
            animation: glitch-anim-1 3s cubic-bezier(0.25, 0.46, 0.45, 0.94) 1.2s both infinite;
        }

        .glitch::after {
            left: -2px;
            text-shadow: -2px 0 var(--glitch-color-2), 2px 2px var(--glitch-color-1);
            animation: glitch-anim-2 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) 1.1s both infinite;
        }

        /* --- AUTHENTICATION PANEL & LAYOUT --- */
        .auth-container {
            width: 100%;
            max-width: 480px;
            position: relative;
            z-index: 1;
        }
        
        #auth-panel {
            background: linear-gradient(145deg, var(--mafia-panel-brown), #312a25);
            border: 3px solid var(--mafia-panel-border);
            border-radius: 20px;
            padding: 2rem 1.5rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), 
                        inset 0 2px 3px rgba(255, 255, 255, 0.05),
                        inset 0 -2px 3px rgba(0, 0, 0, 0.2);
            animation: panelIntro 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards;
            position: relative;
            overflow: hidden;
        }
        
        @media (min-width: 500px) {
            #auth-panel { padding: 2.5rem; }
        }

        /* Panel decorative corners */
        #auth-panel::before, #auth-panel::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-style: solid;
            border-color: var(--mafia-gold-accent);
            opacity: 0.5;
            transition: all 0.3s ease;
        }
        #auth-panel::before {
            top: 15px; left: 15px;
            border-width: 2px 0 0 2px;
        }
        #auth-panel::after {
            top: 15px; right: 15px;
            border-width: 2px 2px 0 0;
        }
        .panel-bottom-corners::before, .panel-bottom-corners::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-style: solid;
            border-color: var(--mafia-gold-accent);
            opacity: 0.5;
            transition: all 0.3s ease;
        }
        .panel-bottom-corners::before {
            bottom: 15px; left: 15px;
            border-width: 0 0 2px 2px;
        }
        .panel-bottom-corners::after {
            bottom: 15px; right: 15px;
            border-width: 0 2px 2px 0;
        }

        #panel-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        #panel-header .subtitle {
            font-size: 1rem;
            color: var(--mafia-text-light);
            opacity: 0.8;
            margin-top: 1rem;
        }
        
        /* --- TAB NAVIGATION --- */
        #tab-container {
            display: flex;
            margin-bottom: 1.5rem;
            background-color: var(--mafia-input-bg);
            border-radius: 10px;
            padding: 5px;
            border: 1px solid var(--mafia-panel-border);
        }
        
        .tab-btn {
            flex: 1;
            padding: 0.75rem 0.5rem;
            background-color: transparent;
            border: none;
            color: var(--mafia-text-light);
            opacity: 0.6;
            font-family: 'Vazirmatn', sans-serif;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab-btn.active {
            background-color: var(--mafia-gold-accent);
            color: var(--mafia-text-dark);
            opacity: 1;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            text-shadow: none;
        }
        
        .tab-btn:not(.active):hover {
            opacity: 1;
            background-color: rgba(255,255,255,0.05);
        }

        /* --- FORM ELEMENTS --- */
        .form-content {
            display: none; /* Hidden by default */
        }
        
        .form-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .input-group {
            margin-bottom: 1.25rem;
            position: relative;
        }

        .input-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }
        
        .input-mafia-wrapper {
            position: relative;
        }

        .input-mafia-wrapper .icon {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            color: #8a7e74;
            font-size: 1.2rem;
            transition: color 0.3s ease;
        }
        
        .input-mafia {
            width: 100%;
            padding: 0.9rem 2.8rem 0.9rem 1rem; /* Adjusted padding for icon */
            background-color: var(--mafia-input-bg);
            border: 2px solid var(--mafia-panel-border);
            border-radius: 10px;
            color: var(--mafia-text-light);
            font-size: 1rem;
            font-family: 'Vazirmatn', sans-serif;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .input-mafia::placeholder {
            color: #8a7e74;
            opacity: 0.7;
        }

        .input-mafia:focus {
            outline: none;
            border-color: var(--mafia-gold-accent);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 0 10px var(--mafia-gold-glow);
        }
        
        .input-mafia:focus + .icon {
            color: var(--mafia-gold-accent);
        }
        
        .input-mafia.invalid {
            border-color: var(--mafia-error-red);
        }
        .input-mafia.invalid:focus {
             box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 0 10px var(--mafia-error-red-glow);
        }
         .input-mafia.invalid + .icon {
            color: var(--mafia-error-red);
        }
        
        /* --- PRIMARY BUTTON --- */
        .btn-mafia-primary {
            width: 100%;
            padding: 1rem;
            font-family: 'Vazirmatn', sans-serif;
            font-weight: 900;
            font-size: 1.1rem;
            color: var(--mafia-text-dark);
            background: linear-gradient(to top, var(--mafia-gold-dark), var(--mafia-gold-accent));
            border: 2px solid #816600;
            border-radius: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 0 #816600, 0 8px 15px rgba(0,0,0,0.4);
            transition: all 0.15s ease-out;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-mafia-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #816600, 0 12px 20px rgba(0,0,0,0.4);
            filter: brightness(1.1);
        }

        .btn-mafia-primary:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #816600, 0 2px 5px rgba(0,0,0,0.4);
            transition-duration: 0.05s;
        }
        
        .btn-mafia-primary:disabled {
            filter: grayscale(70%) brightness(0.8);
            cursor: not-allowed;
            box-shadow: 0 5px 0 #554400;
        }
        
        .btn-loader {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-top-color: var(--mafia-text-dark);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
        }
        
        /* --- ERROR & SUCCESS MESSAGES --- */
        #message-container {
            margin-top: 1.5rem;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            text-align: center;
            display: none; /* Hidden by default */
            border-width: 2px;
            border-style: solid;
            animation: fadeIn 0.3s;
        }
        
        #message-container.error {
            background-color: rgba(220, 53, 69, 0.2);
            border-color: var(--mafia-error-red);
            color: #f8d7da;
            display: block;
        }

        #message-container.success {
            background-color: rgba(40, 167, 69, 0.2);
            border-color: var(--mafia-success-green);
            color: #d4edda;
            display: block;
        }
        
        /* --- FOOTER LINK --- */
        #panel-footer {
            margin-top: 2rem;
            text-align: center;
        }
        
        #panel-footer a {
            color: var(--mafia-gold-accent);
            text-decoration: none;
            font-weight: 700;
            transition: color 0.3s ease, text-shadow 0.3s ease;
        }
        
        #panel-footer a:hover {
            color: #fff;
            text-shadow: 0 0 5px var(--mafia-gold-glow);
        }
        
        /* --- UTILITY CLASSES --- */
        .hidden {
            display: none !important;
        }

    </style>
</head>
<body>

    <div class="auth-container">
        <div id="auth-panel">
            <div id="panel-header">
                <h1 class="title-font glitch" data-text="Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§">Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h1>
                <p class="subtitle">Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ØŒ Ù‡ÙˆÛŒØª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯</p>
            </div>
            
            <div id="tab-container">
                <button id="email-tab-btn" class="tab-btn active" data-form="email-form">Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ø§ Ø§ÛŒÙ…ÛŒÙ„</button>
                <button id="guest-tab-btn" class="tab-btn" data-form="guest-form">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ù‡Ù…Ø§Ù†</button>
            </div>

            <!-- Email Registration Form -->
            <form id="email-form" class="form-content active" novalidate>
                <div class="input-group">
                    <label for="email-display-name">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ (ÙÙ‚Ø· Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)</label>
                    <div class="input-mafia-wrapper">
                        <input type="text" id="email-display-name" class="input-mafia" placeholder="Ù…Ø«Ø§Ù„: Godfather123" required>
                        <span class="icon">ğŸ‘¤</span>
                    </div>
                </div>
                <div class="input-group">
                    <label for="email">Ø§ÛŒÙ…ÛŒÙ„</label>
                    <div class="input-mafia-wrapper">
                        <input type="email" id="email" class="input-mafia" placeholder="Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø±" required>
                        <span class="icon">âœ‰ï¸</span>
                    </div>
                </div>
                <div class="input-group">
                    <label for="password">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                    <div class="input-mafia-wrapper">
                        <input type="password" id="password" class="input-mafia" placeholder="Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ±" required>
                        <span class="icon">ğŸ”‘</span>
                    </div>
                </div>
                 <div class="input-group">
                    <label for="confirm-password">ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                     <div class="input-mafia-wrapper">
                        <input type="password" id="confirm-password" class="input-mafia" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø®ÙˆØ¯ Ø±Ø§ ØªÚ©Ø±Ø§Ø± Ú©Ù†ÛŒØ¯" required>
                        <span class="icon">ğŸ”‘</span>
                    </div>
                </div>
                <button type="submit" id="email-register-btn" class="btn-mafia-primary">
                    <span class="btn-text">Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</span>
                </button>
            </form>

            <!-- Guest Registration Form -->
            <form id="guest-form" class="form-content" novalidate>
                <div class="input-group">
                    <label for="guest-display-name">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ (ÙÙ‚Ø· Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)</label>
                     <div class="input-mafia-wrapper">
                        <input type="text" id="guest-display-name" class="input-mafia" placeholder="Ù†Ø§Ù… Ù…Ù‡Ù…Ø§Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯" required>
                        <span class="icon">ğŸ‘¤</span>
                    </div>
                </div>
                 <p style="font-size: 0.8rem; text-align: center; opacity: 0.7; margin: -1rem 0 1.5rem 0;">ØªÙˆØ¬Ù‡: Ø¯Ø± Ø­Ø§Ù„Øª Ù…Ù‡Ù…Ø§Ù†ØŒ Ù¾ÛŒØ´Ø±ÙØª Ø´Ù…Ø§ ÙÙ‚Ø· Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
                <button type="submit" id="guest-register-btn" class="btn-mafia-primary">
                    <span class="btn-text">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ù‡Ù…Ø§Ù†</span>
                </button>
            </form>

            <div id="message-container"></div>
            
            <div id="panel-footer">
                <p>Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ <a href="login.html">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</a></p>
            </div>
            
            <div class="panel-bottom-corners"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInAnonymously,
            updateProfile 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- FIREBASE CONFIGURATION ---
        // Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
            authDomain: "mafia-9fcbf.firebaseapp.com",
            projectId: "mafia-9fcbf",
            storageBucket: "mafia-9fcbf.appspot.com",
            messagingSenderId: "471627157488",
            appId: "1:471627157488:web:92f008548a5596619a5735",
            measurementId: "G-0PDHDWC6NV"
        };

        // --- INITIALIZE FIREBASE ---
        let app, auth;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            // Display a critical error to the user if Firebase fails to load
            const panel = document.getElementById('auth-panel');
            if(panel) {
                panel.innerHTML = `<div style="text-align: center; color: var(--mafia-error-red);">
                                    <h2>Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„</h2>
                                    <p>Ø§Ù…Ú©Ø§Ù† Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ ØµÙØ­Ù‡ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.</p>
                                   </div>`;
            }
        }
        

        // --- DOM ELEMENT SELECTORS ---
        const emailTabBtn = document.getElementById('email-tab-btn');
        const guestTabBtn = document.getElementById('guest-tab-btn');
        const emailForm = document.getElementById('email-form');
        const guestForm = document.getElementById('guest-form');
        
        // Email Form Elements
        const emailDisplayNameInput = document.getElementById('email-display-name');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const emailRegisterBtn = document.getElementById('email-register-btn');

        // Guest Form Elements
        const guestDisplayNameInput = document.getElementById('guest-display-name');
        const guestRegisterBtn = document.getElementById('guest-register-btn');
        
        // Message Container
        const messageContainer = document.getElementById('message-container');

        // --- UI HELPER FUNCTIONS ---

        /**
         * Switches between registration forms (Email/Guest).
         * @param {string} formId The ID of the form to show ('email-form' or 'guest-form').
         */
        function switchForm(formId) {
            const isEmailForm = formId === 'email-form';
            
            emailForm.classList.toggle('active', isEmailForm);
            guestForm.classList.toggle('active', !isEmailForm);
            
            emailTabBtn.classList.toggle('active', isEmailForm);
            guestTabBtn.classList.toggle('active', !isEmailForm);

            clearMessages();
        }
        
        /**
         * Displays a message (error or success) to the user.
         * @param {string} message The text to display.
         * @param {'error' | 'success'} type The type of message.
         */
        function showMessage(message, type = 'error') {
            messageContainer.textContent = message;
            messageContainer.className = type; 
        }

        /**
         * Clears any displayed messages and removes invalid states from inputs.
         */
        function clearMessages() {
            messageContainer.className = '';
            messageContainer.textContent = '';
            document.querySelectorAll('.input-mafia.invalid').forEach(input => {
                input.classList.remove('invalid');
            });
        }
        
        /**
         * Toggles the loading state of a button.
         * @param {HTMLButtonElement} button The button element.
         * @param {boolean} isLoading True to show loader, false to hide.
         */
        function setButtonLoadingState(button, isLoading) {
            button.disabled = isLoading;
            const btnText = button.querySelector('.btn-text');
            let loader = button.querySelector('.btn-loader');

            if (isLoading) {
                if (btnText) btnText.classList.add('hidden');
                if (!loader) {
                    loader = document.createElement('div');
                    loader.className = 'btn-loader';
                    button.prepend(loader);
                }
            } else {
                if (btnText) btnText.classList.remove('hidden');
                if (loader) loader.remove();
            }
        }
        
        // --- VALIDATION FUNCTIONS ---

        /**
         * Validates an email address format.
         * @param {string} email The email to validate.
         * @returns {boolean} True if valid, false otherwise.
         */
        function isValidEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        /**
         * Validates the display name.
         * @param {string} name The name to validate.
         * @returns {string|null} An error message if invalid, otherwise null.
         */
        function validateDisplayName(name) {
            if (!name.trim()) return "Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.";
            if (name.length < 3) return "Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û³ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.";
            if (name.length > 20) return "Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Û²Û° Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.";
            if (/[^a-zA-Z0-9_]/.test(name)) return "Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ ÙÙ‚Ø· Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø´Ø§Ù…Ù„ Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ Ø¢Ù†Ø¯Ø±Ù„Ø§ÛŒÙ† (_) Ø¨Ø§Ø´Ø¯.";
            return null;
        }

        // --- EVENT HANDLERS ---
        
        /**
         * Handles the submission of the email registration form.
         * @param {Event} event The form submission event.
         */
        async function handleEmailRegistration(event) {
            event.preventDefault();
            clearMessages();
            
            const displayName = emailDisplayNameInput.value;
            const email = emailInput.value;
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            // --- Form Validation ---
            const displayNameError = validateDisplayName(displayName);
            if (displayNameError) {
                showMessage(displayNameError);
                emailDisplayNameInput.classList.add('invalid');
                return;
            }
            if (!isValidEmail(email)) {
                showMessage("Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
                emailInput.classList.add('invalid');
                return;
            }
            if (password.length < 6) {
                showMessage("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.");
                passwordInput.classList.add('invalid');
                return;
            }
            if (password !== confirmPassword) {
                showMessage("Ø±Ù…Ø²Ù‡Ø§ÛŒ Ø¹Ø¨ÙˆØ± Ø¨Ø§ ÛŒÚ©Ø¯ÛŒÚ¯Ø± Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ù†Ø¯.");
                passwordInput.classList.add('invalid');
                confirmPasswordInput.classList.add('invalid');
                return;
            }
            
            setButtonLoadingState(emailRegisterBtn, true);

            // --- SIMULATED SERVER INTERACTION (As requested) ---
            setTimeout(() => {
                showMessage("Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯...", "success");
                setButtonLoadingState(emailRegisterBtn, false);
            }, 2000);

            /*
            // --- ACTUAL FIREBASE REGISTRATION LOGIC (Future Implementation) ---
            try {
                // Step 1: Create user with email and password
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log("User created:", user.uid);

                // Step 2: Update the user's profile with the display name
                await updateProfile(user, { displayName: displayName });
                console.log("Profile updated with display name:", displayName);
                
                setButtonLoadingState(emailRegisterBtn, false);
                showMessage("Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯! Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªÙ‚Ø§Ù„...", "success");
                
                // Step 3: Redirect to the game or main page after a delay
                // setTimeout(() => { window.location.href = '/game.html'; }, 2000);

            } catch (error) {
                setButtonLoadingState(emailRegisterBtn, false);
                console.error("Email registration error:", error.code, error.message);
                
                // Provide user-friendly error messages
                if (error.code === 'auth/email-already-in-use') {
                    showMessage("Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª.");
                } else if (error.code === 'auth/weak-password') {
                    showMessage("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¶Ø¹ÛŒÙ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø±Ù…Ø² Ù‚ÙˆÛŒâ€ŒØªØ±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
                } else {
                    showMessage("Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ø«Ø¨Øª Ù†Ø§Ù… Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
                }
            }
            */
        }
        
        /**
         * Handles the submission of the guest registration form.
         * @param {Event} event The form submission event.
         */
        async function handleGuestRegistration(event) {
            event.preventDefault();
            clearMessages();

            const displayName = guestDisplayNameInput.value;

            // --- Form Validation ---
            const displayNameError = validateDisplayName(displayName);
            if (displayNameError) {
                showMessage(displayNameError);
                guestDisplayNameInput.classList.add('invalid');
                return;
            }

            setButtonLoadingState(guestRegisterBtn, true);
            
            // --- SIMULATED SERVER INTERACTION (As requested) ---
            setTimeout(() => {
                showMessage("Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯...", "success");
                setButtonLoadingState(guestRegisterBtn, false);
            }, 2000);
            
            /*
            // --- ACTUAL FIREBASE GUEST LOGIC (Future Implementation) ---
            try {
                // Step 1: Sign in anonymously
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                console.log("Guest user signed in:", user.uid);

                // Step 2: Update the anonymous user's profile with the display name
                await updateProfile(user, { displayName: displayName });
                console.log("Guest profile updated with display name:", displayName);
                
                setButtonLoadingState(guestRegisterBtn, false);
                showMessage("ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ² Ø¨ÙˆØ¯! Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªÙ‚Ø§Ù„...", "success");

                // Step 3: Redirect to the game
                // setTimeout(() => { window.location.href = '/game.html'; }, 2000);

            } catch (error) {
                setButtonLoadingState(guestRegisterBtn, false);
                console.error("Guest registration error:", error.code, error.message);
                showMessage("Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… ÙˆØ±ÙˆØ¯ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
            }
            */
        }


        // --- ATTACH EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!auth) {
                console.error("Auth service is not available. Event listeners not attached.");
                return;
            }

            emailTabBtn.addEventListener('click', () => switchForm('email-form'));
            guestTabBtn.addEventListener('click', () => switchForm('guest-form'));

            emailForm.addEventListener('submit', handleEmailRegistration);
            guestForm.addEventListener('submit', handleGuestRegistration);
        });

    </script>

</body>
</html>
