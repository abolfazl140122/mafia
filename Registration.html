<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ثبت نام - شهر مافیا</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&family=Lalezar&display=swap" rel="stylesheet">

    <style>
        /* --- MAFIA CITY THEME - REGISTRATION PAGE --- */

        /* --- ROOT VARIABLES (Consistent Theming) --- */
        :root {
            --mafia-dark-wood: #1e1a17;
            --mafia-panel-brown: #3a322d;
            --mafia-panel-border: #2c2521;
            --mafia-gold-accent: #e6b800;
            --mafia-gold-glow: rgba(230, 184, 0, 0.6);
            --mafia-gold-dark: #a88700;
            --mafia-text-light: #e8e0d9;
            --mafia-text-dark: #1a1a1a;
            --mafia-success-green: #28a745;
            --mafia-success-green-glow: rgba(40, 167, 69, 0.7);
            --mafia-error-red: #dc3545;
            --mafia-error-red-glow: rgba(220, 53, 69, 0.7);
            --mafia-input-bg: #2a2420;
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes panelIntro {
            0% { 
                opacity: 0; 
                transform: translateY(40px) scale(0.95);
                filter: blur(5px);
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        @keyframes backgroundPan {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }
        
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 15px -5px var(--mafia-gold-glow), inset 0 0 10px -5px rgba(255,255,255,0.1); }
            50% { box-shadow: 0 0 25px 0px var(--mafia-gold-glow), inset 0 0 10px -5px rgba(255,255,255,0.2); }
            100% { box-shadow: 0 0 15px -5px var(--mafia-gold-glow), inset 0 0 10px -5px rgba(255,255,255,0.1); }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- GENERAL & BODY STYLES --- */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--mafia-dark-wood);
            background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            color: var(--mafia-text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            animation: fadeIn 1s ease-out;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background-image: url('https://www.transparenttextures.com/patterns/foggy-birds.png');
            opacity: 0.05;
            z-index: 0;
            animation: backgroundPan 180s linear infinite;
        }
        
        /* --- TYPOGRAPHY --- */
        .title-font {
            font-family: 'Lalezar', cursive;
        }
        
        h1, h2, h3 {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* --- REGISTRATION PANEL & LAYOUT --- */
        .registration-container {
            width: 100%;
            max-width: 480px;
            position: relative;
            z-index: 1;
        }
        
        #registration-panel {
            background: linear-gradient(145deg, var(--mafia-panel-brown), #312a25);
            border: 3px solid var(--mafia-panel-border);
            border-radius: 20px;
            padding: 2rem 1.5rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), 
                        inset 0 2px 3px rgba(255, 255, 255, 0.05),
                        inset 0 -2px 3px rgba(0, 0, 0, 0.2);
            animation: panelIntro 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards;
            position: relative;
            overflow: hidden;
        }
        
        @media (min-width: 500px) {
            #registration-panel {
                padding: 2.5rem;
            }
        }

        /* Panel decorative corners */
        #registration-panel::before, #registration-panel::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-style: solid;
            border-color: var(--mafia-gold-accent);
            opacity: 0.5;
            transition: all 0.3s ease;
        }
        #registration-panel::before {
            top: 15px; left: 15px;
            border-width: 2px 0 0 2px;
        }
        #registration-panel::after {
            top: 15px; right: 15px;
            border-width: 2px 2px 0 0;
        }
        /* Using a separate pseudo-element for the bottom corners */
        #registration-panel .panel-bottom-corners::before, #registration-panel .panel-bottom-corners::after {
             content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-style: solid;
            border-color: var(--mafia-gold-accent);
            opacity: 0.5;
            transition: all 0.3s ease;
        }
        #registration-panel .panel-bottom-corners::before {
            bottom: 15px; left: 15px;
            border-width: 0 0 2px 2px;
        }
        #registration-panel .panel-bottom-corners::after {
            bottom: 15px; right: 15px;
            border-width: 0 2px 2px 0;
        }

        #panel-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        #panel-header h1 {
            font-size: 2.5rem;
            color: var(--mafia-gold-accent);
            text-shadow: 0 0 10px var(--mafia-gold-glow), 2px 2px 2px #000;
        }
        
        #panel-header p {
            font-size: 1rem;
            color: var(--mafia-text-light);
            opacity: 0.8;
            margin-top: 0.25rem;
        }
        
        /* --- TAB NAVIGATION --- */
        #tab-container {
            display: flex;
            margin-bottom: 1.5rem;
            background-color: var(--mafia-input-bg);
            border-radius: 10px;
            padding: 5px;
            border: 1px solid var(--mafia-panel-border);
        }
        
        .tab-btn {
            flex: 1;
            padding: 0.75rem 0.5rem;
            background-color: transparent;
            border: none;
            color: var(--mafia-text-light);
            opacity: 0.6;
            font-family: 'Vazirmatn', sans-serif;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab-btn.active {
            background-color: var(--mafia-gold-accent);
            color: var(--mafia-text-dark);
            opacity: 1;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            text-shadow: none;
        }
        
        .tab-btn:not(.active):hover {
            opacity: 1;
            background-color: rgba(255,255,255,0.05);
        }

        /* --- FORM ELEMENTS --- */
        .form-content {
            display: none; /* Hidden by default */
        }
        
        .form-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .form-group {
            margin-bottom: 1.25rem;
            position: relative;
        }

        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }
        
        .input-mafia {
            width: 100%;
            padding: 0.9rem 1rem;
            background-color: var(--mafia-input-bg);
            border: 2px solid var(--mafia-panel-border);
            border-radius: 10px;
            color: var(--mafia-text-light);
            font-size: 1rem;
            font-family: 'Vazirmatn', sans-serif;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .input-mafia::placeholder {
            color: #8a7e74;
            opacity: 0.7;
        }

        .input-mafia:focus {
            outline: none;
            border-color: var(--mafia-gold-accent);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 0 10px var(--mafia-gold-glow);
        }
        
        .input-mafia.invalid {
            border-color: var(--mafia-error-red);
        }
        .input-mafia.invalid:focus {
             box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 0 10px var(--mafia-error-red-glow);
        }
        
        /* --- PRIMARY BUTTON --- */
        .btn-mafia-primary {
            width: 100%;
            padding: 1rem;
            font-family: 'Vazirmatn', sans-serif;
            font-weight: 900;
            font-size: 1.1rem;
            color: var(--mafia-text-dark);
            background: linear-gradient(to top, var(--mafia-gold-dark), var(--mafia-gold-accent));
            border: 2px solid #816600;
            border-radius: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 0 #816600, 0 8px 15px rgba(0,0,0,0.4);
            transition: all 0.15s ease-out;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-mafia-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #816600, 0 12px 20px rgba(0,0,0,0.4);
            filter: brightness(1.1);
        }

        .btn-mafia-primary:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #816600, 0 2px 5px rgba(0,0,0,0.4);
            transition-duration: 0.05s;
        }
        
        .btn-mafia-primary:disabled {
            filter: grayscale(70%) brightness(0.8);
            cursor: not-allowed;
            box-shadow: 0 5px 0 #554400;
        }
        
        .btn-loader {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-top-color: var(--mafia-text-dark);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
        }
        
        /* --- ERROR & SUCCESS MESSAGES --- */
        #message-container {
            margin-top: 1.5rem;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            text-align: center;
            display: none; /* Hidden by default */
            border-width: 2px;
            border-style: solid;
            animation: fadeIn 0.3s;
        }
        
        #message-container.error {
            background-color: rgba(220, 53, 69, 0.2);
            border-color: var(--mafia-error-red);
            color: #f8d7da;
            display: block;
        }

        #message-container.success {
            background-color: rgba(40, 167, 69, 0.2);
            border-color: var(--mafia-success-green);
            color: #d4edda;
            display: block;
        }
        
        /* --- FOOTER LINK --- */
        #panel-footer {
            margin-top: 2rem;
            text-align: center;
        }
        
        #panel-footer a {
            color: var(--mafia-gold-accent);
            text-decoration: none;
            font-weight: 700;
            transition: color 0.3s ease, text-shadow 0.3s ease;
        }
        
        #panel-footer a:hover {
            color: #fff;
            text-shadow: 0 0 5px var(--mafia-gold-glow);
        }
        
        /* --- UTILITY CLASSES --- */
        .hidden {
            display: none !important;
        }

    </style>
</head>
<body>

    <div class="registration-container">
        <div id="registration-panel">
            <div id="panel-header">
                <h1 class="title-font">شهر مافیا</h1>
                <p>برای ورود به شهر، هویت خود را مشخص کنید</p>
            </div>
            
            <div id="tab-container">
                <button id="email-tab-btn" class="tab-btn active" data-form="email-form">ثبت نام با ایمیل</button>
                <button id="guest-tab-btn" class="tab-btn" data-form="guest-form">ورود به عنوان مهمان</button>
            </div>

            <!-- Email Registration Form -->
            <form id="email-form" class="form-content active" novalidate>
                <div class="form-group">
                    <label for="email-display-name">نام نمایشی (انگلیسی)</label>
                    <input type="text" id="email-display-name" class="input-mafia" placeholder="مثال: Godfather123" required>
                </div>
                <div class="form-group">
                    <label for="email">ایمیل</label>
                    <input type="email" id="email" class="input-mafia" placeholder="آدرس ایمیل خود را وارد کنید" required>
                </div>
                <div class="form-group">
                    <label for="password">رمز عبور</label>
                    <input type="password" id="password" class="input-mafia" placeholder="حداقل ۶ کاراکتر" required>
                </div>
                 <div class="form-group">
                    <label for="confirm-password">تکرار رمز عبور</label>
                    <input type="password" id="confirm-password" class="input-mafia" placeholder="رمز عبور خود را تکرار کنید" required>
                </div>
                <button type="submit" id="email-register-btn" class="btn-mafia-primary">
                    <span class="btn-text">ایجاد حساب کاربری</span>
                </button>
            </form>

            <!-- Guest Registration Form -->
            <form id="guest-form" class="form-content" novalidate>
                <div class="form-group">
                    <label for="guest-display-name">نام نمایشی (انگلیسی)</label>
                    <input type="text" id="guest-display-name" class="input-mafia" placeholder="نام مهمان خود را انتخاب کنید" required>
                </div>
                 <p style="font-size: 0.8rem; text-align: center; opacity: 0.7; margin: -1rem 0 1.5rem 0;">توجه: در حالت مهمان، پیشرفت شما فقط روی همین مرورگر ذخیره می‌شود.</p>
                <button type="submit" id="guest-register-btn" class="btn-mafia-primary">
                    <span class="btn-text">ورود به عنوان مهمان</span>
                </button>
            </form>

            <div id="message-container"></div>
            
            <div id="panel-footer">
                <p>حساب کاربری دارید؟ <a href="#">وارد شوید</a></p>
            </div>
            
            <div class="panel-bottom-corners"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInAnonymously,
            updateProfile 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- FIREBASE CONFIGURATION ---
        // Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
            authDomain: "mafia-9fcbf.firebaseapp.com",
            projectId: "mafia-9fcbf",
            storageBucket: "mafia-9fcbf.appspot.com",
            messagingSenderId: "471627157488",
            appId: "1:471627157488:web:92f008548a5596619a5735",
            measurementId: "G-0PDHDWC6NV"
        };

        // --- INITIALIZE FIREBASE ---
        let app, auth;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            // Display a critical error to the user if Firebase fails to load
            const panel = document.getElementById('registration-panel');
            if(panel) {
                panel.innerHTML = `<div style="text-align: center; color: var(--mafia-error-red);">
                                    <h2>خطای اتصال</h2>
                                    <p>امکان برقراری ارتباط با سرورهای بازی وجود ندارد. لطفاً اتصال اینترنت خود را بررسی کرده و صفحه را دوباره بارگذاری کنید.</p>
                                   </div>`;
            }
        }
        

        // --- DOM ELEMENT SELECTORS ---
        const emailTabBtn = document.getElementById('email-tab-btn');
        const guestTabBtn = document.getElementById('guest-tab-btn');
        const emailForm = document.getElementById('email-form');
        const guestForm = document.getElementById('guest-form');
        
        // Email Form Elements
        const emailDisplayNameInput = document.getElementById('email-display-name');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const emailRegisterBtn = document.getElementById('email-register-btn');

        // Guest Form Elements
        const guestDisplayNameInput = document.getElementById('guest-display-name');
        const guestRegisterBtn = document.getElementById('guest-register-btn');
        
        // Message Container
        const messageContainer = document.getElementById('message-container');

        // --- UI HELPER FUNCTIONS ---

        /**
         * Switches between registration forms (Email/Guest).
         * @param {string} formId The ID of the form to show ('email-form' or 'guest-form').
         */
        function switchForm(formId) {
            const isEmailForm = formId === 'email-form';
            
            // Toggle form visibility
            emailForm.classList.toggle('active', isEmailForm);
            guestForm.classList.toggle('active', !isEmailForm);
            
            // Toggle tab button active state
            emailTabBtn.classList.toggle('active', isEmailForm);
            guestTabBtn.classList.toggle('active', !isEmailForm);

            // Clear any previous messages
            clearMessages();
        }
        
        /**
         * Displays a message (error or success) to the user.
         * @param {string} message The text to display.
         * @param {'error' | 'success'} type The type of message.
         */
        function showMessage(message, type = 'error') {
            messageContainer.textContent = message;
            messageContainer.className = type; // 'error' or 'success'
        }

        /**
         * Clears any displayed messages and removes invalid states from inputs.
         */
        function clearMessages() {
            messageContainer.className = '';
            messageContainer.textContent = '';
            document.querySelectorAll('.input-mafia.invalid').forEach(input => {
                input.classList.remove('invalid');
            });
        }
        
        /**
         * Toggles the loading state of a button.
         * @param {HTMLButtonElement} button The button element.
         * @param {boolean} isLoading True to show loader, false to hide.
         */
        function setButtonLoadingState(button, isLoading) {
            button.disabled = isLoading;
            const btnText = button.querySelector('.btn-text');
            let loader = button.querySelector('.btn-loader');

            if (isLoading) {
                if (btnText) btnText.classList.add('hidden');
                if (!loader) {
                    loader = document.createElement('div');
                    loader.className = 'btn-loader';
                    button.prepend(loader);
                }
            } else {
                if (btnText) btnText.classList.remove('hidden');
                if (loader) loader.remove();
            }
        }
        
        // --- VALIDATION FUNCTIONS ---

        /**
         * Validates an email address format.
         * @param {string} email The email to validate.
         * @returns {boolean} True if valid, false otherwise.
         */
        function isValidEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        /**
         * Validates the display name.
         * @param {string} name The name to validate.
         * @returns {string|null} An error message if invalid, otherwise null.
         */
        function validateDisplayName(name) {
            if (!name.trim()) return "نام نمایشی نمی‌تواند خالی باشد.";
            if (name.length < 3) return "نام نمایشی باید حداقل ۳ کاراکتر باشد.";
            if (name.length > 20) return "نام نمایشی نمی‌تواند بیشتر از ۲۰ کاراکتر باشد.";
            if (/[^a-zA-Z0-9_]/.test(name)) return "نام نمایشی فقط می‌تواند شامل حروف انگلیسی، اعداد و آندرلاین (_) باشد.";
            return null;
        }

        // --- EVENT HANDLERS ---
        
        /**
         * Handles the submission of the email registration form.
         * @param {Event} event The form submission event.
         */
        async function handleEmailRegistration(event) {
            event.preventDefault();
            clearMessages();
            
            const displayName = emailDisplayNameInput.value;
            const email = emailInput.value;
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            // --- Form Validation ---
            const displayNameError = validateDisplayName(displayName);
            if (displayNameError) {
                showMessage(displayNameError);
                emailDisplayNameInput.classList.add('invalid');
                return;
            }
            if (!isValidEmail(email)) {
                showMessage("لطفاً یک آدرس ایمیل معتبر وارد کنید.");
                emailInput.classList.add('invalid');
                return;
            }
            if (password.length < 6) {
                showMessage("رمز عبور باید حداقل ۶ کاراکتر باشد.");
                passwordInput.classList.add('invalid');
                return;
            }
            if (password !== confirmPassword) {
                showMessage("رمزهای عبور با یکدیگر مطابقت ندارند.");
                passwordInput.classList.add('invalid');
                confirmPasswordInput.classList.add('invalid');
                return;
            }
            
            setButtonLoadingState(emailRegisterBtn, true);

            // --- SIMULATED SERVER INTERACTION (As requested) ---
            setTimeout(() => {
                showMessage("این قابلیت به زودی فعال خواهد شد...", "success");
                setButtonLoadingState(emailRegisterBtn, false);
            }, 2000);

            /*
            // --- ACTUAL FIREBASE REGISTRATION LOGIC (Future Implementation) ---
            try {
                // Step 1: Create user with email and password
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log("User created:", user.uid);

                // Step 2: Update the user's profile with the display name
                await updateProfile(user, { displayName: displayName });
                console.log("Profile updated with display name:", displayName);
                
                setButtonLoadingState(emailRegisterBtn, false);
                showMessage("ثبت نام با موفقیت انجام شد! در حال انتقال...", "success");
                
                // Step 3: Redirect to the game or main page after a delay
                // setTimeout(() => { window.location.href = '/game.html'; }, 2000);

            } catch (error) {
                setButtonLoadingState(emailRegisterBtn, false);
                console.error("Email registration error:", error.code, error.message);
                
                // Provide user-friendly error messages
                if (error.code === 'auth/email-already-in-use') {
                    showMessage("این ایمیل قبلاً ثبت نام کرده است.");
                } else if (error.code === 'auth/weak-password') {
                    showMessage("رمز عبور ضعیف است. لطفاً رمز قوی‌تری انتخاب کنید.");
                } else {
                    showMessage("خطایی در هنگام ثبت نام رخ داد. لطفاً دوباره تلاش کنید.");
                }
            }
            */
        }
        
        /**
         * Handles the submission of the guest registration form.
         * @param {Event} event The form submission event.
         */
        async function handleGuestRegistration(event) {
            event.preventDefault();
            clearMessages();

            const displayName = guestDisplayNameInput.value;

            // --- Form Validation ---
            const displayNameError = validateDisplayName(displayName);
            if (displayNameError) {
                showMessage(displayNameError);
                guestDisplayNameInput.classList.add('invalid');
                return;
            }

            setButtonLoadingState(guestRegisterBtn, true);
            
            // --- SIMULATED SERVER INTERACTION (As requested) ---
            setTimeout(() => {
                showMessage("این قابلیت به زودی فعال خواهد شد...", "success");
                setButtonLoadingState(guestRegisterBtn, false);
            }, 2000);
            
            /*
            // --- ACTUAL FIREBASE GUEST LOGIC (Future Implementation) ---
            try {
                // Step 1: Sign in anonymously
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                console.log("Guest user signed in:", user.uid);

                // Step 2: Update the anonymous user's profile with the display name
                await updateProfile(user, { displayName: displayName });
                console.log("Guest profile updated with display name:", displayName);
                
                setButtonLoadingState(guestRegisterBtn, false);
                showMessage("ورود موفقیت آمیز بود! در حال انتقال...", "success");

                // Step 3: Redirect to the game
                // setTimeout(() => { window.location.href = '/game.html'; }, 2000);

            } catch (error) {
                setButtonLoadingState(guestRegisterBtn, false);
                console.error("Guest registration error:", error.code, error.message);
                showMessage("خطایی در هنگام ورود رخ داد. لطفاً دوباره تلاش کنید.");
            }
            */
        }


        // --- ATTACH EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!auth) {
                console.error("Auth service is not available. Event listeners not attached.");
                return;
            }

            // Tab switching logic
            emailTabBtn.addEventListener('click', () => switchForm('email-form'));
            guestTabBtn.addEventListener('click', () => switchForm('guest-form'));

            // Form submission logic
            emailForm.addEventListener('submit', handleEmailRegistration);
            guestForm.addEventListener('submit', handleGuestRegistration);
        });

    </script>

</body>
</html>
