<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ÿ®ÿßÿ≤€å ŸÖÿπÿßŸÖŸÑŸá‚Äå⁄Øÿ± - ÿ¥Ÿáÿ± ŸÖÿßŸÅ€åÿß</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* === ŸÖÿ™ÿ∫€åÿ±Ÿáÿß€å ÿ±ŸÜ⁄Ø€å Ÿæÿß€åŸá === */
        :root {
            --primary-gold: #ffc947;
            --dark-red: #8c4843;
            --darker-red: #5a2c2a;
            --text-light: #f0e6d2;
            --text-secondary: #c5a687;
            --bg-dark: #1a140e;
            --border-color: #5c4a3a;
            --green-cooperate: #2ecc71;
            --red-betray: #e74c3c;
            --blue-neutral: #3498db;
            --purple-mafia: #9b59b6; /* Changed from temp-blue */
        }

        /* === ÿ±€åÿ≥ÿ™ Ÿà ÿßÿ≥ÿ™ÿß€åŸÑ‚ÄåŸáÿß€å ⁄©ŸÑ€å === */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { 
            height: 100%; 
            width: 100%;
            overflow: hidden; 
        }

        body { 
            font-family: 'Vazirmatn', sans-serif; 
            color: var(--text-light); 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            background-image: url('https://up.20script.ir/file/d1c7-InShot-€≤€∞€≤€µ0911-122520760.jpg');
            background-size: cover;
            background-position: center center;
        }

        #background-blurry { position: fixed; top: -20px; left: -20px; width: calc(100% + 40px); height: calc(100% + 40px); background-image: url('https://up.20script.ir/file/d1c7-InShot-€≤€∞€≤€µ0911-122520760.jpg'); background-size: cover; background-position: center center; filter: blur(8px) brightness(0.6); z-index: -1; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; transition: opacity 0.5s ease; }
        .loader { border: 6px solid #f3f3f330; border-top: 6px solid var(--primary-gold); border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-text { margin-top: 20px; font-size: 1.1rem; font-weight: 700; }

        /* === ⁄©ÿßŸÜÿ™€åŸÜÿ± ÿßÿµŸÑ€å ÿ®ÿßÿ≤€å === */
        .game-container { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            gap: 10px; 
        }
        
        /* === ŸáÿØÿ± ÿ®ÿßÿ≤€å (ÿßÿ∑ŸÑÿßÿπÿßÿ™ ⁄©ŸÑ€å) === */
        .game-header {
            width: 100%;
            flex-shrink: 0;
            background-color: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        .header-info { display: flex; align-items: center; gap: 15px; }
        .header-title { font-size: clamp(1rem, 4vw, 1.4rem); font-weight: 900; color: var(--primary-gold); text-shadow: 1px 1px 0px var(--darker-red), 2px 2px 5px rgba(0,0,0,0.7); }
        .header-round { font-size: 1rem; color: var(--text-secondary); }
        .header-timer { 
            font-size: 1.2rem; font-weight: 900; color: var(--red-betray); 
            background-color: rgba(255, 255, 255, 0.1); padding: 5px 10px; 
            border-radius: 8px; border: 1px solid var(--red-betray);
            text-shadow: 0 0 5px rgba(231, 76, 60, 0.7);
            min-width: 60px; text-align: center;
        }

        .header-actions { display: flex; gap: 10px; }
        .game-button {
            padding: 6px 12px; border-radius: 8px; font-weight: 700; font-size: 0.9rem;
            cursor: pointer; transition: all 0.2s ease;
            background: linear-gradient(145deg, #a13d3d, #7c1f1f); border: 1px solid #ff8f8f; color: white;
        }
        .game-button:hover { transform: scale(1.05); }
        .game-button:disabled { opacity: 0.6; cursor: not-allowed; }
        .game-button.next-phase { background: linear-gradient(145deg, var(--green-cooperate), #27ae60); border-color: #58d68d; }
        .game-button.next-phase:hover { transform: scale(1.05); }
        
        /* === Player Grid === */
        .players-grid-container {
            flex-grow: 1;
            width: 100%;
            padding: 5px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            overflow-y: auto;
            justify-content: center;
            align-items: flex-start; /* Align items to the top */
        }
        .players-grid-container::-webkit-scrollbar { width: 8px; }
        .players-grid-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        .players-grid-container::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        .players-grid-container::-webkit-scrollbar-thumb:hover { background: var(--primary-gold); }


        .player-card {
            background-color: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            position: relative;
        }
        .player-card.current-player { border-color: var(--primary-gold); box-shadow: 0 0 15px var(--primary-gold); transform: scale(1.02); }
        .player-card.is-partner { border-color: var(--blue-neutral); box-shadow: 0 0 15px var(--blue-neutral); }
        
        .player-avatar { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 3px solid var(--text-secondary); transition: border-color 0.3s ease; }
        .player-card.current-player .player-avatar { border-color: var(--primary-gold); }
        .player-card.is-partner .player-avatar { border-color: var(--blue-neutral); }
        .player-name { font-size: 0.9rem; font-weight: 700; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .player-score { font-size: 1.1rem; font-weight: 900; color: var(--primary-gold); display: flex; align-items: center; gap: 5px; }
        .player-score::before { content: 'üíé'; font-size: 0.9em; filter: drop-shadow(0 0 3px rgba(255, 201, 71, 0.7)); }
        
        /* Choice status indicator */
        .choice-status { 
            position: absolute; top: 5px; right: 5px; 
            font-size: 0.8rem; font-weight: 700; padding: 3px 8px; 
            border-radius: 5px; 
        }
        .choice-status.pending { background-color: rgba(243, 156, 18, 0.8); color: white; }
        .choice-status.chosen { background-color: rgba(46, 204, 113, 0.8); color: white; }


        /* === Footer (Action Buttons) === */
        .game-footer {
            flex-shrink: 0; 
            display: flex; 
            justify-content: center;
            padding: 10px; 
            gap: 15px; 
            background-color: rgba(0,0,0,0.6); 
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -4px 15px rgba(0,0,0,0.4);
        }
        .action-button {
            padding: 14px 25px; 
            font-size: 1.1rem; 
            font-weight: 900; 
            border-radius: 12px; 
            border: none; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            color: white; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); 
            position: relative; 
            overflow: hidden; 
            flex-grow: 1;
            max-width: 180px;
        }
        .action-button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .action-button:disabled { opacity: 0.6; cursor: not-allowed; }

        #cooperate-btn { background: linear-gradient(145deg, var(--green-cooperate), #27ae60); border: 2px solid #58d68d; }
        #betray-btn { background: linear-gradient(145deg, var(--red-betray), #c0392b); border: 2px solid #e67e22; }
        #general-chat-btn { 
            background: linear-gradient(145deg, #4a5568, #2d3748); 
            border: 2px solid #718096;
            width: 50px; height: 50px; 
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; flex-shrink: 0;
            padding: 0; /* Override default button padding */
            max-width: 50px; /* Ensure it stays round */
        }
        #general-chat-btn:hover:not(:disabled) { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #general-chat-btn.new-message::after { content: ''; position: absolute; bottom: 0; right: 0; width: 14px; height: 14px; background-color: #e53e3e; border-radius: 50%; border: 2px solid var(--bg-dark); animation: pulse-new-message 1.5s infinite; }
        @keyframes pulse-new-message { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }


        /* === Narrator (Dialogue Guide) === */
        #narrator-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 100; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: flex-end; 
            padding: 20px; box-sizing: border-box; overflow: hidden;
            opacity: 0; visibility: hidden; 
            transition: opacity 0.5s ease;
        }
        #narrator-overlay.visible { opacity: 1; visibility: visible; }
        #narrator-wrapper { 
            position: relative; width: 90%; max-width: 550px; margin-bottom: 20px; 
            opacity: 0; transform: translateY(40px); 
            transition: opacity 0.5s ease 0.2s, transform 0.5s ease 0.2s; 
        }
        #narrator-overlay.visible #narrator-wrapper { opacity: 1; transform: translateY(0); }
        #narrator-character-container { 
            position: absolute; bottom: -20px; left: -40px; 
            width: 180px; height: auto; z-index: 3; 
            transition: transform 0.3s ease; transform-origin: bottom center; 
            cursor: pointer; 
        }
        #narrator-character-container:hover { transform: scale(1.05); }
        #narrator-character-img { 
            width: 100%; height: auto; object-fit: contain; 
            filter: drop-shadow(0px 5px 15px rgba(0,0,0,0.5)); 
        }
        #narrator-box { 
            width: 100%; background: linear-gradient(145deg, #2c2217, #1a140e); 
            border: 2px solid var(--border-color); border-radius: 16px; 
            padding: 25px 30px 25px 120px; box-shadow: 0 8px 25px rgba(0,0,0,0.6); 
            position: relative; z-index: 2; text-align: right; 
            min-height: 140px; display: flex; flex-direction: column; justify-content: space-between; 
        }
        #narrator-text { 
            font-size: 1rem; line-height: 1.7; margin-bottom: 20px; min-height: 50px;
        }
        .typing-text::after { content: '|'; animation: blink 0.7s infinite; font-weight: bold; color: var(--primary-gold); }
        .typing-text.typing-done::after { content: ''; }
        @keyframes blink { 50% { opacity: 0; } }
        #narrator-button { 
            padding: 10px 30px; font-size: 1rem; font-weight: 700; 
            background: linear-gradient(145deg, var(--dark-red), var(--darker-red)); 
            border: 1px solid var(--primary-gold); color: #fff; border-radius: 8px; 
            cursor: pointer; transition: all 0.2s ease; opacity: 0; visibility: hidden; 
            float: left; align-self: flex-start; 
        }
        #narrator-button:hover { background: linear-gradient(145deg, #a1534d, #6b3431); }
        #narrator-button.visible { opacity: 1; visibility: visible; transition: opacity 0.4s ease 0.2s; }
        @media (max-width: 600px) { 
            #narrator-wrapper { max-width: 100%; } 
            #narrator-character-container { width: 120px; left: -15px; bottom: -15px; } 
            #narrator-box { padding: 20px 20px 20px 90px; min-height: 120px; } 
            #narrator-text { font-size: 0.9rem; } 
        }


        /* === Private Chat Modal === */
        #private-chat-modal {
            position: fixed; top: 50%; left: 50%; width: 90%; max-width: 450px; height: 70%; max-height: 500px;
            background-color: rgba(26, 20, 14, 0.95); backdrop-filter: blur(10px);
            border: 1px solid var(--border-color); border-radius: 16px;
            display: flex; flex-direction: column; z-index: 101;
            box-shadow: 0 8px 30px rgba(0,0,0,0.6);
            opacity: 0; transform: translate(-50%, -50%) scale(0.9);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            pointer-events: none;
        }
        #private-chat-modal.visible { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
        .private-chat-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .private-chat-header h3 { font-size: 1.1rem; color: var(--blue-neutral); font-weight: 700; }
        #private-chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px 15px; display: flex; flex-direction: column; gap: 12px; }
        #private-chat-messages::-webkit-scrollbar { width: 6px; }
        #private-chat-messages::-webkit-scrollbar-track { background: transparent; }
        #private-chat-messages::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 3px; }
        .private-chat-message { display: flex; align-items: flex-start; gap: 10px; }
        .private-chat-message.self { align-self: flex-end; flex-direction: row-reverse; }
        .private-chat-message-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--border-color); }
        .private-chat-message-content { display: flex; flex-direction: column; max-width: calc(100% - 42px); }
        .private-chat-message-sender { font-size: 0.8rem; font-weight: 700; color: var(--blue-neutral); margin-bottom: 3px; }
        .private-chat-message.self .private-chat-message-sender { color: var(--green-cooperate); text-align: right; }
        .private-chat-message-bubble { background-color: #332a20; padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; line-height: 1.5; word-wrap: break-word; }
        .private-chat-message.self .private-chat-message-bubble { background-color: #2a3a30; }
        #private-chat-form { display: flex; padding: 10px 15px; border-top: 1px solid var(--border-color); gap: 10px; flex-shrink: 0; }
        #private-chat-input { flex-grow: 1; background-color: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; color: var(--text-light); font-family: 'Vazirmatn', sans-serif; font-size: 0.9rem; }
        #private-chat-input:focus { outline: none; border-color: var(--blue-neutral); }
        #private-chat-send-btn { background-color: var(--blue-neutral); border: none; border-radius: 8px; color: white; font-weight: 900; padding: 0 15px; cursor: pointer; transition: background-color 0.2s ease; }
        #private-chat-send-btn:hover { background-color: #5dade2; }
        
        /* === General Game Chat Modal === */
        #general-chat-modal {
            position: fixed; top: 50%; left: 50%; width: 90%; max-width: 550px; height: 70%; max-height: 500px;
            background-color: rgba(26, 20, 14, 0.95); backdrop-filter: blur(10px);
            border: 1px solid var(--border-color); border-radius: 16px;
            display: flex; flex-direction: column; z-index: 102; /* Higher than private chat */
            box-shadow: 0 8px 30px rgba(0,0,0,0.6);
            opacity: 0; transform: translate(-50%, -50%) scale(0.9);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            pointer-events: none;
        }
        #general-chat-modal.visible { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
        .general-chat-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .general-chat-header h3 { font-size: 1.1rem; color: var(--primary-gold); font-weight: 700; }
        #general-chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px 15px; display: flex; flex-direction: column; gap: 12px; }
        #general-chat-messages::-webkit-scrollbar { width: 6px; }
        #general-chat-messages::-webkit-scrollbar-track { background: transparent; }
        #general-chat-messages::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 3px; }
        .general-chat-message { display: flex; align-items: flex-start; gap: 10px; }
        .general-chat-message.self { align-self: flex-end; flex-direction: row-reverse; }
        .general-chat-message-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--border-color); }
        .general-chat-message-content { display: flex; flex-direction: column; max-width: calc(100% - 42px); }
        .general-chat-message-sender { font-size: 0.8rem; font-weight: 700; color: var(--primary-gold); margin-bottom: 3px; }
        .general-chat-message.self .general-chat-message-sender { color: var(--green-cooperate); text-align: right; }
        .general-chat-message-bubble { background-color: #332a20; padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; line-height: 1.5; word-wrap: break-word; }
        .general-chat-message.self .general-chat-message-bubble { background-color: #2a3a30; }
        #general-chat-form { display: flex; padding: 10px 15px; border-top: 1px solid var(--border-color); gap: 10px; flex-shrink: 0; }
        #general-chat-input { flex-grow: 1; background-color: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; color: var(--text-light); font-family: 'Vazirmatn', sans-serif; font-size: 0.9rem; }
        #general-chat-input:focus { outline: none; border-color: var(--primary-gold); }
        #general-chat-send-btn { background-color: var(--primary-gold); border: none; border-radius: 8px; color: var(--bg-dark); font-weight: 900; padding: 0 15px; cursor: pointer; transition: background-color 0.2s ease; }
        #general-chat-send-btn:hover { background-color: #ffd46d; }


        /* === Result Modal === */
        #result-modal {
            position: fixed; top: 50%; left: 50%; width: 90%; max-width: 600px;
            background-color: rgba(26, 20, 14, 0.98); backdrop-filter: blur(10px);
            border: 2px solid var(--primary-gold); border-radius: 16px;
            padding: 25px; text-align: center; z-index: 103;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
            opacity: 0; transform: translate(-50%, -50%) scale(0.9);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            pointer-events: none;
        }
        #result-modal.visible { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
        #result-modal-title { font-size: 1.8rem; font-weight: 900; color: var(--primary-gold); margin-bottom: 20px; }
        #round-results-list {
            display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px;
            max-height: 300px; overflow-y: auto; padding-right: 10px;
        }
        #round-results-list::-webkit-scrollbar { width: 6px; }
        #round-results-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 3px; }
        #round-results-list::-webkit-scrollbar-thumb { background-color: var(--primary-gold); border-radius: 3px; }

        .pair-result {
            background-color: rgba(0,0,0,0.5); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 12px;
            display: flex; align-items: center; justify-content: space-around;
            gap: 10px;
        }
        .pair-player {
            display: flex; flex-direction: column; align-items: center;
            gap: 5px; min-width: 80px;
        }
        .pair-player-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--text-secondary); }
        .pair-player-name { font-size: 0.85rem; font-weight: 700; color: var(--text-light); }
        .pair-player-choice { 
            font-size: 0.9rem; font-weight: 700; padding: 4px 8px; border-radius: 8px;
        }
        .pair-player-choice.cooperate { background-color: var(--green-cooperate); color: white; }
        .pair-player-choice.betray { background-color: var(--red-betray); color: white; }
        .pair-score-change { font-size: 1rem; font-weight: 900; color: var(--primary-gold); }
        .pair-divider { font-size: 1.5rem; font-weight: 900; color: var(--text-secondary); }

        /* === Game Over Modal === */
        #game-over-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.95); backdrop-filter: blur(15px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.5s ease;
        }
        #game-over-modal.visible { opacity: 1; visibility: visible; }
        #game-over-content {
            background: linear-gradient(145deg, #2a2118, var(--bg-dark));
            border: 2px solid var(--primary-gold); border-radius: 16px;
            padding: 30px; width: 90%; max-width: 500px; text-align: center;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
            transform: scale(0.9); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: fadeInScale 0.8s forwards;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        #game-over-title { font-size: 2.5rem; font-weight: 900; color: var(--primary-gold); margin-bottom: 20px; text-shadow: 0 0 10px rgba(255, 201, 71, 0.7); }
        #game-winner { font-size: 1.5rem; font-weight: 700; color: var(--green-cooperate); margin-bottom: 15px; }
        #game-over-final-scores {
            list-style: none; display: flex; flex-direction: column; gap: 10px;
            margin-bottom: 30px; max-height: 250px; overflow-y: auto;
            border-top: 1px solid var(--border-color); padding-top: 20px;
        }
        .final-score-item {
            display: flex; justify-content: space-between; align-items: center;
            background-color: rgba(0,0,0,0.4); padding: 8px 15px; border-radius: 8px;
        }
        .final-score-item.winner { background-color: rgba(255, 201, 71, 0.2); border: 1px solid var(--primary-gold); }
        .final-score-player { display: flex; align-items: center; gap: 10px; }
        .final-score-player img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid var(--text-secondary); }
        .final-score-player-name { font-weight: 700; }
        .final-score-value { font-size: 1.1rem; font-weight: 900; color: var(--primary-gold); }
        .game-over-buttons { display: flex; gap: 15px; justify-content: center; }
        .game-over-button {
            padding: 12px 25px; font-size: 1rem; font-weight: 700; border-radius: 8px;
            cursor: pointer; transition: all 0.2s ease; border: 1px solid;
            color: white; background: linear-gradient(145deg, #504436, #332a20); border-color: var(--border-color);
        }
        .game-over-button:hover { background: linear-gradient(145deg, #615342, #403529); }


        /* === Custom Modals (from lobby.html) === */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-content { background: linear-gradient(145deg, #3c3022, var(--bg-dark)); border: 2px solid var(--border-color); border-radius: 16px; padding: 25px; width: 90%; max-width: 380px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.5rem; font-weight: 900; color: var(--primary-gold); margin-bottom: 20px; }
        .modal-message { font-size: 1rem; line-height: 1.6; margin-bottom: 25px; }
        .modal-buttons { display: flex; flex-direction: column; gap: 10px; }
        .modal-button { width: 100%; padding: 12px; font-size: 1rem; font-weight: 700; border-radius: 8px; cursor: pointer; border: 1px solid; }
        .modal-button.primary { color: white; background: linear-gradient(145deg, var(--dark-red), var(--darker-red)); border-color: var(--primary-gold); }
        .modal-button.secondary { color: var(--text-light); background: linear-gradient(145deg, #504436, #332a20); border-color: var(--border-color); }
        
    </style>
</head>
<body>

    <div id="background-blurry"></div>
    <div id="loading-overlay">
        <div class="loader"></div>
        <p id="loading-text">ÿØÿ± ÿ≠ÿßŸÑ Ÿàÿ±ŸàÿØ ÿ®Ÿá ÿ®ÿßÿ≤€å...</p>
    </div>

    <div class="game-container" style="display: none;">
        <header class="game-header">
            <div class="header-info">
                <h1 class="header-title">ŸÖÿπÿßŸÖŸÑŸá‚Äå⁄Øÿ±</h1>
                <span id="game-round" class="header-round">ÿØŸàÿ±: 1/5</span>
            </div>
            <div class="header-info">
                <span id="phase-timer" class="header-timer">00:00</span>
                <div class="header-actions">
                    <button id="leave-game-btn" class="game-button">ÿÆÿ±Ÿàÿ¨</button>
                    <button id="next-phase-btn" class="game-button next-phase" style="display: none;">ŸÖÿ±ÿ≠ŸÑŸá ÿ®ÿπÿØ€å (ŸÖ€åÿ≤ÿ®ÿßŸÜ)</button>
                    <!-- Host/Admin can force next phase -->
                </div>
            </div>
        </header>

        <main id="players-grid-container" class="players-grid-container">
            <!-- Player cards will be rendered here -->
            <p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); opacity: 0.7;">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ®ÿßÿ≤€å⁄©ŸÜÿßŸÜ...</p>
        </main>
        
        <footer class="game-footer">
            <button id="cooperate-btn" class="action-button" style="display: none;">ŸáŸÖ⁄©ÿßÿ±€å</button>
            <button id="betray-btn" class="action-button" style="display: none;">ÿÆ€åÿßŸÜÿ™</button>
            <button id="general-chat-btn" title="⁄Üÿ™ ÿπŸÖŸàŸÖ€å">üí¨</button>
        </footer>
    </div>
    
    <!-- Narrator Overlay (Adapted from Main Lobby) -->
    <div id="narrator-overlay"> 
        <div id="narrator-wrapper"> 
            <div id="narrator-character-container"> 
                <img id="narrator-character-img" src="https://up.20script.ir/file/6195-file-000000001500622f9419de6c322df297-1-.jpg" alt="ÿ±ÿßŸà€å"> 
            </div> 
            <div id="narrator-box"> 
                <p id="narrator-text" class="typing-text"></p> 
                <button id="narrator-button">ÿßÿØÿßŸÖŸá</button> 
            </div> 
        </div> 
    </div>

    <!-- Private Chat Modal -->
    <div id="private-chat-modal" class="modal-overlay">
        <div class="modal-content" style="padding: 0;">
            <div class="private-chat-header">
                <h3 id="private-chat-partner-name">⁄ØŸÅÿ™⁄ØŸà ÿ®ÿß ÿ®ÿßÿ≤€å⁄©ŸÜ</h3>
                <button id="close-private-chat-btn" class="game-button" style="background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; padding: 5px;">&times;</button>
            </div>
            <div id="private-chat-messages"></div>
            <form id="private-chat-form">
                <input type="text" id="private-chat-input" placeholder="Ÿæ€åÿßŸÖ ÿÆŸàÿØ ÿ±ÿß ÿ®ŸÜŸà€åÿ≥€åÿØ..." autocomplete="off">
                <button type="submit" id="private-chat-send-btn">ÿßÿ±ÿ≥ÿßŸÑ</button>
            </form>
        </div>
    </div>

    <!-- General Game Chat Modal -->
    <div id="general-chat-modal" class="modal-overlay">
        <div class="modal-content" style="padding: 0;">
            <div class="general-chat-header">
                <h3>⁄Üÿ™ ÿπŸÖŸàŸÖ€å</h3>
                <button id="close-general-chat-btn" class="game-button" style="background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; padding: 5px;">&times;</button>
            </div>
            <div id="general-chat-messages"></div>
            <form id="general-chat-form">
                <input type="text" id="general-chat-input" placeholder="Ÿæ€åÿßŸÖ ÿÆŸàÿØ ÿ±ÿß ÿ®ŸÜŸà€åÿ≥€åÿØ..." autocomplete="off">
                <button type="submit" id="general-chat-send-btn">ÿßÿ±ÿ≥ÿßŸÑ</button>
            </form>
        </div>
    </div>


    <!-- Result Modal -->
    <div id="result-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px; padding: 25px 0;">
            <h2 id="result-modal-title">ŸÜÿ™ÿß€åÿ¨ ÿØŸàÿ±</h2>
            <div id="round-results-list" style="padding: 0 20px;">
                <!-- Round results will be appended here -->
            </div>
            <button id="result-modal-continue-btn" class="modal-button primary" style="width: calc(100% - 40px); margin: 0 20px;">ÿßÿØÿßŸÖŸá</button>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="game-over-modal" class="modal-overlay">
        <div id="game-over-content">
            <h2 id="game-over-title">Ÿæÿß€åÿßŸÜ ÿ®ÿßÿ≤€å!</h2>
            <p id="game-winner"></p>
            <h3 style="color: var(--text-light); margin-bottom: 15px;">ÿ±ÿØŸá‚Äåÿ®ŸÜÿØ€å ŸÜŸáÿß€å€å:</h3>
            <ul id="game-over-final-scores">
                <!-- Final scores will be rendered here -->
            </ul>
            <div class="game-over-buttons">
                <button id="go-to-lobby-list-btn" class="game-over-button">ÿ®ÿßÿ≤⁄Øÿ¥ÿ™ ÿ®Ÿá ŸÑÿßÿ®€å‚ÄåŸáÿß</button>
                <button id="go-to-main-menu-btn" class="game-over-button">ÿ®ÿßÿ≤⁄Øÿ¥ÿ™ ÿ®Ÿá ÿµŸÅÿ≠Ÿá ÿßÿµŸÑ€å</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal (from lobby.html) -->
    <div id="custom-alert-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="custom-alert-title" class="modal-title">ÿ™Ÿàÿ¨Ÿá!</h2>
            <div id="custom-alert-message" class="modal-message"></div>
            <div id="custom-alert-buttons" class="modal-buttons"></div>
        </div>
    </div>

    <audio id="sound-round-start" src="https://assets.mixkit.co/sfx/preview/mixkit-game-magical-discovery-notification-2735.mp3" preload="auto"></audio>
    <audio id="sound-choice-made" src="https://assets.mixkit.co/sfx/preview/mixkit-fast-response-click-1133.mp3" preload="auto"></audio>
    <audio id="sound-result-reveal" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-level-success-2035.mp3" preload="auto"></audio>
    <audio id="sound-game-over" src="https://assets.mixkit.co/sfx/preview/mixkit-game-show-suspense-672.mp3" preload="auto"></audio>
    <audio id="sound-new-message" src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, runTransaction, getDoc, collection, addDoc, updateDoc, serverTimestamp, query, orderBy, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Configuration (Same as other files) ---
        const firebaseConfig = {
            apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
            authDomain: "mafia-9fcbf.firebaseapp.com",
            projectId: "mafia-9fcbf",
            storageBucket: "mafia-9fcbf.appspot.com",
            messagingSenderId: "471627157488",
            appId: "1:471627157488:web:92f008548a5596619a5735",
            measurementId: "G-0PDHDWC6NV"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const gameContainer = document.querySelector('.game-container');
        const headerRound = document.getElementById('game-round');
        const phaseTimer = document.getElementById('phase-timer');
        const leaveGameBtn = document.getElementById('leave-game-btn');
        const nextPhaseBtn = document.getElementById('next-phase-btn');
        const playersGridContainer = document.getElementById('players-grid-container');
        const cooperateBtn = document.getElementById('cooperate-btn');
        const betrayBtn = document.getElementById('betray-btn');
        const generalChatBtn = document.getElementById('general-chat-btn');

        // Narrator Elements
        const narratorOverlay = document.getElementById('narrator-overlay');
        const narratorCharacterImg = document.getElementById('narrator-character-img');
        const narratorTextEl = document.getElementById('narrator-text');
        const narratorButton = document.getElementById('narrator-button');

        // Private Chat Elements
        const privateChatModal = document.getElementById('private-chat-modal');
        const closePrivateChatBtn = document.getElementById('close-private-chat-btn');
        const privateChatPartnerName = document.getElementById('private-chat-partner-name');
        const privateChatMessagesEl = document.getElementById('private-chat-messages');
        const privateChatForm = document.getElementById('private-chat-form');
        const privateChatInput = document.getElementById('private-chat-input');

        // General Chat Elements
        const generalChatModal = document.getElementById('general-chat-modal');
        const closeGeneralChatBtn = document.getElementById('close-general-chat-btn');
        const generalChatMessagesEl = document.getElementById('general-chat-messages');
        const generalChatForm = document.getElementById('general-chat-form');
        const generalChatInput = document.getElementById('general-chat-input');

        // Result Modal Elements
        const resultModal = document.getElementById('result-modal');
        const resultModalTitle = document.getElementById('result-modal-title');
        const roundResultsList = document.getElementById('round-results-list');
        const resultModalContinueBtn = document.getElementById('result-modal-continue-btn');

        // Game Over Modal Elements
        const gameOverModal = document.getElementById('game-over-modal');
        const gameWinnerEl = document.getElementById('game-winner');
        const gameOverFinalScoresList = document.getElementById('game-over-final-scores');
        const goToLobbyListBtn = document.getElementById('go-to-lobby-list-btn');
        const goToMainMenuBtn = document.getElementById('go-to-main-menu-btn');
        
        // Custom Alert Elements
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertButtons = document.getElementById('custom-alert-buttons');

        // Audio Elements
        const soundRoundStart = document.getElementById('sound-round-start');
        const soundChoiceMade = document.getElementById('sound-choice-made');
        const soundResultReveal = document.getElementById('sound-result-reveal');
        const soundGameOver = document.getElementById('sound-game-over');
        const soundNewMessage = document.getElementById('sound-new-message');

        // --- Game State Variables ---
        const GAME_ROUNDS = 5; // Total number of rounds for the game
        const PHASE_TIMERS = { // Timers in seconds for each phase
            'narrator_announcement': 7,
            'negotiation_chat': 60,
            'choice': 30,
            'results': 10,
            'game_over': 0 // Handled by user interaction
        };
        const SCORE_MATRIX = {
            'cooperate_cooperate': { p1: 3, p2: 3, text: "Ÿáÿ± ÿØŸà ŸáŸÖ⁄©ÿßÿ±€å ⁄©ÿ±ÿØ€åÿØ! ÿßŸÖÿ™€åÿßÿ≤ ŸÖÿ¥ÿ™ÿ±⁄©." },
            'betray_cooperate': { p1: 5, p2: 0, text: "ÿ¥ŸÖÿß ÿÆ€åÿßŸÜÿ™ ⁄©ÿ±ÿØ€åÿØÿå ÿßŸà ŸáŸÖ⁄©ÿßÿ±€å ⁄©ÿ±ÿØ. Ÿæ€åÿ±Ÿàÿ≤€å ⁄©ÿßŸÖŸÑ!" },
            'cooperate_betray': { p1: 0, p2: 5, text: "ÿßŸà ÿÆ€åÿßŸÜÿ™ ⁄©ÿ±ÿØÿå ÿ¥ŸÖÿß ŸáŸÖ⁄©ÿßÿ±€å ⁄©ÿ±ÿØ€åÿØ. ÿ¥⁄©ÿ≥ÿ™!" },
            'betray_betray': { p1: 1, p2: 1, text: "Ÿáÿ± ÿØŸà ÿÆ€åÿßŸÜÿ™ ⁄©ÿ±ÿØ€åÿØ. ÿ≠ÿØÿßŸÇŸÑ ÿßŸÖÿ™€åÿßÿ≤." }
        };
        const DEFAULT_AVATAR = 'https://up.20script.ir/file/1d50-defult.png';
        const NARRATOR_AVATAR = 'https://up.20script.ir/file/6195-file-000000001500622f9419de6c322df297-1-.jpg'; // Reusing your main background image as narrator avatar
        const NARRATOR_NAME = "ÿ±ÿßŸà€å";

        let gameId = null;
        let currentUser = null;
        let currentUserData = {};
        let currentGameState = null;
        let unsubscribeGame = null;
        let unsubscribePrivateChat = null;
        let unsubscribeGeneralChat = null;
        let timerInterval = null;
        let isHost = false;
        let currentNarratorMessageIndex = 0;
        let typingInterval = null;
        let privateChatPartnerUid = null;
        let currentPairId = null;

        // --- Helper Functions ---
        function showModal(modalElement) { modalElement.classList.add('visible'); }
        function hideModal(modalElement) { modalElement.classList.remove('visible'); }

        function showCustomAlert(title, message, buttons) {
            customAlertTitle.textContent = title;
            customAlertMessage.innerHTML = message;
            customAlertButtons.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `modal-button ${btnInfo.class}`;
                button.onclick = () => {
                    if (!btnInfo.keepOpen) hideModal(customAlertModal);
                    if (btnInfo.action) btnInfo.action();
                };
                customAlertButtons.appendChild(button);
            });
            showModal(customAlertModal);
        }

        function playSound(soundElement) {
            if (soundElement) {
                soundElement.currentTime = 0;
                soundElement.play().catch(e => console.warn("Failed to play sound:", e));
            }
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
        }

        function startTimer(endTime) {
            if (timerInterval) clearInterval(timerInterval);

            const updateTimer = () => {
                const now = serverTimestamp().toMillis ? serverTimestamp().toMillis() : Date.now(); // Use serverTimestamp for consistency
                const remaining = Math.max(0, Math.floor((endTime - now) / 1000));
                phaseTimer.textContent = formatTime(remaining);

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    if (isHost) {
                        // Host triggers next phase if timer runs out
                        console.log("Host triggering next phase due to timer expiration.");
                        triggerNextPhase();
                    } else {
                        console.log("Timer ended. Waiting for host to advance phase.");
                    }
                }
            };
            
            // Check once immediately, then every second
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function typeWriterEffect(element, text, callback) {
            let i = 0;
            element.innerHTML = '';
            element.classList.remove('typing-done');
            if (typingInterval) clearInterval(typingInterval);

            typingInterval = setInterval(() => {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                } else {
                    clearInterval(typingInterval);
                    element.classList.add('typing-done');
                    if (callback) callback();
                }
            }, 40); // typing speed
        }

        // --- Game Logic Functions ---

        async function main() {
            gameId = new URLSearchParams(window.location.search).get('gameId');
            if (!gameId) {
                showCustomAlert("ÿÆÿ∑ÿß", "ÿ¥ŸÜÿßÿ≥Ÿá ÿ®ÿßÿ≤€å ŸÜÿßŸÖÿπÿ™ÿ®ÿ± ÿßÿ≥ÿ™.", [{ text: 'ÿ®ÿßÿ≤⁄Øÿ¥ÿ™ ÿ®Ÿá ÿµŸÅÿ≠Ÿá ÿßÿµŸÑ€å', class: 'primary', action: () => window.location.href = './main.html' }]);
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        currentUserData = userDocSnap.data();
                    } else {
                        // Fallback if user data not found (shouldn't happen with proper registration)
                        currentUserData = { displayName: user.displayName || "ÿ®ÿßÿ≤€å⁄©ŸÜ", avatarUrl: DEFAULT_AVATAR, game: 0 };
                    }
                    
                    // Start listening to game state changes
                    listenToGameChanges();
                    listenToGeneralChat(); // General chat is always available

                    // Setup initial event listeners
                    setupEventListeners();
                } else {
                    window.location.href = './login.html';
                }
            });
        }

        function listenToGameChanges() {
            const gameDocRef = doc(db, "games", gameId);
            unsubscribeGame = onSnapshot(gameDocRef, (docSnap) => {
                if (!docSnap.exists()) {
                    showCustomAlert("ÿ®ÿßÿ≤€å ÿ≠ÿ∞ŸÅ ÿ¥ÿØ", "ÿß€åŸÜ ÿ®ÿßÿ≤€å ÿØ€å⁄Øÿ± ŸÅÿπÿßŸÑ ŸÜ€åÿ≥ÿ™.", [{ text: 'ÿ®ÿßÿ≤⁄Øÿ¥ÿ™ ÿ®Ÿá ŸÑÿßÿ®€å‚ÄåŸáÿß', class: 'primary', action: () => window.location.href = './Lobby page.html' }]);
                    return;
                }
                currentGameState = docSnap.data();
                
                // Determine if current user is the host
                isHost = currentUser.uid === currentGameState.creatorId;
                nextPhaseBtn.style.display = isHost ? 'block' : 'none';

                renderGameUI(currentGameState);
                handlePhase(currentGameState.phase);

                if (loadingOverlay.style.display !== 'none') {
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                        gameContainer.style.display = 'flex';
                    }, 500);
                }
            }, (error) => {
                console.error("Firebase Game listen error:", error);
                showCustomAlert("ÿÆÿ∑ÿß€å ÿßÿ±ÿ™ÿ®ÿßÿ∑", "ÿßÿ±ÿ™ÿ®ÿßÿ∑ ÿ®ÿß ÿ≥ÿ±Ÿàÿ± ÿ®ÿßÿ≤€å ŸÇÿ∑ÿπ ÿ¥ÿØ.", [{ text: 'ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÖÿ¨ÿØÿØ', class: 'primary', action: () => window.location.reload() }]);
            });
        }
        
        function renderGameUI(state) {
            headerRound.textContent = `ÿØŸàÿ±: ${state.round}/${GAME_ROUNDS}`;

            playersGridContainer.innerHTML = '';
            state.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.classList.add('player-card');
                if (player.uid === currentUser.uid) {
                    playerCard.classList.add('current-player');
                }
                // Highlight partner during negotiation phase
                if (state.phase === 'negotiation_chat' && player.uid === privateChatPartnerUid) {
                    playerCard.classList.add('is-partner');
                }

                let choiceStatusHTML = '';
                if (state.phase === 'choice' || state.phase === 'results') {
                    if (player.hasChosen) {
                        choiceStatusHTML = `<span class="choice-status chosen">ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿØ</span>`;
                    } else {
                        choiceStatusHTML = `<span class="choice-status pending">ÿØÿ± ÿßŸÜÿ™ÿ∏ÿßÿ±</span>`;
                    }
                }


                playerCard.innerHTML = `
                    ${choiceStatusHTML}
                    <img src="${player.avatarUrl || DEFAULT_AVATAR}" alt="${player.displayName}" class="player-avatar" onerror="this.src='${DEFAULT_AVATAR}';">
                    <span class="player-name">${player.displayName}</span>
                    <span class="player-score">${player.score}</span>
                `;
                playersGridContainer.appendChild(playerCard);
            });

            // Start or update timer
            if (state.phase !== 'game_over') {
                 const endTime = state.timerEndsAt?.toDate().getTime() || Date.now();
                 startTimer(endTime);
            } else {
                 if (timerInterval) clearInterval(timerInterval);
                 phaseTimer.textContent = "Ÿæÿß€åÿßŸÜ";
            }
        }

        async function handlePhase(phase) {
            // Hide all action elements by default
            cooperateBtn.style.display = 'none';
            betrayBtn.style.display = 'none';
            nextPhaseBtn.style.display = 'none'; // Only visible to host in header
            hideModal(privateChatModal);
            hideModal(resultModal);

            switch (phase) {
                case 'loading':
                    loadingOverlay.style.display = 'flex';
                    loadingText.textContent = "ÿØÿ± ÿ≠ÿßŸÑ ÿ¢ŸÖÿßÿØŸá ÿ≥ÿßÿ≤€å ÿ®ÿßÿ≤€å...";
                    break;
                
                case 'narrator_announcement':
                    showNarratorAnnouncement(currentGameState.announcements[currentNarratorMessageIndex]);
                    // Narrator button click advances message, then host triggers next phase
                    break;

                case 'negotiation_chat':
                    narratorOverlay.classList.remove('visible');
                    const myPlayer = currentGameState.players.find(p => p.uid === currentUser.uid);
                    if (!myPlayer) {
                        showCustomAlert("ÿÆÿ∑ÿß", "ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ®ÿßÿ≤€å⁄©ŸÜ ÿ¥ŸÖÿß ÿØÿ± ÿ®ÿßÿ≤€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ.", [{ text: 'ÿÆÿ±Ÿàÿ¨', class: 'danger', action: () => leaveGame() }]);
                        return;
                    }

                    // Find partner for current user
                    const myPair = currentGameState.pairs.find(pair => pair.includes(currentUser.uid));
                    if (myPair) {
                        privateChatPartnerUid = myPair.find(uid => uid !== currentUser.uid);
                        const partnerPlayer = currentGameState.players.find(p => p.uid === privateChatPartnerUid);
                        if (partnerPlayer) {
                            privateChatPartnerName.textContent = `⁄ØŸÅÿ™⁄ØŸà ÿ®ÿß ${partnerPlayer.displayName}`;
                            currentPairId = [currentUser.uid, privateChatPartnerUid].sort().join('_'); // Consistent pair ID
                            listenToPrivateChat(currentPairId);
                            showModal(privateChatModal);
                            privateChatInput.focus();
                        } else {
                            showCustomAlert("ÿÆÿ∑ÿß", "ÿ¥ÿ±€å⁄© ÿ¥ŸÖÿß ÿØÿ± ÿ®ÿßÿ≤€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ.", [{ text: 'ÿ®ÿßÿ¥Ÿá', class: 'primary' }]);
                        }
                    } else {
                        // If a player is not paired (e.g., odd number of players), they just observe
                        showCustomAlert("ÿ™Ÿàÿ¨Ÿá", "ÿ¥ŸÖÿß ÿØÿ± ÿß€åŸÜ ÿØŸàÿ± ÿ®ÿß ÿ®ÿßÿ≤€å⁄©ŸÜ€å ÿ¨ŸÅÿ™ ŸÜÿ¥ÿØŸá‚Äåÿß€åÿØ. ŸÑÿ∑ŸÅÿß ŸÖŸÜÿ™ÿ∏ÿ± ÿ®ŸÖÿßŸÜ€åÿØ.", [{ text: 'ÿ®ÿßÿ¥Ÿá', class: 'primary' }]);
                    }
                    playSound(soundRoundStart);
                    break;

                case 'choice':
                    hideModal(privateChatModal);
                    const currentPlayer = currentGameState.players.find(p => p.uid === currentUser.uid);
                    if (currentPlayer && !currentPlayer.hasChosen) {
                        cooperateBtn.style.display = 'flex';
                        betrayBtn.style.display = 'flex';
                        cooperateBtn.disabled = false;
                        betrayBtn.disabled = false;
                    } else if (currentPlayer && currentPlayer.hasChosen) {
                        // User has already made a choice
                        cooperateBtn.style.display = 'flex'; // Show, but disabled or styled differently
                        betrayBtn.style.display = 'flex';
                        cooperateBtn.disabled = true;
                        betrayBtn.textContent = "ŸÖŸÜÿ™ÿ∏ÿ± ÿ≥ÿß€åÿ±€åŸÜ...";
                        betrayBtn.classList.add('action-button', 'secondary'); // Change styling
                        cooperateBtn.classList.add('action-button', 'secondary');
                    }
                    playSound(soundChoiceMade);
                    break;

                case 'results':
                    cooperateBtn.style.display = 'none';
                    betrayBtn.style.display = 'none';
                    displayRoundResults(currentGameState.roundResults.slice(-1));
                    playSound(soundResultReveal);
                    break;

                case 'game_over':
                    displayGameOverScreen();
                    playSound(soundGameOver);
                    break;
            }
        }
        
        // Narrator Logic
        function showNarratorAnnouncement(message) {
            narratorOverlay.classList.add('visible');
            narratorCharacterImg.src = NARRATOR_AVATAR; // Set narrator character image
            narratorTextEl.innerHTML = '';
            typeWriterEffect(narratorTextEl, message, () => {
                narratorButton.classList.add('visible');
            });
        }
        
        function advanceNarratorMessage() {
            currentNarratorMessageIndex++;
            if (currentNarratorMessageIndex < currentGameState.announcements.length) {
                narratorButton.classList.remove('visible');
                showNarratorAnnouncement(currentGameState.announcements[currentNarratorMessageIndex]);
            } else {
                hideModal(narratorOverlay);
                currentNarratorMessageIndex = 0; // Reset for next round
                // Host will trigger next phase after all messages are shown
            }
        }

        async function triggerNextPhase() {
            if (!isHost) return;

            await runTransaction(db, async (transaction) => {
                const gameDocRef = doc(db, "games", gameId);
                const gameDoc = await transaction.get(gameDocRef);
                if (!gameDoc.exists()) throw new Error("ÿ®ÿßÿ≤€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ!");

                const state = gameDoc.data();
                let nextPhase = state.phase;
                let nextRound = state.round;
                let newAnnouncements = [];
                let nextPlayersState = [...state.players]; // Copy players array
                
                let pairsForNextRound = [];

                switch (state.phase) {
                    case 'loading':
                        newAnnouncements = [`ÿØŸàÿ± ${nextRound} ÿ¢ÿ∫ÿßÿ≤ ÿ¥ÿØ.`, `ÿ®ÿßÿ≤€å⁄©ŸÜÿßŸÜ ÿØÿ± ÿß€åŸÜ ÿØŸàÿ± ÿ®Ÿá ÿµŸàÿ±ÿ™ ÿ™ÿµÿßÿØŸÅ€å ÿ¨ŸÅÿ™ ŸÖ€å‚Äåÿ¥ŸàŸÜÿØ.`, `ÿ¥ŸÖÿß ${PHASE_TIMERS['negotiation_chat']} ÿ´ÿßŸÜ€åŸá ŸÅÿ±ÿµÿ™ ÿØÿßÿ±€åÿØ ÿ™ÿß ÿ®ÿß ÿ¥ÿ±€å⁄© ÿÆŸàÿØ ŸÖÿ∞ÿß⁄©ÿ±Ÿá ⁄©ŸÜ€åÿØ.`];
                        nextPhase = 'narrator_announcement';
                        
                        // Create pairs
                        const activePlayers = nextPlayersState.filter(p => p.isOnline);
                        const shuffledPlayers = [...activePlayers].sort(() => Math.random() - 0.5);
                        for (let i = 0; i < shuffledPlayers.length - 1; i += 2) {
                            pairsForNextRound.push([shuffledPlayers[i].uid, shuffledPlayers[i+1].uid]);
                        }
                        
                        // Update currentPartnerUid for all players
                        nextPlayersState = nextPlayersState.map(p => {
                            const pair = pairsForNextRound.find(pr => pr.includes(p.uid));
                            return { ...p, currentPartnerUid: pair ? pair.find(uid => uid !== p.uid) : null };
                        });

                        break;

                    case 'narrator_announcement':
                        // If all announcements for current phase are shown, move to next
                        if (currentNarratorMessageIndex >= state.announcements.length -1 ) {
                            nextPhase = 'negotiation_chat';
                            newAnnouncements = []; // Clear for next phase's specific announcements
                        } else {
                            // Still showing announcements, no phase change, just update announcement index
                            // This part is client-side, host just progresses by clicking Narrator button
                            return; 
                        }
                        break;

                    case 'negotiation_chat':
                        newAnnouncements = [`ŸÖÿ±ÿ≠ŸÑŸá ŸÖÿ∞ÿß⁄©ÿ±Ÿá ÿ®Ÿá Ÿæÿß€åÿßŸÜ ÿ±ÿ≥€åÿØ.`, `ÿß⁄©ŸÜŸàŸÜ Ÿáÿ± ÿ®ÿßÿ≤€å⁄©ŸÜ ÿ®ÿß€åÿØ ÿßŸÜÿ™ÿÆÿßÿ® ÿÆŸàÿØ ÿ±ÿß ŸÖÿÆŸÅ€åÿßŸÜŸá ÿßŸÜÿ¨ÿßŸÖ ÿØŸáÿØ.`, `ÿ¥ŸÖÿß ${PHASE_TIMERS['choice']} ÿ´ÿßŸÜ€åŸá ŸÅÿ±ÿµÿ™ ÿØÿßÿ±€åÿØ ÿ™ÿß ÿ™ÿµŸÖ€åŸÖ ÿ®⁄Ø€åÿ±€åÿØ.`];
                        nextPhase = 'choice';
                        // Reset choices from previous round for players who are not bots
                        nextPlayersState = nextPlayersState.map(p => p.isBot ? { ...p, currentChoice: null, hasChosen: false } : { ...p, currentChoice: null, hasChosen: false });
                        break;

                    case 'choice':
                        // Ensure all players have chosen or it's timeout for bots
                        for (const player of nextPlayersState) {
                            if (!player.hasChosen && player.isBot) {
                                // Bots make a random choice if they haven't chosen yet
                                player.currentChoice = Math.random() < 0.5 ? 'cooperate' : 'betray';
                                player.hasChosen = true;
                            }
                        }

                        // Calculate scores for this round
                        const currentRoundResults = { roundNumber: nextRound, pairResults: [] };
                        for (const pair of state.pairs) {
                            const p1 = nextPlayersState.find(p => p.uid === pair);
                            const p2 = nextPlayersState.find(p => p.uid === pair);

                            if (p1 && p2 && p1.hasChosen && p2.hasChosen) {
                                let p1ScoreChange = 0;
                                let p2ScoreChange = 0;
                                let resultText = "";
                                let outcomeKey = `${p1.currentChoice}_${p2.currentChoice}`;
                                
                                // Map outcomeKey to SCORE_MATRIX keys
                                if (outcomeKey === 'cooperate_cooperate') {
                                    outcomeKey = 'cooperate_cooperate';
                                } else if (outcomeKey === 'betray_cooperate') {
                                    outcomeKey = 'betray_cooperate';
                                } else if (outcomeKey === 'cooperate_betray') {
                                    outcomeKey = 'cooperate_betray';
                                } else if (outcomeKey === 'betray_betray') {
                                    outcomeKey = 'betray_betray';
                                } else {
                                    // Default/error case if choices are invalid or missing
                                    outcomeKey = 'betray_betray'; // Assume minimal gain
                                }

                                const scoreOutcome = SCORE_MATRIX[outcomeKey];
                                p1ScoreChange = scoreOutcome.p1;
                                p2ScoreChange = scoreOutcome.p2;
                                resultText = scoreOutcome.text;
                                
                                // Update player scores in nextPlayersState
                                nextPlayersState.find(p => p.uid === p1.uid).score += p1ScoreChange;
                                nextPlayersState.find(p => p.uid === p2.uid).score += p2ScoreChange;
                                
                                currentRoundResults.pairResults.push({
                                    player1_uid: p1.uid, p1DisplayName: p1.displayName, p1Avatar: p1.avatarUrl, p1Choice: p1.currentChoice, p1ScoreChange,
                                    player2_uid: p2.uid, p2DisplayName: p2.displayName, p2Avatar: p2.avatarUrl, p2Choice: p2.currentChoice, p2ScoreChange,
                                    resultText
                                });
                            } else {
                                // Handle cases where a player didn't make a choice (e.g., disconnected, error)
                                // For simplicity, if one didn't choose, treat as Betray for scoring against the other.
                                // If both didn't choose, treat as Betray/Betray.
                                let p1ChoiceDefault = p1?.hasChosen ? p1.currentChoice : 'betray';
                                let p2ChoiceDefault = p2?.hasChosen ? p2.currentChoice : 'betray';
                                let p1ScoreChange = 0;
                                let p2ScoreChange = 0;
                                let resultText = "€å⁄© €åÿß Ÿáÿ± ÿØŸà ÿ®ÿßÿ≤€å⁄©ŸÜ ÿßŸÜÿ™ÿÆÿßÿ®€å ŸÜÿØÿßÿ¥ÿ™ŸÜÿØ. ÿßŸÖÿ™€åÿßÿ≤ ÿ®ÿ± ÿßÿ≥ÿßÿ≥ ÿÆ€åÿßŸÜÿ™ Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂.";
                                let outcomeKey = `${p1ChoiceDefault}_${p2ChoiceDefault}`;

                                if (outcomeKey === 'cooperate_cooperate') {
                                    outcomeKey = 'cooperate_cooperate';
                                } else if (outcomeKey === 'betray_cooperate') {
                                    outcomeKey = 'betray_cooperate';
                                } else if (outcomeKey === 'cooperate_betray') {
                                    outcomeKey = 'cooperate_betray';
                                } else if (outcomeKey === 'betray_betray') {
                                    outcomeKey = 'betray_betray';
                                }
                                
                                const scoreOutcome = SCORE_MATRIX[outcomeKey];
                                p1ScoreChange = scoreOutcome.p1;
                                p2ScoreChange = scoreOutcome.p2;

                                if (p1) nextPlayersState.find(p => p.uid === p1.uid).score += p1ScoreChange;
                                if (p2) nextPlayersState.find(p => p.uid === p2.uid).score += p2ScoreChange;

                                currentRoundResults.pairResults.push({
                                    player1_uid: p1?.uid || 'N/A', p1DisplayName: p1?.displayName || 'ŸÜÿßÿ¥ŸÜÿßÿ≥', p1Avatar: p1?.avatarUrl || DEFAULT_AVATAR, p1Choice: p1ChoiceDefault, p1ScoreChange,
                                    player2_uid: p2?.uid || 'N/A', p2DisplayName: p2?.displayName || 'ŸÜÿßÿ¥ŸÜÿßÿ≥', p2Avatar: p2?.avatarUrl || DEFAULT_AVATAR, p2Choice: p2ChoiceDefault, p2ScoreChange,
                                    resultText
                                });
                            }
                        }

                        transaction.update(gameDocRef, {
                            roundResults: arrayUnion(currentRoundResults),
                            players: nextPlayersState // Update player scores and choices for next round
                        });

                        newAnnouncements = [`ŸÜÿ™ÿß€åÿ¨ ÿØŸàÿ± ${nextRound} ÿßÿπŸÑÿßŸÖ ÿ¥ÿØ.`, `ÿ¢ŸÖÿßÿØŸá‚Äåÿ≥ÿßÿ≤€å ÿ®ÿ±ÿß€å ÿØŸàÿ± ÿ®ÿπÿØ€å.`];
                        nextPhase = 'results';
                        break;

                    case 'results':
                        nextRound++;
                        if (nextRound > GAME_ROUNDS) {
                            nextPhase = 'game_over';
                            newAnnouncements = ["ÿ®ÿßÿ≤€å ÿ®Ÿá Ÿæÿß€åÿßŸÜ ÿ±ÿ≥€åÿØ!"]; // Final announcement
                        } else {
                            newAnnouncements = [`ÿØŸàÿ± ${nextRound} ÿ¢ÿ∫ÿßÿ≤ ÿ¥ÿØ.`, `ÿ®ÿßÿ≤€å⁄©ŸÜÿßŸÜ ÿØÿ± ÿß€åŸÜ ÿØŸàÿ± ÿ®Ÿá ÿµŸàÿ±ÿ™ ÿ™ÿµÿßÿØŸÅ€å ÿ¨ŸÅÿ™ ŸÖ€å‚Äåÿ¥ŸàŸÜÿØ.`, `ÿ¥ŸÖÿß ${PHASE_TIMERS['negotiation_chat']} ÿ´ÿßŸÜ€åŸá ŸÅÿ±ÿµÿ™ ÿØÿßÿ±€åÿØ ÿ™ÿß ÿ®ÿß ÿ¥ÿ±€å⁄© ÿÆŸàÿØ ŸÖÿ∞ÿß⁄©ÿ±Ÿá ⁄©ŸÜ€åÿØ.`];
                            nextPhase = 'narrator_announcement';
                            // Reset choices from previous round for players who are not bots
                            nextPlayersState = nextPlayersState.map(p => p.isBot ? { ...p, currentChoice: null, hasChosen: false } : { ...p, currentChoice: null, hasChosen: false });
                            // Re-pair players for the new round
                            const activePlayers = nextPlayersState.filter(p => p.isOnline);
                            const shuffledPlayers = [...activePlayers].sort(() => Math.random() - 0.5);
                            pairsForNextRound = [];
                            for (let i = 0; i < shuffledPlayers.length - 1; i += 2) {
                                pairsForNextRound.push([shuffledPlayers[i].uid, shuffledPlayers[i+1].uid]);
                            }
                            nextPlayersState = nextPlayersState.map(p => {
                                const pair = pairsForNextRound.find(pr => pr.includes(p.uid));
                                return { ...p, currentPartnerUid: pair ? pair.find(uid => uid !== p.uid) : null };
                            });
                        }
                        break;

                    case 'game_over':
                        // No further phases, game is over.
                        return;
                }
                
                // Update game document
                const newTimerEndsAt = new Date(Date.now() + PHASE_TIMERS[nextPhase] * 1000);
                transaction.update(gameDocRef, {
                    round: nextRound,
                    phase: nextPhase,
                    timerEndsAt: newTimerEndsAt,
                    announcements: newAnnouncements,
                    players: nextPlayersState,
                    pairs: pairsForNextRound.length > 0 ? pairsForNextRound : state.pairs // Keep pairs if no new ones generated
                });
            });
        }

        async function makeChoice(choice) {
            cooperateBtn.disabled = true;
            betrayBtn.disabled = true;
            cooperateBtn.textContent = "ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿØ!";
            betrayBtn.textContent = "ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿØ!";

            await runTransaction(db, async (transaction) => {
                const gameDocRef = doc(db, "games", gameId);
                const gameDoc = await transaction.get(gameDocRef);
                if (!gameDoc.exists()) throw new Error("ÿ®ÿßÿ≤€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ!");

                const state = gameDoc.data();
                const players = [...state.players];
                const playerIndex = players.findIndex(p => p.uid === currentUser.uid);

                if (playerIndex > -1 && !players[playerIndex].hasChosen) {
                    players[playerIndex].currentChoice = choice;
                    players[playerIndex].hasChosen = true;
                    transaction.update(gameDocRef, { players: players });
                }
            });
        }

        function displayRoundResults(roundResult) {
            resultModalTitle.textContent = `ŸÜÿ™ÿß€åÿ¨ ÿØŸàÿ± ${roundResult.roundNumber}`;
            roundResultsList.innerHTML = '';

            roundResult.pairResults.forEach(pair => {
                const pairDiv = document.createElement('div');
                pairDiv.classList.add('pair-result');
                pairDiv.innerHTML = `
                    <div class="pair-player">
                        <img src="${pair.p1Avatar || DEFAULT_AVATAR}" alt="${pair.p1DisplayName}" class="pair-player-avatar">
                        <span class="pair-player-name">${pair.p1DisplayName}</span>
                        <span class="pair-player-choice ${pair.p1Choice}">${pair.p1Choice === 'cooperate' ? 'ŸáŸÖ⁄©ÿßÿ±€å' : 'ÿÆ€åÿßŸÜÿ™'}</span>
                        <span class="pair-score-change">+${pair.p1ScoreChange}</span>
                    </div>
                    <span class="pair-divider">vs</span>
                    <div class="pair-player">
                        <img src="${pair.p2Avatar || DEFAULT_AVATAR}" alt="${pair.p2DisplayName}" class="pair-player-avatar">
                        <span class="pair-player-name">${pair.p2DisplayName}</span>
                        <span class="pair-player-choice ${pair.p2Choice}">${pair.p2Choice === 'cooperate' ? 'ŸáŸÖ⁄©ÿßÿ±€å' : 'ÿÆ€åÿßŸÜÿ™'}</span>
                        <span class="pair-score-change">+${pair.p2ScoreChange}</span>
                    </div>
                `;
                roundResultsList.appendChild(pairDiv);
            });
            showModal(resultModal);
        }

        async function displayGameOverScreen() {
            hideModal(resultModal); // Ensure result modal is hidden
            if (timerInterval) clearInterval(timerInterval);
            phaseTimer.textContent = "Ÿæÿß€åÿßŸÜ";

            const finalScores = [...currentGameState.players].sort((a, b) => b.score - a.score);
            let winner = finalScores;
            
            gameWinnerEl.textContent = `ÿ®ÿ±ŸÜÿØŸá: ${winner.displayName} ÿ®ÿß ${winner.score} ÿßŸÖÿ™€åÿßÿ≤!`;
            gameOverFinalScoresList.innerHTML = '';

            for (const player of finalScores) {
                const li = document.createElement('li');
                li.classList.add('final-score-item');
                if (player.uid === winner.uid) {
                    li.classList.add('winner');
                }
                li.innerHTML = `
                    <div class="final-score-player">
                        <img src="${player.avatarUrl || DEFAULT_AVATAR}" alt="${player.displayName}">
                        <span class="final-score-player-name">${player.displayName}</span>
                    </div>
                    <span class="final-score-value">${player.score}</span>
                `;
                gameOverFinalScoresList.appendChild(li);

                // Update user's total game score (gems) in Firestore
                // Only do this once per game end, by host or first client to reach it
                if (isHost && !currentGameState.scoreUpdated) {
                    const userDocRef = doc(db, 'users', player.uid);
                    await updateDoc(userDocRef, { game: (currentUserData.game || 0) + player.score });
                }
            }
            if (isHost && !currentGameState.scoreUpdated) {
                await updateDoc(doc(db, "games", gameId), { scoreUpdated: true, status: 'finished' });
            }

            showModal(gameOverModal);
        }

        async function leaveGame() {
            // First confirm with user
            showCustomAlert("ÿÆÿ±Ÿàÿ¨ ÿßÿ≤ ÿ®ÿßÿ≤€å", "ÿ¢€åÿß ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØ ⁄©Ÿá ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ÿßÿ≤ ÿ®ÿßÿ≤€å ÿÆÿßÿ±ÿ¨ ÿ¥Ÿà€åÿØÿü", [
                { text: 'ÿ®ŸÑŸáÿå ÿÆÿßÿ±ÿ¨ ÿ¥ŸàŸÖ', class: 'danger', action: async () => {
                    if (unsubscribeGame) unsubscribeGame();
                    if (unsubscribePrivateChat) unsubscribePrivateChat();
                    if (unsubscribeGeneralChat) unsubscribeGeneralChat();
                    if (timerInterval) clearInterval(timerInterval);

                    const gameDocRef = doc(db, "games", gameId);
                    await runTransaction(db, async (transaction) => {
                        const gameDoc = await transaction.get(gameDocRef);
                        if (!gameDoc.exists()) return; // Game already deleted or finished

                        const players = gameDoc.data().players.filter(p => p.uid !== currentUser.uid);
                        
                        // If host leaves, the game usually ends for everyone
                        if (isHost) {
                            transaction.update(gameDocRef, {
                                status: 'finished',
                                announcements: ["ŸÖ€åÿ≤ÿ®ÿßŸÜ ÿßÿ≤ ÿ®ÿßÿ≤€å ÿÆÿßÿ±ÿ¨ ÿ¥ÿØ. ÿ®ÿßÿ≤€å ÿ®Ÿá Ÿæÿß€åÿßŸÜ ÿ±ÿ≥€åÿØ."],
                                phase: 'game_over' // Force game over
                            });
                        } else {
                            // Mark player as offline, or remove them
                            const playerIndex = gameDoc.data().players.findIndex(p => p.uid === currentUser.uid);
                            if (playerIndex > -1) {
                                const updatedPlayers = [...gameDoc.data().players];
                                updatedPlayers[playerIndex].isOnline = false; // Mark as offline instead of removing
                                transaction.update(gameDocRef, { players: updatedPlayers });
                            }
                        }
                    });
                    window.location.href = './Lobby page.html';
                }},
                { text: 'ÿÆ€åÿ±ÿå ÿ®ŸÖÿßŸÜŸÖ', class: 'secondary' }
            ]);
        }

        // --- Chat Functions ---

        function listenToPrivateChat(pairId) {
            if (unsubscribePrivateChat) unsubscribePrivateChat(); // Stop previous listener
            privateChatMessagesEl.innerHTML = ''; // Clear old messages

            const chatCollectionRef = collection(db, `games/${gameId}/privateChats/${pairId}/messages`);
            const q = query(chatCollectionRef, orderBy('timestamp', 'asc'));

            unsubscribePrivateChat = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        renderPrivateMessage(change.doc.data());
                    }
                });
            }, (error) => {
                console.error("Error listening to private chat:", error);
                showCustomAlert("ÿÆÿ∑ÿß", "ŸÖÿ¥⁄©ŸÑ€å ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ⁄Üÿ™ ÿÆÿµŸàÿµ€å Ÿæ€åÿ¥ ÿ¢ŸÖÿØ.", [{ text: 'ÿ®ÿßÿ¥Ÿá', class: 'primary' }]);
            });
        }

        function renderPrivateMessage(messageData) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('private-chat-message');
            if (messageData.senderUid === currentUser.uid) {
                messageDiv.classList.add('self');
            }
            messageDiv.innerHTML = `
                <img src="${messageData.senderAvatarUrl || DEFAULT_AVATAR}" alt="${messageData.senderName}" class="private-chat-message-avatar" onerror="this.src='${DEFAULT_AVATAR}';">
                <div class="private-chat-message-content">
                    <span class="private-chat-message-sender">${messageData.senderName}</span>
                    <div class="private-chat-message-bubble">${messageData.text}</div>
                </div>
            `;
            privateChatMessagesEl.appendChild(messageDiv);
            privateChatMessagesEl.scrollTop = privateChatMessagesEl.scrollHeight;
        }

        async function sendPrivateMessage(e) {
            e.preventDefault();
            const messageText = privateChatInput.value.trim();
            if (!messageText || !currentPairId) return;

            privateChatInput.value = '';
            privateChatInput.disabled = true;

            try {
                const chatCollectionRef = collection(db, `games/${gameId}/privateChats/${currentPairId}/messages`);
                await addDoc(chatCollectionRef, {
                    text: messageText,
                    senderName: currentUserData.displayName || "ÿ®ÿßÿ≤€å⁄©ŸÜ",
                    senderUid: currentUser.uid,
                    senderAvatarUrl: currentUserData.avatarUrl || DEFAULT_AVATAR,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Error sending private message:", error);
                showCustomAlert("ÿÆÿ∑ÿß", "ÿßÿ±ÿ≥ÿßŸÑ Ÿæ€åÿßŸÖ ÿÆÿµŸàÿµ€å ÿ®ÿß ŸÖÿ¥⁄©ŸÑ ŸÖŸàÿßÿ¨Ÿá ÿ¥ÿØ.", [{ text: 'ÿ®ÿßÿ¥Ÿá', class: 'primary' }]);
            } finally {
                privateChatInput.disabled = false;
                privateChatInput.focus();
            }
        }

        function listenToGeneralChat() {
            if (unsubscribeGeneralChat) unsubscribeGeneralChat();
            generalChatMessagesEl.innerHTML = '';

            const chatCollectionRef = collection(db, `games/${gameId}/gameChat`);
            const q = query(chatCollectionRef, orderBy('timestamp', 'asc'));

            unsubscribeGeneralChat = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        renderGeneralMessage(change.doc.data());
                        if (!generalChatModal.classList.contains('visible') && change.doc.data().senderUid !== currentUser.uid) {
                            generalChatBtn.classList.add('new-message');
                            playSound(soundNewMessage);
                        }
                    }
                });
            }, (error) => {
                console.error("Error listening to general chat:", error);
                showCustomAlert("ÿÆÿ∑ÿß", "ŸÖÿ¥⁄©ŸÑ€å ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ⁄Üÿ™ ÿπŸÖŸàŸÖ€å Ÿæ€åÿ¥ ÿ¢ŸÖÿØ.", [{ text: 'ÿ®ÿßÿ¥Ÿá', class: 'primary' }]);
            });
        }

        function renderGeneralMessage(messageData) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('general-chat-message');
            if (messageData.senderUid === currentUser.uid) {
                messageDiv.classList.add('self');
            }
            messageDiv.innerHTML = `
                <img src="${messageData.senderAvatarUrl || DEFAULT_AVATAR}" alt="${messageData.senderName}" class="general-chat-message-avatar" onerror="this.src='${DEFAULT_AVATAR}';">
                <div class="general-chat-message-content">
                    <span class="general-chat-message-sender">${messageData.senderName}</span>
                    <div class="general-chat-message-bubble">${messageData.text}</div>
                </div>
            `;
            generalChatMessagesEl.appendChild(messageDiv);
            generalChatMessagesEl.scrollTop = generalChatMessagesEl.scrollHeight;
        }

        async function sendGeneralMessage(e) {
            e.preventDefault();
            const messageText = generalChatInput.value.trim();
            if (!messageText) return;

            generalChatInput.value = '';
            generalChatInput.disabled = true;

            try {
                const chatCollectionRef = collection(db, `games/${gameId}/gameChat`);
                await addDoc(chatCollectionRef, {
                    text: messageText,
                    senderName: currentUserData.displayName || "ÿ®ÿßÿ≤€å⁄©ŸÜ",
                    senderUid: currentUser.uid,
                    senderAvatarUrl: currentUserData.avatarUrl || DEFAULT_AVATAR,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Error sending general message:", error);
                showCustomAlert("ÿÆÿ∑ÿß", "ÿßÿ±ÿ≥ÿßŸÑ Ÿæ€åÿßŸÖ ÿπŸÖŸàŸÖ€å ÿ®ÿß ŸÖÿ¥⁄©ŸÑ ŸÖŸàÿßÿ¨Ÿá ÿ¥ÿØ.", [{ text: 'ÿ®ÿßÿ¥Ÿá', class: 'primary' }]);
            } finally {
                generalChatInput.disabled = false;
                generalChatInput.focus();
            }
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            leaveGameBtn.addEventListener('click', leaveGame);
            nextPhaseBtn.addEventListener('click', () => triggerNextPhase());

            cooperateBtn.addEventListener('click', () => makeChoice('cooperate'));
            betrayBtn.addEventListener('click', () => makeChoice('betray'));

            narratorButton.addEventListener('click', advanceNarratorMessage);

            closePrivateChatBtn.addEventListener('click', () => hideModal(privateChatModal));
            privateChatForm.addEventListener('submit', sendPrivateMessage);

            generalChatBtn.addEventListener('click', () => {
                generalChatBtn.classList.remove('new-message'); // Clear new message indicator
                showModal(generalChatModal);
                generalChatInput.focus();
            });
            closeGeneralChatBtn.addEventListener('click', () => hideModal(generalChatModal));
            generalChatForm.addEventListener('submit', sendGeneralMessage);

            resultModalContinueBtn.addEventListener('click', () => {
                hideModal(resultModal);
                if (isHost) {
                    // Host triggers next phase after results are seen
                    triggerNextPhase();
                } else {
                    // Non-host just waits for the game state to update
                }
            });

            goToLobbyListBtn.addEventListener('click', () => window.location.href = './Lobby page.html');
            goToMainMenuBtn.addEventListener('click', () => window.location.href = './main.html');
        }

        // --- Initialize Game ---
        main();
    </script>
</body>
</html>
```

---
**File: `ÿµŸÅŸá ÿØÿßÿÆŸÑ ŸÑÿßÿ®€å.txt` (MODIFICATION)**
---

Here are the *minimal* modifications required in `ÿµŸÅŸá ÿØÿßÿÆŸÑ ŸÑÿßÿ®€å.txt` to properly integrate with the new `gamescreen.html`. The main change is in the `startGame` function to create the correct Firebase `games` document for "The Negotiator" and then redirect.

```html
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ŸÑÿßÿ®€å ÿ®ÿßÿ≤€å - ÿ¥Ÿáÿ± ŸÖÿßŸÅ€åÿß</title>
    <!-- Vazirmatn Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* === ŸÖÿ™ÿ∫€åÿ±Ÿáÿß€å ÿ±ŸÜ⁄Ø€å Ÿæÿß€åŸá === */
        :root {
            --primary-gold: #ffc947;
            --dark-red: #c0392b;
            --darker-red: #a13226;
            --admin-red: #e74c3c;
            --admin-red-hover: #ff6b5a;
            --admin-spectate-blue: #3498db;
            --admin-spectate-blue-hover: #5dade2;
            --text-light: #f0e6d2;
            --text-secondary: #c5a687;
            --bg-dark: #120e0a;
            --bg-card: rgba(26, 20, 14, 0.75);
            --border-color: rgba(92, 74, 58, 0.7);
            --border-glow: rgba(255, 201, 71, 0.6);
            --shadow-color: rgba(0, 0, 0, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-dark);
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #background-blurry {
            position: fixed;
            top: -20px;
            left: -20px;
            width: calc(100% + 40px);
            height: calc(100% + 40px);
            background-image: url('https://up.20script.ir/file/d1c7-InShot-€≤€∞€≤€µ€∞€π€±€±-€±€≤€≤€µ€≤€∞€∑€∂€∞.jpg');
            background-size: cover;
            background-position: center center;
            filter: blur(10px) brightness(0.5);
            z-index: -1;
        }
        
        /* --- ENHANCED Loading Overlay --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
        }
        .loader-logo-wrapper {
            position: relative; width: 180px; height: 180px;
            display: flex; justify-content: center; align-items: center;
        }
        .loader-logo-wrapper::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            border: 4px solid transparent;
            border-top-color: var(--primary-gold);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader-logo { 
            width: 100px; height: auto; 
            animation: pulse-logo 2s infinite ease-in-out;
        }
        @keyframes pulse-logo {
            0%, 100% { transform: scale(0.95); opacity: 0.9; }
            50% { transform: scale(1.05); opacity: 1; }
        }
        #loading-text {
            margin-top: 25px; font-size: 1.1rem; font-weight: 700;
            color: var(--text-light); text-shadow: 1px 1px 3px #000;
        }
        
        /* --- Music Download Overlay --- */
        #music-download-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.95); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1999; opacity: 0; visibility: hidden; transition: all 0.5s ease;
        }
        #music-download-overlay.visible { opacity: 1; visibility: visible; }
        .download-panel { width: 90%; max-width: 350px; text-align: center; }
        .download-title {
            font-size: 1.4rem; font-weight: 900; color: var(--primary-gold);
            margin-bottom: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.7);
        }
        .progress-bar-container {
            width: 100%; height: 10px; background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        #progress-bar {
            width: 0%; height: 100%;
            background: linear-gradient(90deg, var(--dark-red), var(--primary-gold));
            border-radius: 10px; transition: width 0.3s ease-out;
        }
        #progress-text { margin-top: 15px; font-size: 1rem; font-weight: 700; color: var(--text-light); }

        /* --- Main Layout --- */
        .main-container {
            width: 100%; height: 100%; display: flex;
            flex-direction: column; padding: 15px; padding-bottom: 90px;
        }

        header {
            width: 100%; display: flex; align-items: center;
            gap: 10px; margin-bottom: 20px;
        }
        .search-bar { flex-grow: 1; position: relative; }
        .search-bar input {
            width: 100%; padding: 12px 20px 12px 50px;
            background-color: var(--bg-card); border: 1px solid var(--border-color);
            backdrop-filter: blur(10px); border-radius: 25px;
            color: var(--text-light); font-size: 1rem;
            font-family: 'Vazirmatn', sans-serif; transition: all 0.3s ease;
        }
        .search-bar input::placeholder { color: var(--text-secondary); opacity: 0.7; }
        .search-bar input:focus {
            outline: none; border-color: var(--primary-gold);
            box-shadow: 0 0 15px var(--border-glow);
            background-color: rgba(36, 28, 20, 0.8);
        }
        .search-bar .search-icon {
            position: absolute; left: 20px; top: 50%;
            transform: translateY(-50%); color: var(--text-secondary); font-size: 1rem;
        }
        .back-button {
            padding: 12px;
            width: 46px; height: 46px; display: grid; place-items: center;
            background: var(--bg-card);
            border: 1px solid var(--border-color); border-radius: 50%;
            color: var(--text-light); font-size: 1.2rem; cursor: pointer;
            transition: all 0.3s ease;
        }
        .back-button:hover {
            border-color: var(--primary-gold);
            color: var(--primary-gold);
            transform: scale(1.1);
        }

        #lobby-list {
            flex-grow: 1; overflow-y: auto; display: flex;
            flex-direction: column; gap: 15px; padding: 0 5px 15px 0;
        }
        #lobby-list::-webkit-scrollbar { width: 6px; }
        #lobby-list::-webkit-scrollbar-track { background: transparent; }
        #lobby-list::-webkit-scrollbar-thumb {
            background-color: var(--primary-gold); border-radius: 10px;
        }
        
        /* --- ENHANCED Lobby Card --- */
        .lobby-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            border-radius: 16px; padding: 15px;
            display: flex; flex-direction: column; gap: 12px;
            box-shadow: 0 5px 20px var(--shadow-color);
            position: relative; overflow: hidden;
            opacity: 0; transform: translateY(30px);
            animation: slideInUp 0.6s cubic-bezier(0.25, 1, 0.5, 1) forwards;
            transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.4s ease, max-height 0.5s ease-in-out, padding 0.4s ease, margin-bottom 0.4s ease;
            max-height: 500px; /* Initial max-height for transition */
        }
        
        .lobby-card.hidden {
            opacity: 0;
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            border-width: 0;
            transform: scale(0.95);
        }
        
        .lobby-card::before { /* Glow effect */
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border-radius: 16px;
            background: radial-gradient(circle at 50% 50%, rgba(255, 201, 71, 0.2), transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }
        .lobby-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 10px 30px var(--shadow-color), 0 0 25px var(--border-glow);
        }
        .lobby-card:hover::before { opacity: 1; }
        
        @keyframes slideInUp { to { opacity: 1; transform: translateY(0); } }

        .lobby-card-header { display: flex; justify-content: space-between; align-items: center; }
        .lobby-card-footer { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-end; gap: 12px; }
        .lobby-card-body { padding: 10px 0; border-top: 1px solid rgba(92, 74, 58, 0.5); margin-top: 8px; }
        
        .lobby-description {
            font-size: 0.9rem; color: var(--text-secondary);
            line-height: 1.5; font-style: italic;
        }
        .lobby-name-wrapper { display: flex; align-items: center; gap: 10px; }
        .lobby-name {
            font-size: 1.4rem; font-weight: 900; color: var(--primary-gold);
            text-shadow: 0 2px 5px rgba(0,0,0,0.7);
        }
        .lock-icon { font-size: 1.1rem; color: var(--primary-gold); }
        .lobby-info { display: flex; gap: 15px; align-items: center; flex-wrap: wrap;}
        .lobby-scenario {
            background: rgba(255, 201, 71, 0.1); color: var(--primary-gold);
            padding: 4px 12px; border-radius: 15px; font-size: 0.8rem;
            font-weight: 700; border: 1px solid rgba(255, 201, 71, 0.3);
        }
        .player-count {
            display: flex; align-items: center; gap: 8px; font-size: 1.1rem;
            font-weight: 700; background-color: rgba(0,0,0,0.3);
            padding: 5px 12px; border-radius: 20px;
        }
        .player-count .fa-users {
            animation: pulse-icon 2s infinite ease-in-out;
        }
        @keyframes pulse-icon { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .creator-info { display: flex; align-items: center; gap: 10px; min-width: 180px; }
        .creator-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            border: 2px solid var(--primary-gold); object-fit: cover;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .creator-details { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
        .lobby-creator { font-size: 0.9rem; color: var(--text-secondary); }
        
        .admin-password-container {
            display: flex; align-items: center; justify-content: space-between;
            background-color: rgba(0, 0, 0, 0.4); border: 1px solid var(--border-color);
            border-radius: 6px; padding: 4px 8px; margin-top: 6px; cursor: pointer;
            transition: all 0.2s ease;
        }
        .admin-password-container:hover { background-color: var(--admin-edit-bg); border-color: var(--primary-gold); }
        .admin-password-text { font-size: 0.8rem; color: #f39c12; font-family: monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        .admin-edit-icon { font-size: 0.9rem; color: var(--text-secondary); padding-left: 8px; }
        
        .lobby-actions { display: flex; gap: 10px; flex-grow: 1; justify-content: flex-end; }
        .lobby-btn {
            padding: 10px 15px; font-size: 0.9rem; font-weight: 700;
            border-radius: 8px; cursor: pointer; border: none;
            transition: all 0.3s ease; font-family: 'Vazirmatn', sans-serif;
            text-shadow: 0 1px 2px rgba(0,0,0,0.4); text-align: center;
            white-space: nowrap; flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .lobby-btn:active { transform: translateY(1px) scale(0.98); }
        
        .btn-join { color: white; background: linear-gradient(145deg, var(--dark-red), var(--darker-red)); border: 1px solid var(--primary-gold); }
        .btn-join:hover { background: linear-gradient(145deg, #d35400, #a13226); transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        .btn-join:disabled { background: linear-gradient(145deg, #616161, #3a3a3a); border-color: #888; cursor: not-allowed; opacity: 0.7; }
        .btn-join:disabled:hover { transform: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        .btn-admin-delete { background: linear-gradient(145deg, var(--admin-red), #962d2d); color: white; border: 1px solid #ff7961; }
        .btn-admin-delete:hover { background: linear-gradient(145deg, var(--admin-red-hover), var(--admin-red)); transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.4); }

        .btn-spectate { background: linear-gradient(145deg, var(--admin-spectate-blue), #20638f); color: white; border: 1px solid #7dc2f1; }
        .btn-spectate:hover { background: linear-gradient(145deg, var(--admin-spectate-blue-hover), var(--admin-spectate-blue)); transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        
        .btn-delete { background: linear-gradient(145deg, #555, #333); color: var(--text-light); border: 1px solid #888; }
        .btn-delete:hover { background: linear-gradient(145deg, #666, #444); transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.4); }

        /* --- Floating Action Button --- */
        #create-lobby-fab {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 60px; height: 60px;
            background: linear-gradient(145deg, var(--primary-gold), var(--secondary-gold));
            color: var(--bg-dark); border-radius: 50%; border: none; font-size: 2.2rem;
            display: grid; place-items: center; cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 201, 71, 0.4);
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1); z-index: 999;
        }
        #create-lobby-fab:hover { transform: translateX(-50%) scale(1.1) rotate(90deg); box-shadow: 0 8px 25px rgba(255, 201, 71, 0.5); }
        #create-lobby-fab:active { transform: translateX(-50%) scale(0.95) rotate(90deg); }

        /* --- ENHANCED Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: linear-gradient(145deg, #2a2118, var(--bg-dark));
            border: 2px solid var(--border-color); border-radius: 16px;
            padding: 25px 30px; width: 90%; max-width: 380px; text-align: center;
            box-shadow: 0 10px 40px var(--shadow-color);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.visible .modal-content { transform: scale(1) translateY(0); }
        .modal-title {
            font-size: 1.6rem; font-weight: 900; color: var(--primary-gold);
            margin-bottom: 20px; text-shadow: 0 2px 5px var(--shadow-color);
        }
        .modal-message { font-size: 1rem; line-height: 1.6; margin-bottom: 25px; color: var(--text-light); }
        .modal-input-group { width: 100%; margin-bottom: 20px; }
        .modal-input, .modal-select, .modal-textarea {
            width: 100%; padding: 12px 15px;
            background-color: rgba(0,0,0,0.4); border: 1px solid var(--border-color);
            border-radius: 8px; color: var(--text-light);
            font-family: 'Vazirmatn', sans-serif; font-size: 1rem; text-align: center;
            transition: all 0.3s ease;
        }
        .modal-input, .modal-textarea { margin-bottom: 15px; }
        .modal-textarea { resize: none; height: 80px; text-align: right; padding: 10px; }
        .modal-input:focus, .modal-select:focus, .modal-textarea:focus { outline: none; border-color: var(--primary-gold); box-shadow: 0 0 10px var(--border-glow); }
        .modal-buttons { display: flex; gap: 15px; width: 100%; }
        .modal-button {
            flex-grow: 1; padding: 12px; font-size: 1rem; font-weight: 700;
            border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
            border: 1px solid; font-family: 'Vazirmatn', sans-serif;
        }
        .modal-button.primary { color: white; background: linear-gradient(145deg, var(--dark-red), var(--darker-red)); border-color: var(--primary-gold); }
        .modal-button.primary:hover { background: linear-gradient(145deg, #d35400, #a13226); }
        .modal-button.primary:disabled { background: #555; border-color: #777; cursor: not-allowed; opacity: 0.6; }
        .modal-button.secondary { color: var(--text-light); background: linear-gradient(145deg, #504436, #332a20); border-color: var(--border-color); }
        .modal-button.secondary:hover { background: linear-gradient(145deg, #615342, #403529); }
        
        .password-toggle-group { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px; cursor: pointer; }
        .password-toggle-group label { color: var(--text-secondary); font-weight: 700; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #332a20; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: var(--text-light); transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-gold); }
        input:checked + .slider:before { transform: translateX(22px); background-color: var(--bg-dark); }

        #lobby-password-input { margin-top: 15px; display: none; }
        
        /* Message for empty states */
        .info-message, .info-message-filter {
            text-align: center; color: var(--text-secondary);
            padding: 20px; font-size: 1.1rem; display: none; /* Hidden by default */
        }
    </style>
</head>
<body>

    <div id="background-blurry"></div>
    <audio id="background-music" loop></audio>

    <div id="music-download-overlay">
        <div class="download-panel">
            <h2 class="download-title">ŸÖŸàÿ≥€åŸÇ€å Ÿæÿ≥‚Äåÿ≤ŸÖ€åŸÜŸá</h2>
            <div class="progress-bar-container"><div id="progress-bar"></div></div>
            <p id="progress-text">ÿØÿ± ÿ≠ÿßŸÑ ÿØÿßŸÜŸÑŸàÿØ... 0%</p>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="loader-logo-wrapper">
            <img src="https://up.20script.ir/file/eaae-Copilot-20250812-110015-removebg-preview-1-.png" alt="Loading Logo" class="loader-logo">
        </div>
        <p id="loading-text">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÑÿßÿ®€å‚ÄåŸáÿß...</p>
    </div>

    <div class="main-container">
        <header>
            <button class="back-button" onclick="window.location.href='./main.html'" title="ÿ®ÿßÿ≤⁄Øÿ¥ÿ™"><i class="fa-solid fa-arrow-left"></i></button>
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="ÿ¨ÿ≥ÿ™ÿ¨Ÿà€å ŸÜÿßŸÖ ŸÑÿßÿ®€åÿå ÿ≥ÿßÿ≤ŸÜÿØŸá €åÿß ÿ≥ŸÜÿßÿ±€åŸà...">
                <span class="search-icon"><i class="fa-solid fa-search"></i></span>
            </div>
        </header>

        <div id="lobby-list">
            <!-- ŸÑÿßÿ®€å‚ÄåŸáÿß ÿ®Ÿá ÿµŸàÿ±ÿ™ ÿØÿß€åŸÜÿßŸÖ€å⁄© ÿß€åŸÜÿ¨ÿß ÿßÿ∂ÿßŸÅŸá ŸÖ€å‚Äåÿ¥ŸàŸÜÿØ -->
            <p class="info-message"></p>
            <p class="info-message-filter"></p>
        </div>
    </div>
    
    <button id="create-lobby-fab" title="ÿ≥ÿßÿÆÿ™ ŸÑÿßÿ®€å ÿ¨ÿØ€åÿØ"><i class="fa-solid fa-plus"></i></button>

    <!-- Modal for creating new lobby -->
    <div id="create-lobby-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">ÿ≥ÿßÿÆÿ™ ŸÑÿßÿ®€å ÿ¨ÿØ€åÿØ</h2>
            <div class="modal-input-group">
                <input type="text" id="lobby-name-input" class="modal-input" placeholder="ŸÜÿßŸÖ ŸÑÿßÿ®€å ÿÆŸàÿØ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ" maxlength="30">
                <textarea id="lobby-description-input" class="modal-textarea" placeholder="ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™ ⁄©Ÿàÿ™ÿßŸá (ÿßÿÆÿ™€åÿßÿ±€å)" maxlength="120"></textarea>
                <select id="lobby-scenario-select" class="modal-select">
                    <option value="ŸÖÿπÿßŸÖŸÑŸá‚Äå⁄Øÿ±">ÿ≥ŸÜÿßÿ±€åŸà: ŸÖÿπÿßŸÖŸÑŸá‚Äå⁄Øÿ± (The Negotiator)</option>
                    <option value="⁄©ŸÑÿßÿ≥€å⁄©">ÿ≥ŸÜÿßÿ±€åŸà: ⁄©ŸÑÿßÿ≥€å⁄©</option>
                    <option value="ÿ¥ÿ®‚ÄåŸáÿß€å ŸÖÿßŸÅ€åÿß">ÿ≥ŸÜÿßÿ±€åŸà: ÿ¥ÿ®‚ÄåŸáÿß€å ŸÖÿßŸÅ€åÿß</option>
                    <option value="ÿ≤ŸàÿØ€åÿß⁄©">ÿ≥ŸÜÿßÿ±€åŸà: ÿ≤ŸàÿØ€åÿß⁄©</option>
                    <option value="ÿßÿ±ÿ™ÿ¥ ÿ≥ÿ±€å">ÿ≥ŸÜÿßÿ±€åŸà: ÿßÿ±ÿ™ÿ¥ ÿ≥ÿ±€å</option>
                </select>
                <div class="password-toggle-group">
                    <label for="private-lobby-toggle">ŸÑÿßÿ®€å ÿÆÿµŸàÿµ€å (ÿ®ÿß ÿ±ŸÖÿ≤)</label>
                    <label class="switch">
                        <input type="checkbox" id="private-lobby-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <input type="password" id="lobby-password-input" class="modal-input" placeholder="ÿ±ŸÖÿ≤ ÿπÿ®Ÿàÿ± ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ" maxlength="20">
            </div>
            <div class="modal-buttons">
                <button id="create-lobby-confirm-btn" class="modal-button primary">ÿ≥ÿßÿÆÿ™ŸÜ</button>
                <button id="create-lobby-cancel-btn" class="modal-button secondary">ÿßŸÜÿµÿ±ÿßŸÅ</button>
            </div>
        </div>
    </div>

    <!-- Custom Modal for alerts and confirmations -->
    <div id="custom-alert-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="custom-alert-title" class="modal-title">ÿ™Ÿàÿ¨Ÿá!</h2>
            <div id="custom-alert-message" class="modal-message"></div>
            <div id="custom-alert-buttons" class="modal-buttons"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, where, getDocs, deleteDoc, doc, orderBy, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
            authDomain: "mafia-9fcbf.firebaseapp.com",
            projectId: "mafia-9fcbf",
            storageBucket: "mafia-9fcbf.appspot.com",
            messagingSenderId: "471627157488",
            appId: "1:471627157488:web:92f008548a5596619a5735",
            measurementId: "G-0PDHDWC6NV"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const lobbyList = document.getElementById('lobby-list');
        const createLobbyFab = document.getElementById('create-lobby-fab');
        const searchInput = document.getElementById('search-input');
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const lobbyNameInput = document.getElementById('lobby-name-input');
        const lobbyDescriptionInput = document.getElementById('lobby-description-input');
        const lobbyScenarioSelect = document.getElementById('lobby-scenario-select');
        const privateLobbyToggle = document.getElementById('private-lobby-toggle');
        const lobbyPasswordInput = document.getElementById('lobby-password-input');
        const createLobbyConfirmBtn = document.getElementById('create-lobby-confirm-btn');
        const createLobbyCancelBtn = document.getElementById('create-lobby-cancel-btn');
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertButtons = document.getElementById('custom-alert-buttons');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        const backgroundMusic = document.getElementById('background-music');
        const musicDownloadOverlay = document.getElementById('music-download-overlay');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        let currentUser = null;
        let currentUserIsAdmin = false;
        let allLobbiesData = new Map();
        let isCreatingLobby = false;

        let isMusicPlaying = false;
        const MUSIC_URL = "https://raw.githubusercontent.com/abolfazl140122/mafia/main/mysterious-dark-background-310162%20(1).mp3";
        const MUSIC_CACHE_NAME = 'mafia-lobby-music-cache-v1';
        const MUSIC_VERSION_KEY = 'mafia-lobby-music-version';

        // --- Functions ---
        
        // --- Music Handling ---
        const playMusicAfterUserInteraction = () => {
            if (!isMusicPlaying && backgroundMusic.src && backgroundMusic.paused) {
                backgroundMusic.play()
                    .then(() => {
                        isMusicPlaying = true;
                        document.body.removeEventListener('click', playMusicAfterUserInteraction, true);
                        document.body.removeEventListener('keydown', playMusicAfterUserInteraction, true);
                    })
                    .catch(e => console.error("Error playing music post-interaction.", e));
            } else {
                document.body.removeEventListener('click', playMusicAfterUserInteraction, true);
                document.body.removeEventListener('keydown', playMusicAfterUserInteraction, true);
            }
        };
        function playMusicFromBlob(blob) {
            const objectUrl = URL.createObjectURL(blob);
            backgroundMusic.src = objectUrl;
            backgroundMusic.volume = 0.3;
            const playPromise = backgroundMusic.play();
            if (playPromise !== undefined) {
                playPromise.then(() => { isMusicPlaying = true; })
                .catch(error => {
                    isMusicPlaying = false;
                    document.body.addEventListener('click', playMusicAfterUserInteraction, true);
                    document.body.addEventListener('keydown', playMusicAfterUserInteraction, true);
                });
            }
        }
        function downloadAndCacheMusic() {
            return new Promise((resolve, reject) => {
                musicDownloadOverlay.classList.add('visible');
                const xhr = new XMLHttpRequest();
                xhr.open('GET', MUSIC_URL, true);
                xhr.responseType = 'blob';
                xhr.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const percentComplete = Math.round((event.loaded / event.total) * 100);
                        progressBar.style.width = percentComplete + '%';
                        progressText.textContent = `ÿØÿ± ÿ≠ÿßŸÑ ÿØÿßŸÜŸÑŸàÿØ... ${percentComplete}%`;
                    }
                };
                xhr.onload = async () => {
                    if (xhr.status === 200) {
                        const musicBlob = xhr.response;
                        try {
                            const cache = await caches.open(MUSIC_CACHE_NAME);
                            await cache.put(MUSIC_URL, new Response(musicBlob));
                            localStorage.setItem(MUSIC_VERSION_KEY, MUSIC_URL);
                            musicDownloadOverlay.classList.remove('visible');
                            resolve(musicBlob);
                        } catch (cacheError) { reject(cacheError); }
                    } else { reject(new Error(`Network error: ${xhr.statusText}`)); }
                };
                xhr.onerror = () => { musicDownloadOverlay.classList.remove('visible'); reject(new Error('Network error during download.')); };
                xhr.send();
            });
        }
        async function handleBackgroundMusic() {
            const cachedVersion = localStorage.getItem(MUSIC_VERSION_KEY);
            if (cachedVersion === MUSIC_URL) {
                try {
                    const cache = await caches.open(MUSIC_CACHE_NAME);
                    const cachedResponse = await cache.match(MUSIC_URL);
                    if (cachedResponse) { playMusicFromBlob(await cachedResponse.blob()); } 
                    else { playMusicFromBlob(await downloadAndCacheMusic()); }
                } catch (error) { playMusicFromBlob(await downloadAndCacheMusic()); }
            } else {
                try { playMusicFromBlob(await downloadAndCacheMusic()); } 
                catch (error) { console.error('Music download/play process failed:', error); }
            }
        }
        
        // --- UI & Modal Functions ---
        function showModal(modalElement) { modalElement.classList.add('visible'); }
        function hideModal(modalElement) { modalElement.classList.remove('visible'); }
        function showCustomAlert(title, message, buttons) {
            customAlertTitle.textContent = title;
            customAlertMessage.innerHTML = message;
            customAlertButtons.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `modal-button ${btnInfo.class}`;
                button.onclick = () => {
                    if (!btnInfo.keepOpen) hideModal(customAlertModal);
                    if (btnInfo.action) btnInfo.action();
                };
                customAlertButtons.appendChild(button);
            });
            showModal(customAlertModal);
        }
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        // --- Lobby Data Functions ---
        function promptForPasswordChange(lobbyData) {
            const messageHTML = `<p>ÿ±ŸÖÿ≤ ÿ¨ÿØ€åÿØ ÿ±ÿß ÿ®ÿ±ÿß€å ŸÑÿßÿ®€å "${lobbyData.lobbyName}" Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ:</p><input type="text" id="new-password-input" class="modal-input" style="margin-top: 15px;" placeholder="ÿ±ŸÖÿ≤ ÿ¨ÿØ€åÿØ" value="${lobbyData.password || ''}">`;
            showCustomAlert('ÿ™ÿ∫€å€åÿ± ÿ±ŸÖÿ≤ ŸÑÿßÿ®€å', messageHTML, [
                { text: 'ÿ∞ÿÆ€åÿ±Ÿá', class: 'primary', keepOpen: true, action: () => {
                    const newPassword = document.getElementById('new-password-input').value.trim();
                    if (!newPassword) { 
                        customAlertMessage.innerHTML += '<p style="color:red; margin-top:10px;">ÿ±ŸÖÿ≤ ÿπÿ®Ÿàÿ± ŸÜŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿÆÿßŸÑ€å ÿ®ÿßÿ¥ÿØ.</p>';
                        return;
                    }
                    updateLobbyPassword(lobbyData.id, newPassword);
                }}, { text: 'ÿßŸÜÿµÿ±ÿßŸÅ', class: 'secondary' }
            ]);
        }
        async function updateLobbyPassword(lobbyId, newPassword) {
            try {
                await updateDoc(doc(db, 'Lobbys_list', lobbyId), { password: newPassword });
                hideModal(customAlertModal);
                showCustomAlert('ŸÖŸàŸÅŸÇ€åÿ™', 'ÿ±ŸÖÿ≤ ŸÑÿßÿ®€å ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿ™ÿ∫€å€åÿ± ⁄©ÿ±ÿØ.', [{text: 'ÿπÿßŸÑ€å', class: 'primary'}]);
            } catch (error) { console.error("Error updating password:", error); showCustomAlert('ÿÆÿ∑ÿß', 'ŸÖÿ¥⁄©ŸÑ€å ÿØÿ± ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿ±ŸÖÿ≤ Ÿæ€åÿ¥ ÿ¢ŸÖÿØ.', [{text: 'ÿ®ÿßÿ¥Ÿá', class: 'primary'}]); }
        }
        function promptForLobbyPassword(lobbyData) {
            const messageHTML = `<p>ÿß€åŸÜ ŸÑÿßÿ®€å ÿÆÿµŸàÿµ€å ÿßÿ≥ÿ™. ŸÑÿ∑ŸÅÿß ÿ±ŸÖÿ≤ ÿπÿ®Ÿàÿ± ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ:</p><input type="password" id="join-password-input" class="modal-input" style="margin-top: 15px;" placeholder="ÿ±ŸÖÿ≤ ÿπÿ®Ÿàÿ±">`;
            showCustomAlert('Ÿàÿ±ŸàÿØ ÿ®Ÿá ŸÑÿßÿ®€å ÿÆÿµŸàÿµ€å', messageHTML, [
                { text: 'Ÿæ€åŸàÿ≥ÿ™ŸÜ', class: 'primary', keepOpen: true, action: () => {
                    const enteredPassword = document.getElementById('join-password-input').value;
                    if (enteredPassword === lobbyData.password) {
                        hideModal(customAlertModal);
                        // --- MODIFICATION START ---
                        // Changed redirection based on scenario
                        const redirectUrl = lobbyData.scenario === 'ŸÖÿπÿßŸÖŸÑŸá‚Äå⁄Øÿ±' ? 
                                            `./gamescreen.html?gameId=${lobbyData.id}` : 
                                            `./lobby.html?id=${lobbyData.id}`;
                        window.location.href = redirectUrl;
                        // --- MODIFICATION END ---
                    } else {
                        // Show error without closing the modal
                        hideModal(customAlertModal);
                        setTimeout(() => {
                           showCustomAlert('ÿÆÿ∑ÿß', 'ÿ±ŸÖÿ≤ ÿπÿ®Ÿàÿ± Ÿàÿßÿ±ÿØ ÿ¥ÿØŸá ÿßÿ¥ÿ™ÿ®ÿßŸá ÿßÿ≥ÿ™.', [{text: 'ÿßŸÖÿ™ÿ≠ÿßŸÜ ŸÖÿ¨ÿØÿØ', class: 'primary', action: () => promptForLobbyPassword(lobbyData)}, {text: 'ÿßŸÜÿµÿ±ÿßŸÅ', class: 'secondary'}]);
                        }, 300);
                    }
                }}, { text: 'ÿßŸÜÿµÿ±ÿßŸÅ', class: 'secondary' }
            ]);
        }
        
        // --- Render Functions ---
        function renderLobbyCard(lobbyData, index) {
            const card = document.createElement('div');
            card.className = 'lobby-card';
            card.dataset.id = lobbyData.id;
            card.style.animationDelay = `${index * 0.08}s`;

            const isOwner = currentUser && currentUser.uid === lobbyData.creatorId;
            const canAdminDelete = currentUserIsAdmin && !isOwner;
            const isLobbyFull = (lobbyData.playerCount || 1) >= (lobbyData.maxPlayers || 12);
            const isPrivate = lobbyData.password && lobbyData.password.length > 0;
            const creatorAvatar = lobbyData.creatorAvatarUrl || 'https://up.20script.ir/file/1d50-defult.png';

            let actionButtonsHTML = '';
            if (currentUserIsAdmin) actionButtonsHTML += `<button class="lobby-btn btn-spectate" data-action="spectate">ÿ™ŸÖÿßÿ¥ÿß€å ŸÑÿßÿ®€å</button>`;
            if (isOwner) actionButtonsHTML += `<button class="lobby-btn btn-delete" data-action="delete">ÿ≠ÿ∞ŸÅ ŸÑÿßÿ®€å</button>`;
            else if (canAdminDelete) actionButtonsHTML += `<button class="lobby-btn btn-admin-delete" data-action="admin-delete">ÿ®ÿ≥ÿ™ŸÜ ŸÑÿßÿ®€å</button>`;
            
            actionButtonsHTML += `<button class="lobby-btn btn-join" data-action="join" ${isLobbyFull ? 'disabled' : ''}>${isLobbyFull ? 'ŸÑÿßÿ®€å Ÿæÿ± ÿßÿ≥ÿ™' : 'Ÿæ€åŸàÿ≥ÿ™ŸÜ'}</button>`;
            
            let adminControlsHTML = '';
            if (currentUserIsAdmin && isPrivate) {
                adminControlsHTML = `<div class="admin-password-container" data-action="edit-pass" title="ÿ™ÿ∫€å€åÿ± ÿ±ŸÖÿ≤">
                    <span class="admin-password-text">${lobbyData.password}</span>
                    <span class="admin-edit-icon"><i class="fa-solid fa-pencil"></i></span>
                </div>`;
            }

            const descriptionHTML = lobbyData.description ? `<div class="lobby-card-body"><p class="lobby-description">${lobbyData.description}</p></div>` : '';

            card.innerHTML = `
                <div class="lobby-card-header">
                    <div class="lobby-info">
                        <div class="lobby-name-wrapper">
                            ${isPrivate ? '<span class="lock-icon"><i class="fa-solid fa-lock"></i></span>' : ''}
                            <h3 class="lobby-name">${lobbyData.lobbyName}</h3>
                        </div>
                        <span class="lobby-scenario">${lobbyData.scenario || '⁄©ŸÑÿßÿ≥€å⁄©'}</span>
                    </div>
                    <div class="player-count">
                        <i class="fa-solid fa-users"></i>&nbsp;${lobbyData.playerCount || 1}/${lobbyData.maxPlayers || 12}
                    </div>
                </div>
                ${descriptionHTML}
                <div class="lobby-card-footer">
                    <div class="creator-info">
                        <img src="${creatorAvatar}" alt="ÿ¢Ÿàÿßÿ™ÿßÿ± ÿ≥ÿßÿ≤ŸÜÿØŸá" class="creator-avatar" onerror="this.src='https://up.20script.ir/file/1d50-defult.png';">
                        <div class="creator-details">
                            <span class="lobby-creator">ÿ≥ÿßÿ≤ŸÜÿØŸá: ${lobbyData.creatorName}</span>
                            ${adminControlsHTML}
                        </div>
                    </div>
                    <div class="lobby-actions">${actionButtonsHTML}</div>
                </div>`;
            
            card.querySelector('[data-action="join"]')?.addEventListener('click', () => {
                if ((lobbyData.playerCount || 1) >= (lobbyData.maxPlayers || 12)) { showCustomAlert('ŸÑÿßÿ®€å Ÿæÿ± ÿßÿ≥ÿ™', 'ÿ∏ÿ±ŸÅ€åÿ™ ÿß€åŸÜ ŸÑÿßÿ®€å ÿ™⁄©ŸÖ€åŸÑ ÿ¥ÿØŸá ÿßÿ≥ÿ™.', [{ text: 'ÿ®ÿßÿ¥Ÿá', class: 'primary' }]); return; }
                if (isPrivate) { promptForLobbyPassword(lobbyData); } else {
                    // --- MODIFICATION START ---
                    // Changed redirection based on scenario
                    const redirectUrl = lobbyData.scenario === 'ŸÖÿπÿßŸÖŸÑŸá‚Äå⁄Øÿ±' ? 
                                        `./gamescreen.html?gameId=${lobbyData.id}` : 
                                        `./lobby.html?id=${lobbyData.id}`;
                    window.location.href = redirectUrl;
                    // --- MODIFICATION END ---
                }
            });
            const deleteAction = (title, message) => showCustomAlert(title, message, [{ text: 'ÿ®ŸÑŸáÿå ÿ≠ÿ∞ŸÅ ⁄©ŸÜ', class: 'primary', action: () => deleteLobby(lobbyData.id) }, { text: 'ÿÆ€åÿ±', class: 'secondary' }]);
            card.querySelector('[data-action="delete"]')?.addEventListener('click', () => deleteAction('ÿ™ÿß€å€åÿØ ÿ≠ÿ∞ŸÅ', 'ÿ¢€åÿß ÿßÿ≤ ÿ≠ÿ∞ŸÅ ŸÑÿßÿ®€å ÿÆŸàÿØ ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØÿü'));
            card.querySelector('[data-action="admin-delete"]')?.addEventListener('click', () => deleteAction('ÿ™ÿß€å€åÿØ ÿßÿØŸÖ€åŸÜ', `ÿ¢€åÿß ÿßÿ≤ ÿ®ÿ≥ÿ™ŸÜ ŸÑÿßÿ®€å "${lobbyData.lobbyName}" ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØÿü`));
            card.querySelector('[data-action="edit-pass"]')?.addEventListener('click', () => promptForPasswordChange(lobbyData));
            card.querySelector('[data-action="spectate"]')?.addEventListener('click', () => showCustomAlert('ÿ™ÿß€å€åÿØ ÿ™ŸÖÿßÿ¥ÿß', `ÿ¢€åÿß ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ÿ®Ÿá ÿµŸàÿ±ÿ™ ŸÖÿÆŸÅ€åÿßŸÜŸá ÿ®Ÿá ÿπŸÜŸàÿßŸÜ ÿ™ŸÖÿßÿ¥ÿß⁄Øÿ± Ÿàÿßÿ±ÿØ ŸÑÿßÿ®€å "${lobbyData.lobbyName}" ÿ¥Ÿà€åÿØÿü`, [{ text: 'ÿ®ŸÑŸáÿå ÿ™ŸÖÿßÿ¥ÿß ŸÖ€å‚Äå⁄©ŸÜŸÖ', class: 'primary', action: () => { window.location.href = `./lobby.html?id=${lobbyData.id}&spectate=true`; }}, { text: 'ÿÆ€åÿ±', class: 'secondary' }]));

            return card;
        }
        
        function rerenderAllLobbyCards() {
            const sortedLobbies = Array.from(allLobbiesData.values()).sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());
            
            // Remove old cards
            lobbyList.querySelectorAll('.lobby-card').forEach(card => {
                if (!allLobbiesData.has(card.dataset.id)) {
                    card.classList.add('hidden');
                    card.addEventListener('transitionend', () => card.remove(), { once: true });
                }
            });

            // Add or update cards
            sortedLobbies.forEach((lobbyData, index) => {
                let cardElement = lobbyList.querySelector(`.lobby-card[data-id="${lobbyData.id}"]`);
                if (cardElement) {
                    // Just update content if needed (simple update here)
                    cardElement.querySelector('.player-count').innerHTML = `<i class="fa-solid fa-users"></i>&nbsp;${lobbyData.playerCount || 1}/${lobbyData.maxPlayers || 12}`;
                } else {
                    cardElement = renderLobbyCard(lobbyData, index);
                    lobbyList.prepend(cardElement); // Prepend for new items to appear on top
                }
            });
            
            updateLobbyListState();
            filterLobbies();
        }
        
        // --- Firebase Auth & Data Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await handleBackgroundMusic();
                const userDocRef = doc(db, 'users', user.uid);
                
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const newAdminStatus = docSnap.data()?.isAdmin === true;
                        if (newAdminStatus !== currentUserIsAdmin) {
                            currentUserIsAdmin = newAdminStatus;
                            rerenderAllLobbyCards(); 
                        }
                    }
                });

                const q = query(collection(db, 'Lobbys_list'), orderBy("createdAt", "desc"));

                onSnapshot(q, (snapshot) => {
                    let hasChanges = false;
                    snapshot.docChanges().forEach((change) => {
                        hasChanges = true;
                        const lobbyData = { id: change.doc.id, ...change.doc.data() };
                        if (lobbyData.gameStarted && lobbyData.scenario === 'ŸÖÿπÿßŸÖŸÑŸá‚Äå⁄Øÿ±') { // Special handling for Negotiator
                            if (allLobbiesData.has(lobbyData.id)) allLobbiesData.delete(lobbyData.id);
                            return;
                        }
                        if (change.type === "added" || change.type === "modified") allLobbiesData.set(lobbyData.id, lobbyData);
                        if (change.type === "removed") allLobbiesData.delete(lobbyData.id);
                    });
                    if (hasChanges) rerenderAllLobbyCards();
                    if (loadingOverlay.style.opacity !== '0') {
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => loadingOverlay.style.display = 'none', 500);
                    }
                }, (error) => { console.error("Error fetching lobbies:", error); showCustomAlert('ÿÆÿ∑ÿß€å ÿ¥ÿ®⁄©Ÿá', 'ÿØÿ±€åÿßŸÅÿ™ ŸÑ€åÿ≥ÿ™ ŸÑÿßÿ®€å‚ÄåŸáÿß ÿ®ÿß ŸÖÿ¥⁄©ŸÑ ŸÖŸàÿßÿ¨Ÿá ÿ¥ÿØ.', [{text:'ÿ®ÿßÿ¥Ÿá', class:'primary'}]); });
            } else { window.location.href = './login.html'; }
        });
        
        // --- UI State Management ---
        function updateLobbyListState() {
            const msgElement = lobbyList.querySelector('.info-message');
            if (allLobbiesData.size === 0) {
                msgElement.textContent = 'Ÿá€å⁄Ü ŸÑÿßÿ®€å ŸÅÿπÿßŸÑ€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ. ÿßŸàŸÑ€åŸÜ ŸÑÿßÿ®€å ÿ±ÿß ÿ¥ŸÖÿß ÿ®ÿ≥ÿßÿ≤€åÿØ!';
                msgElement.style.display = 'block';
            } else {
                msgElement.style.display = 'none';
            }
        }
        
        // --- Lobby Creation/Deletion ---
        async function createLobby() {
            if (isCreatingLobby) return;
            const lobbyName = lobbyNameInput.value.trim(); const description = lobbyDescriptionInput.value.trim(); const scenario = lobbyScenarioSelect.value; const isPrivate = privateLobbyToggle.checked; const password = lobbyPasswordInput.value;
            if (!lobbyName) { showCustomAlert('ÿÆÿ∑ÿß', 'ŸÜÿßŸÖ ŸÑÿßÿ®€å ŸÜŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿÆÿßŸÑ€å ÿ®ÿßÿ¥ÿØ.', [{ text: 'ÿ®ÿßÿ¥Ÿá', class: 'primary' }]); return; }
            if (isPrivate && !password) { showCustomAlert('ÿÆÿ∑ÿß', 'ÿ®ÿ±ÿß€å ŸÑÿßÿ®€å ÿÆÿµŸàÿµ€å ÿ®ÿß€åÿØ ÿ±ŸÖÿ≤ ÿπÿ®Ÿàÿ± ÿ™ÿπ€å€åŸÜ ⁄©ŸÜ€åÿØ.', [{ text: 'ÿ®ÿßÿ¥Ÿá', class: 'primary' }]); return; }
            if (!currentUser) return;
            
            isCreatingLobby = true; createLobbyConfirmBtn.disabled = true; createLobbyConfirmBtn.textContent = 'ÿØÿ± ÿ≠ÿßŸÑ ÿ≥ÿßÿÆÿ™...';
            
            try {
                const q = query(collection(db, 'Lobbys_list'), where("creatorId", "==", currentUser.uid)); const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    hideModal(createLobbyModal);
                    showCustomAlert('ÿÆÿ∑ÿß', 'ÿ¥ŸÖÿß ŸÇÿ®ŸÑÿßŸã €å⁄© ŸÑÿßÿ®€å ÿß€åÿ¨ÿßÿØ ⁄©ÿ±ÿØŸá‚Äåÿß€åÿØ. ÿ®ÿ±ÿß€å ÿ≥ÿßÿÆÿ™ ŸÑÿßÿ®€å ÿ¨ÿØ€åÿØÿå ÿßÿ®ÿ™ÿØÿß ŸÑÿßÿ®€å ŸÇÿ®ŸÑ€å ÿÆŸàÿØ ÿ±ÿß ÿ≠ÿ∞ŸÅ ⁄©ŸÜ€åÿØ.', [{ text: 'ÿ®ÿßÿ¥Ÿá', class: 'primary' }]);
                    return; 
                }
                const userDocSnap = await getDoc(doc(db, 'users', currentUser.uid)); let creatorAvatarUrl = userDocSnap.exists() ? userDocSnap.data().avatarUrl : null;
                const lobbyData = { lobbyName, description, scenario, creatorId: currentUser.uid, creatorName: currentUser.displayName || '⁄©ÿßÿ±ÿ®ÿ± ŸÜÿßÿ¥ŸÜÿßÿ≥', creatorAvatarUrl, createdAt: serverTimestamp(), playerCount: 1, maxPlayers: 12, gameStarted: false };
                if (isPrivate) lobbyData.password = password;
                
                const docRef = await addDoc(collection(db, 'Lobbys_list'), lobbyData);
                hideModal(createLobbyModal); lobbyNameInput.value = ''; lobbyDescriptionInput.value = ''; lobbyPasswordInput.value = ''; privateLobbyToggle.checked = false; lobbyPasswordInput.style.display = 'none';
                
                // --- MODIFICATION START ---
                // Redirection based on the selected scenario
                if (scenario === 'ŸÖÿπÿßŸÖŸÑŸá‚Äå⁄Øÿ±') {
                    // For Negotiator, create the initial game document directly and redirect to game screen
                    const initialPlayers = [{ 
                        uid: currentUser.uid, 
                        displayName: currentUser.displayName || '⁄©ÿßÿ±ÿ®ÿ± ŸÜÿßÿ¥ŸÜÿßÿ≥', 
                        avatarUrl: creatorAvatarUrl, 
                        score: 0, 
                        currentChoice: null, 
                        hasChosen: false, 
                        isBot: false,
                        isOnline: true,
                        currentPartnerUid: null
                    }];
                    const gameDocRef = await addDoc(collection(db, 'games'), {
                        lobbyId: docRef.id,
                        creatorId: currentUser.uid,
                        players: initialPlayers,
                        round: 0, // Start at 0, next phase will make it 1
                        phase: 'loading', // Initial phase for gamescreen to set up
                        timerEndsAt: null, 
                        pairs: [],
                        roundResults: [],
                        announcements: ["ÿØÿ± ÿ≠ÿßŸÑ ÿ¢ŸÖÿßÿØŸá‚Äåÿ≥ÿßÿ≤€å ÿ®ÿßÿ≤€å...", "ŸÑÿ∑ŸÅÿß ÿµÿ®ÿ± ⁄©ŸÜ€åÿØ..."],
                        status: 'active',
                        createdAt: serverTimestamp()
                    });
                    // Update the lobby to point to the new game document
                    await updateDoc(docRef, { gameStarted: true, gameId: gameDocRef.id });
                    window.location.href = `./gamescreen.html?gameId=${gameDocRef.id}`;
                } else {
                    // For other scenarios (Mafia, etc.), redirect to the lobby waiting room
                    window.location.href = `./lobby.html?id=${docRef.id}`;
                }
                // --- MODIFICATION END ---

            } catch (error) { console.error("Error creating lobby:", error); showCustomAlert('ÿÆÿ∑ÿß€å ÿ≥ÿ±Ÿàÿ±', 'ŸÖÿ¥⁄©ŸÑ€å ÿØÿ± ÿ≥ÿßÿÆÿ™ ŸÑÿßÿ®€å Ÿæ€åÿ¥ ÿ¢ŸÖÿØ.', [{ text: 'ÿ®ÿßÿ¥Ÿá', class: 'primary' }]);
            } finally { isCreatingLobby = false; createLobbyConfirmBtn.disabled = false; createLobbyConfirmBtn.textContent = 'ÿ≥ÿßÿÆÿ™ŸÜ'; }
        }
        async function deleteLobby(lobbyId) {
            try { await deleteDoc(doc(db, "Lobbys_list", lobbyId)); } 
            catch (error) { showCustomAlert('ÿÆÿ∑ÿß€å ÿ≥ÿ±Ÿàÿ±', 'ŸÖÿ¥⁄©ŸÑ€å ÿØÿ± ÿ≠ÿ∞ŸÅ ŸÑÿßÿ®€å Ÿæ€åÿ¥ ÿ¢ŸÖÿØ.', [{ text: 'ÿ®ÿßÿ¥Ÿá', class: 'primary' }]); }
        }

        // --- IMPROVED Animated filterLobbies ---
        function filterLobbies() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const cards = lobbyList.querySelectorAll('.lobby-card');
            let visibleCount = 0;

            cards.forEach(card => {
                const lobbyName = card.querySelector('.lobby-name')?.textContent.toLowerCase() || '';
                const creatorName = card.querySelector('.lobby-creator')?.textContent.toLowerCase() || '';
                const scenario = card.querySelector('.lobby-scenario')?.textContent.toLowerCase() || '';
                const isVisible = lobbyName.includes(searchTerm) || creatorName.includes(searchTerm) || scenario.includes(searchTerm);
                
                if (isVisible) {
                    card.classList.remove('hidden');
                    visibleCount++;
                } else {
                    card.classList.add('hidden');
                }
            });

            const msgElement = lobbyList.querySelector('.info-message-filter');
            if (visibleCount === 0 && allLobbiesData.size > 0 && searchTerm) {
                msgElement.textContent = 'Ÿá€å⁄Ü ŸÑÿßÿ®€å ÿ®ÿß ÿß€åŸÜ ŸÖÿ¥ÿÆÿµÿßÿ™ €åÿßŸÅÿ™ ŸÜÿ¥ÿØ.';
                msgElement.style.display = 'block';
            } else {
                 msgElement.style.display = 'none';
            }
        }

        // --- Event Listeners ---
        createLobbyFab.addEventListener('click', () => showModal(createLobbyModal));
        createLobbyCancelBtn.addEventListener('click', () => { hideModal(createLobbyModal); lobbyPasswordInput.style.display = 'none'; privateLobbyToggle.checked = false; });
        createLobbyConfirmBtn.addEventListener('click', createLobby);
        searchInput.addEventListener('input', debounce(filterLobbies, 250));
        privateLobbyToggle.addEventListener('change', () => { lobbyPasswordInput.style.display = privateLobbyToggle.checked ? 'block' : 'none'; });
        [createLobbyModal, customAlertModal].forEach(modal => { modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(modal); }); });
    </script>
</body>
</html>
