<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>بازی معامله‌گر - اجرا (با پشتیبانی از ربات)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
<style>
/* --- (همان استایل تمی که قبلاً داشتی؛ فقط کمی برای نشان دادن "ربات" بَج اضافه کردم) --- */
:root{--primary-gold:#ffc947;--text-light:#f0e6d2;--bg-surface:#1e1e1e;--border-color:#4a4a4a;--green-coop:#2ecc71;--red-betray:#e74c3c}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'Vazirmatn',sans-serif;background-color:#121212;color:var(--text-light);direction:rtl}
.game-wrapper{max-width:1200px;margin:12px auto;display:grid;grid-template-columns:280px 1fr;grid-template-rows:60px 1fr;grid-template-areas:"header header" "sidebar main";gap:12px}
.game-header{grid-area:header;background:var(--bg-surface);padding:12px;border-radius:12px;border:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
.players-sidebar{grid-area:sidebar;background:var(--bg-surface);border-radius:12px;padding:8px;border:1px solid var(--border-color);display:flex;flex-direction:column}
.sidebar-title{font-weight:900;color:var(--primary-gold);text-align:center;margin-bottom:8px}
#players-list{overflow:auto;display:flex;flex-direction:column;gap:6px}
.player-score-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:rgba(0,0,0,0.12)}
.player-info{display:flex;align-items:center;gap:10px}
.player-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #c5a687}
.player-name{font-weight:700}
.player-score{font-weight:900;color:var(--primary-gold)}
.bot-badge{font-size:12px;background:#2d2d2d;padding:3px 6px;border-radius:10px;border:1px solid #6b6b6b;margin-right:8px}
.main-content{grid-area:main;background:var(--bg-surface);border-radius:12px;padding:8px;border:1px solid var(--border-color);display:flex;flex-direction:column;height:70vh;overflow:hidden}
#chat-messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
.chat-message{background:#2a2a2a;padding:10px;border-radius:10px;max-width:70%}
.chat-message.self{align-self:flex-end;background:#203a20}
.overlay-panel{position:absolute;inset:0;background:rgba(0,0,0,0.85);display:flex;justify-content:center;align-items:center;z-index:20;visibility:hidden;opacity:0;transition:all .2s}
.overlay-panel.visible{visibility:visible;opacity:1}
.choice-btn{padding:12px 28px;border-radius:12px;border:none;font-weight:900;cursor:pointer;margin:0 8px}
#cooperate-btn{background:var(--green-coop);color:#fff}
#betray-btn{background:var(--red-betray);color:#fff}
.player-score-item.is-self{border-left:4px solid var(--primary-gold);background:linear-gradient(90deg,rgba(255,201,71,0.03),transparent)}
.header-controls{display:flex;gap:8px;align-items:center}
.timer{font-weight:900}
small.note{display:block;color:#bdbdbd;font-size:12px;margin-top:6px;text-align:center}
</style>
</head>
<body>

<div class="game-wrapper">
  <header class="game-header">
    <h2 id="game-round-info">در انتظار</h2>
    <div class="header-controls">
      <div class="timer" id="game-timer">00:00</div>
    </div>
  </header>

  <aside class="players-sidebar">
    <div class="sidebar-title">امتیازات</div>
    <div id="players-list"></div>
    <small class="note">فقط بازیکنان لابی فعلی نمایش داده می‌شوند. ربات‌ها با برچسب «ربات» مشخص‌اند.</small>
  </aside>

  <main class="main-content" id="main-content">
    <div id="pairing-panel" class="overlay-panel">
      <div style="text-align:center;color:var(--primary-gold)">
        <h2>هم‌پیمان شما</h2>
        <div style="display:flex;gap:12px;align-items:center;justify-content:center;margin-top:12px">
          <img id="my-avatar-pairing" src="" style="width:90px;height:90px;border-radius:50%;border:3px solid var(--primary-gold)">
          <div style="font-size:2rem">+</div>
          <img id="partner-avatar-pairing" src="" style="width:90px;height:90px;border-radius:50%;border:3px solid var(--primary-gold)">
        </div>
        <div id="partner-name-display" style="margin-top:12px;font-weight:900"></div>
      </div>
    </div>

    <div id="choice-panel" class="overlay-panel">
      <div style="text-align:center;color:var(--primary-gold)">
        <h2>انتخاب کنید</h2>
        <p>آیا همکاری یا خیانت؟</p>
        <div style="margin-top:12px">
          <button id="cooperate-btn" class="choice-btn">همکاری</button>
          <button id="betray-btn" class="choice-btn">خیانت</button>
        </div>
      </div>
    </div>

    <div id="chat-messages"></div>
    <form id="chat-form" style="display:flex;gap:8px;padding:8px;border-top:1px solid rgba(255,255,255,0.05)">
      <input id="chat-input" placeholder="پیام..." style="flex:1;padding:10px;border-radius:12px;border:1px solid #333;background:#111;color:var(--text-light)">
      <button id="chat-send-btn" type="submit" style="padding:8px 12px;border-radius:8px;background:var(--primary-gold);border:none;font-weight:900">ارسال</button>
    </form>
  </main>
</div>

<!-- Firebase SDK (همان نسخهٔ قبلی) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getFirestore, doc, onSnapshot, updateDoc, setDoc, getDoc, collection, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

/* === پیکربندی Firebase (همان که داشتی) === */
const firebaseConfig = {
  apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
  authDomain: "mafia-9fcbf.firebaseapp.com",
  databaseURL: "https://mafia-9fcbf-default-rtdb.firebaseio.com",
  projectId: "mafia-9fcbf",
  storageBucket: "mafia-9fcbf.firebasestorage.app",
  messagingSenderId: "471627157488",
  appId: "1:471627157488:web:92f008548a5596619a5735",
  measurementId: "G-0PDHDWC6NV"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* === المان‌ها === */
const playersListEl = document.getElementById('players-list');
const chatMessagesEl = document.getElementById('chat-messages');
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');
const gameTimerEl = document.getElementById('game-timer');
const roundInfoEl = document.getElementById('game-round-info');
const pairingPanel = document.getElementById('pairing-panel');
const choicePanel = document.getElementById('choice-panel');
const cooperateBtn = document.getElementById('cooperate-btn');
const betrayBtn = document.getElementById('betray-btn');
const myAvatarPairing = document.getElementById('my-avatar-pairing');
const partnerAvatarPairing = document.getElementById('partner-avatar-pairing');
const partnerNameDisplay = document.getElementById('partner-name-display');

/* === متغیرهای حالت === */
let currentUser = null;
let currentGameState = null;
let gameId = getQueryParam('gameId') || 'active_game_01';
let lobbyId = getQueryParam('lobbyId') || 'lobby_01'; // سعی می‌کنیم lobbyId از URL بگیریم؛ در غیر این صورت از fallback استفاده می‌کنیم
let gameRef = doc(db, 'games', gameId);
let unsubscribeGame = null;
let timerInterval = null;

/* === helper: خواندن param های URL === */
function getQueryParam(name){
  const url = new URL(location.href);
  return url.searchParams.get(name);
}

/* === شروع: مانیتور auth و بارگذاری بازی === */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    // در محیط واقعی، کاربر باید لاگین کند. برای تست محلی می‌توان لاگین مهمان اضافه کرد.
    alert('لطفاً وارد حساب کاربری خود شوید تا بازی شروع شود.');
    return;
  }
  // خواندن داکیومنت users برای اطلاعات بیشتر
  currentUser = { uid: user.uid };
  const udoc = await getDoc(doc(db, 'users', user.uid));
  if (udoc.exists()) {
    Object.assign(currentUser, udoc.data());
  }
  initGame();
});

/* === initGame: ثبت شنونده و ساخت بازی در صورت نیاز === */
async function initGame(){
  // اگر داک بازی وجود ندارد -> بسازیم (با استفاده از شرکت‌کنندگان لابی)
  const gSnap = await getDoc(gameRef);
  if (!gSnap.exists()) {
    await createGameFromLobby();
  }
  // شنونده تغییرات بازی
  unsubscribeGame = onSnapshot(gameRef, snap => {
    const state = snap.data();
    if (!state) return;
    currentGameState = state;
    renderUI(state);
    handlePhases(state);
  });
}

/* === ایجاد بازی با استفاده از داک لابی === */
async function createGameFromLobby(){
  // سعی می‌کنیم لیست بازیکنان را از /Lobbys_list/{lobbyId}.players بخوانیم
  try {
    const lobbyRef = doc(db, 'Lobbys_list', lobbyId);
    const lobbySnap = await getDoc(lobbyRef);
    let participants = [];
    if (lobbySnap.exists() && Array.isArray(lobbySnap.data().players)) {
      // فرض می‌کنیم ساختار: { players: [{ uid, displayName, avatarUrl, isBot }] }
      participants = lobbySnap.data().players.map(p => ({
        uid: p.uid || `guest_${Math.random().toString(36).slice(2,8)}`,
        displayName: p.displayName || (p.isBot ? 'ربات' : 'بدون نام'),
        avatarUrl: p.avatarUrl || (p.isBot ? 'https://cdn.iconscout.com/icon/free/png-256/robot-251-675771.png' : `https://i.pravatar.cc/150?u=${p.uid}`),
        score: 0,
        isBot: !!p.isBot
      }));
    } else {
      // fallback (برای دمو): اگر لابی مشخص نبود یا players نداشت، تعدادی نمونه می‌سازیم
      const usersSnapshot = await getDocs(collection(db, 'users'));
      const allUsers = [];
      usersSnapshot.forEach(d => allUsers.push({ uid: d.id, displayName: d.data().displayName || d.id, avatarUrl: d.data().avatarUrl }));
      // انتخاب تصادفی 4-6 بازیکن؛ یکی‌شان currentUser را تضمین کن
      while (participants.length < Math.min(6, allUsers.length || 4)) {
        const u = allUsers[Math.floor(Math.random()*allUsers.length)];
        if (!participants.find(x=>x.uid===u.uid)) participants.push({ uid:u.uid, displayName:u.displayName, avatarUrl:u.avatarUrl, score:0, isBot:false });
      }
      // اضافه کردن یک یا دو ربات برای دمو
      participants.push({ uid:`bot_${Date.now()%10000}`, displayName:'ربات', avatarUrl:'https://cdn.iconscout.com/icon/free/png-256/robot-251-675771.png', score:0, isBot:true });
    }

    // مطمئن شو currentUser در لیست هست
    if (!participants.find(p=>p.uid===currentUser.uid)) {
      participants.push({
        uid: currentUser.uid,
        displayName: currentUser.displayName || 'شما',
        avatarUrl: currentUser.avatarUrl || `https://i.pravatar.cc/150?u=${currentUser.uid}`,
        score: 0,
        isBot: false
      });
    }

    // حالت اولیه بازی
    const initState = {
      round: 1,
      phase: 'initial',
      players: participants,
      pairs: [],
      choices: {},
      chat: []
    };
    await setDoc(gameRef, initState);
    await addAnnouncement("راوی: بازی ساخته شد — آماده‌اید؟");
    setTimeout(() => startGame(), 1500);
  } catch(err){
    console.error('createGameFromLobby error', err);
    await setDoc(gameRef, {
      round:1,phase:'initial',players:[{uid:currentUser.uid,displayName:currentUser.displayName||'شما',avatarUrl:currentUser.avatarUrl||`https://i.pravatar.cc/150?u=${currentUser.uid}`,score:0,isBot:false}],pairs:[],choices:{},chat:[]
    });
  }
}

/* === رندر UI: فقط players از state (نه کل users collection) === */
function renderUI(state){
  // لیست بازیکنان (فقط آنهایی که در state.players هستند)
  playersListEl.innerHTML = '';
  const sorted = [...(state.players||[])].sort((a,b)=> (b.score||0)-(a.score||0));
  sorted.forEach(p=>{
    const item = document.createElement('div');
    item.className = 'player-score-item ' + (p.uid===currentUser.uid ? 'is-self' : '');
    const nameHtml = document.createElement('div');
    nameHtml.className = 'player-info';
    const img = document.createElement('img'); img.className='player-avatar';
    img.src = p.avatarUrl || `https://i.pravatar.cc/150?u=${p.uid}`;
    const span = document.createElement('span'); span.className='player-name';
    // اگر isBot باشد، اسم را "ربات" نمایش بده و بَج اضافه کن
    if (p.isBot) {
      span.textContent = p.displayName || 'ربات';
      const botBadge = document.createElement('span'); botBadge.className='bot-badge'; botBadge.textContent='ربات';
      nameHtml.appendChild(img); nameHtml.appendChild(span); nameHtml.appendChild(botBadge);
    } else {
      span.textContent = p.displayName || 'بدون نام';
      nameHtml.appendChild(img); nameHtml.appendChild(span);
    }
    const scoreSpan = document.createElement('span'); scoreSpan.className='player-score'; scoreSpan.textContent = p.score || 0;
    item.appendChild(nameHtml); item.appendChild(scoreSpan);
    playersListEl.appendChild(item);
  });

  // chat
  chatMessagesEl.innerHTML = '';
  (state.chat||[]).forEach(m=> appendChatMessage(m));
}

/* === مدیریت فازها و پنل‌ها === */
function handlePhases(state){
  // hide overlays by default
  pairingPanel.classList.remove('visible');
  choicePanel.classList.remove('visible');
  chatInput.disabled = true;

  const phase = state.phase;
  roundInfoEl.textContent = `دور ${state.round} - ${phase.replace('_',' ')}`;

  if (phase === 'pairing') {
    // اگر کاربر پِر شده در جفتی هست، نمایش هم‌پیمانی
    const myPair = state.pairs.find(pair => pair.includes(currentUser.uid));
    if (myPair) {
      showPairing(state, myPair);
    }
    // برای ربات‌ها: آماده‌سازی تصمیم‌گیری بعدی به محض ورود فاز choice
  } else if (phase === 'choice') {
    // اگر هنوز انتخاب نکرده‌ایم و این کاربر واقعی است -> نمایش پنل انتخاب
    if (!state.choices || !state.choices[currentUser.uid]) {
      const myPair = state.pairs.find(pair => pair.includes(currentUser.uid));
      if (myPair) {
        // اگر خود ما ربات باشیم، صبر نکن — اجازه می‌دهیم game-manager تصمیم ربات را ثبت کند
        const me = state.players.find(p=>p.uid===currentUser.uid);
        if (!me.isBot) showChoicePanel();
      }
    }
    // تصمیم‌گیری ربات‌ها را از طرف یک مدیر (game-manager) اجرا کن
    triggerBotsDecisionsIfManager();
  } else if (phase === 'private_chat') {
    chatInput.disabled = false;
    chatInput.placeholder = "با هم‌پیمان خود چت کنید...";
  } else if (phase === 'public_chat') {
    chatInput.disabled = false;
    chatInput.placeholder = "با همه صحبت کنید...";
  } else if (phase === 'results') {
    chatInput.disabled = true;
    // نتایج محاسبه شود (در این نسخه ساده‌سازی شده)
  }
}

/* === نمایش پنل همپیمان === */
function showPairing(state, pair){
  const me = state.players.find(p=>p.uid===currentUser.uid);
  const partnerId = pair.find(id=>id!==currentUser.uid);
  const partner = state.players.find(p=>p.uid===partnerId);
  if (!partner) return;
  myAvatarPairing.src = me.avatarUrl || `https://i.pravatar.cc/150?u=${me.uid}`;
  partnerAvatarPairing.src = partner.avatarUrl || `https://i.pravatar.cc/150?u=${partner.uid}`;
  partnerNameDisplay.textContent = partner.isBot ? `هم‌پیمان شما: ربات` : `هم‌پیمان شما: ${partner.displayName}`;
  pairingPanel.classList.add('visible');
  setTimeout(()=> pairingPanel.classList.remove('visible'), 2500);
}

/* === نمایش پنل انتخاب (برای بازیکن واقعی) === */
function showChoicePanel(){
  choicePanel.classList.add('visible');
}

/* === ثبت انتخاب بازیکن واقعی === */
async function handlePlayerChoice(choice){
  // جلوگیری از دوبار کلیک
  cooperateBtn.disabled = true; betrayBtn.disabled = true;
  choicePanel.classList.remove('visible');
  await addAnnouncement(`شما: ${choice === 'cooperate' ? 'همکاری' : 'خیانت'}`);
  const choices = {...(currentGameState.choices||{})};
  choices[currentUser.uid] = choice;
  await updateDoc(gameRef, { choices });
  checkAllChoicesComplete();
}

/* === بررسی کامل شدن انتخاب‌ها === */
async function checkAllChoicesComplete(){
  // تعداد بازیکنانِ درگیر در زوج‌ها
  const pairedUids = (currentGameState.pairs || []).flat();
  const totalPaired = pairedUids.length;
  const totalChoices = Object.keys(currentGameState.choices || {}).length;
  if (totalChoices >= totalPaired) {
    await addAnnouncement('راوی: همه تصمیم‌ها ثبت شد.');
    // انتقال به چت عمومی...
    setTimeout(()=> updateDoc(gameRef,{phase:'public_chat'}), 1200);
  }
}

/* === افزودن پیام اعلان در چت بازی === */
async function addAnnouncement(text){
  const newMsg = { announcement:true, text, timestamp: new Date() };
  const chat = [...(currentGameState.chat||[]), newMsg];
  await updateDoc(gameRef, { chat });
}

/* === append chat message to UI === */
function appendChatMessage(m){
  if (m.announcement) {
    const el = document.createElement('div'); el.className='chat-message'; el.style.alignSelf='center'; el.style.background='linear-gradient(90deg,#333,#222)'; el.textContent = m.text;
    chatMessagesEl.appendChild(el); chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight; return;
  }
  // private filtering
  if (m.isPrivate) {
    // اگر پیام خصوصی برای من نیست نمایش نده
    const pair = currentGameState.pairs.find(p=>p.includes(currentUser.uid));
    if (!pair || !pair.includes(m.senderUid)) return;
  }
  const el = document.createElement('div'); el.className='chat-message ' + (m.senderUid === currentUser.uid ? 'self' : '');
  el.innerHTML = `<strong style="display:block;margin-bottom:6px">${m.senderName || (m.senderUid==='system'?'سیستم':'کاربر')}</strong><div>${m.text}</div>`;
  chatMessagesEl.appendChild(el);
  chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
}

/* === ارسال پیام چت (عمومی یا خصوصی بسته به فاز) === */
chatForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const txt = chatInput.value.trim();
  if (!txt) return;
  const isPrivate = currentGameState.phase === 'private_chat';
  const msg = {
    senderUid: currentUser.uid,
    senderName: currentUser.displayName || 'شما',
    senderAvatar: currentUser.avatarUrl || '',
    text: txt,
    isPrivate,
    timestamp: new Date()
  };
  const chat = [...(currentGameState.chat || []), msg];
  await updateDoc(gameRef, { chat });
  chatInput.value = '';
});

/* === روال شروع بازی: pair کردن بازیکنان === */
async function startGame(){
  await addAnnouncement('راوی: گروه‌بندی در حال انجام است...');
  let playersToPair = [...(currentGameState.players || [])];
  playersToPair = playersToPair.sort(()=>Math.random()-0.5);
  const pairs = [];
  while(playersToPair.length > 1){
    const a = playersToPair.pop().uid;
    const b = playersToPair.pop().uid;
    pairs.push([a,b]);
  }
  // اگر یک نفر اضافه مانده، او را با یک ربات مجازی جفت می‌کنیم (یا می‌ماند)
  await updateDoc(gameRef, { phase:'pairing', pairs, choices: {} });
  setTimeout(()=> updateDoc(gameRef,{phase:'choice'}), 3500);
}

/* === تصمیم‌گیری خودکار ربات‌ها (اجرای تنها توسط یک مدیر) === */
function isGameManager(){
  // تعیین مدیر بازی: اولین بازیکن در آرایه players (یا ادمین)
  const managerUid = (currentGameState.players && currentGameState.players[0] && currentGameState.players[0].uid) || null;
  return currentUser && currentUser.uid === managerUid;
}

/* === تصمیم‌گیری برای یک ربات: الگوریتم ساده که قابل تعویض است === */
function decideForBot(botPlayer, partnerPlayer){
  // مثال: اگر partner یک ربات باشد، احتمال همکاری کمی بالاتر یا پایین‌تر باشد
  // این تابع می‌تواند با مدل ML یا rule-based پیچیده‌تر شود.
  // به عنوان نمونه: وزن‌دهی ساده
  const baseCoopProb = 0.55; // احتمال پایه همکاری
  let prob = baseCoopProb;
  // اگر شریک واقعی باشد، ربات کمی محتاط‌تر می‌شود
  if (!partnerPlayer.isBot) prob -= 0.05;
  // اگر خود ربات سابقه همکاری بالایی داشته باشد (score)، تشویق به همکاری
  if ((botPlayer.score||0) > 5) prob += 0.05;
  // اختصاص مقدار تصادفی برای تصمیم
  return Math.random() < prob ? 'cooperate' : 'betray';
}

/* === اجرای تصمیم‌گیری ربات‌ها از طرف مدیر بازی === */
async function triggerBotsDecisionsIfManager(){
  if (!isGameManager()) return;
  // تصمیم‌گیری را تنها یکبار اجرا کن: بررسی کن چند ربات هنوز انتخاب نکرده‌اند
  const pairs = currentGameState.pairs || [];
  const choices = {...(currentGameState.choices || {})};
  for (const pair of pairs){
    const [a,b] = pair;
    const pA = currentGameState.players.find(p=>p.uid===a);
    const pB = currentGameState.players.find(p=>p.uid===b);
    // اگر a ربات و هنوز انتخاب نکرده
    if (pA && pA.isBot && !choices[pA.uid]) {
      // تصمیم‌گیری با یک تاخیر تصادفی کوتاه برای طبیعی‌بودن
      setTimeout(async ()=>{
        // دوباره تازه‌سازی choices قبل از نوشتن برای جلوگیری از overwrites
        const snap = await getDoc(gameRef);
        const latestChoices = {...(snap.data().choices || {})};
        if (!latestChoices[pA.uid]) {
          const c = decideForBot(pA, pB);
          latestChoices[pA.uid] = c;
          await updateDoc(gameRef, { choices: latestChoices });
        }
        checkAllChoicesComplete();
      }, 1000 + Math.floor(Math.random()*4000));
    }
    if (pB && pB.isBot && !choices[pB.uid]) {
      setTimeout(async ()=>{
        const snap = await getDoc(gameRef);
        const latestChoices = {...(snap.data().choices || {})};
        if (!latestChoices[pB.uid]) {
          const c = decideForBot(pB, pA);
          latestChoices[pB.uid] = c;
          await updateDoc(gameRef, { choices: latestChoices });
        }
        checkAllChoicesComplete();
      }, 1200 + Math.floor(Math.random()*4500));
    }
  }
}

/* === وقتی همه انتخاب‌ها ثبت شد، به فاز چت عمومی می‌رویم (مثال) === */
async function finalizeChoicesAndContinue(){
  // این تابع می‌تواند منطق امتیازدهی را هم اجرا کند.
}

/* === کمکی: افزودن پیام عمومی === */
async function addAnnouncementToChat(text){
  const chat = [...(currentGameState.chat||[]), { announcement:true, text, timestamp:new Date() }];
  await updateDoc(gameRef, { chat });
}

/* === کمک به بررسی تکمیل انتخاب‌ها (بار دیگر در هر update) === */
async function checkAllChoicesComplete(){
  const snap = await getDoc(gameRef);
  const state = snap.data();
  const paired = (state.pairs || []).flat();
  const totalChoices = Object.keys(state.choices || {}).length;
  if (totalChoices >= paired.length) {
    await updateDoc(gameRef, { phase: 'public_chat' });
    await addAnnouncement('راوی: همه تصمیم‌ها ثبت شد. وارد چت عمومی می‌شویم.');
  }
}

/* === listener: وقتی state.chat تغییر کند، UI را آپدیت کن === */
/* اینکار از طریق onSnapshot اصلی انجام می‌شود (renderUI) */

/* === event listeners === */
cooperateBtn.addEventListener('click', ()=> handlePlayerChoice('cooperate'));
betrayBtn.addEventListener('click', ()=> handlePlayerChoice('betray'));

/* === تمیزکاری موقع ترک صفحه === */
window.addEventListener('beforeunload', ()=>{
  if (unsubscribeGame) unsubscribeGame();
});

/* === پایان فایل === */

</script>
</body>
</html>
