<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ù…ÛŒØ¯Ø§Ù† Ø¨Ø§Ø²ÛŒ - Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* === Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø±Ù†Ú¯ÛŒ === */
        :root {
            --primary-gold: #ffc947;
            --dark-red: #8c4843;
            --darker-red: #5a2c2a;
            --text-light: #f0e6d2;
            --text-secondary: #c5a687;
            --bg-dark: #1a140e;
            --border-color: #5c4a3a;
            --cooperate-green: #28a745;
            --betray-red: #dc3545;
            --glow-color: rgba(255, 201, 71, 0.7);
        }

        /* === Ø±ÛŒØ³Øª Ùˆ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒ === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100%; 
            width: 100%;
            overflow: hidden; 
        }

        body { 
            font-family: 'Vazirmatn', sans-serif; 
            color: var(--text-light); 
            background-color: var(--bg-dark);
            background-image: url('https://up.20script.ir/file/d1c7-InShot-Û²Û°Û²ÛµÛ°Û¹Û±Û±-Û±Û²Û²ÛµÛ²Û°Û·Û¶Û°.jpg');
            background-size: cover;
            background-position: center center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* === Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù¾ÙˆØ´Ø§Ù†Ù†Ø¯Ù‡ (Overlay) === */
        #background-blurry { position: fixed; top: -20px; left: -20px; width: calc(100% + 40px); height: calc(100% + 40px); background: inherit; filter: blur(10px) brightness(0.5); z-index: -1; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; transition: opacity 0.5s ease; }
        .loader { border: 6px solid #f3f3f330; border-top: 6px solid var(--primary-gold); border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-text { margin-top: 20px; font-size: 1.1rem; font-weight: 700; }
        
        /* [Ø¬Ø¯ÛŒØ¯] Ø§ÙÚ©Øª Ú¯Ø°Ø§Ø± Ø¨ÛŒÙ† ÙØ§Ø²Ù‡Ø§ */
        #phase-transition-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--primary-gold); z-index: 3000;
            opacity: 0; pointer-events: none;
        }
        #phase-transition-overlay.active {
            animation: phase-flash 0.8s ease-in-out;
        }
        @keyframes phase-flash { 0% { opacity: 0; } 50% { opacity: 0.7; } 100% { opacity: 0; } }

        /* === Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ === */
        .game-container {
            width: 100%; height: 100%; max-width: 1400px;
            display: grid; grid-template-columns: 280px 1fr 280px;
            grid-template-rows: 80px 1fr; grid-template-areas: "header header header" "scoreboard main history";
            gap: 15px; padding: 15px; opacity: 0; transition: opacity 0.5s ease-in-out;
        }
        
        @media (max-width: 900px) {
            .game-container { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; grid-template-areas: "header" "scoreboard" "main"; padding: 10px; }
            #history-panel { display: none; }
        }

        /* === Ù‡Ø¯Ø± Ø¨Ø§Ø²ÛŒ === */
        .game-header { grid-area: header; background: rgba(0,0,0,0.4); border: 1px solid var(--border-color); border-radius: 12px; display: flex; justify-content: space-between; align-items: center; padding: 0 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #game-title { font-size: 1.5rem; font-weight: 900; color: var(--primary-gold); text-shadow: 1px 1px 5px #000; }
        .main-timer-style { font-size: 1.3rem; background-color: var(--darker-red); padding: 5px 15px; border-radius: 8px; border: 1px solid var(--primary-gold); font-weight: 700; }

        /* === Ù¾Ù†Ù„â€ŒÙ‡Ø§ÛŒ Ú©Ù†Ø§Ø±ÛŒ === */
        .side-panel {
            background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 12px;
            padding: 15px; display: flex; flex-direction: column; overflow-y: auto;
            /* [Ø¬Ø¯ÛŒØ¯] Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ÙˆØ±ÙˆØ¯ */
            animation: slide-in 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            opacity: 0;
        }
        #scoreboard-panel { animation-delay: 0.2s; }
        #history-panel { animation-delay: 0.4s; }

        @keyframes slide-in {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .panel-title { font-size: 1.2rem; font-weight: 700; color: var(--primary-gold); margin-bottom: 15px; text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }

        /* === Ù¾Ù†Ù„ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª === */
        #scoreboard-panel { grid-area: scoreboard; }
        #scoreboard-list { list-style: none; display: flex; flex-direction: column; gap: 10px; }
        .player-score-item { display: flex; align-items: center; background-color: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; transition: all 0.3s ease; }
        .player-score-item.is-self { background-color: var(--darker-red); border: 1px solid var(--primary-gold); }
        .player-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-left: 10px; border: 2px solid var(--border-color); }
        .player-name { flex-grow: 1; font-weight: 700; }
        .player-score { font-size: 1.2rem; font-weight: 900; color: var(--primary-gold); }
        .player-score.score-increase { animation: score-up 0.5s ease-out; }
        @keyframes score-up { 0% { transform: scale(1); } 50% { transform: scale(1.4); color: var(--cooperate-green); } 100% { transform: scale(1); } }
        
        /* === Ù¾Ù†Ù„ ØªØ§Ø±ÛŒØ®Ú†Ù‡ === */
        #history-panel { grid-area: history; }
        #history-list { display: flex; flex-direction: column; gap: 8px; }
        .history-item { font-size: 0.85rem; background-color: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; }
        
        /* === Ø§Ø³ØªÛŒØ¬ Ø§ØµÙ„ÛŒ === */
        #main-stage { grid-area: main; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 12px; display: flex; flex-direction: column; justify-content: space-around; align-items: center; padding: 20px; text-align: center; }
        #stage-message { font-size: 1.5rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 20px; }
        #pair-container { display: none; flex-direction: row; justify-content: space-around; align-items: center; width: 100%; perspective: 1000px; }
        .player-card { width: 200px; height: 280px; position: relative; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .player-card.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 15px; border: 2px solid var(--border-color); background: linear-gradient(145deg, #3c3022, var(--bg-dark)); box-shadow: 0 5px 20px rgba(0,0,0,0.4); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 15px; }
        .card-face.card-back { transform: rotateY(180deg); }
        .player-card-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--border-color); margin-bottom: 15px; }
        .player-card-name { font-size: 1.2rem; font-weight: 700; color: var(--primary-gold); }
        .player-card-status { font-size: 1rem; color: var(--text-secondary); margin-top: 10px; }
        .card-back .choice-icon { font-size: 5rem; line-height: 1; }
        .card-back .choice-text { font-size: 2rem; font-weight: 900; margin-top: 10px; }
        .card-back.cooperate { background: var(--cooperate-green); color: white; }
        .card-back.betray { background: var(--betray-red); color: white; }

        .decision-buttons-container { display: none; gap: 25px; margin-top: 20px; }
        .decision-btn {
            padding: 15px 30px; border-radius: 10px; border: 2px solid; font-size: 1.2rem; font-weight: 900;
            cursor: pointer; transition: all 0.2s ease-out; text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        }
        /* [Ø¬Ø¯ÛŒØ¯] Ø§ÙÚ©Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .decision-btn:not(:disabled):hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 30px rgba(0,0,0,0.6), 0 0 15px var(--glow-color), 0 0 25px var(--glow-color);
        }
        .decision-btn:active {
            transform: translateY(-1px) scale(1);
        }
        .decision-btn:disabled { cursor: not-allowed; opacity: 0.6; }
        #cooperate-btn { background-color: var(--cooperate-green); border-color: #73c686; color: white; }
        #betray-btn { background-color: var(--betray-red); border-color: #eb9a9a; color: white; }

        /* === Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ === */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-content { background: linear-gradient(145deg, #3c3022, var(--bg-dark)); border: 2px solid var(--border-color); border-radius: 16px; padding: 25px; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: scale(0.9); transition: transform 0.3s ease; position: relative; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.5rem; font-weight: 900; color: var(--primary-gold); margin-bottom: 20px; }
        
        /* [Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡] Ù…ÙˆØ¯Ø§Ù„ Ú†Øª Ø®ØµÙˆØµÛŒ */
        #private-chat-modal .modal-content { width: 95%; max-width: 500px; height: 80%; max-height: 600px; display: flex; flex-direction: column; padding: 0; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        #chat-partner-name { font-size: 1.1rem; color: var(--primary-gold); }
        #chat-timer { font-size: 1.1rem; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .chat-message { display: flex; align-items: flex-start; gap: 10px; max-width: 80%; }
        .chat-message.self { align-self: flex-end; flex-direction: row-reverse; }
        .chat-message-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--border-color); }
        .chat-message-content { display: flex; flex-direction: column; }
        .chat-message.self .chat-message-content { align-items: flex-end; }
        .chat-message-bubble { background-color: #332a20; padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; word-wrap: break-word; }
        .chat-message.self .chat-message-bubble { background-color: #2a3a30; }
        .chat-message-timestamp { font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px; padding: 0 5px; }
        #chat-form { display: flex; padding: 15px; border-top: 1px solid var(--border-color); gap: 10px; flex-shrink: 0; }
        #chat-input { flex-grow: 1; background-color: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; color: var(--text-light); font-family: 'Vazirmatn', sans-serif; font-size: 0.9rem; }
        #chat-send-btn { background-color: var(--primary-gold); border: none; border-radius: 8px; color: var(--darker-red); font-weight: 900; padding: 0 15px; cursor: pointer; }
        
        #round-result-modal-content { display: flex; flex-direction: column; gap: 20px; }
        .result-pair { display: flex; justify-content: space-around; align-items: center; }
        .result-player-card { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .result-player-card .player-avatar { width: 80px; height: 80px; }
        .result-choice { font-size: 1.2rem; font-weight: 700; padding: 5px 10px; border-radius: 8px; color: white; }
        .result-choice.cooperate { background-color: var(--cooperate-green); }
        .result-choice.betray { background-color: var(--betray-red); }
        .result-points { font-size: 1.5rem; font-weight: 900; }
        .result-points.positive { color: #2ecc71; }
        .result-points.negative { color: #e74c3c; }
        
        /* [Ø¬Ø¯ÛŒØ¯] Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ */
        #game-over-modal.visible .modal-content { animation: game-over-entry 1s cubic-bezier(0.19, 1, 0.22, 1) forwards; }
        #game-over-modal-content .modal-title { font-size: 2rem; }
        #final-winner { margin: 20px 0; font-size: 1.3rem; }
        #final-winner span { color: var(--primary-gold); font-weight: 900; }
        #back-to-lobby-btn { padding: 12px; font-size: 1rem; font-weight: 700; border-radius: 8px; cursor: pointer; border: 1px solid var(--primary-gold); background: linear-gradient(145deg, var(--dark-red), var(--darker-red)); color: white; }
        #game-over-modal.visible .modal-title::before {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 300px; height: 300px;
            background: radial-gradient(circle, var(--glow-color) 0%, rgba(255,201,71,0) 70%);
            transform: translate(-50%, -50%) scale(0);
            animation: golden-burst 1.5s 0.5s ease-out forwards;
            z-index: -1;
        }
        @keyframes game-over-entry { from { transform: scale(0.5) rotate(-15deg); opacity: 0; } to { transform: scale(1) rotate(0deg); opacity: 1; } }
        @keyframes golden-burst { from { transform: translate(-50%, -50%) scale(0); opacity: 1; } to { transform: translate(-50%, -50%) scale(2); opacity: 0; } }
    </style>
</head>
<body>

    <div id="background-blurry"></div>
    <div id="loading-overlay">
        <div class="loader"></div>
        <p id="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø§Ø²ÛŒ...</p>
    </div>
    
    <!-- [Ø¬Ø¯ÛŒØ¯] Ù„Ø§ÛŒÙ‡ Ú¯Ø°Ø§Ø± Ø¨ÛŒÙ† ÙØ§Ø²Ù‡Ø§ -->
    <div id="phase-transition-overlay"></div>

    <!-- Container Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ -->
    <div class="game-container" id="game-container">
        <header class="game-header">
            <h1 id="game-title">Ù…Ø°Ø§Ú©Ø±Ù‡â€ŒÚ©Ù†Ù†Ø¯Ù‡</h1>
            <div id="round-counter">Ø¯ÙˆØ± Û± / Ûµ</div>
            <div id="main-timer" class="main-timer-style">--:--</div>
        </header>
        
        <aside id="scoreboard-panel" class="side-panel">
            <h2 class="panel-title">Ø§Ù…ØªÛŒØ§Ø²Ø§Øª</h2>
            <ul id="scoreboard-list"></ul>
        </aside>

        <main id="main-stage">
            <h3 id="stage-message" class="stage-message">Ø¯Ø± Ø­Ø§Ù„ Ø¬ÙØªâ€ŒÚ©Ø±Ø¯Ù† Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†...</h3>
            
            <div id="pair-container">
                <div class="player-card-container">
                    <div class="player-card" id="self-card">
                        <div class="card-face card-front">
                            <img id="self-card-avatar" src="https://up.20script.ir/file/1d50-defult.png" class="player-card-avatar">
                            <div id="self-card-name" class="player-card-name">Ø´Ù…Ø§</div>
                            <div id="self-card-status" class="player-card-status">Ø¯Ø± Ø­Ø§Ù„ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ...</div>
                        </div>
                        <div id="self-card-back" class="card-face card-back">
                            <span id="self-choice-icon" class="choice-icon"></span>
                            <span id="self-choice-text" class="choice-text"></span>
                        </div>
                    </div>
                </div>
                <div style="font-size: 3rem; color: var(--primary-gold);">VS</div>
                <div class="player-card-container">
                     <div class="player-card" id="opponent-card">
                        <div class="card-face card-front">
                            <img id="opponent-card-avatar" src="https://up.20script.ir/file/1d50-defult.png" class="player-card-avatar">
                            <div id="opponent-card-name" class="player-card-name">Ø­Ø±ÛŒÙ</div>
                            <div id="opponent-card-status" class="player-card-status">Ø¯Ø± Ø­Ø§Ù„ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ...</div>
                        </div>
                        <div id="opponent-card-back" class="card-face card-back">
                            <span id="opponent-choice-icon" class="choice-icon"></span>
                            <span id="opponent-choice-text" class="choice-text"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="decision-buttons-container" id="decision-buttons">
                <button id="cooperate-btn" class="decision-btn">ğŸ¤ Ù‡Ù…Ú©Ø§Ø±ÛŒ</button>
                <button id="betray-btn" class="decision-btn">ğŸ’£ Ø®ÛŒØ§Ù†Øª</button>
            </div>
        </main>

        <aside id="history-panel" class="side-panel">
            <h2 class="panel-title">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¹Ù…ÙˆÙ…ÛŒ</h2>
            <div id="history-list"></div>
        </aside>
    </div>
    
    <!-- Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ -->
    <div id="private-chat-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="chat-header">
                <h3 id="chat-partner-name">Ú†Øª Ø¨Ø§ ...</h3>
                <!-- [Ø¬Ø¯ÛŒØ¯] ØªØ§ÛŒÙ…Ø± Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ Ú†Øª -->
                <div id="chat-timer" class="main-timer-style">--:--</div>
            </div>
            <div id="chat-messages"></div>
            <form id="chat-form">
                <input type="text" id="chat-input" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." autocomplete="off">
                <button type="submit" id="chat-send-btn">Ø§Ø±Ø³Ø§Ù„</button>
            </form>
        </div>
    </div>
    <div id="round-result-modal" class="modal-overlay">
        <div id="round-result-modal-content" class="modal-content">
             <h2 class="modal-title">Ù†ØªØ§ÛŒØ¬ Ø¯ÙˆØ±</h2>
             <div id="result-pairs-container"></div>
        </div>
    </div>
    <div id="game-over-modal" class="modal-overlay">
        <div id="game-over-modal-content" class="modal-content">
             <h2 class="modal-title">Ø¨Ø§Ø²ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯!</h2>
             <p id="final-winner"></p>
             <button id="back-to-lobby-btn">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„Ø§Ø¨ÛŒ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, runTransaction, getDoc, collection, addDoc, serverTimestamp, query, orderBy, writeBatch, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Config & Elements ---
        const firebaseConfig = { apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg", authDomain: "mafia-9fcbf.firebaseapp.com", projectId: "mafia-9fcbf", storageBucket: "mafia-9fcbf.appspot.com", messagingSenderId: "471627157488", appId: "1:471627157488:web:92f008548a5596619a5735", };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UI Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const gameContainer = document.getElementById('game-container');
        const roundCounterEl = document.getElementById('round-counter');
        const mainTimerEl = document.getElementById('main-timer');
        const scoreboardListEl = document.getElementById('scoreboard-list');
        const stageMessageEl = document.getElementById('stage-message');
        const pairContainerEl = document.getElementById('pair-container');
        const decisionButtonsEl = document.getElementById('decision-buttons');
        const cooperateBtn = document.getElementById('cooperate-btn');
        const betrayBtn = document.getElementById('betray-btn');
        const privateChatModal = document.getElementById('private-chat-modal');
        const chatPartnerNameEl = document.getElementById('chat-partner-name');
        const chatMessagesEl = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const roundResultModal = document.getElementById('round-result-modal');
        const resultPairsContainer = document.getElementById('result-pairs-container');
        const gameOverModal = document.getElementById('game-over-modal');
        const finalWinnerEl = document.getElementById('final-winner');
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
        
        // --- [Ø¬Ø¯ÛŒØ¯] Ø§ÙÚ©Øªâ€ŒÙ‡Ø§ÛŒ ØµÙˆØªÛŒ ---
        const sounds = {
            click: new Audio('./sounds/click.mp3'),
            reveal: new Audio('./sounds/reveal.mp3'),
            win: new Audio('./sounds/win.mp3')
        };
        sounds.click.volume = 0.5;
        sounds.reveal.volume = 0.7;

        // --- Game State ---
        let currentUser = null;
        let gameId = null;
        let gameData = null;
        let unsubscribeGame = null;
        let unsubscribeChat = null;
        let isHost = false;
        let currentPartner = null;
        let mainTimerInterval = null;
        const botMemory = new Map();

        // --- Main Function ---
        async function main() {
            gameId = new URLSearchParams(window.location.search).get('id');
            if (!gameId) {
                alert("Ø´Ù†Ø§Ø³Ù‡ Ø¨Ø§Ø²ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.");
                window.location.href = './Lobby page.html';
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    listenToGameChanges();
                    setupEventListeners();
                } else {
                    window.location.href = './login.html';
                }
            });
        }

        function listenToGameChanges() {
            const gameDocRef = doc(db, 'games', gameId);
            unsubscribeGame = onSnapshot(gameDocRef, (docSnap) => {
                if (!docSnap.exists()) {
                    alert("Ø¨Ø§Ø²ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ø­Ø°Ù Ø´Ø¯Ù‡ Ø§Ø³Øª.");
                    window.location.href = './Lobby page.html';
                    return;
                }
                
                const oldGameData = gameData;
                gameData = { id: docSnap.id, ...docSnap.data() };
                
                if (!gameData.players.some(p => p.uid === currentUser.uid)) {
                    alert("Ø´Ù…Ø§ Ø¹Ø¶Ùˆ Ø§ÛŒÙ† Ø¨Ø§Ø²ÛŒ Ù†ÛŒØ³ØªÛŒØ¯.");
                    window.location.href = './Lobby page.html';
                    return;
                }
                
                isHost = gameData.players[0].uid === currentUser.uid;

                updateUI(oldGameData);
                handleGameStatus();
                
                if (loadingOverlay.style.display !== 'none') {
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                        gameContainer.style.opacity = '1';
                    }, 500);
                }
            });
        }
        
        // --- UI Update ---
        function updateUI(oldGameData) {
            const sortedPlayers = [...gameData.players].sort((a, b) => b.score - a.score);
            scoreboardListEl.innerHTML = '';
            sortedPlayers.forEach(player => {
                const oldPlayer = oldGameData?.players.find(p => p.uid === player.uid);
                const oldScore = oldPlayer ? oldPlayer.score : 0;
                const item = document.createElement('li');
                item.className = 'player-score-item';
                if (player.uid === currentUser.uid) item.classList.add('is-self');
                item.innerHTML = `<img src="${player.avatar || 'https://up.20script.ir/file/1d50-defult.png'}" alt="avatar" class="player-avatar"><span class="player-name">${player.displayName}</span><span class="player-score" data-uid="${player.uid}">${player.score}</span>`;
                scoreboardListEl.appendChild(item);
                if (player.score > oldScore) {
                     const scoreEl = item.querySelector('.player-score');
                     animateScore(scoreEl, oldScore, player.score);
                }
            });
            roundCounterEl.textContent = `Ø¯ÙˆØ± ${gameData.round} / ${gameData.maxRounds}`;
        }
        
        function animateScore(element, start, end) { /* ... (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ... */ }

        // --- Game State Machine ---
        function handleGameStatus() {
            const self = gameData.players.find(p => p.uid === currentUser.uid);
            const myPair = gameData.pairs?.find(p => p.players.includes(currentUser.uid));
            currentPartner = myPair ? gameData.players.find(p => p.uid === myPair.players.find(uid => uid !== currentUser.uid)) : null;

            privateChatModal.classList.remove('visible');
            roundResultModal.classList.remove('visible');
            gameOverModal.classList.remove('visible');
            updateTimer();
            
            switch(gameData.status) {
                case 'pairing':
                    stageMessageEl.style.display = 'block'; pairContainerEl.style.display = 'none'; decisionButtonsEl.style.display = 'none';
                    stageMessageEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¬ÙØªâ€ŒÚ©Ø±Ø¯Ù† Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†...';
                    if (isHost) setTimeout(runPairingLogic, 2000);
                    break;
                case 'chat':
                    stageMessageEl.style.display = 'none';
                    if (myPair) { renderPlayerCards(self, currentPartner); openPrivateChat(); }
                    else { stageMessageEl.textContent = 'Ø´Ù…Ø§ Ø§ÛŒÙ† Ø¯ÙˆØ± Ø§Ø³ØªØ±Ø§Ø­Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.'; stageMessageEl.style.display = 'block'; pairContainerEl.style.display = 'none'; }
                    decisionButtonsEl.style.display = 'none';
                    break;
                case 'decision':
                    stageMessageEl.style.display = 'none';
                    if (privateChatModal.classList.contains('visible')) { privateChatModal.classList.remove('visible'); if(unsubscribeChat) unsubscribeChat(); }
                    if (myPair) {
                        renderPlayerCards(self, currentPartner);
                        if (self.currentChoice) { decisionButtonsEl.style.display = 'none'; document.getElementById('self-card-status').textContent = 'Ù…Ù†ØªØ¸Ø± Ø­Ø±ÛŒÙ...'; }
                        else { decisionButtonsEl.style.display = 'flex'; cooperateBtn.disabled = false; betrayBtn.disabled = false; }
                    } else { stageMessageEl.textContent = 'Ø´Ù…Ø§ Ø§ÛŒÙ† Ø¯ÙˆØ± Ø§Ø³ØªØ±Ø§Ø­Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.'; stageMessageEl.style.display = 'block'; pairContainerEl.style.display = 'none'; }
                    if (isHost) checkAllDecisionsMade();
                    runBotDecisionLogic(self);
                    break;
                case 'result':
                    stageMessageEl.style.display = 'none'; decisionButtonsEl.style.display = 'none';
                    if (myPair) { revealChoices(self, currentPartner); }
                    showRoundResultModal();
                    if (isHost) setTimeout(startNextRound, 7000);
                    break;
                case 'ended':
                    stageMessageEl.textContent = 'Ø¨Ø§Ø²ÛŒ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯!'; pairContainerEl.style.display = 'none'; decisionButtonsEl.style.display = 'none';
                    showGameOver();
                    if (isHost) updatePermanentStats();
                    break;
            }
        }
        
        // --- Host-Side Logic ---
        async function runPairingLogic() {
            if (gameData.pairs?.length > 0 && gameData.round === gameData.pairs[0].round) return;
            triggerPhaseTransition();
            // ... (Ù…Ù†Ø·Ù‚ Ø¬ÙØª Ú©Ø±Ø¯Ù† Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        }
        async function checkAllDecisionsMade() { /* ... (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ... */ }
        async function runScoringLogic() {
            const gameDocRef = doc(db, 'games', gameId);
            try {
                await runTransaction(db, async (transaction) => {
                    // ... (Ø¨Ø®Ø´ Ø§ÙˆÙ„ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
                    gameData.pairs.forEach(pair => {
                        // ... (Ù…Ù†Ø·Ù‚ Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
                        
                        // [Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡] Ø¢Ù¾Ø¯ÛŒØª Ø­Ø§ÙØ¸Ù‡ Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª Ø±Ø¨Ø§Øª Ø§Ø² Ø­Ø±Ú©Ø§Øª Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†
                        const updateBotMemory = (humanPlayer, humanChoice) => {
                            if (humanPlayer.uid.startsWith('bot_')) return;
                            const history = botMemory.get(humanPlayer.uid) || { betrayals: 0, cooperations: 0 };
                            if (humanChoice === 'betray') history.betrayals++; else history.cooperations++;
                            botMemory.set(humanPlayer.uid, history);
                        };
                        updateBotMemory(playerA, choiceA);
                        updateBotMemory(playerB, choiceB);
                        
                        roundResults.push({ /* ... */ });
                    });
                    // ... (Ø¨Ø®Ø´ Ø¢Ø®Ø± Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
                });
            } catch (error) { console.error("Error in scoring:", error); }
        }
        async function startNextRound() {
            triggerPhaseTransition();
            // ... (Ø¨Ù‚ÛŒÙ‡ Ú©Ø¯ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        }
        async function updatePermanentStats() { /* ... (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ... */ }

        // --- Player Actions & UI ---
        async function makeDecision(choice) { /* ... (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ... */ }
        function renderPlayerCards(self, partner) { /* ... (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ... */ }
        function revealChoices(self, partner) {
            // ... (Ø¨Ø®Ø´ Ø§ÙˆÙ„ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
            sounds.reveal.play(); // Ù¾Ø®Ø´ ØµØ¯Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§
            setTimeout(() => {
                document.getElementById('self-card').classList.add('flipped');
                document.getElementById('opponent-card').classList.add('flipped');
            }, 100);
        }
        
        // --- Chat Logic ---
        function openPrivateChat() { /* ... (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ... */ }
        function renderMessage(data) { /* ... (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ... */ }
        async function handleSendMessage(e) { /* ... (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ... */ }

        // --- [Ø¬Ø¯ÛŒØ¯] Ù…Ù†Ø·Ù‚ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø±Ø¨Ø§Øª ---
        function runBotChatLogic(bot, pairId) { /* ... (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ... */ }
        function runBotDecisionLogic(bot) {
            if (!bot || !bot.uid.startsWith('bot_') || bot.currentChoice) return;

            setTimeout(() => {
                let cooperationChance = 0.65;
                const partnerHistory = botMemory.get(currentPartner.uid) || { betrayals: 0, cooperations: 0 };
                const totalInteractions = partnerHistory.betrayals + partnerHistory.cooperations;

                if (totalInteractions > 0) {
                    const betrayalRatio = partnerHistory.betrayals / totalInteractions;
                    if (betrayalRatio > 0.5) cooperationChance = 0.2;
                    else if (betrayalRatio < 0.25) cooperationChance = 0.85;
                }
                
                const lastRound = gameData.rounds?.[gameData.rounds.length - 1];
                const partnerLastResult = lastRound?.results.find(r => r.players[currentPartner.uid]);
                const partnerLastMove = partnerLastResult?.players[currentPartner.uid].choice;

                if (partnerLastMove === 'betray') cooperationChance -= 0.4;
                else if (partnerLastMove === 'cooperate') cooperationChance += 0.2;
                
                const botHistory = botMemory.get(bot.uid) || { lastMove: null, betrayalStreak: 0 };
                if (botHistory.betrayalStreak >= 2) cooperationChance += 0.25;

                cooperationChance = Math.max(0.05, Math.min(0.95, cooperationChance));
                const choice = Math.random() < cooperationChance ? 'cooperate' : 'betray';
                
                botMemory.set(bot.uid, { lastMove: choice, betrayalStreak: choice === 'betray' ? (botHistory.betrayalStreak || 0) + 1 : 0 });

                const gameDocRef = doc(db, 'games', gameId);
                runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameDocRef);
                    if (!gameDoc.exists()) return;
                    const players = gameDoc.data().players;
                    const botIndex = players.findIndex(p => p.uid === bot.uid);
                    if (botIndex !== -1 && players[botIndex].currentChoice === null) {
                        players[botIndex].currentChoice = choice;
                        transaction.update(gameDocRef, { players: players });
                    }
                });
            }, Math.random() * 3000 + 1500);
        }

        // --- Modals & Timer ---
        function showRoundResultModal() { /* ... (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ... */ }
        function showGameOver() {
            const winner = [...gameData.players].sort((a,b) => b.score - a.score)[0];
            finalWinnerEl.innerHTML = `Ø¨Ø±Ù†Ø¯Ù‡ Ø¨Ø§Ø²ÛŒ <span>${winner.displayName}</span> Ø¨Ø§ ${winner.score} Ø§Ù…ØªÛŒØ§Ø² Ø§Ø³Øª!`;
            gameOverModal.classList.add('visible');
            sounds.win.play();
        }
        
        // [Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡] ØªØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§ÛŒÙ…Ø±
        function updateTimer() {
            if(mainTimerInterval) clearInterval(mainTimerInterval);
            if (!gameData.phaseStartTime) return;

            const chatTimerEl = document.getElementById('chat-timer');
            const phaseDurations = { 'chat': 60, 'decision': 20, 'result': 7 };
            const duration = phaseDurations[gameData.status] || 0;
            if (duration === 0) { mainTimerEl.textContent = "--:--"; if(chatTimerEl) chatTimerEl.textContent = "--:--"; return; }

            const startTime = gameData.phaseStartTime.toDate();
            mainTimerInterval = setInterval(() => {
                const elapsed = (new Date() - startTime) / 1000;
                const remaining = Math.max(0, duration - elapsed);
                const timeString = `${Math.floor(remaining / 60).toString().padStart(2, '0')}:${Math.floor(remaining % 60).toString().padStart(2, '0')}`;
                
                mainTimerEl.textContent = timeString;
                if (chatTimerEl && gameData.status === 'chat') chatTimerEl.textContent = timeString;

                if (remaining <= 0) {
                    clearInterval(mainTimerInterval);
                    if (isHost && gameData.status === 'chat') {
                        triggerPhaseTransition();
                        const gameDocRef = doc(db, 'games', gameId);
                        runTransaction(db, async (tx) => tx.update(gameDocRef, { status: 'decision', phaseStartTime: serverTimestamp() }));
                    }
                }
            }, 1000);
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            cooperateBtn.addEventListener('click', () => { sounds.click.play(); makeDecision('cooperate'); });
            betrayBtn.addEventListener('click', () => { sounds.click.play(); makeDecision('betray'); });
            chatForm.addEventListener('submit', handleSendMessage);
            backToLobbyBtn.addEventListener('click', () => { window.location.href = './Lobby page.html'; });
        }
        
        // [Ø¬Ø¯ÛŒØ¯] ØªØ§Ø¨Ø¹ Ø§ÙÚ©Øª Ú¯Ø°Ø§Ø±
        function triggerPhaseTransition() {
            const overlay = document.getElementById('phase-transition-overlay');
            overlay.classList.add('active');
            setTimeout(() => overlay.classList.remove('active'), 800);
        }
        
        main();
    </script>
</body>
</html>
