<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>بازی - معامله‌گر</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gold: #ffc947; --dark-red: #8c4843; --darker-red: #5a2c2a;
            --text-light: #f0e6d2; --text-secondary: #c5a687; --bg-dark: #1a140e;
            --border-color: #5c4a3a; --green-cooperate: #2ecc71; --red-betray: #e74c3c;
            --blue-partner: #3498db; --blue-vote: #2980b9; --grey-text: #bdc3c7;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; overflow: hidden; }
        body {
            font-family: 'Vazirmatn', sans-serif; color: var(--text-light); display: flex; flex-direction: column;
            position: relative; background-image: url('https://up.20script.ir/file/d1c7-InShot-۲۰۲۵۰۹۱۱-۱۲۲۵۲۰۷۶۰.jpg');
            background-size: cover; background-position: center center;
        }
        #background-blurry { position: fixed; top: -20px; left: -20px; width: calc(100% + 40px); height: calc(100% + 40px); background-image: url('https://up.20script.ir/file/d1c7-InShot-۲۰۲۵۰۹۱۱-۱۲۲۵۲۰۷۶۰.jpg'); background-size: cover; background-position: center center; filter: blur(8px) brightness(0.6); z-index: -1; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; transition: opacity 0.5s ease; }
        .loader { border: 6px solid #f3f3f330; border-top: 6px solid var(--primary-gold); border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-text { margin-top: 20px; font-size: 1.1rem; font-weight: 700; }

        .game-container { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 10px 5px; gap: 10px; }
        .game-header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 5px 15px; background-color: rgba(0, 0, 0, 0.4); border: 1px solid var(--border-color); border-radius: 12px; height: 60px; }
        #game-phase-info { font-size: 1.3rem; font-weight: 900; color: var(--primary-gold); text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }
        #game-timer { font-size: 1.5rem; font-weight: 700; background-color: var(--darker-red); color: white; padding: 5px 15px; border-radius: 8px; border: 1px solid var(--primary-gold); min-width: 80px; text-align: center; }
        .announcement-bar { flex-shrink: 0; width: 100%; padding: 10px; background-color: rgba(140, 72, 67, 0.5); border-radius: 8px; text-align: center; font-size: 1rem; font-weight: 700; display: none; transition: all 0.3s ease; }
        .players-area { flex-grow: 1; width: 100%; display: flex; justify-content: space-between; align-items: flex-start; gap: 5px; overflow: hidden; }
        .players-column { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; height: 100%; flex-shrink: 0; width: 120px; gap: 8px; overflow-y: auto; padding-top: 10px;}
        .player-card { display: flex; align-items: center; width: 110px; background-color: rgba(0,0,0,0.4); border: 2px solid var(--border-color); border-radius: 8px; padding: 5px; gap: 8px; transition: all 0.3s ease; }
        .player-card.highlighted { border-color: var(--blue-partner); box-shadow: 0 0 15px var(--blue-partner); transform: scale(1.05); }
        .player-card img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid var(--text-secondary); }
        .player-card-info { display: flex; flex-direction: column; }
        .player-card-name { font-size: 0.8rem; font-weight: 700; color: var(--text-light); }
        .player-card-score { font-size: 0.9rem; font-weight: 700; color: var(--primary-gold); }

        #central-board-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 0 5px; gap: 20px; }
        .central-area { display: none; flex-direction: column; align-items: center; gap: 15px; width: 100%; }
        
        /* Negotiation & Revelation Areas */
        #partner-display, #revelation-display { display: flex; align-items: center; gap: 20px; }
        .partner-avatar, .revelation-avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--primary-gold); object-fit: cover; }
        .versus-icon { font-size: 2.5rem; font-weight: 900; color: var(--primary-gold); }
        #partner-name { font-size: 1.5rem; font-weight: 900; }
        .prompt-text { font-size: 1rem; color: var(--text-secondary); text-align: center; }
        
        .action-buttons { display: flex; gap: 15px; margin-top: 10px; }
        .choice-btn, .vote-btn { padding: 12px 25px; font-size: 1.1rem; font-weight: 900; border-radius: 12px; border: 2px solid; cursor: pointer; transition: all 0.3s ease; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        #cooperate-btn { background: linear-gradient(145deg, var(--green-cooperate), #27ae60); border-color: #fff; }
        #betray-btn { background: linear-gradient(145deg, var(--red-betray), #c0392b); border-color: #fff; }
        .vote-btn { background: linear-gradient(145deg, var(--blue-vote), #34495e); border-color: #fff; }
        .choice-btn:disabled, .vote-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .choice-btn:not(:disabled):hover, .vote-btn:not(:disabled):hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        #revelation-result { margin-top: 15px; font-size: 1.2rem; font-weight: bold; text-align: center; }
        .result-cooperate { color: var(--green-cooperate); }
        .result-betray { color: var(--red-betray); }
        
        .game-footer { flex-shrink: 0; display: flex; justify-content: flex-end; padding: 10px; background-color: rgba(0,0,0,0.3); border-top: 1px solid var(--border-color); }
        
        /* Chat Styles */
        #toggle-chat-btn { width: 50px; height: 50px; border-radius: 50%; background-color: #4a5568; color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        #chat-panel { position: fixed; top: 50%; left: 50%; width: 90%; max-width: 550px; height: 70%; max-height: 500px; background-color: rgba(26, 20, 14, 0.95); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 16px; display: flex; flex-direction: column; z-index: 999; box-shadow: 0 8px 30px rgba(0,0,0,0.6); opacity: 0; transform: translate(-50%, -50%) scale(0.9); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease; pointer-events: none; }
        #chat-panel.visible { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); }
        .chat-header h3 { font-size: 1.1rem; color: var(--primary-gold); }
        #close-chat-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.5rem; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px 15px; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { display: flex; align-items: flex-start; gap: 10px; }
        .chat-message.self { align-self: flex-end; flex-direction: row-reverse; }
        .chat-message-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .chat-message-content { display: flex; flex-direction: column; }
        .chat-message-sender { font-size: 0.8rem; font-weight: 700; color: var(--primary-gold); margin-bottom: 3px; }
        .chat-message.self .chat-message-sender { text-align: right; }
        .chat-message-bubble { background-color: #332a20; padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; }
        .chat-message-bubble.private { background-color: #293a4a; border: 1px solid var(--blue-partner); }
        #chat-form { display: flex; padding: 10px 15px; border-top: 1px solid var(--border-color); gap: 10px; }
        #chat-input { flex-grow: 1; background-color: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; color: var(--text-light); font-size: 0.9rem; }
        #chat-send-btn { background-color: var(--primary-gold); border: none; border-radius: 8px; color: var(--darker-red); font-weight: 900; padding: 0 15px; cursor: pointer; }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: linear-gradient(145deg, #3c3022, var(--bg-dark)); border: 2px solid var(--border-color); border-radius: 16px; padding: 25px; width: 90%; max-width: 380px; text-align: center; }
        .modal-title { font-size: 1.5rem; font-weight: 900; color: var(--primary-gold); margin-bottom: 20px; }
        .modal-message { margin-bottom: 25px; }
        .modal-button { width: 100%; padding: 12px; font-size: 1rem; font-weight: 700; border-radius: 8px; cursor: pointer; border: 1px solid; color: white; background: linear-gradient(145deg, var(--dark-red), var(--darker-red)); border-color: var(--primary-gold); }
    </style>
</head>
<body>

    <div id="background-blurry"></div>
    <div id="loading-overlay">
        <div class="loader"></div>
        <p id="loading-text">در حال بارگذاری بازی معامله‌گر...</p>
    </div>

    <div class="game-container" style="display: none;">
        <header class="game-header">
            <div id="game-phase-info">دور ۱ از ۳</div>
            <div id="game-timer">00:00</div>
        </header>
        <div id="announcement-bar" class="announcement-bar"></div>
        <main class="players-area">
            <div id="right-players" class="players-column"></div>
            <div id="central-board-container">
                <!-- 1. Private Negotiation Phase -->
                <div id="private-negotiation-area" class="central-area">
                    <div id="partner-display">
                        <img id="my-avatar-negotiation" class="partner-avatar" src="">
                        <span class="versus-icon">⚔️</span>
                        <img id="partner-avatar" class="partner-avatar" src="">
                    </div>
                    <p class="prompt-text">با <strong id="partner-name"></strong> به طور خصوصی صحبت کنید و تصمیم بگیرید.</p>
                    <div class="action-buttons">
                        <button id="cooperate-btn" class="choice-btn">همکاری</button>
                        <button id="betray-btn" class="choice-btn">خیانت</button>
                    </div>
                </div>

                <!-- 2. Public Discussion Phase -->
                <div id="public-discussion-area" class="central-area">
                    <h2 style="color: var(--primary-gold);">بحث عمومی</h2>
                    <p class="prompt-text">با همه بازیکنان صحبت کنید. سعی کنید بفهمید چه کسی همکاری کرده و چه کسی خیانت.</p>
                </div>
                
                <!-- 3. Revelation & Voting Phase -->
                <div id="revelation-area" class="central-area">
                    <p class="prompt-text">نوبت افشای زوج زیر است:</p>
                    <div id="revelation-display">
                         <img id="p1-revelation-avatar" class="revelation-avatar">
                         <span class="versus-icon">🤝 / 🔪</span>
                         <img id="p2-revelation-avatar" class="revelation-avatar">
                    </div>
                    <p id="revelation-names" class="prompt-text" style="font-weight: bold; font-size: 1.2rem;"></p>
                    <div id="voting-section">
                        <p class="prompt-text">حدس شما چیست؟</p>
                        <div class="action-buttons">
                            <button class="vote-btn" data-vote="cooperate">همکاری کردند</button>
                            <button class="vote-btn" data-vote="betray">خیانت کردند</button>
                        </div>
                    </div>
                    <p id="revelation-wait-text" class="prompt-text"></p>
                    <div id="revelation-result"></div>
                </div>

                <!-- 4. Game Over Phase -->
                <div id="final-winner-area" class="central-area">
                     <h2 style="color: var(--primary-gold);">بازی تمام شد!</h2>
                     <p id="winner-text" style="font-size: 1.2rem;"></p>
                </div>

            </div>
            <div id="left-players" class="players-column"></div>
        </main>
        <footer class="game-footer">
            <button id="toggle-chat-btn" title="باز کردن چت">
                <svg viewBox="0 0 24 24"><path d="M20,2H4A2,2,0,0,0,2,4V22l4-4H20a2,2,0,0,0,2-2V4A2,2,0,0,0,20,2Z"/></svg>
            </button>
        </footer>
    </div>
    
    <div id="chat-panel"> <div class="chat-header"> <h3 id="chat-title">چت</h3> <button id="close-chat-btn">&times;</button> </div> <div id="chat-messages"></div> <form id="chat-form"> <input type="text" id="chat-input" placeholder="پیام..." autocomplete="off"> <button type="submit" id="chat-send-btn">ارسال</button> </form> </div>
    <div id="notification-modal" class="modal-overlay"> <div class="modal-content"> <h2 id="notification-modal-title" class="modal-title"></h2> <p id="notification-modal-message" class="modal-message"></p> <button id="notification-modal-ok-btn" class="modal-button primary">متوجه شدم</button> </div> </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, runTransaction, serverTimestamp, collection, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = { apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg", authDomain: "mafia-9fcbf.firebaseapp.com", projectId: "mafia-9fcbf", storageBucket: "mafia-9fcbf.appspot.com", messagingSenderId: "471627157488", appId: "1:471627157488:web:92f008548a5596619a5735", };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- Game Settings ---
        const TOTAL_ROUNDS = 3;
        // NOTE: Timers are now managed by Cloud Functions for accuracy.
        // These values are for display/fallback.
        const PHASE_DURATIONS = {
            private_negotiation: 60,
            public_discussion: 120,
            revelation_voting: 20,
            round_summary: 10
        };

        // --- Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const gameContainer = document.querySelector('.game-container');
        const centralAreas = document.querySelectorAll('.central-area');
        // ... (get all other elements by ID)
        const leftPlayersEl = document.getElementById('left-players');
        const rightPlayersEl = document.getElementById('right-players');
        const gamePhaseInfoEl = document.getElementById('game-phase-info');
        const gameTimerEl = document.getElementById('game-timer');
        const announcementBarEl = document.getElementById('announcement-bar');
        
        // --- State ---
        let currentUser = null;
        let gameId = null;
        let unsubscribeGame = null;
        let unsubscribeChat = null;
        let currentGameState = {};
        let timerInterval = null;

        // --- Main Logic ---
        async function main() {
            gameId = new URLSearchParams(window.location.search).get('id');
            if (!gameId) {
                showNotificationModal("خطا", "شناسه بازی نامعتبر است.", () => window.location.href = './Lobby page.html');
                return;
            }
            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUser = user;
                    listenToGameStateChanges();
                    setupEventListeners();
                } else { window.location.href = './login.html'; }
            });
        }

        function listenToGameStateChanges() {
            const gameDocRef = doc(db, "games", gameId);
            unsubscribeGame = onSnapshot(gameDocRef, async (docSnap) => {
                if (!docSnap.exists()) {
                    showNotificationModal("بازی پایان یافت", "این بازی دیگر فعال نیست.", () => window.location.href = './Lobby page.html');
                    return;
                }
                
                currentGameState = docSnap.data();

                if (currentUser.uid === currentGameState.creatorId && !currentGameState.gameStarted) {
                    await initializeGame(currentGameState);
                    return;
                }
                
                if (loadingOverlay.style.display !== 'none') {
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => { loadingOverlay.style.display = 'none'; gameContainer.style.display = 'flex'; }, 500);
                }

                renderGame(currentGameState);
                updateChatSubscription(currentGameState);
            }, (error) => {
                console.error("Firestore listen error:", error);
                showNotificationModal("خطای ارتباط", "ارتباط با سرور بازی قطع شد.", () => window.location.reload());
            });
        }
        
        // --- Host-Only Functions ---
        async function initializeGame(gameState) {
            const gameDocRef = doc(db, "games", gameId);
            const players = gameState.players.map(p => ({ ...p, score: 0 }));
            try {
                await runTransaction(db, async (transaction) => {
                    transaction.update(gameDocRef, {
                        players,
                        gameStarted: true,
                        totalRounds: TOTAL_ROUNDS,
                        currentRound: 0,
                        phase: 'starting'
                    });
                });
                // After initialization, the host calls the function to start the first round.
                // This would typically be a Cloud Function trigger, but we'll simulate it here.
                await startNewRound();
            } catch (error) { console.error("Game init error:", error); }
        }

        async function startNewRound() {
            if (currentUser.uid !== currentGameState.creatorId) return;
            
            const gameDocRef = doc(db, "games", gameId);
            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameDocRef);
                    if (!gameDoc.exists()) throw "Game does not exist!";
                    
                    const data = gameDoc.data();
                    const newRound = data.currentRound + 1;

                    if (newRound > data.totalRounds) {
                        transaction.update(gameDocRef, { phase: 'finished' });
                        return;
                    }

                    // Create new pairings
                    let playersToPair = [...data.players];
                    let newPairings = [];
                    playersToPair.sort(() => Math.random() - 0.5); // Shuffle
                    
                    while (playersToPair.length >= 2) {
                        const p1 = playersToPair.pop();
                        const p2 = playersToPair.pop();
                        newPairings.push({
                            pair: [p1.uid, p2.uid],
                            chatId: `round${newRound}_${p1.uid.slice(0,5)}_${p2.uid.slice(0,5)}`,
                            choices: { [p1.uid]: null, [p2.uid]: null },
                            publicVotes: {},
                            isRevealed: false
                        });
                    }

                    transaction.update(gameDocRef, {
                        currentRound: newRound,
                        phase: 'private_negotiation',
                        roundData: { pairings: newPairings, revealedPairIndex: -1 },
                        timerEndsAt: serverTimestamp(), // To be set by Cloud Function
                        announcements: [`دور ${newRound} شروع شد! با شریک خود مذاکره کنید.`]
                    });
                });
            } catch (error) { console.error("Error starting new round:", error); }
        }

        // --- Rendering Logic ---
        function renderGame(data) {
            renderPlayerList(data.players, data.phase, data.roundData);
            renderHeader(data);
            renderAnnouncements(data.announcements);

            centralAreas.forEach(area => area.style.display = 'none');
            const self = data.players.find(p => p.uid === currentUser.uid);

            switch(data.phase) {
                case 'private_negotiation': renderPrivateNegotiation(data, self); break;
                case 'public_discussion': document.getElementById('public-discussion-area').style.display = 'flex'; break;
                case 'revelation_voting': renderRevelation(data, self); break;
                case 'finished': renderFinished(data); break;
            }
        }
        
        function renderPlayerList(players, phase, roundData) {
            leftPlayersEl.innerHTML = ''; rightPlayersEl.innerHTML = '';
            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);

            let highlightedPlayers = [];
            if (phase === 'revelation_voting' && roundData && roundData.revealedPairIndex !== -1) {
                highlightedPlayers = roundData.pairings[roundData.revealedPairIndex].pair;
            }
            
            sortedPlayers.forEach((player, i) => {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.dataset.uid = player.uid;
                if(highlightedPlayers.includes(player.uid)) card.classList.add('highlighted');
                card.innerHTML = `<img src="${player.avatarUrl || ''}"><div class="player-card-info"><span class="player-card-name">${player.displayName}</span><span class="player-card-score">${player.score} امتیاز</span></div>`;
                (i % 2 === 0 ? rightPlayersEl : leftPlayersEl).appendChild(card);
            });
        }

        function renderHeader(data) {
            const phaseMap = { 'private_negotiation': 'مذاکره خصوصی', 'public_discussion': 'بحث عمومی', 'revelation_voting': 'افشا و رأی‌گیری', 'round_summary': 'نتایج دور', 'finished': 'پایان بازی' };
            gamePhaseInfoEl.textContent = `${phaseMap[data.phase] || ''} - دور ${data.currentRound} از ${data.totalRounds}`;
            updateTimer(data.timerEndsAt);
        }

        function updateTimer(timerEndsAt) {
            if (timerInterval) clearInterval(timerInterval);
            if (!timerEndsAt) { gameTimerEl.textContent = "--:--"; return; }
            
            const endTime = timerEndsAt.toDate();
            timerInterval = setInterval(() => {
                const secondsLeft = Math.round((endTime - new Date()) / 1000);
                if (secondsLeft <= 0) {
                    clearInterval(timerInterval);
                    gameTimerEl.textContent = "00:00";
                    return;
                }
                const minutes = Math.floor(secondsLeft / 60);
                const seconds = secondsLeft % 60;
                gameTimerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }
        
        function renderAnnouncements(announcements) {
             announcementBarEl.style.display = (announcements && announcements.length > 0) ? 'block' : 'none';
             if(announcements && announcements.length > 0) announcementBarEl.textContent = announcements[announcements.length - 1];
        }
        
        function renderPrivateNegotiation(data, self) {
            document.getElementById('private-negotiation-area').style.display = 'flex';
            const myPairing = data.roundData.pairings.find(p => p.pair.includes(self.uid));
            if (!myPairing) { /* handle spectator or odd player out */ return; }
            
            const partnerUid = myPairing.pair.find(uid => uid !== self.uid);
            const partnerData = data.players.find(p => p.uid === partnerUid);
            
            document.getElementById('my-avatar-negotiation').src = self.avatarUrl || '';
            document.getElementById('partner-avatar').src = partnerData.avatarUrl || '';
            document.getElementById('partner-name').textContent = partnerData.displayName;
            
            const myChoice = myPairing.choices[self.uid];
            document.getElementById('cooperate-btn').disabled = !!myChoice;
            document.getElementById('betray-btn').disabled = !!myChoice;
        }

        function renderRevelation(data, self) {
            document.getElementById('revelation-area').style.display = 'flex';
            const { pairings, revealedPairIndex } = data.roundData;
            if (revealedPairIndex === -1 || !pairings[revealedPairIndex]) return;

            const currentPair = pairings[revealedPairIndex];
            const [p1, p2] = currentPair.pair.map(uid => data.players.find(p => p.uid === uid));
            
            document.getElementById('p1-revelation-avatar').src = p1.avatarUrl || '';
            document.getElementById('p2-revelation-avatar').src = p2.avatarUrl || '';
            document.getElementById('revelation-names').textContent = `${p1.displayName} و ${p2.displayName}`;

            const isUserInPair = currentPair.pair.includes(self.uid);
            const userHasVoted = !!currentPair.publicVotes[self.uid];
            
            document.getElementById('voting-section').style.display = (!isUserInPair && !currentPair.isRevealed) ? 'block' : 'none';
            document.querySelectorAll('.vote-btn').forEach(b => b.disabled = userHasVoted);
            document.getElementById('revelation-wait-text').textContent = isUserInPair ? 'درحال رأی‌گیری در مورد شما...' : (userHasVoted ? 'منتظر بقیه رأی‌دهندگان...' : '');
            
            // Show results if revealed
            const resultEl = document.getElementById('revelation-result');
            if (currentPair.isRevealed) {
                document.getElementById('voting-section').style.display = 'none';
                const c1 = currentPair.choices[p1.uid];
                const c2 = currentPair.choices[p2.uid];
                resultEl.innerHTML = `
                    <p>${p1.displayName}: <span class="result-${c1}">${c1 === 'cooperate' ? 'همکاری' : 'خیانت'}</span></p>
                    <p>${p2.displayName}: <span class="result-${c2}">${c2 === 'cooperate' ? 'همکاری' : 'خیانت'}</span></p>
                `;
            } else {
                resultEl.innerHTML = '';
            }
        }
        
        function renderFinished(data) {
            document.getElementById('final-winner-area').style.display = 'flex';
            const winner = [...data.players].sort((a,b) => b.score - a.score)[0];
            document.getElementById('winner-text').textContent = `برنده: ${winner.displayName} با ${winner.score} امتیاز!`;
        }

        // --- User Actions ---
        function setupEventListeners() {
            document.getElementById('cooperate-btn').addEventListener('click', () => handleChoice('cooperate'));
            document.getElementById('betray-btn').addEventListener('click', () => handleChoice('betray'));
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.addEventListener('click', () => handlePublicVote(btn.dataset.vote));
            });
            // ... (chat event listeners)
        }

        async function handleChoice(choice) {
            const gameDocRef = doc(db, "games", gameId);
            await runTransaction(db, async (transaction) => {
                const gameDoc = await transaction.get(gameDocRef);
                const data = gameDoc.data();
                const pairIndex = data.roundData.pairings.findIndex(p => p.pair.includes(currentUser.uid));
                if (pairIndex > -1) {
                    data.roundData.pairings[pairIndex].choices[currentUser.uid] = choice;
                    transaction.update(gameDocRef, { roundData: data.roundData });
                }
            });
        }
        
        async function handlePublicVote(vote) {
             const gameDocRef = doc(db, "games", gameId);
             await runTransaction(db, async (transaction) => {
                const gameDoc = await transaction.get(gameDocRef);
                const data = gameDoc.data();
                const pairIndex = data.roundData.revealedPairIndex;
                if(pairIndex > -1) {
                    // Assuming the players' actual choices are 'cooperate' or 'betray'
                    // The public votes on the OUTCOME. Let's simplify and say they vote if betrayal happened.
                    // 'cooperate' -> they both cooperated. 'betray' -> at least one betrayed.
                    const p1_choice = data.roundData.pairings[pairIndex].choices[data.roundData.pairings[pairIndex].pair[0]];
                    const p2_choice = data.roundData.pairings[pairIndex].choices[data.roundData.pairings[pairIndex].pair[1]];
                    const actualOutcome = (p1_choice === 'betray' || p2_choice === 'betray') ? 'betray' : 'cooperate';
                    
                    data.roundData.pairings[pairIndex].publicVotes[currentUser.uid] = {
                        vote: vote,
                        isCorrect: vote === actualOutcome
                    };
                    transaction.update(gameDocRef, { roundData: data.roundData });
                }
             });
        }
        
        // --- Chat Logic ---
        function updateChatSubscription(data) {
            if (unsubscribeChat) unsubscribeChat();
            
            let chatPath;
            let title = "چت عمومی";
            
            if (data.phase === 'private_negotiation') {
                const myPairing = data.roundData?.pairings.find(p => p.pair.includes(currentUser.uid));
                if (myPairing) {
                    chatPath = `games/${gameId}/roundChats/${myPairing.chatId}`;
                    title = "چت خصوصی";
                } else { chatPath = `games/${gameId}/publicChat`; }
            } else {
                chatPath = `games/${gameId}/publicChat`;
            }

            document.getElementById('chat-title').textContent = title;
            document.getElementById('chat-messages').innerHTML = '';
            listenToChatMessages(chatPath);
        }
        
        function listenToChatMessages(path) {
            // ... (Implementation is the same as previous version, but with bubble styling)
        }

        main();
    </script>
</body>
</html>
