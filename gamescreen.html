<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>بازی مذاکره - شهر مافیا</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* === متغیرهای رنگی پایه === */
        :root {
            --primary-gold: #ffc947;
            --dark-red: #8c4843;
            --darker-red: #5a2c2a;
            --text-light: #f0e6d2;
            --text-secondary: #c5a687;
            --bg-dark: #1a140e;
            --border-color: #5c4a3a;
            --green-cooperate: #2ecc71;
            --red-betray: #e74c3c;
            --blue-accent: #3498db;
        }

        /* === ریست و استایل‌های کلی === */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { 
            height: 100%; 
            width: 100%;
            overflow: hidden; 
        }
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            color: var(--text-light); 
            background-color: var(--bg-dark);
            background-image: url('https://up.20script.ir/file/d1c7-InShot-۲۰۲۵۰۹۱۱-۱۲۲۵۲۰۷۶۰.jpg');
            background-size: cover;
            background-position: center center;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        #background-blurry { position: fixed; top: -20px; left: -20px; width: calc(100% + 40px); height: calc(100% + 40px); background-image: inherit; background-size: cover; background-position: center center; filter: blur(10px) brightness(0.5); z-index: -1; }
        
        /* === لودینگ اولیه === */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; transition: opacity 0.5s ease; }
        .loader { border: 6px solid #f3f3f330; border-top: 6px solid var(--primary-gold); border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-text { margin-top: 20px; font-size: 1.1rem; font-weight: 700; }

        /* === ساختار اصلی صفحه بازی === */
        .game-container {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 250px 1fr 250px;
            grid-template-rows: 70px 1fr 60px;
            grid-template-areas:
                "header header header"
                "scoreboard main-stage history"
                "footer footer footer";
            gap: 10px;
            padding: 10px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .game-container.visible { opacity: 1; }

        /* === هدر === */
        .game-header {
            grid-area: header;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0,0,0,0.4);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 0 20px;
        }
        #game-title { font-size: 1.5rem; font-weight: 900; color: var(--primary-gold); text-shadow: 1px 1px 5px #000; }
        .round-info { text-align: center; }
        #round-counter { font-size: 1.2rem; }
        .countdown-timer {
            font-size: 2rem;
            font-weight: 900;
            color: var(--blue-accent);
            text-shadow: 0 0 10px var(--blue-accent);
            width: 80px;
            text-align: center;
        }

        /* === پنل امتیازات (چپ) === */
        .scoreboard-panel {
            grid-area: scoreboard;
            background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            overflow-y: auto;
        }
        .panel-title { font-size: 1.2rem; font-weight: 700; color: var(--primary-gold); margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .player-score-card { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 8px; border-radius: 8px; transition: all 0.2s; }
        .player-score-card.is-self { background-color: rgba(255, 201, 71, 0.1); border-left: 4px solid var(--primary-gold); }
        .player-score-card.is-waiting { opacity: 0.6; }
        .player-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--text-secondary); }
        .player-info { flex-grow: 1; }
        .player-name { font-weight: 700; }
        .player-score { font-size: 1.1rem; font-weight: 900; color: var(--primary-gold); }
        .player-choice-indicator { font-size: 1.5rem; width: 30px; text-align: center; }
        .player-choice-indicator.made-choice { color: var(--green-cooperate); }


        /* === صحنه اصلی (وسط) === */
        .main-stage-panel {
            grid-area: main-stage;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        #game-status-display { font-size: 1.5rem; font-weight: 700; color: var(--text-secondary); }
        .decision-buttons-container { display: none; gap: 20px; margin-top: 30px; }
        .decision-button {
            width: 200px;
            padding: 20px;
            font-size: 1.8rem;
            font-weight: 900;
            border-radius: 16px;
            border: 3px solid;
            cursor: pointer;
            transition: all 0.2s ease;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            color: white;
        }
        .decision-button:not(:disabled):hover { transform: scale(1.05); box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
        .decision-button:disabled { cursor: not-allowed; opacity: 0.5; }
        #cooperate-btn { background: linear-gradient(145deg, var(--green-cooperate), #27ae60); border-color: #82e0aa; }
        #betray-btn { background: linear-gradient(145deg, var(--red-betray), #c0392b); border-color: #f5b7b1; }
        #partner-info { margin-top: 20px; display: none; align-items: center; gap: 15px; padding: 10px 20px; background-color: rgba(0,0,0,0.3); border-radius: 12px; }
        #partner-avatar { width: 50px; height: 50px; border-radius: 50%; }
        #partner-name { font-size: 1.2rem; font-weight: 700; }

        /* === پنل تاریخچه (راست) === */
        .history-panel {
            grid-area: history;
            background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            overflow-y: auto;
        }
        .history-item { padding: 10px; border-bottom: 1px solid rgba(92, 74, 58, 0.5); font-size: 0.9rem; }
        .history-item:last-child { border-bottom: none; }
        .history-item-header { font-weight: 700; color: var(--primary-gold); margin-bottom: 5px; }

        /* === فوتر === */
        .game-footer {
            grid-area: footer;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 0 20px;
        }
        .action-button { background: linear-gradient(145deg, #a13d3d, #7c1f1f); border: 1px solid #ff8f8f; color: white; padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; }
        .action-button:hover { transform: scale(1.05); }

        /* === مودال‌ها === */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-content { background: linear-gradient(145deg, #3c3022, var(--bg-dark)); border: 2px solid var(--border-color); border-radius: 16px; padding: 25px; width: 90%; max-width: 550px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.5rem; font-weight: 900; color: var(--primary-gold); margin-bottom: 20px; }
        .modal-close-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 2rem; line-height: 1; padding: 5px; position: absolute; top: 10px; left: 15px; }

        /* --- مودال چت خصوصی --- */
        #private-chat-modal .modal-content { height: 80%; max-height: 600px; display: flex; flex-direction: column; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px 15px; display: flex; flex-direction: column; gap: 12px; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); margin: 15px 0; }
        .chat-message { display: flex; align-items: flex-start; gap: 10px; max-width: 80%; }
        .chat-message.self { align-self: flex-end; flex-direction: row-reverse; }
        .chat-message-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .chat-message-bubble { background-color: #332a20; padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; word-wrap: break-word; }
        .chat-message.self .chat-message-bubble { background-color: #2a3a30; }
        #chat-form { display: flex; gap: 10px; flex-shrink: 0; }
        #chat-input { flex-grow: 1; background-color: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; color: var(--text-light); }
        #chat-send-btn { background-color: var(--primary-gold); border: none; border-radius: 8px; color: var(--darker-red); font-weight: 900; padding: 0 15px; cursor: pointer; }

        /* --- مودال نمایش نتایج --- */
        #round-result-modal .result-display { display: flex; justify-content: space-around; align-items: center; margin: 20px 0; }
        .result-player-card { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .result-player-card img { width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--border-color); }
        .result-player-choice { font-size: 1.2rem; font-weight: 700; padding: 5px 15px; border-radius: 8px; }
        .result-player-choice.cooperate { background-color: var(--green-cooperate); }
        .result-player-choice.betray { background-color: var(--red-betray); }
        .result-points { font-size: 1.5rem; font-weight: 900; }
        .result-points.positive { color: var(--green-cooperate); }
        .result-points.negative { color: var(--red-betray); }
        #result-summary-message { margin-top: 20px; font-size: 1.1rem; }

        /* رسپانسیو سازی */
        @media (max-width: 768px) {
            .game-container {
                grid-template-columns: 1fr;
                grid-template-rows: 70px auto 1fr auto 60px;
                grid-template-areas:
                    "header"
                    "scoreboard"
                    "main-stage"
                    "history"
                    "footer";
                overflow-y: auto;
            }
            .scoreboard-panel, .history-panel {
                height: 200px; /* ارتفاع ثابت برای پنل‌های کناری در موبایل */
            }
            .decision-button { width: 150px; font-size: 1.5rem; }
        }

    </style>
</head>
<body>

    <div id="background-blurry"></div>
    <div id="loading-overlay">
        <div class="loader"></div>
        <p id="loading-text">در حال بارگذاری بازی...</p>
    </div>

    <div id="game-container" class="game-container">
        <!-- هدر -->
        <header class="game-header">
            <h1 id="game-title">مذاکره</h1>
            <div class="round-info">
                <div id="round-counter">دور ۱ از ۵</div>
                <div id="countdown-timer">--:--</div>
            </div>
            <div id="game-id-display" style="font-size: 0.8rem; opacity: 0.5;"></div>
        </header>

        <!-- پنل امتیازات -->
        <aside class="scoreboard-panel">
            <h2 class="panel-title">امتیازات</h2>
            <div id="scoreboard-list">
                <!-- Player cards will be inserted here -->
            </div>
        </aside>

        <!-- صحنه اصلی -->
        <main class="main-stage-panel">
            <div id="partner-info">
                <img id="partner-avatar" src="https://up.20script.ir/file/1d50-defult.png" alt="Partner Avatar">
                <span id="partner-name">...</span>
            </div>
            <h3 id="game-status-display">لطفا منتظر بمانید...</h3>
            <div id="decision-buttons-container" class="decision-buttons-container">
                <button id="cooperate-btn" class="decision-button" data-choice="cooperate">🤝 همکاری</button>
                <button id="betray-btn" class="decision-button" data-choice="betray">⚔️ خیانت</button>
            </div>
        </main>

        <!-- پنل تاریخچه -->
        <aside class="history-panel">
            <h2 class="panel-title">تاریخچه دورها</h2>
            <div id="history-list">
                 <!-- History items will be inserted here -->
            </div>
        </aside>

        <!-- فوتر -->
        <footer class="game-footer">
            <button id="leave-game-btn" class="action-button">خروج از بازی</button>
        </footer>
    </div>
    
    <!-- مودال‌ها -->
    <div id="private-chat-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="chat-modal-title" class="modal-title">چت خصوصی</h2>
            <div id="chat-messages"></div>
            <form id="chat-form">
                <input type="text" id="chat-input" placeholder="پیام خود را بنویسید..." autocomplete="off">
                <button type="submit" id="chat-send-btn">ارسال</button>
            </form>
        </div>
    </div>

    <div id="round-result-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="result-modal-title" class="modal-title">نتیجه دور</h2>
            <div class="result-display">
                <!-- Your card -->
                <div class="result-player-card">
                    <img id="result-my-avatar" src="">
                    <span id="result-my-name">شما</span>
                    <div id="result-my-choice" class="result-player-choice"></div>
                    <div id="result-my-points" class="result-points"></div>
                </div>
                <!-- Partner's card -->
                 <div class="result-player-card">
                    <img id="result-partner-avatar" src="">
                    <span id="result-partner-name">شریک</span>
                    <div id="result-partner-choice" class="result-player-choice"></div>
                    <div id="result-partner-points" class="result-points"></div>
                </div>
            </div>
            <p id="result-summary-message"></p>
        </div>
    </div>
    
    <div id="notification-modal" class="modal-overlay">
         <div class="modal-content">
             <h2 id="notification-modal-title" class="modal-title">توجه</h2>
             <p id="notification-modal-message" class="modal-message"></p>
             <button id="notification-modal-ok-btn" style="padding: 10px 20px; font-size: 1rem; cursor:pointer;">متوجه شدم</button>
         </div>
     </div>

    <!-- صداها -->
    <audio id="sound-round-start" src="https://assets.mixkit.co/sfx/preview/mixkit-game-level-completed-2059.mp3" preload="auto"></audio>
    <audio id="sound-decision-time" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-game-over-213.mp3" preload="auto"></audio>
    <audio id="sound-new-message" src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" preload="auto"></audio>
    <audio id="sound-choice-made" src="https://assets.mixkit.co/sfx/preview/mixkit-quick-positive-video-game-notification-interface-265.mp3" preload="auto"></audio>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, runTransaction, getDoc, collection, addDoc, updateDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Config & Elements ---
        const firebaseConfig = { apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg", authDomain: "mafia-9fcbf.firebaseapp.com", projectId: "mafia-9fcbf", storageBucket: "mafia-9fcbf.appspot.com", messagingSenderId: "471627157488", appId: "1:471627157488:web:92f008548a5596619a5735", };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const gameContainer = document.getElementById('game-container');
        const gameIdDisplay = document.getElementById('game-id-display');
        const roundCounterEl = document.getElementById('round-counter');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const scoreboardListEl = document.getElementById('scoreboard-list');
        const gameStatusDisplay = document.getElementById('game-status-display');
        const decisionButtonsContainer = document.getElementById('decision-buttons-container');
        const historyListEl = document.getElementById('history-list');
        const partnerInfoEl = document.getElementById('partner-info');
        const chatModal = document.getElementById('private-chat-modal');
        const chatMessagesEl = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const resultModal = document.getElementById('round-result-modal');


        // --- Game State ---
        let currentUser = null;
        let currentUserData = {};
        let gameId = null;
        let unsubscribeGame = null;
        let unsubscribeChat = null;
        let currentGameState = null;
        let isHost = false; // Player who starts the pairing/scoring
        let countdownInterval = null;
        
        // --- Game Timers Config ---
        const CHAT_DURATION = 60; // seconds
        const RESULT_DISPLAY_DURATION = 8; // seconds
        const POST_RESULT_DELAY = 3; // seconds

        // --- Main Logic ---
        async function main() {
            gameId = new URLSearchParams(window.location.search).get('id');
            if (!gameId) {
                showNotification("خطا", "شناسه بازی نامعتبر است.", () => window.location.href = './Lobby page.html');
                return;
            }
            gameIdDisplay.textContent = `ID: ${gameId.substring(0,6)}...`;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    const userDocSnap = await getDoc(doc(db, 'users', user.uid));
                    currentUserData = userDocSnap.exists() ? userDocSnap.data() : { displayName: user.displayName };
                    
                    listenToGameChanges();
                    setupEventListeners();
                } else {
                    window.location.href = './login.html';
                }
            });
        }

        function listenToGameChanges() {
            const gameDocRef = doc(db, "games", gameId);
            unsubscribeGame = onSnapshot(gameDocRef, (docSnap) => {
                if (!docSnap.exists()) {
                    showNotification("بازی پایان یافت", "این بازی دیگر وجود ندارد.", () => window.location.href = './Lobby page.html');
                    cleanUp();
                    return;
                }
                
                const gameData = docSnap.data();
                const wasFirstLoad = !currentGameState;
                currentGameState = gameData;

                // Check if user is part of this game
                const isPlayerInGame = gameData.players.some(p => p.uid === currentUser.uid);
                if (!isPlayerInGame) {
                     showNotification("خطا", "شما عضو این بازی نیستید.", () => window.location.href = './Lobby page.html');
                     cleanUp();
                     return;
                }

                if(wasFirstLoad) {
                    // This is the first data load, determine if this client is the host.
                    // The host is the first player in the array, responsible for server-like tasks.
                    // NOTE: In production, this MUST be a Cloud Function.
                    isHost = gameData.players[0].uid === currentUser.uid;
                    hideLoading();
                }
                
                updateUI(gameData);

                // --- HOST-ONLY LOGIC (Client-side fallback for Cloud Functions) ---
                if (isHost) {
                    handleHostTasks(gameData);
                }
            }, (error) => {
                console.error("Error listening to game:", error);
                showNotification("خطای ارتباط", "ارتباط با سرور بازی قطع شد.");
            });
        }
        
        function updateUI(data) {
            renderScoreboard(data.players);
            renderHistory(data.rounds || []);
            roundCounterEl.textContent = `دور ${data.round} از ${data.maxRounds}`;

            // Reset UI elements
            decisionButtonsContainer.style.display = 'none';
            partnerInfoEl.style.display = 'none';
            document.querySelectorAll('.decision-button').forEach(b => b.disabled = false);

            switch (data.status) {
                case 'pairing':
                    gameStatusDisplay.textContent = 'در حال جفت‌سازی بازیکنان...';
                    closeAllModals();
                    stopTimer();
                    break;
                case 'chat':
                    handleChatPhase(data);
                    break;
                case 'decision':
                    handleDecisionPhase(data);
                    break;
                case 'result':
                    handleResultPhase(data);
                    break;
                case 'ended':
                    handleGameEnd(data);
                    break;
            }
        }
        
        // --- Host-Only Tasks (Simulating Server Logic) ---
        async function handleHostTasks(data) {
            if (data.status === 'pairing') {
                await pairPlayers(data);
            } else if (data.status === 'decision') {
                const allMadeChoice = data.pairs.every(pair => {
                    const playerA = data.players.find(p => p.uid === pair.playerA);
                    const playerB = data.players.find(p => p.uid === pair.playerB);
                    return playerA.currentChoice && playerB.currentChoice;
                });
                if (allMadeChoice) {
                    await calculateScores(data);
                }
            }
        }

        async function pairPlayers(gameData) {
            console.log("HOST: Pairing players for round", gameData.round);
            let playersToPair = [...gameData.players];
            // Simple shuffle
            for (let i = playersToPair.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [playersToPair[i], playersToPair[j]] = [playersToPair[j], playersToPair[i]];
            }

            const newPairs = [];
            while(playersToPair.length >= 2) {
                const playerA = playersToPair.pop();
                const playerB = playersToPair.pop();
                const pairId = [playerA.uid, playerB.uid].sort().join('_');
                newPairs.push({ playerA: playerA.uid, playerB: playerB.uid, pairId: pairId });
            }
            
            // Any player left over sits out this round.
            // Reset choices for the new round
            const updatedPlayers = gameData.players.map(p => ({...p, currentChoice: null}));

            try {
                await updateDoc(doc(db, "games", gameId), {
                    status: 'chat',
                    pairs: newPairs,
                    players: updatedPlayers
                });
            } catch (error) {
                console.error("HOST: Error setting up pairs:", error);
            }
        }
        
        async function calculateScores(gameData) {
            console.log("HOST: All choices are in. Calculating scores.");
            
            let updatedPlayers = [...gameData.players];
            const roundResults = [];

            for (const pair of gameData.pairs) {
                const playerA = updatedPlayers.find(p => p.uid === pair.playerA);
                const playerB = updatedPlayers.find(p => p.uid === pair.playerB);
                
                const [pointsA, pointsB] = computePoints(playerA.currentChoice, playerB.currentChoice);

                playerA.score += pointsA;
                playerB.score += pointsB;

                roundResults.push(
                    { playerUid: playerA.uid, partnerUid: playerB.uid, choice: playerA.currentChoice, points: pointsA },
                    { playerUid: playerB.uid, partnerUid: playerA.uid, choice: playerB.currentChoice, points: pointsB }
                );
            }
            
            const updatedRounds = [...(gameData.rounds || []), { roundNumber: gameData.round, results: roundResults, timestamp: serverTimestamp()}];

            try {
                await updateDoc(doc(db, "games", gameId), {
                    status: 'result',
                    players: updatedPlayers,
                    rounds: updatedRounds
                });
            } catch (error) {
                console.error("HOST: Error calculating scores:", error);
            }
        }
        
        // --- UI Rendering Functions ---
        function renderScoreboard(players) {
            scoreboardListEl.innerHTML = '';
            players.sort((a, b) => b.score - a.score); // Sort by score descending
            players.forEach(p => {
                const card = document.createElement('div');
                card.className = 'player-score-card';
                if(p.uid === currentUser.uid) card.classList.add('is-self');
                
                const choiceIndicator = getChoiceIndicator(p.currentChoice);

                card.innerHTML = `
                    <img src="${p.avatar || 'https://up.20script.ir/file/1d50-defult.png'}" alt="avatar" class="player-avatar">
                    <div class="player-info">
                        <div class="player-name">${p.displayName}</div>
                        <div class="player-score">${p.score} امتیاز</div>
                    </div>
                    <div class="player-choice-indicator ${p.currentChoice ? 'made-choice' : ''}">${choiceIndicator}</div>
                `;
                scoreboardListEl.appendChild(card);
            });
        }
        
        function renderHistory(rounds) {
            historyListEl.innerHTML = '';
            rounds.slice().reverse().forEach(round => {
                const myResult = round.results.find(r => r.playerUid === currentUser.uid);
                if(!myResult) return;
                
                const choiceText = myResult.choice === 'cooperate' ? 'همکاری' : 'خیانت';
                const pointsText = myResult.points > 0 ? `+${myResult.points}` : myResult.points;
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="history-item-header">دور ${round.roundNumber}</div>
                    <div>شما <strong>${choiceText}</strong> کردید و <strong>${pointsText}</strong> امتیاز گرفتید.</div>
                `;
                historyListEl.appendChild(item);
            });
        }

        // --- Phase Handlers ---
        function handleChatPhase(data) {
            const myPair = data.pairs.find(p => p.playerA === currentUser.uid || p.playerB === currentUser.uid);
            if(myPair) {
                const partnerId = myPair.playerA === currentUser.uid ? myPair.playerB : myPair.playerA;
                const partner = data.players.find(p => p.uid === partnerId);
                
                gameStatusDisplay.textContent = `شما با ${partner.displayName} مذاکره می‌کنید.`;
                showPartnerInfo(partner);

                // Open chat
                openPrivateChat(myPair.pairId, partner);
                startTimer(CHAT_DURATION, async () => {
                    // This callback runs when the timer finishes
                    chatModal.classList.remove('visible');
                    if(isHost) {
                        console.log("HOST: Chat time is over. Moving to decision phase.");
                        try {
                            await updateDoc(doc(db, "games", gameId), { status: 'decision' });
                        } catch(e) { console.error("Error updating status to decision", e); }
                    }
                });
                playSound('sound-round-start');

            } else {
                gameStatusDisplay.textContent = 'شما این دور استراحت می‌کنید.';
                closeAllModals();
                stopTimer();
            }
        }
        
        function handleDecisionPhase(data) {
            const myPair = data.pairs.find(p => p.playerA === currentUser.uid || p.playerB === currentUser.uid);
            if(myPair) {
                const me = data.players.find(p => p.uid === currentUser.uid);
                
                if (me.currentChoice) {
                    gameStatusDisplay.textContent = 'منتظر انتخاب شریک خود باشید...';
                    decisionButtonsContainer.style.display = 'flex';
                    document.querySelectorAll('.decision-button').forEach(b => b.disabled = true);
                } else {
                    gameStatusDisplay.textContent = 'انتخاب خود را ثبت کنید!';
                    decisionButtonsContainer.style.display = 'flex';
                }
                
                const partnerId = myPair.playerA === currentUser.uid ? myPair.playerB : myPair.playerA;
                const partner = data.players.find(p => p.uid === partnerId);
                showPartnerInfo(partner);
                
            } else {
                 gameStatusDisplay.textContent = 'شما این دور استراحت می‌کنید.';
            }
            closeAllModals();
            stopTimer(); // No timer for decision phase in this version
        }
        
        function handleResultPhase(data) {
             const myResult = data.rounds[data.rounds.length - 1].results.find(r => r.playerUid === currentUser.uid);
             if (myResult) {
                 const partnerResult = data.rounds[data.rounds.length - 1].results.find(r => r.playerUid === myResult.partnerUid);
                 const partnerData = data.players.find(p => p.uid === myResult.partnerUid);
                 showResultModal(myResult, partnerResult, partnerData);
             }
             
             stopTimer();
             startTimer(RESULT_DISPLAY_DURATION, async () => {
                 resultModal.classList.remove('visible');
                 // After showing results, wait a bit then move to the next round or end the game
                 if (isHost) {
                    setTimeout(async () => {
                        const isLastRound = data.round >= data.maxRounds;
                        const nextStatus = isLastRound ? 'ended' : 'pairing';
                        const nextRound = isLastRound ? data.round : data.round + 1;
                        await updateDoc(doc(db, "games", gameId), { status: nextStatus, round: nextRound });
                    }, POST_RESULT_DELAY * 1000);
                 }
             });
        }
        
        function handleGameEnd(data) {
            const players = data.players.sort((a,b) => b.score - a.score);
            const winner = players[0];
            gameStatusDisplay.textContent = `بازی تمام شد! برنده: ${winner.displayName}`;
            stopTimer();
            countdownTimerEl.textContent = "پایان";
            closeAllModals();
        }

        async function handleDecision(choice) {
            playSound('sound-choice-made');
            document.querySelectorAll('.decision-button').forEach(b => b.disabled = true);
            gameStatusDisplay.textContent = 'انتخاب شما ثبت شد. منتظر بمانید...';
            
            const gameDocRef = doc(db, "games", gameId);
            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameDocRef);
                    if (!gameDoc.exists()) throw new Error("Game not found");

                    let players = gameDoc.data().players;
                    const playerIndex = players.findIndex(p => p.uid === currentUser.uid);
                    if (playerIndex > -1) {
                        players[playerIndex].currentChoice = choice;
                        transaction.update(gameDocRef, { players: players });
                    }
                });
            } catch (error) {
                console.error("Error making decision:", error);
                showNotification("خطا", "ثبت انتخاب با مشکل مواجه شد.");
                document.querySelectorAll('.decision-button').forEach(b => b.disabled = false);
            }
        }

        // --- Chat Logic ---
        function openPrivateChat(pairId, partner) {
            document.getElementById('chat-modal-title').textContent = `چت با ${partner.displayName}`;
            chatModal.classList.add('visible');
            chatInput.focus();
            
            if(unsubscribeChat) unsubscribeChat(); // Unsubscribe from previous chat
            chatMessagesEl.innerHTML = '';
            
            const chatCollectionRef = collection(db, `games/${gameId}/privateChats/${pairId}/messages`);
            const q = query(chatCollectionRef, orderBy('createdAt', 'asc'));

            unsubscribeChat = onSnapshot(q, (snapshot) => {
                 snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        renderChatMessage(change.doc.data());
                        if (change.doc.data().senderUid !== currentUser.uid) playSound('sound-new-message');
                    }
                 });
            });
        }
        
        async function handleSendMessage(e) {
            e.preventDefault();
            const text = chatInput.value.trim();
            if(!text || !currentGameState) return;
            
            const myPair = currentGameState.pairs.find(p => p.playerA === currentUser.uid || p.playerB === currentUser.uid);
            if(!myPair) return;

            const chatCollectionRef = collection(db, `games/${gameId}/privateChats/${myPair.pairId}/messages`);
            chatInput.value = '';
            try {
                await addDoc(chatCollectionRef, {
                    senderUid: currentUser.uid,
                    senderName: currentUserData.displayName,
                    text: text,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error sending chat message:", error);
            }
        }
        
        function renderChatMessage(data) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-message';
            if(data.senderUid === currentUser.uid) {
                msgDiv.classList.add('self');
            }
            msgDiv.innerHTML = `<div class="chat-message-bubble">${data.text}</div>`;
            chatMessagesEl.appendChild(msgDiv);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        // --- Utility & Helper Functions ---
        function computePoints(choiceA, choiceB) {
            // [pointsA, pointsB]
            if (choiceA === 'cooperate' && choiceB === 'cooperate') return [2, 2]; // Both cooperate
            if (choiceA === 'betray' && choiceB === 'cooperate') return [3, 0]; // A betrays, B cooperates
            if (choiceA === 'cooperate' && choiceB === 'betray') return [0, 3]; // A cooperates, B betrays
            if (choiceA === 'betray' && choiceB === 'betray') return [1, 1]; // Both betray
            return [0, 0]; // Default/Error case
        }

        function getChoiceIndicator(choice) {
            if (choice === 'cooperate') return '🤝';
            if (choice === 'betray') return '⚔️';
            if (choice) return '✔️'; // Made a choice, but it's hidden
            return '...'; // Waiting
        }
        
        function showPartnerInfo(partner) {
            partnerInfoEl.style.display = 'flex';
            document.getElementById('partner-avatar').src = partner.avatar || 'https://up.20script.ir/file/1d50-defult.png';
            document.getElementById('partner-name').textContent = `شریک شما: ${partner.displayName}`;
        }
        
        function showResultModal(myResult, partnerResult, partnerData) {
            document.getElementById('result-my-avatar').src = currentUserData.avatarUrl || 'https://up.20script.ir/file/1d50-defult.png';
            document.getElementById('result-partner-avatar').src = partnerData.avatar || 'https://up.20script.ir/file/1d50-defult.png';
            document.getElementById('result-partner-name').textContent = partnerData.displayName;
            
            const myChoiceEl = document.getElementById('result-my-choice');
            const partnerChoiceEl = document.getElementById('result-partner-choice');
            myChoiceEl.textContent = myResult.choice === 'cooperate' ? 'همکاری' : 'خیانت';
            myChoiceEl.className = `result-player-choice ${myResult.choice}`;
            partnerChoiceEl.textContent = partnerResult.choice === 'cooperate' ? 'همکاری' : 'خیانت';
            partnerChoiceEl.className = `result-player-choice ${partnerResult.choice}`;

            const myPointsEl = document.getElementById('result-my-points');
            const partnerPointsEl = document.getElementById('result-partner-points');
            myPointsEl.textContent = `${myResult.points >= 0 ? '+' : ''}${myResult.points}`;
            myPointsEl.className = `result-points ${myResult.points > 0 ? 'positive' : 'negative'}`;
            partnerPointsEl.textContent = `${partnerResult.points >= 0 ? '+' : ''}${partnerResult.points}`;
            partnerPointsEl.className = `result-points ${partnerResult.points > 0 ? 'positive' : 'negative'}`;
            
            resultModal.classList.add('visible');
        }

        function playSound(soundId) { try { document.getElementById(soundId).play(); } catch(e) { console.warn("Sound play failed", e); } }
        function startTimer(duration, onComplete) {
            stopTimer();
            let timer = duration;
            countdownInterval = setInterval(() => {
                const minutes = Math.floor(timer / 60);
                const seconds = timer % 60;
                countdownTimerEl.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                if (--timer < 0) {
                    stopTimer();
                    if (onComplete) onComplete();
                }
            }, 1000);
        }
        function stopTimer() { clearInterval(countdownInterval); countdownTimerEl.textContent = "--:--"; }
        function hideLoading() { loadingOverlay.style.opacity = '0'; setTimeout(() => { loadingOverlay.style.display = 'none'; gameContainer.classList.add('visible'); }, 500); }
        function closeAllModals() { chatModal.classList.remove('visible'); resultModal.classList.remove('visible'); }
        
        function showNotification(title, message, onOk) {
            const modal = document.getElementById('notification-modal');
            document.getElementById('notification-modal-title').textContent = title;
            document.getElementById('notification-modal-message').textContent = message;
            const okBtn = document.getElementById('notification-modal-ok-btn');
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            newOkBtn.addEventListener('click', () => { modal.classList.remove('visible'); if(onOk) onOk(); });
            modal.classList.add('visible');
        }

        function cleanUp() {
            if(unsubscribeGame) unsubscribeGame();
            if(unsubscribeChat) unsubscribeChat();
            stopTimer();
        }

        function setupEventListeners() {
            decisionButtonsContainer.addEventListener('click', (e) => {
                const choice = e.target.closest('.decision-button')?.dataset.choice;
                if(choice) handleDecision(choice);
            });
            chatForm.addEventListener('submit', handleSendMessage);
            document.getElementById('leave-game-btn').addEventListener('click', () => {
                showNotification("خروج", "آیا می‌خواهید از بازی خارج شوید؟ (این عمل قابل بازگشت نیست)", () => {
                    cleanUp();
                    window.location.href = './Lobby page.html';
                });
            });
        }
        
        // --- Start the application ---
        main();
    </script>
</body>
</html>
```
