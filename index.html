<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهر مافیا - در حال بارگذاری</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --wood-dark: #0c0a09; /* Darker base for new background */
            --text-gold: #ffc947;
            --text-light: #e0dacc;
            --logo-glow-main: #ffdd00;
            --progress-bar-bg: rgba(0,0,0,0.4);
            --progress-bar-fill-start: #8c4843;
            --progress-bar-fill-end: #ffc947;
            --countdown-bg: rgba(0,0,0,0.3);
            --panel-glow: rgba(255, 201, 71, 0.5);
            /* Suspension styles */
            --suspension-red: #e74c3c;
            --suspension-border: #c0392b;
            --suspension-glow: rgba(231, 76, 60, 0.5);
            /* [NEW] Viewport height variable for mobile browsers */
            --vh: 1vh; 
        }
        @keyframes panel-intro { from { opacity: 0; transform: translateY(50px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            width: 100%;
            height: 100%; 
            overflow: hidden; 
        }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--wood-dark);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #preloader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: calc(var(--vh, 1vh) * 100);
            background-color: var(--wood-dark);
            z-index: 9999;
            transition: opacity 0.7s ease-in-out;
        }

        #bottom-loader {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px 40px 30px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px; /* Increased gap */
            z-index: 100;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
        }
        
        /* [MODIFIED] Progress bar is now thicker */
        #bottom-loader #progress-bar-container {
            width: 100%;
            max-width: 480px;
            height: 12px; /* Increased from 8px */
            background-color: var(--progress-bar-bg);
            border-radius: 6px; /* Increased from 4px */
            overflow: hidden;
            padding: 2px;
            border: 1px solid rgba(255, 201, 71, 0.2);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
        }
        #bottom-loader #progress-bar-fill {
            width: 0%;
            height: 100%;
            border-radius: 4px; /* Increased from 2px */
            background: linear-gradient(90deg, var(--progress-bar-fill-start), var(--progress-bar-fill-end));
            transition: width 0.4s cubic-bezier(0.65, 0, 0.35, 1);
        }
        
        /* [NEW] Container for status message and percentage */
        #status-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 480px;
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--text-light);
            opacity: 0.9;
            min-height: 1.2em;
        }
        #status-message {
             /* Styles are now mainly on the container */
        }
        #status-percentage {
            font-weight: 700;
            font-variant-numeric: tabular-nums; /* Keeps width of numbers consistent */
            direction: ltr; /* Percentages should be LTR */
        }
        
        .panel {
            width: 90%;
            max-width: 480px;
            background: rgba(10, 5, 2, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 1px solid rgba(255, 201, 71, 0.25);
            padding: 30px 40px;
            text-align: center;
            animation: panel-intro 1s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }
        
        #maintenance-panel { box-shadow: 0 0 25px var(--panel-glow), 0 15px 45px rgba(0, 0, 0, 0.7); padding: 25px; }
        #maintenance-banner-container { width: 100%; margin-bottom: 25px; border-radius: 16px; overflow: hidden; background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255, 201, 71, 0.2); }
        #maintenance-banner { width: 100%; height: auto; display: block; }
        #maintenance-title { font-size: 2rem; font-weight: 900; color: var(--text-gold); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #maintenance-message { font-size: 1rem; line-height: 1.8; margin-bottom: 30px; color: var(--text-light); padding: 0 15px; }
        
        .countdown-timer { display: flex; flex-direction: row-reverse; justify-content: center; gap: 15px; }
        .time-block { background-color: var(--countdown-bg); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 201, 71, 0.15); min-width: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .time-value { font-size: 3rem; font-weight: 900; color: white; line-height: 1; }
        .time-label { font-size: 0.8rem; font-weight: 400; color: var(--text-light); margin-top: 8px; }

        #suspension-panel { border-color: var(--suspension-border); box-shadow: 0 0 25px var(--suspension-glow), 0 15px 45px rgba(0, 0, 0, 0.7); padding: 35px; }
        
        #suspension-user-info { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        #suspension-avatar { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 3px solid var(--suspension-red); box-shadow: 0 5px 15px rgba(0,0,0,0.5); margin-bottom: 15px; }
        #suspension-username { font-size: 1.5rem; font-weight: 700; color: var(--text-light); text-shadow: 1px 1px 3px #000; }
        
        #suspension-title { font-size: 2rem; color: var(--suspension-red); margin-bottom: 15px; font-weight: 900; }
        #suspension-reason { font-size: 1.1rem; margin-bottom: 25px; padding: 12px; background-color: rgba(0,0,0,0.3); border-radius: 8px; font-style: italic; border: 1px solid rgba(255,255,255,0.1); }
        #suspension-message { margin-bottom: 20px; font-size: 1rem; color: var(--text-light); }
        
        #suspension-countdown-timer { margin-bottom: 35px; }
        #suspension-countdown-timer .time-block { border-color: var(--suspension-border); background-color: rgba(231, 76, 60, 0.1); }
        #suspension-countdown-timer .time-value { color: #f8d7da; }
        #suspension-countdown-timer .time-label { color: #f5c6cb; }

        #logout-btn { background: linear-gradient(145deg, #616161, #3a3a3a); border: 1px solid #777; color: var(--text-light); padding: 12px 30px; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        #logout-btn:hover { background: linear-gradient(145deg, #757575, #4f4f4f); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        #logout-btn:active { transform: translateY(0); }
    </style>
</head>
<body>

    <div id="preloader-overlay"></div>

    <div id="bottom-loader" style="display: flex;">
        <div id="progress-bar-container">
            <div id="progress-bar-fill"></div>
        </div>
        <!-- [MODIFIED] Replaced <p> with a container for message and percentage -->
        <div id="status-container">
            <span id="status-message">در حال آماده سازی...</span>
            <span id="status-percentage"></span>
        </div>
    </div>

    <div id="maintenance-panel" class="panel" style="display: none;">
        <div id="maintenance-banner-container"><img id="maintenance-banner" src="" alt="بنر بروزرسانی"></div>
        <h1 id="maintenance-title"></h1>
        <p id="maintenance-message"></p>
        <div class="countdown-timer">
            <div class="time-block"><div id="days" class="time-value">00</div><div class="time-label">روز</div></div>
            <div class="time-block"><div id="hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
            <div class="time-block"><div id="minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
            <div class="time-block"><div id="seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
    </div>

    <div id="suspension-panel" class="panel" style="display: none;">
        <div id="suspension-user-info">
            <img id="suspension-avatar" src="" alt="آواتار کاربر">
            <h3 id="suspension-username"></h3>
        </div>
        <h1 id="suspension-title">حساب کاربری مسدود است</h1>
        <p id="suspension-reason"></p>
        <p id="suspension-message">زمان باقی‌مانده تا رفع مسدودیت:</p>
        <div id="suspension-countdown-timer" class="countdown-timer">
             <div class="time-block"><div id="s-days" class="time-value">00</div><div class="time-label">روز</div></div>
             <div class="time-block"><div id="s-hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
             <div class="time-block"><div id="s-minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
             <div class="time-block"><div id="s-seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
        <button id="logout-btn">خروج از حساب</button>
    </div>
    
    <audio id="background-music" loop></audio>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
            authDomain: "mafia-9fcbf.firebaseapp.com",
            projectId: "mafia-9fcbf",
            storageBucket: "mafia-9fcbf.appspot.com",
            messagingSenderId: "471627157488",
            appId: "1:471627157488:web:92f008548a5596619a5735",
            measurementId: "G-0PDHDWC6NV"
        };
        
        const setVh = () => {
            document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
        };
        window.addEventListener('resize', setVh);
        setVh(); 

        // --- DOM Elements ---
        const progressBarFill = document.getElementById('progress-bar-fill');
        const statusMessageEl = document.getElementById('status-message');
        const statusPercentageEl = document.getElementById('status-percentage');
        const backgroundMusic = document.getElementById('background-music');
        const bottomLoader = document.getElementById('bottom-loader');
        const maintenancePanel = document.getElementById('maintenance-panel');
        const suspensionPanel = document.getElementById('suspension-panel');
        const logoutBtn = document.getElementById('logout-btn');
        const allViews = [bottomLoader, maintenancePanel, suspensionPanel];

        // --- Constants ---
        const MUSIC_URL = "https://raw.githubusercontent.com/abolfazl140122/mafia/main/dark-music-249503.mp3";
        const MUSIC_CACHE_NAME = 'mafia-music-cache-v1';
        const MUSIC_VERSION_KEY = 'mafia-music-version';
        const DEFAULT_AVATAR = 'https://i.imgur.com/T2bT1tG.png';

        function showView(viewName) {
            allViews.forEach(view => view.style.display = 'none');
            switch (viewName) {
                case 'loading': bottomLoader.style.display = 'flex'; break;
                case 'maintenance': maintenancePanel.style.display = 'block'; break;
                case 'suspended': suspensionPanel.style.display = 'block'; break;
                default: console.error(`Unknown view: ${viewName}`);
            }
        }
        
        // --- [MODIFIED] New Progress Update Functions ---
        const updateOverallProgress = (percentage) => {
            progressBarFill.style.width = `${percentage}%`;
        };

        const updateTaskStatus = (message, percentage) => {
            statusMessageEl.textContent = message;
            if (percentage !== null && percentage !== undefined) {
                statusPercentageEl.textContent = `${Math.round(percentage)}%`;
                statusPercentageEl.style.display = 'inline';
            } else {
                statusPercentageEl.style.display = 'none';
                statusPercentageEl.textContent = '';
            }
        };
        
        const showLoadingError = (message) => {
            updateOverallProgress(100);
            updateTaskStatus(message, null);
            progressBarFill.style.background = 'linear-gradient(90deg, #c0392b, #e74c3c)';
        };

        // --- Helper Functions ---
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        
        function playMusicFromBlob(blob) { /* ... (Function unchanged) ... */ try { const objectUrl = URL.createObjectURL(blob); backgroundMusic.src = objectUrl; backgroundMusic.volume = 0.4; backgroundMusic.play().catch(e => console.warn("پخش خودکار موسیقی توسط مرورگر مسدود شد.", e)); } catch (error) { console.error("خطا در ایجاد URL برای پخش موسیقی:", error); } }
        function downloadAndCacheMusic(progressCallback) { /* ... (Function unchanged) ... */ return new Promise((resolve, reject) => { const xhr = new XMLHttpRequest(); xhr.open('GET', MUSIC_URL, true); xhr.responseType = 'blob'; xhr.onprogress = (event) => { if (event.lengthComputable) { const percentComplete = Math.round((event.loaded / event.total) * 100); progressCallback(percentComplete); } }; xhr.onload = async () => { if (xhr.status === 200) { const musicBlob = xhr.response; try { const cache = await caches.open(MUSIC_CACHE_NAME); await cache.put(MUSIC_URL, new Response(musicBlob)); localStorage.setItem(MUSIC_VERSION_KEY, MUSIC_URL); resolve(musicBlob); } catch (cacheError) { reject(cacheError); } } else { reject(new Error(`خطای شبکه در دانلود موسیقی: ${xhr.statusText}`)); } }; xhr.onerror = () => { reject(new Error('خطای شبکه در هنگام دانلود موسیقی.')); }; xhr.send(); }); }
        
        // [MODIFIED] Music handler now accepts a progress callback for the task runner
        async function handleBackgroundMusic(onProgress) {
            const cachedVersion = localStorage.getItem(MUSIC_VERSION_KEY);
            try {
                if (cachedVersion === MUSIC_URL) {
                    const cache = await caches.open(MUSIC_CACHE_NAME);
                    const cachedResponse = await cache.match(MUSIC_URL);
                    if (cachedResponse) {
                        onProgress(50);
                        const musicBlob = await cachedResponse.blob();
                        playMusicFromBlob(musicBlob);
                        onProgress(100);
                        return;
                    }
                }
                const musicBlob = await downloadAndCacheMusic(onProgress);
                playMusicFromBlob(musicBlob);
            } catch (error) {
                console.error('فرایند مدیریت موسیقی با خطا مواجه شد:', error);
                // Don't throw an error, just log it. Music is not critical.
            }
        }

        async function transitionToGame(displayName) { /* ... (Function unchanged) ... */ showView('loading'); updateOverallProgress(100); updateTaskStatus(`خوش آمدید، ${displayName}!`, null); await delay(2000); window.location.href = './main.html'; }
        
        // --- View Population & Countdown Logic (All functions unchanged) ---
        function populateSuspensionPanel(config, auth, db) { const displayName = config.displayName || 'کاربر'; document.getElementById('suspension-avatar').src = config.avatarUrl || DEFAULT_AVATAR; document.getElementById('suspension-username').textContent = displayName; document.getElementById('suspension-reason').textContent = `دلیل: ${config.banReason || 'نامشخص'}`; startSuspensionCountdown(config.banExpiresAt.toDate(), auth, db, displayName); logoutBtn.onclick = () => { signOut(auth).then(() => { window.location.href = './login.html'; }).catch(err => { console.error('Logout error:', err); alert('خطا در خروج از حساب.'); }); }; }
        function startSuspensionCountdown(targetDate, auth, db, displayName) { const countdownElements = { days: document.getElementById('s-days'), hours: document.getElementById('s-hours'), minutes: document.getElementById('s-minutes'), seconds: document.getElementById('s-seconds') }; const interval = setInterval(async () => { const distance = targetDate.getTime() - new Date().getTime(); if (distance < 0) { clearInterval(interval); try { const userDocRef = doc(db, 'users', auth.currentUser.uid); await updateDoc(userDocRef, { isBanned: false, banReason: null, banExpiresAt: null }); console.log("مسدودیت کاربر به صورت خودکار رفع شد."); } catch(e) { console.error("خطا در رفع خودکار مسدودیت:", e); } await transitionToGame(displayName); return; } const f = (n) => String(Math.floor(n)).padStart(2, '0'); countdownElements.days.textContent = f(distance / (1000 * 60 * 60 * 24)); countdownElements.hours.textContent = f((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); countdownElements.minutes.textContent = f((distance % (1000 * 60 * 60)) / (1000 * 60)); countdownElements.seconds.textContent = f((distance % (1000 * 60)) / 1000); }, 1000); }
        function populateMaintenancePanel(config) { const bannerContainer = document.getElementById('maintenance-banner-container'); if (config.imageUrl) { document.getElementById('maintenance-banner').src = config.imageUrl; bannerContainer.style.display = 'block'; } else { bannerContainer.style.display = 'none'; } const titleEl = document.getElementById('maintenance-title'); titleEl.textContent = config.title || "در حال بروزرسانی"; if (config.titleColor) { titleEl.style.color = config.titleColor; } const messageEl = document.getElementById('maintenance-message'); messageEl.textContent = config.message || "به زودی باز خواهیم گشت."; if (config.textColor) { messageEl.style.color = config.textColor; } }
        function handleMaintenanceFinish(auth, db) { document.getElementById('maintenance-title').textContent = "بروزرسانی به پایان رسید"; document.getElementById('maintenance-message').textContent = "در حال هدایت شما به بازی..."; const countdownElements = { days: document.getElementById('days'), hours: document.getElementById('hours'), minutes: document.getElementById('minutes'), seconds: document.getElementById('seconds') }; Object.values(countdownElements).forEach(el => el.textContent = '00'); setTimeout(() => { showView('loading'); startNewLoadingSequence(auth, db).catch(err => console.error("Error after maintenance:", err)); }, 2500); }
        function startMaintenanceCountdown(targetDate, auth, db) { const countdownElements = { days: document.getElementById('days'), hours: document.getElementById('hours'), minutes: document.getElementById('minutes'), seconds: document.getElementById('seconds') }; const interval = setInterval(() => { const distance = targetDate.getTime() - new Date().getTime(); if (distance < 0) { clearInterval(interval); handleMaintenanceFinish(auth, db); return; } const f = (n) => String(Math.floor(n)).padStart(2, '0'); countdownElements.days.textContent = f(distance / (1000 * 60 * 60 * 24)); countdownElements.hours.textContent = f((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); countdownElements.minutes.textContent = f((distance % (1000 * 60 * 60)) / (1000 * 60)); countdownElements.seconds.textContent = f((distance % (1000 * 60)) / 1000); }, 1000); }

        // --- [NEW] Core Application Logic with Task Runner ---

        // Helper to simulate progress for quick, non-trackable async operations
        async function withSimulatedProgress(promise, onProgress) {
            let progress = 0;
            const interval = setInterval(() => {
                if (progress < 95) {
                    progress += Math.random() * 8 + 2; // Random increment
                    onProgress(Math.min(progress, 95));
                }
            }, 120);

            try {
                return await promise;
            } finally {
                clearInterval(interval);
                onProgress(100);
            }
        }
        
        // The main task runner
        async function runTaskSequence(tasks, auth, db) {
            const totalTasks = tasks.length;
            let context = {}; // Shared context for tasks

            for (let i = 0; i < totalTasks; i++) {
                const task = tasks[i];
                
                const result = await task.action(
                    (progress) => updateTaskStatus(`${task.name}...`, progress),
                    context, auth, db
                );

                context = { ...context, ...result };
                updateOverallProgress(((i + 1) / totalTasks) * 100);
                await delay(200); // Short delay for better UX
            }
            return context;
        }
        
        async function startNewLoadingSequence(auth, db) {
            const loadingTasks = [
                {
                    name: "احراز هویت کاربر",
                    action: async (onProgress, context, auth) => {
                        const promise = new Promise((resolve, reject) => {
                            const unsubscribe = onAuthStateChanged(auth, user => {
                                unsubscribe();
                                if (user) resolve({ user });
                                else reject({ type: 'NO_USER' });
                            }, error => reject({ type: 'ERROR', error }));
                        });
                        return await withSimulatedProgress(promise, onProgress);
                    }
                },
                {
                    name: "دریافت اطلاعات بازیکن",
                    action: async (onProgress, context, auth, db) => {
                        const userDocRef = doc(db, 'users', context.user.uid);
                        const userDocSnap = await withSimulatedProgress(getDoc(userDocRef), onProgress);
                        if (!userDocSnap.exists()) {
                            // This case might need specific handling, but for now we proceed
                            return { displayName: context.user.displayName || 'بازیکن جدید' };
                        }
                        return { userData: userDocSnap.data(), displayName: userDocSnap.data().displayName || context.user.displayName };
                    }
                },
                {
                    name: "بررسی وضعیت حساب",
                    action: async (onProgress, context) => {
                        const promise = new Promise((resolve, reject) => {
                            const userData = context.userData;
                            if (userData && userData.isBanned === true && userData.banExpiresAt && userData.banExpiresAt.toDate() > new Date()) {
                                reject({ type: 'BANNED', config: userData });
                            } else {
                                resolve();
                            }
                        });
                        return await withSimulatedProgress(promise, onProgress);
                    }
                },
                {
                    name: "بارگذاری منابع",
                    action: async (onProgress) => {
                        await handleBackgroundMusic(onProgress);
                        return {};
                    }
                }
            ];

            try {
                const finalContext = await runTaskSequence(loadingTasks, auth, db);
                await transitionToGame(finalContext.displayName);
            } catch (rejection) {
                if (rejection.type === 'BANNED') {
                    populateSuspensionPanel(rejection.config, auth, db);
                    showView('suspended');
                } else if (rejection.type === 'NO_USER') {
                    showLoadingError('احراز هویت ناموفق بود. در حال انتقال به صفحه ورود...');
                    await delay(2500);
                    window.location.href = './login.html';
                } else {
                    console.error("خطای جدی در فرآیند بارگذاری:", rejection.error || rejection);
                    showLoadingError('خطا در بارگذاری. لطفاً صفحه را رفرش کنید.');
                }
            }
        }
        
        async function runAppInitialization() {
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                
                const maintenanceDocRef = doc(db, 'settings', 'maintenance');
                const docSnap = await getDoc(maintenanceDocRef);

                if (docSnap.exists() && docSnap.data().enabled === true) {
                    const config = docSnap.data();
                    populateMaintenancePanel(config);
                    showView('maintenance');
                    if (config.endTime && typeof config.endTime.toDate === 'function') {
                        const targetDate = config.endTime.toDate();
                        if (targetDate.getTime() - new Date().getTime() < 0) {
                            handleMaintenanceFinish(auth, db);
                        } else {
                            startMaintenanceCountdown(targetDate, auth, db);
                        }
                    } else {
                        document.querySelector('#maintenance-panel .countdown-timer').innerHTML = "<p>زمان پایان مشخص نشده است.</p>";
                    }
                } else {
                    // Loader is now visible from the start, delay removed.
                    showView('loading'); // Ensure other views are hidden
                    updateTaskStatus('در حال آماده سازی...', null);
                    await startNewLoadingSequence(auth, db);
                }
            } catch (error) {
                console.error("خطا در اتصال اولیه:", error);
                // Removed delay to show error immediately
                showView('loading');
                showLoadingError('خطا در اتصال! اینترنت خود را بررسی کنید.');
            }
        }
        
        async function main() {
            const preloaderOverlay = document.getElementById('preloader-overlay');
            const body = document.body;
            const imageUrl = 'https://cdn.imgurl.ir/uploads/q9812_file_6917756f1e1d68.57033147.jpg';

            const startApp = () => {
                preloaderOverlay.style.opacity = '0';
                preloaderOverlay.addEventListener('transitionend', () => preloaderOverlay.style.display = 'none', { once: true });
                runAppInitialization();
            };

            const img = new Image();
            img.src = imageUrl;

            if (img.complete) {
                body.style.backgroundImage = `url(${imageUrl})`;
                startApp();
            } else {
                img.onload = () => { body.style.backgroundImage = `url(${imageUrl})`; startApp(); };
                img.onerror = () => { console.warn('تصویر پس‌زمینه دانلود نشد.'); startApp(); };
            }
        }

        main();
    </script>
</body>
</html>