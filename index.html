<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهر مافیا - در حال بارگذاری</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --wood-dark: #0c0a09;
            --text-gold: #ffc947;
            --text-light: #e0dacc;
            --progress-bar-bg: rgba(0,0,0,0.4);
            --progress-bar-fill-start: #ffc947;
            --progress-bar-fill-end: #d97706;
            --countdown-bg: rgba(0,0,0,0.3);
            --panel-bg: rgba(23, 17, 12, 0.85);
            --panel-border: #4a3f35;
            --panel-glow: rgba(255, 201, 71, 0.4);
            --suspension-red: #e74c3c;
            --suspension-border: #c0392b;
            --suspension-glow: rgba(231, 76, 60, 0.5);
            --vh: 1vh;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes panel-intro { from { opacity: 0; transform: translateY(50px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 5px var(--text-gold), 0 0 10px var(--text-gold); }
            50% { text-shadow: 0 0 10px var(--text-gold), 0 0 20px var(--text-gold); }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background: url('https://www.transparenttextures.com/patterns/dark-wood.png') var(--wood-dark);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }

        #preloader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--wood-dark);
            z-index: 1000;
            animation: fadeIn 0.5s ease-in;
            transition: opacity 0.8s ease-out;
        }

        #bottom-loader {
            position: fixed;
            bottom: 5vh;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 12px;
            animation: fadeIn 1s 0.5s ease-in both;
        }

        #progress-bar-container {
            width: 100%;
            height: 12px;
            background-color: var(--progress-bar-bg);
            border-radius: 10px;
            border: 1px solid var(--panel-border);
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }

        #progress-bar-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--progress-bar-fill-start), var(--progress-bar-fill-end));
            border-radius: 10px;
            transition: width 0.3s ease-out;
        }

        #status-container {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--text-light);
            padding: 0 5px;
        }
        
        #status-message {
            font-weight: 400;
        }

        #status-percentage {
            font-weight: 700;
            color: var(--text-gold);
        }
        
        .panel {
            width: 90%;
            max-width: 500px;
            background-color: var(--panel-bg);
            border: 2px solid var(--panel-border);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 0 20px var(--panel-glow);
            backdrop-filter: blur(5px);
            animation: panel-intro 0.7s ease-out forwards;
            z-index: 50;
        }

        .panel h1 {
            font-size: 24px;
            font-weight: 900;
            color: var(--text-gold);
            margin-bottom: 15px;
            animation: glow 2s infinite;
        }

        .panel p {
            font-size: 16px;
            line-height: 1.7;
            margin-bottom: 25px;
        }
        
        #maintenance-banner-container {
            width: 100%;
            margin-bottom: 20px;
        }
        
        #maintenance-banner {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            border: 2px solid var(--panel-border);
        }

        .countdown-timer {
            display: flex;
            justify-content: center;
            gap: 15px;
            direction: ltr;
        }

        .time-block {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .time-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-gold);
            background-color: var(--countdown-bg);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--panel-border);
            min-width: 60px;
        }

        .time-label {
            font-size: 12px;
            margin-top: 5px;
            color: var(--text-light);
        }

        /* Suspension Panel Styles */
        #suspension-panel {
            box-shadow: 0 0 20px var(--suspension-glow);
            border-color: var(--suspension-border);
        }

        #suspension-panel h1 {
            color: var(--suspension-red);
            animation: none;
            text-shadow: 0 0 8px rgba(0,0,0,0.7);
        }
        
        #suspension-user-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        #suspension-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--suspension-border);
        }
        
        #suspension-username {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-light);
        }
        
        #suspension-reason {
            font-weight: 700;
            background-color: var(--countdown-bg);
            padding: 10px;
            border-radius: 5px;
            border-right: 4px solid var(--suspension-red);
        }

        .suspension-message {
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        #logout-btn {
            margin-top: 25px;
            padding: 12px 25px;
            border: 2px solid var(--suspension-border);
            background-color: var(--suspension-red);
            color: white;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 16px;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        #logout-btn:hover {
            background-color: var(--suspension-border);
            box-shadow: 0 0 15px var(--suspension-glow);
        }
    </style>
</head>
<body>

    <div id="preloader-overlay"></div>

    <div id="bottom-loader" style="display: none;">
        <div id="progress-bar-container">
            <div id="progress-bar-fill"></div>
        </div>
        <div id="status-container">
            <span id="status-message">در حال آماده سازی...</span>
            <span id="status-percentage">0%</span>
        </div>
    </div>

    <!-- پنل حالت تعمیرات -->
    <div id="maintenance-panel" class="panel" style="display: none;">
        <div id="maintenance-banner-container"><img id="maintenance-banner" src="" alt="بنر بروزرسانی"></div>
        <h1 id="maintenance-title"></h1>
        <p id="maintenance-message"></p>
        <div class="countdown-timer">
            <div class="time-block"><div id="days" class="time-value">00</div><div class="time-label">روز</div></div>
            <div class="time-block"><div id="hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
            <div class="time-block"><div id="minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
            <div class="time-block"><div id="seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
    </div>

    <!-- پنل کاربر مسدود شده -->
    <div id="suspension-panel" class="panel" style="display: none;">
        <div id="suspension-user-info">
            <img id="suspension-avatar" src="" alt="آواتار کاربر">
            <h3 id="suspension-username"></h3>
        </div>
        <h1 id="suspension-title">حساب کاربری مسدود است</h1>
        <p id="suspension-reason"></p>
        <p class="suspension-message">زمان باقی‌مانده تا رفع مسدودیت:</p>
        <div id="suspension-countdown-timer" class="countdown-timer">
             <div class="time-block"><div id="s-days" class="time-value">00</div><div class="time-label">روز</div></div>
             <div class="time-block"><div id="s-hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
             <div class="time-block"><div id="s-minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
             <div class="time-block"><div id="s-seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
        <button id="logout-btn">خروج از حساب</button>
    </div>
    
    <audio id="background-music" loop></audio>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIGURATION ---
            const API_URL = 'mafianovin.php'; // آدرس فایل PHP واسط شما
            const API_SECRET_KEY = 'sjnrsontORFBioerrt4651renttn'; // کلید امنیتی شما

            // --- DOM ELEMENTS ---
            const elements = {
                preloaderOverlay: document.getElementById('preloader-overlay'),
                bottomLoader: document.getElementById('bottom-loader'),
                progressBarFill: document.getElementById('progress-bar-fill'),
                statusMessage: document.getElementById('status-message'),
                statusPercentage: document.getElementById('status-percentage'),
                maintenancePanel: document.getElementById('maintenance-panel'),
                suspensionPanel: document.getElementById('suspension-panel'),
                backgroundMusic: document.getElementById('background-music'),
            };
            
            let countdownInterval = null;

            // --- HELPER FUNCTIONS ---

            /**
             * Handles API calls to the PHP proxy.
             * @param {string} action - The action to perform (e.g., 'get', 'set').
             * @param {string} path - The Firebase database path.
             * @param {object|null} data - The data payload for 'set', 'update', 'push'.
             * @returns {Promise<any>} - The data from the API response.
             */
            async function apiCall(action, path, data = null) {
                try {
                    const requestBody = {
                        secret_key: API_SECRET_KEY,
                        action: action,
                        path: path,
                    };
                    if (data !== null) {
                        requestBody.data = data;
                    }

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.status === 'error') {
                        throw new Error(result.message);
                    }
                    
                    return result.data;

                } catch (error) {
                    console.error('API Call Failed:', error);
                    // Show a generic error message on the screen
                    updateStatus('خطا در برقراری ارتباط با سرور', 100, true);
                    throw error; // Re-throw to stop further execution
                }
            }
            
            /**
             * Updates the loading status message and progress bar.
             * @param {string} message - The message to display.
             * @param {number} percentage - The progress percentage (0-100).
             * @param {boolean} isError - If true, styles the bar as an error.
             */
            function updateStatus(message, percentage, isError = false) {
                elements.statusMessage.textContent = message;
                elements.statusPercentage.textContent = `${Math.round(percentage)}%`;
                elements.progressBarFill.style.width = `${percentage}%`;
                if(isError) {
                    elements.progressBarFill.style.background = 'var(--suspension-red)';
                }
            }
            
            /**
             * Starts a countdown timer and updates the DOM elements.
             * @param {string} endTime - The ISO 8601 timestamp for the countdown end.
             * @param {string} prefix - The prefix for DOM element IDs ('s-' for suspension, '' for maintenance).
             */
            function startCountdown(endTime, prefix = '') {
                if (countdownInterval) clearInterval(countdownInterval);

                const end = new Date(endTime).getTime();

                countdownInterval = setInterval(() => {
                    const now = new Date().getTime();
                    const distance = end - now;

                    if (distance < 0) {
                        clearInterval(countdownInterval);
                        // Optional: Reload the page or show a message
                        document.getElementById(`${prefix}days`).textContent = '00';
                        document.getElementById(`${prefix}hours`).textContent = '00';
                        document.getElementById(`${prefix}minutes`).textContent = '00';
                        document.getElementById(`${prefix}seconds`).textContent = '00';
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    document.getElementById(`${prefix}days`).textContent = String(days).padStart(2, '0');
                    document.getElementById(`${prefix}hours`).textContent = String(hours).padStart(2, '0');
                    document.getElementById(`${prefix}minutes`).textContent = String(minutes).padStart(2, '0');
                    document.getElementById(`${prefix}seconds`).textContent = String(seconds).padStart(2, '0');
                }, 1000);
            }

            // --- UI LOGIC ---

            function hideAllPanels() {
                elements.maintenancePanel.style.display = 'none';
                elements.suspensionPanel.style.display = 'none';
                elements.bottomLoader.style.display = 'none';
            }

            function showMaintenance(data) {
                hideAllPanels();
                document.getElementById('maintenance-title').textContent = data.title || 'در دست تعمیر هستیم';
                document.getElementById('maintenance-message').textContent = data.message || 'برای ارائه خدمات بهتر، سرورهای بازی به طور موقت از دسترس خارج شده‌اند. به زودی باز خواهیم گشت.';
                const banner = document.getElementById('maintenance-banner');
                if (data.bannerUrl) {
                    banner.src = data.bannerUrl;
                    banner.parentElement.style.display = 'block';
                } else {
                    banner.parentElement.style.display = 'none';
                }
                elements.maintenancePanel.style.display = 'block';
                if (data.endTime) {
                    startCountdown(data.endTime);
                }
            }

            function showSuspension(data) {
                hideAllPanels();
                document.getElementById('suspension-username').textContent = data.username || 'کاربر';
                document.getElementById('suspension-avatar').src = data.avatarUrl || 'https://via.placeholder.com/80';
                document.getElementById('suspension-reason').textContent = `دلیل: ${data.reason || 'نامشخص'}`;
                elements.suspensionPanel.style.display = 'block';
                 if (data.endTime) {
                    startCountdown(data.endTime, 's-');
                }
                document.getElementById('logout-btn').onclick = () => {
                    // Your logout logic here (e.g., clear local storage, redirect)
                    console.log("Logout button clicked");
                };
            }

            async function runNormalLoad(data) {
                elements.bottomLoader.style.display = 'flex';
                
                if (data.musicUrl) {
                    elements.backgroundMusic.src = data.musicUrl;
                    elements.backgroundMusic.play().catch(e => console.log("Music autoplay was blocked."));
                }
                
                // Simulate loading assets
                updateStatus('بررسی فایل‌های اولیه...', 10);
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateStatus('دریافت اطلاعات کاربر...', 30);
                await new Promise(resolve => setTimeout(resolve, 600));

                updateStatus('بارگذاری منابع بازی...', 75);
                await new Promise(resolve => setTimeout(resolve, 1200));

                updateStatus('آماده‌سازی صحنه...', 95);
                await new Promise(resolve => setTimeout(resolve, 400));
                
                updateStatus('ورود به بازی...', 100);
                
                // Fade out and redirect
                elements.preloaderOverlay.style.opacity = '0';
                elements.bottomLoader.style.opacity = '0';
                
                setTimeout(() => {
                    console.log("Loading complete. Redirecting to game...");
                    // window.location.href = data.gameUrl || '/game.html';
                }, 800);
            }

            // --- MAIN EXECUTION ---
            async function startLoadingSequence() {
                try {
                    // Step 1: Get the overall status from Firebase via PHP proxy
                    const statusData = await apiCall('get', 'loading/status');

                    if (!statusData || !statusData.mode) {
                        throw new Error("Invalid status data received from server.");
                    }

                    // Step 2: Decide which panel to show based on the mode
                    switch (statusData.mode) {
                        case 'maintenance':
                            showMaintenance(statusData);
                            break;
                        
                        case 'suspended':
                            // Here you would typically get the user's ID from local storage/session
                            const userId = "user123"; // Replace with actual dynamic user ID
                            const suspensionData = await apiCall('get', `users/${userId}/suspension`);
                            const userData = await apiCall('get', `users/${userId}/profile`);
                            
                            if (suspensionData && suspensionData.isSuspended) {
                                showSuspension({ ...suspensionData, ...userData });
                            } else {
                                // If user is not actually suspended, proceed to normal load
                                runNormalLoad(statusData);
                            }
                            break;
                            
                        case 'normal':
                        default:
                            runNormalLoad(statusData);
                            break;
                    }

                } catch (error) {
                    console.error("Failed to initialize loading sequence:", error);
                    // The error message is already shown by apiCall's catch block
                }
            }

            // --- INITIALIZATION ---
            
            // Fix for 100vh on mobile browsers
            function setViewportHeight() {
                let vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            window.addEventListener('resize', setViewportHeight);
            setViewportHeight(); // Initial call
            
            startLoadingSequence();
        });
    </script>
</body>
</html>
