<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهر مافیا - در حال بارگذاری</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- کتابخانه سوپابیس -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --wood-dark: #1a140f;
            --wood-texture-url: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            --panel-bg-gradient: linear-gradient(145deg, #3c3022, #1e170f);
            --panel-border: #5c4a3a;
            --text-gold: #ffc947;
            --text-light: #e0dacc;
            --logo-glow-main: #ffdd00;
            --progress-bar-bg: rgba(0,0,0,0.4);
            --progress-bar-fill-start: #8c4843;
            --progress-bar-fill-end: #ffc947;
            --countdown-bg: rgba(0,0,0,0.3);
            --panel-glow: rgba(255, 201, 71, 0.5);
            /* Suspension styles */
            --suspension-red: #e74c3c;
            --suspension-border: #c0392b;
            --suspension-glow: rgba(231, 76, 60, 0.5);
        }
        @keyframes panel-intro { from { opacity: 0; transform: translateY(50px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes logo-glow { 0%, 100% { filter: drop-shadow(0 0 8px var(--logo-glow-main)) drop-shadow(0 0 16px rgba(255, 221, 0, 0.5)); } 50% { filter: drop-shadow(0 0 16px var(--logo-glow-main)) drop-shadow(0 0 32px rgba(255, 221, 0, 0.7)); } }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--wood-dark); background-image: var(--wood-texture-url); color: var(--text-light); display: flex; align-items: center; justify-content: center; }
        
        .panel { width: 90%; max-width: 480px; background: var(--panel-bg-gradient); border-radius: 24px; border: 2px solid var(--panel-border); padding: 30px 40px; text-align: center; animation: panel-intro 1s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5); }
        
        #logo-container { margin: 0 auto 25px auto; width: 180px; height: 180px; }
        #logo { width: 100%; height: auto; animation: logo-glow 3s ease-in-out infinite; }
        #title { font-size: 3rem; font-weight: 900; color: var(--text-gold); margin-bottom: 30px; text-shadow: 0 0 5px rgba(255, 201, 71, 0.5), 2px 2px 4px rgba(0,0,0,0.5); }
        #progress-bar-container { width: 100%; height: 20px; background-color: var(--progress-bar-bg); border-radius: 10px; overflow: hidden; padding: 3px; margin-bottom: 15px; border: 1px solid #5c4a3a; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); }
        #progress-bar-fill { width: 0%; height: 100%; border-radius: 7px; background: linear-gradient(90deg, var(--progress-bar-fill-start), var(--progress-bar-fill-end)); transition: width 0.4s cubic-bezier(0.65, 0, 0.35, 1); }
        #status-message { font-size: 1rem; font-weight: 700; min-height: 24px; }
        
        #maintenance-panel { box-shadow: 0 0 25px var(--panel-glow), 0 15px 45px rgba(0, 0, 0, 0.7); padding: 25px; }
        #maintenance-banner-container { width: 100%; margin-bottom: 25px; border-radius: 16px; overflow: hidden; background-color: rgba(0,0,0,0.2); border: 1px solid var(--panel-border); }
        #maintenance-banner { width: 100%; height: auto; display: block; }
        #maintenance-title { font-size: 2rem; font-weight: 900; color: var(--text-gold); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #maintenance-message { font-size: 1rem; line-height: 1.8; margin-bottom: 30px; color: var(--text-light); padding: 0 15px; }
        
        .countdown-timer { display: flex; flex-direction: row-reverse; justify-content: center; gap: 15px; }
        .time-block { background-color: var(--countdown-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--panel-border); min-width: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .time-value { font-size: 3rem; font-weight: 900; color: white; line-height: 1; }
        .time-label { font-size: 0.8rem; font-weight: 400; color: var(--text-light); margin-top: 8px; }

        /* --- [NEW] Suspension Panel Styles --- */
        #suspension-panel { border-color: var(--suspension-border); box-shadow: 0 0 25px var(--suspension-glow), 0 15px 45px rgba(0, 0, 0, 0.7); padding: 35px; }
        
        #suspension-user-info { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        #suspension-avatar { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 3px solid var(--suspension-red); box-shadow: 0 5px 15px rgba(0,0,0,0.5); margin-bottom: 15px; }
        #suspension-username { font-size: 1.5rem; font-weight: 700; color: var(--text-light); text-shadow: 1px 1px 3px #000; }
        
        #suspension-title { font-size: 2rem; color: var(--suspension-red); margin-bottom: 15px; font-weight: 900; }
        #suspension-reason { font-size: 1.1rem; margin-bottom: 25px; padding: 12px; background-color: rgba(0,0,0,0.3); border-radius: 8px; font-style: italic; border: 1px solid rgba(255,255,255,0.1); }
        #suspension-message { margin-bottom: 20px; font-size: 1rem; color: var(--text-light); }
        
        #suspension-countdown-timer { margin-bottom: 35px; }
        #suspension-countdown-timer .time-block { border-color: var(--suspension-border); background-color: rgba(231, 76, 60, 0.1); }
        #suspension-countdown-timer .time-value { color: #f8d7da; }
        #suspension-countdown-timer .time-label { color: #f5c6cb; }

        #logout-btn { background: linear-gradient(145deg, #616161, #3a3a3a); border: 1px solid #777; color: var(--text-light); padding: 12px 30px; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        #logout-btn:hover { background: linear-gradient(145deg, #757575, #4f4f4f); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        #logout-btn:active { transform: translateY(0); }
    </style>
</head>
<body>

    <div id="loading-panel" class="panel">
        <div id="logo-container"> <img id="logo" src="https://up.20script.ir/file/40b6-Copilot-20250812-110015-removebg-preview.png" alt="لوگوی شهر مافیا"> </div>
        <h1 id="title">شهر مافیا</h1>
        <div id="progress-bar-container"> <div id="progress-bar-fill"></div> </div>
        <p id="status-message">در حال آماده سازی...</p>
    </div>

    <div id="maintenance-panel" class="panel" style="display: none;">
        <div id="maintenance-banner-container"><img id="maintenance-banner" src="" alt="بنر بروزرسانی"></div>
        <h1 id="maintenance-title"></h1>
        <p id="maintenance-message"></p>
        <div class="countdown-timer">
            <div class="time-block"><div id="days" class="time-value">00</div><div class="time-label">روز</div></div>
            <div class="time-block"><div id="hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
            <div class="time-block"><div id="minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
            <div class="time-block"><div id="seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
    </div>

    <div id="suspension-panel" class="panel" style="display: none;">
        <div id="suspension-user-info">
            <img id="suspension-avatar" src="" alt="آواتار کاربر">
            <h3 id="suspension-username"></h3>
        </div>
        <h1 id="suspension-title">حساب کاربری مسدود است</h1>
        <p id="suspension-reason"></p>
        <p id="suspension-message">زمان باقی‌مانده تا رفع مسدودیت:</p>
        <div id="suspension-countdown-timer" class="countdown-timer">
             <div class="time-block"><div id="s-days" class="time-value">00</div><div class="time-label">روز</div></div>
             <div class="time-block"><div id="s-hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
             <div class="time-block"><div id="s-minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
             <div class="time-block"><div id="s-seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
        <button id="logout-btn">خروج از حساب</button>
    </div>
    
    <audio id="background-music" loop></audio>
    
    <script type="module">
        // --- اطلاعات اتصال به سوپابیس ---
        const SUPABASE_URL = 'https://fraafzyqixuvolutryso.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyYWFmenlxaXh1dm9sdXRyeXNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MDY3MDQsImV4cCI6MjA3MzI4MjcwNH0.USpriGlF3le4pKqpgbXr7Wk5k_nsvyNpT8Eq6TdWJ7A';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM Elements ---
        const progressBarFill = document.getElementById('progress-bar-fill');
        const statusMessage = document.getElementById('status-message');
        const backgroundMusic = document.getElementById('background-music');
        const loadingPanel = document.getElementById('loading-panel');
        const suspensionPanel = document.getElementById('suspension-panel');
        const logoutBtn = document.getElementById('logout-btn');
        
        // --- Constants ---
        const MUSIC_URL = "https://raw.githubusercontent.com/abolfazl140122/mafia/main/dark-music-249503.mp3";
        const MUSIC_CACHE_NAME = 'mafia-music-cache-v1';
        const MUSIC_VERSION_KEY = 'mafia-music-version';
        const DEFAULT_AVATAR = 'https://i.imgur.com/T2bT1tG.png';

        // --- Helper Functions (بدون تغییر از Firebase) ---
        const updateProgress = (percentage, message) => {
            progressBarFill.style.width = `${percentage}%`;
            if (message) statusMessage.textContent = message;
        };
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        function playMusicFromBlob(blob) {
            try {
                const objectUrl = URL.createObjectURL(blob);
                backgroundMusic.src = objectUrl;
                backgroundMusic.volume = 0.4;
                backgroundMusic.play().catch(e => console.warn("پخش خودکار موسیقی توسط مرورگر مسدود شد.", e));
            } catch (error) { console.error("خطا در ایجاد URL برای پخش موسیقی:", error); }
        }
        function downloadAndCacheMusic(progressCallback) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', MUSIC_URL, true);
                xhr.responseType = 'blob';
                xhr.onprogress = (event) => { if (event.lengthComputable) { const percentComplete = Math.round((event.loaded / event.total) * 100); progressCallback(percentComplete); } };
                xhr.onload = async () => { if (xhr.status === 200) { const musicBlob = xhr.response; try { const cache = await caches.open(MUSIC_CACHE_NAME); await cache.put(MUSIC_URL, new Response(musicBlob)); localStorage.setItem(MUSIC_VERSION_KEY, MUSIC_URL); resolve(musicBlob); } catch (cacheError) { reject(cacheError); } } else { reject(new Error(`خطای شبکه در دانلود موسیقی: ${xhr.statusText}`)); } };
                xhr.onerror = () => { reject(new Error('خطای شبکه در هنگام دانلود موسیقی.')); };
                xhr.send();
            });
        }
        async function handleBackgroundMusic() {
            const cachedVersion = localStorage.getItem(MUSIC_VERSION_KEY);
            try {
                if (cachedVersion === MUSIC_URL) {
                    const cache = await caches.open(MUSIC_CACHE_NAME);
                    const cachedResponse = await cache.match(MUSIC_URL);
                    if (cachedResponse) { const musicBlob = await cachedResponse.blob(); playMusicFromBlob(musicBlob); return; }
                }
                const musicBlob = await downloadAndCacheMusic((percent) => { const overallProgress = 20 + (percent * 0.4); updateProgress(overallProgress, `در حال دریافت موسیقی... ${percent}%`); });
                playMusicFromBlob(musicBlob);
            } catch (error) { console.error('فرایند مدیریت موسیقی با خطا مواجه شد:', error); statusMessage.textContent = 'خطا در دریافت موسیقی پس‌زمینه.'; }
        }
        
        // --- توابع پنل مسدودیت با منطق سوپابیس ---
        function showSuspensionPanel(profileData, user) {
            loadingPanel.style.display = 'none';
            suspensionPanel.style.display = 'block';

            document.getElementById('suspension-avatar').src = profileData.avatar_url || DEFAULT_AVATAR;
            document.getElementById('suspension-username').textContent = profileData.display_name || 'کاربر';
            document.getElementById('suspension-reason').textContent = `دلیل: ${profileData.banReason || 'نامشخص'}`;
            
            startSuspensionCountdown(new Date(profileData.banExpiresAt), user);
            
            logoutBtn.onclick = async () => {
                await supabase.auth.signOut();
                window.location.href = './login.html';
            };
        }
        function startSuspensionCountdown(targetDate, user) {
            const countdownElements = { days: document.getElementById('s-days'), hours: document.getElementById('s-hours'), minutes: document.getElementById('s-minutes'), seconds: document.getElementById('s-seconds') };
            const interval = setInterval(async () => {
                const distance = targetDate.getTime() - new Date().getTime();
                if (distance < 0) {
                    clearInterval(interval);
                    // چون تاریخ انقضا گذشته، فیلد is_banned را در دیتابیس false می‌کنیم
                    await supabase.from('profiles').update({ is_banned: false }).eq('id', user.id);
                    window.location.reload();
                    return;
                }
                const f = (n) => String(Math.floor(n)).padStart(2, '0');
                countdownElements.days.textContent = f(distance / (1000 * 60 * 60 * 24));
                countdownElements.hours.textContent = f((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                countdownElements.minutes.textContent = f((distance % (1000 * 60 * 60)) / (1000 * 60));
                countdownElements.seconds.textContent = f((distance % (1000 * 60)) / 1000);
            }, 1000);
        }

        // --- توابع پنل تعمیرات (بدون تغییر) ---
        function showMaintenancePanel(config) {
            loadingPanel.style.display = 'none';
            const maintenancePanel = document.getElementById('maintenance-panel');
            maintenancePanel.style.display = 'block';
            const bannerContainer = document.getElementById('maintenance-banner-container');
            if (config.image_url) { document.getElementById('maintenance-banner').src = config.image_url; bannerContainer.style.display = 'block'; } else { bannerContainer.style.display = 'none'; }
            document.getElementById('maintenance-title').textContent = config.title || "در حال بروزرسانی";
            document.getElementById('maintenance-message').textContent = config.message || "به زودی باز خواهیم گشت.";
            if (config.end_time) {
                startMaintenanceCountdown(new Date(config.end_time));
            } else {
                document.querySelector('#maintenance-panel .countdown-timer').innerHTML = "<p>زمان پایان مشخص نشده است.</p>";
            }
        }
        function startMaintenanceCountdown(targetDate) {
            const countdownElements = { days: document.getElementById('days'), hours: document.getElementById('hours'), minutes: document.getElementById('minutes'), seconds: document.getElementById('seconds') };
            const interval = setInterval(() => {
                const distance = targetDate.getTime() - new Date().getTime();
                if (distance < 0) {
                    clearInterval(interval);
                    window.location.reload(); // صفحه را رفرش کن تا دوباره وضعیت سرور چک شود
                    return;
                }
                const f = (n) => String(Math.floor(n)).padStart(2, '0');
                countdownElements.days.textContent = f(distance / (1000 * 60 * 60 * 24));
                countdownElements.hours.textContent = f((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                countdownElements.minutes.textContent = f((distance % (1000 * 60 * 60)) / (1000 * 60));
                countdownElements.seconds.textContent = f((distance % (1000 * 60)) / 1000);
            }, 1000);
        }

        // --- منطق اصلی و جدید با سوپابیس ---
        async function startNormalLoading(profile) {
            updateProgress(10, '...برقراری ارتباط با سرورهای شهر');
            const musicPromise = handleBackgroundMusic();
            
            updateProgress(70, '...در حال واکشی اطلاعات بازیکن');
            const displayName = profile.display_name || 'بازیکن';
            
            await musicPromise; // منتظر می‌مانیم تا موسیقی شروع به دانلود/پخش کند
            
            updateProgress(100, `خوش آمدید، ${displayName}!`);
            await delay(1500); 
            window.location.href = './main.html';
        }

        async function main() {
            try {
                // 1. بررسی وضعیت تعمیرات سرور
                const { data: maintenanceSettings, error: maintenanceError } = await supabase
                    .from('settings')
                    .select('*')
                    .eq('id', 'maintenance')
                    .single();
                
                if (maintenanceError) throw new Error("خطا در بررسی وضعیت سرور.");
                if (maintenanceSettings && maintenanceSettings.enabled === true) {
                    showMaintenancePanel(maintenanceSettings);
                    return; // اجرای بقیه کد متوقف می‌شود
                }

                // 2. بررسی وضعیت احراز هویت کاربر
                const { data: { user } } = await supabase.auth.getUser();

                if (!user) {
                    updateProgress(100, 'احراز هویت انجام نشد، در حال هدایت به صفحه ورود...');
                    await delay(2000);
                    window.location.href = './login.html';
                    return;
                }

                // 3. دریافت اطلاعات پروفایل کاربر و بررسی وضعیت مسدودیت
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (profileError) throw new Error("خطا در دریافت پروفایل کاربر.");
                
                if (profile.is_banned === true && profile.banExpiresAt && new Date(profile.banExpiresAt) > new Date()) {
                    showSuspensionPanel(profile, user);
                    return; // اجرای بقیه کد متوقف می‌شود
                }

                // 4. اگر همه چیز اوکی بود، لودینگ عادی را شروع کن
                await startNormalLoading(profile);

            } catch (error) {
                console.error("خطای جدی در فرآیند بارگذاری:", error);
                updateProgress(100);
                statusMessage.innerHTML = 'خطا در بارگذاری اطلاعات.<br>لطفاً صفحه را مجدداً بارگذاری کنید.';
                progressBarFill.style.background = 'linear-gradient(90deg, #c0392b, #e74c3c)';
            }
        }
        
        main();
    </script>
</body>
</html>
