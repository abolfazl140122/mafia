<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>در حال اتصال به سرور مافیا...</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS Reset & Base Styles --- */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* 
         ==========================================================================
           1. ROOT VARIABLES & THEME DEFINITION
           - تعریف رنگ‌ها و متغیرهای اصلی برای تم قهوه‌ای و طلایی
           - این بخش به ما اجازه می‌دهد تا به راحتی تم کلی را تغییر دهیم.
         ========================================================================== 
        */
        :root {
            --color-background-dark: #1a1510;
            --color-panel-brown-dark: #3a2d20;
            --color-panel-brown-light: #5c4a3a;
            --color-gold-bright: #ffd700;
            --color-gold-dark: #b8860b;
            --color-gold-glow: rgba(255, 223, 100, 0.75);
            --color-text-light: #f5eadd;
            --color-text-dark: #2c221a;
            --color-success-glow: rgba(144, 238, 144, 0.8);
            --color-success-dark: #2e7d32;
            --color-error-glow: rgba(255, 100, 100, 0.8);
            --color-error-dark: #c62828;
            --font-main: 'Vazirmatn', sans-serif;
        }

        /* 
         ==========================================================================
           2. KEYFRAME ANIMATIONS
           - تعریف تمام انیمیشن‌های مورد استفاده در صفحه لودینگ
           - شامل انیمیشن برای ورود پنل، درخشش لوگو، حرکت نور روی پروگرس بار و...
         ========================================================================== 
        */

        /* انیمیشن برای ورود سینمایی پنل اصلی */
        @keyframes panel-intro-animation {
            0% {
                opacity: 0;
                transform: translateY(50px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* انیمیشن برای درخشش و تپش نور طلایی پشت لوگو */
        @keyframes logo-glow-pulse {
            0%, 100% {
                filter: drop-shadow(0 0 12px var(--color-gold-glow)) brightness(1.1);
            }
            50% {
                filter: drop-shadow(0 0 22px var(--color-gold-glow)) brightness(1.2);
            }
        }

        /* انیمیشن برای حرکت نور روی نوار پیشرفت */
        @keyframes progress-bar-shine {
            0% {
                left: -100px;
            }
            100% {
                left: 100%;
            }
        }
        
        /* انیمیشن برای ظاهر شدن نرم متن و دکمه‌ها */
        @keyframes fade-in-subtle {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* انیمیشن برای چرخش آیکون لودینگ */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* 
         ==========================================================================
           3. BODY & LAYOUT STYLES
           - استایل‌های اصلی بدنه، پس‌زمینه و چیدمان کلی
         ========================================================================== 
        */
        body {
            font-family: var(--font-main);
            color: var(--color-text-light);
            background-color: var(--color-background-dark);
            /* استفاده از یک بافت چوب تیره برای پس‌زمینه */
            background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* 
         ==========================================================================
           4. LOADING CONTAINER & PANEL STYLING
           - استایل‌های اصلی برای پنل مرکزی لودینگ
           - شامل گرادینت، حاشیه، سایه داخلی و عناصر تزئینی
         ========================================================================== 
        */
        #loading-container {
            width: 90%;
            max-width: 480px;
            padding: 2.5rem 2rem;
            background: linear-gradient(145deg, var(--color-panel-brown-light), var(--color-panel-brown-dark));
            border-radius: 20px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 
                        inset 0 2px 5px rgba(255, 255, 255, 0.05);
            text-align: center;
            position: relative;
            animation: panel-intro-animation 1s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        /* عناصر تزئینی گوشه‌های پنل */
        #loading-container::before,
        #loading-container::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border-style: solid;
            border-color: var(--color-gold-dark);
            opacity: 0.7;
        }

        #loading-container::before {
            top: 15px;
            left: 15px;
            border-width: 3px 0 0 3px;
            border-top-left-radius: 15px;
        }

        #loading-container::after {
            bottom: 15px;
            right: 15px;
            border-width: 0 3px 3px 0;
            border-bottom-right-radius: 15px;
        }
        
        /* 
         ==========================================================================
           5. LOGO STYLING
           - استایل‌های لوگوی مرکزی با افکت نورانی
         ========================================================================== 
        */
        #loading-logo {
            width: 100%;
            max-width: 160px; /* افزایش اندازه لوگو */
            height: auto;
            margin: 0 auto 1.5rem;
            display: block;
            /* حذف پس زمینه احتمالی عکس و اعمال انیمیشن درخشش */
            background-color: transparent;
            animation: logo-glow-pulse 3.5s ease-in-out infinite;
            /* جلوگیری از انتخاب ناخواسته لوگو */
            user-select: none;
            -webkit-user-select: none;
        }

        /* 
         ==========================================================================
           6. TITLE & MESSAGE STYLING
           - استایل‌های عنوان اصلی و پیام‌های وضعیت
         ========================================================================== 
        */
        #loading-title {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--color-gold-bright);
            margin-bottom: 2rem;
            text-shadow: 0 0 15px var(--color-gold-glow), 
                         0 2px 2px var(--color-text-dark);
        }

        #loading-message {
            font-size: 1.1rem;
            font-weight: 700;
            min-height: 50px; /* جلوگیری از پرش صفحه با تغییر متن */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: color 0.5s ease;
        }
        
        /* آیکون چرخان برای نمایش وضعیت "در حال انجام" */
        .spinner-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(245, 234, 221, 0.3);
            border-top-color: var(--color-text-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* آیکون تیک برای نمایش وضعیت "موفق" */
        .success-icon {
            color: var(--color-success-glow);
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        /* آیکون خطا */
        .error-icon {
             color: var(--color-error-glow);
             font-weight: bold;
             font-size: 1.5rem;
        }


        /* 
         ==========================================================================
           7. PROGRESS BAR STYLING
           - استایل‌های نوار پیشرفت با افکت نور متحرک
         ========================================================================== 
        */
        #progress-bar-container {
            width: 100%;
            height: 22px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 11px;
            margin: 1.5rem 0;
            border: 2px solid rgba(0, 0, 0, 0.2);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden; /* برای مخفی کردن افکت نور در خارج از نوار */
        }
        
        #progress-bar-fill {
            height: 100%;
            width: 0%; /* عرض اولیه صفر که با جاوااسکریپت کنترل می‌شود */
            background: linear-gradient(90deg, var(--color-gold-dark), var(--color-gold-bright));
            border-radius: 9px;
            transition: width 0.7s cubic-bezier(0.65, 0, 0.35, 1);
            position: relative;
        }
        
        /* عنصر برای ایجاد افکت نور متحرک روی نوار پیشرفت */
        #progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100px;
            height: 100%;
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0) 0%, 
                rgba(255, 255, 255, 0.4) 50%, 
                rgba(255, 255, 255, 0) 100%);
            transform: skewX(-25deg);
            animation: progress-bar-shine 2.5s linear infinite;
        }

        /* 
         ==========================================================================
           8. BUTTONS STYLING
           - استایل دکمه‌های "ورود" و "تلاش مجدد"
         ========================================================================== 
        */
        .action-button {
            display: none; /* در ابتدا مخفی است */
            padding: 12px 30px;
            margin-top: 2rem;
            font-family: var(--font-main);
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--color-text-dark);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
            text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.3);
            animation: fade-in-subtle 0.5s ease-out forwards;
            animation-delay: 0.3s; /* با تاخیر ظاهر شود */
            opacity: 0; /* برای شروع انیمیشن */
        }

        .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }

        .action-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        /* دکمه اصلی (ورود) */
        #enter-button {
            background: linear-gradient(180deg, var(--color-gold-bright), var(--color-gold-dark));
            box-shadow: 0 5px 0 #8c6400;
        }
        #enter-button:hover {
            background: linear-gradient(180deg, #ffeb8d, var(--color-gold-dark));
        }

        /* دکمه خطا (تلاش مجدد) */
        #retry-button {
            background: linear-gradient(180deg, #ff8a80, var(--color-error-dark));
            box-shadow: 0 5px 0 #8e1c1c;
        }
        #retry-button:hover {
             background: linear-gradient(180deg, #ffab91, var(--color-error-dark));
        }
        
        /* کلاس برای نمایش دکمه‌ها */
        .visible {
            display: inline-block !important;
        }

    </style>
</head>
<body>

    <div id="loading-container">
        <!-- لوگوی بازی -->
        <img id="loading-logo" src="https://up.20script.ir/file/40b6-Copilot-20250812-110015-removebg-preview.png" alt="لوگوی شهر مافیا">
        
        <!-- عنوان اصلی -->
        <h1 id="loading-title">شهر مافیا</h1>
        
        <!-- نوار پیشرفت -->
        <div id="progress-bar-container">
            <div id="progress-bar-fill"></div>
        </div>
        
        <!-- پیام وضعیت -->
        <p id="loading-message">
            <span class="spinner-icon"></span>
            <span>در حال آماده سازی...</span>
        </p>
        
        <!-- دکمه ورود (در ابتدا مخفی) -->
        <button id="enter-button" class="action-button">ورود به شهر</button>

        <!-- دکمه تلاش مجدد (در ابتدا مخفی) -->
        <button id="retry-button" class="action-button">تلاش مجدد</button>
    </div>

    <script type="module">
        /* 
         ==========================================================================
           JAVASCRIPT LOGIC
           - مدیریت کامل فرآیند لودینگ، اتصال به فایربیس و تعامل با کاربر
         ========================================================================== 
        */

        // -----------------------------------------------------------------------
        // 1. FIREBASE IMPORTS & CONFIGURATION
        // -----------------------------------------------------------------------
        
        // این بخش برای اتصال به فایربیس است. مطمئن شوید که SDK ها را به درستی وارد کرده‌اید.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";

        // اطلاعات پیکربندی فایربیس شما
        const firebaseConfig = {
            apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
            authDomain: "mafia-9fcbf.firebaseapp.com",
            projectId: "mafia-9fcbf",
            storageBucket: "mafia-9fcbf.appspot.com",
            messagingSenderId: "471627157488",
            appId: "1:471627157488:web:92f008548a5596619a5735",
            measurementId: "G-0PDHDWC6NV"
        };
        
        // -----------------------------------------------------------------------
        // 2. DOM ELEMENT SELECTORS
        // -----------------------------------------------------------------------

        const progressBarFill = document.getElementById('progress-bar-fill');
        const loadingMessage = document.getElementById('loading-message');
        const enterButton = document.getElementById('enter-button');
        const retryButton = document.getElementById('retry-button');

        // -----------------------------------------------------------------------
        // 3. HELPER FUNCTIONS
        // -----------------------------------------------------------------------

        /**
         * تابع برای به‌روزرسانی نوار پیشرفت و پیام وضعیت
         * @param {number} percentage - درصد پیشرفت (0 تا 100)
         * @param {string} messageText - متن پیامی که نمایش داده می‌شود
         * @param {'loading' | 'success' | 'error'} status - وضعیت برای نمایش آیکون مناسب
         */
        function updateLoadingState(percentage, messageText, status = 'loading') {
            // به‌روزرسانی عرض نوار پیشرفت
            if (progressBarFill) {
                progressBarFill.style.width = `${percentage}%`;
            }
            
            // به‌روزرسانی پیام و آیکون
            if (loadingMessage) {
                let iconHtml = '';
                if (status === 'loading') {
                    iconHtml = '<span class="spinner-icon"></span>';
                } else if (status === 'success') {
                    iconHtml = '<span class="success-icon">✔</span>';
                    progressBarFill.style.background = 'linear-gradient(90deg, #2e7d32, #66bb6a)';
                } else if (status === 'error') {
                    iconHtml = '<span class="error-icon">✖</span>';
                    progressBarFill.style.background = 'linear-gradient(90deg, #c62828, #ef5350)';
                }
                
                loadingMessage.innerHTML = `${iconHtml}<span>${messageText}</span>`;
            }
        }

        /**
         * تابع برای شبیه‌سازی تاخیر (برای نمایش بهتر فرآیند)
         * @param {number} ms - مدت زمان تاخیر به میلی‌ثانیه
         */
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /**
         * تابع برای نمایش دکمه‌ها
         * @param {'enter' | 'retry' | 'none'} buttonToShow - کدام دکمه نمایش داده شود
         */
        function showActionButton(buttonToShow) {
            enterButton.classList.remove('visible');
            retryButton.classList.remove('visible');

            if (buttonToShow === 'enter' && enterButton) {
                enterButton.classList.add('visible');
            } else if (buttonToShow === 'retry' && retryButton) {
                retryButton.classList.add('visible');
            }
        }
        
        // -----------------------------------------------------------------------
        // 4. CORE LOGIC - FIREBASE INITIALIZATION & LOADING SEQUENCE
        // -----------------------------------------------------------------------

        /**
         * تابع اصلی برای شروع فرآیند لودینگ و اتصال
         */
        async function startLoadingSequence() {
            try {
                // --- مرحله ۱: شروع و بررسی اتصال اینترنت ---
                showActionButton('none'); // مخفی کردن همه دکمه‌ها در ابتدا
                updateLoadingState(10, 'در حال آماده سازی...', 'loading');
                await delay(500);

                updateLoadingState(25, 'بررسی اتصال به اینترنت...', 'loading');
                await delay(1000);

                if (!navigator.onLine) {
                    // اگر اینترنت قطع بود، خطا نمایش بده
                    throw new Error("اتصال شما به اینترنت برقرار نیست. لطفا شبکه خود را بررسی کنید.");
                }
                
                updateLoadingState(50, 'اتصال به اینترنت برقرار شد.', 'loading');
                await delay(500);

                // --- مرحله ۲: تلاش برای اتصال به سرور فایربیس ---
                updateLoadingState(75, 'در حال اتصال به سرور بازی...', 'loading');
                
                // شبیه‌سازی اتصال به فایربیس
                // در یک پروژه واقعی، این بخش شامل منطق اتصال واقعی خواهد بود.
                const app = initializeApp(firebaseConfig);
                // const analytics = getAnalytics(app); // در صورت نیاز فعال شود
                
                // اگر کد به اینجا برسد یعنی اتصال موفق بوده است
                await delay(1500); // تاخیر برای نمایش بهتر پیام
                
                // --- مرحله ۳: اتصال موفق ---
                updateLoadingState(100, 'اتصال با موفقیت انجام شد!', 'success');
                
                // نمایش دکمه "ورود به شهر"
                showActionButton('enter');

            } catch (error) {
                // --- مدیریت خطا ---
                console.error("خطا در فرآیند لودینگ:", error);
                
                // نمایش پیام خطا به کاربر
                updateLoadingState(
                    progressBarFill.style.width.replace('%', ''), // نوار پیشرفت در همانجا متوقف شود
                    error.message || "خطایی رخ داد. امکان اتصال به سرور وجود ندارد.",
                    'error'
                );

                // نمایش دکمه "تلاش مجدد"
                showActionButton('retry');
            }
        }
        
        // -----------------------------------------------------------------------
        // 5. EVENT LISTENERS
        // -----------------------------------------------------------------------

        // رویداد کلیک برای دکمه "ورود به شهر"
        if (enterButton) {
            enterButton.addEventListener('click', () => {
                // در اینجا می‌توانید کاربر را به صفحه اصلی بازی هدایت کنید
                // window.location.href = '/game.html';
                alert('در حال هدایت به صفحه اصلی بازی...');
                
                // انیمیشن خروج پنل (اختیاری)
                document.getElementById('loading-container').style.transition = 'opacity 0.5s, transform 0.5s';
                document.getElementById('loading-container').style.opacity = '0';
                document.getElementById('loading-container').style.transform = 'scale(0.9)';
            });
        }
        
        // رویداد کلیک برای دکمه "تلاش مجدد"
        if (retryButton) {
            retryButton.addEventListener('click', () => {
                // فرآیند لودینگ را از اول شروع کن
                startLoadingSequence();
            });
        }

        // -----------------------------------------------------------------------
        // 6. INITIALIZATION
        // -----------------------------------------------------------------------

        // شروع کل فرآیند با بارگذاری کامل صفحه
        document.addEventListener('DOMContentLoaded', startLoadingSequence);

    </script>
</body>
</html>
