<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهر مافیا - در حال بارگذاری</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --wood-dark: #0c0a09; /* Darker base for new background */
            --text-gold: #ffc947;
            --text-light: #e0dacc;
            --logo-glow-main: #ffdd00;
            --progress-bar-bg: rgba(0,0,0,0.4);
            --progress-bar-fill-start: #8c4843;
            --progress-bar-fill-end: #ffc947;
            --countdown-bg: rgba(0,0,0,0.3);
            --panel-glow: rgba(255, 201, 71, 0.5);
            /* Suspension styles */
            --suspension-red: #e74c3c;
            --suspension-border: #c0392b;
            --suspension-glow: rgba(231, 76, 60, 0.5);
        }
        @keyframes panel-intro { from { opacity: 0; transform: translateY(50px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--wood-dark);
            background-image: url('https://cdn.imgurl.ir/uploads/l799321_file_69171c89c9d984.31885040.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* --- [NEW] Bottom Loader Styles --- */
        #bottom-loader {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px 40px 30px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            z-index: 100;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
        }
        #bottom-loader #progress-bar-container {
            width: 100%;
            max-width: 480px;
            height: 8px;
            background-color: var(--progress-bar-bg);
            border-radius: 4px;
            overflow: hidden;
            padding: 2px;
            border: 1px solid rgba(255, 201, 71, 0.2);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
        }
        #bottom-loader #progress-bar-fill {
            width: 0%;
            height: 100%;
            border-radius: 2px;
            background: linear-gradient(90deg, var(--progress-bar-fill-start), var(--progress-bar-fill-end));
            transition: width 0.4s cubic-bezier(0.65, 0, 0.35, 1);
        }
        #bottom-loader #status-message {
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--text-light);
            opacity: 0.8;
            min-height: auto;
        }
        
        /* --- Panel Styles (for Maintenance & Suspension) --- */
        .panel {
            width: 90%;
            max-width: 480px;
            background: rgba(10, 5, 2, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 1px solid rgba(255, 201, 71, 0.25);
            padding: 30px 40px;
            text-align: center;
            animation: panel-intro 1s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }
        
        #maintenance-panel { box-shadow: 0 0 25px var(--panel-glow), 0 15px 45px rgba(0, 0, 0, 0.7); padding: 25px; }
        #maintenance-banner-container { width: 100%; margin-bottom: 25px; border-radius: 16px; overflow: hidden; background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255, 201, 71, 0.2); }
        #maintenance-banner { width: 100%; height: auto; display: block; }
        #maintenance-title { font-size: 2rem; font-weight: 900; color: var(--text-gold); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #maintenance-message { font-size: 1rem; line-height: 1.8; margin-bottom: 30px; color: var(--text-light); padding: 0 15px; }
        
        .countdown-timer { display: flex; flex-direction: row-reverse; justify-content: center; gap: 15px; }
        .time-block { background-color: var(--countdown-bg); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 201, 71, 0.15); min-width: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .time-value { font-size: 3rem; font-weight: 900; color: white; line-height: 1; }
        .time-label { font-size: 0.8rem; font-weight: 400; color: var(--text-light); margin-top: 8px; }

        /* --- Suspension Panel Styles --- */
        #suspension-panel { border-color: var(--suspension-border); box-shadow: 0 0 25px var(--suspension-glow), 0 15px 45px rgba(0, 0, 0, 0.7); padding: 35px; }
        
        #suspension-user-info { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        #suspension-avatar { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 3px solid var(--suspension-red); box-shadow: 0 5px 15px rgba(0,0,0,0.5); margin-bottom: 15px; }
        #suspension-username { font-size: 1.5rem; font-weight: 700; color: var(--text-light); text-shadow: 1px 1px 3px #000; }
        
        #suspension-title { font-size: 2rem; color: var(--suspension-red); margin-bottom: 15px; font-weight: 900; }
        #suspension-reason { font-size: 1.1rem; margin-bottom: 25px; padding: 12px; background-color: rgba(0,0,0,0.3); border-radius: 8px; font-style: italic; border: 1px solid rgba(255,255,255,0.1); }
        #suspension-message { margin-bottom: 20px; font-size: 1rem; color: var(--text-light); }
        
        #suspension-countdown-timer { margin-bottom: 35px; }
        #suspension-countdown-timer .time-block { border-color: var(--suspension-border); background-color: rgba(231, 76, 60, 0.1); }
        #suspension-countdown-timer .time-value { color: #f8d7da; }
        #suspension-countdown-timer .time-label { color: #f5c6cb; }

        #logout-btn { background: linear-gradient(145deg, #616161, #3a3a3a); border: 1px solid #777; color: var(--text-light); padding: 12px 30px; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        #logout-btn:hover { background: linear-gradient(145deg, #757575, #4f4f4f); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        #logout-btn:active { transform: translateY(0); }
    </style>
</head>
<body>

    <!-- [NEW] Bottom loader replaces the center panel -->
    <div id="bottom-loader">
        <div id="progress-bar-container">
            <div id="progress-bar-fill"></div>
        </div>
        <p id="status-message">در حال آماده سازی...</p>
    </div>

    <!-- Maintenance panel remains centered, but hidden by default -->
    <div id="maintenance-panel" class="panel" style="display: none;">
        <div id="maintenance-banner-container"><img id="maintenance-banner" src="" alt="بنر بروزرسانی"></div>
        <h1 id="maintenance-title"></h1>
        <p id="maintenance-message"></p>
        <div class="countdown-timer">
            <div class="time-block"><div id="days" class="time-value">00</div><div class="time-label">روز</div></div>
            <div class="time-block"><div id="hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
            <div class="time-block"><div id="minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
            <div class="time-block"><div id="seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
    </div>

    <!-- Suspension panel remains centered, but hidden by default -->
    <div id="suspension-panel" class="panel" style="display: none;">
        <div id="suspension-user-info">
            <img id="suspension-avatar" src="" alt="آواتار کاربر">
            <h3 id="suspension-username"></h3>
        </div>
        <h1 id="suspension-title">حساب کاربری مسدود است</h1>
        <p id="suspension-reason"></p>
        <p id="suspension-message">زمان باقی‌مانده تا رفع مسدودیت:</p>
        <div id="suspension-countdown-timer" class="countdown-timer">
             <div class="time-block"><div id="s-days" class="time-value">00</div><div class="time-label">روز</div></div>
             <div class="time-block"><div id="s-hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
             <div class="time-block"><div id="s-minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
             <div class="time-block"><div id="s-seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
        <button id="logout-btn">خروج از حساب</button>
    </div>
    
    <audio id="background-music" loop></audio>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
            authDomain: "mafia-9fcbf.firebaseapp.com",
            projectId: "mafia-9fcbf",
            storageBucket: "mafia-9fcbf.appspot.com",
            messagingSenderId: "471627157488",
            appId: "1:471627157488:web:92f008548a5596619a5735",
            measurementId: "G-0PDHDWC6NV"
        };
        
        // --- DOM Elements ---
        const progressBarFill = document.getElementById('progress-bar-fill');
        const statusMessage = document.getElementById('status-message');
        const backgroundMusic = document.getElementById('background-music');
        const bottomLoader = document.getElementById('bottom-loader'); // [MODIFIED]
        const suspensionPanel = document.getElementById('suspension-panel');
        const logoutBtn = document.getElementById('logout-btn');
        
        // --- Constants ---
        const MUSIC_URL = "https://raw.githubusercontent.com/abolfazl140122/mafia/main/dark-music-249503.mp3";
        const MUSIC_CACHE_NAME = 'mafia-music-cache-v1';
        const MUSIC_VERSION_KEY = 'mafia-music-version';
        const DEFAULT_AVATAR = 'https://i.imgur.com/T2bT1tG.png';

        // --- Helper Functions ---
        const updateProgress = (percentage, message) => {
            progressBarFill.style.width = `${percentage}%`;
            if (message) statusMessage.textContent = message;
        };
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function playMusicFromBlob(blob) {
            try {
                const objectUrl = URL.createObjectURL(blob);
                backgroundMusic.src = objectUrl;
                backgroundMusic.volume = 0.4;
                backgroundMusic.play().catch(e => console.warn("پخش خودکار موسیقی توسط مرورگر مسدود شد.", e));
            } catch (error) { console.error("خطا در ایجاد URL برای پخش موسیقی:", error); }
        }
        function downloadAndCacheMusic(progressCallback) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', MUSIC_URL, true);
                xhr.responseType = 'blob';
                xhr.onprogress = (event) => { if (event.lengthComputable) { const percentComplete = Math.round((event.loaded / event.total) * 100); progressCallback(percentComplete); } };
                xhr.onload = async () => { if (xhr.status === 200) { const musicBlob = xhr.response; try { const cache = await caches.open(MUSIC_CACHE_NAME); await cache.put(MUSIC_URL, new Response(musicBlob)); localStorage.setItem(MUSIC_VERSION_KEY, MUSIC_URL); resolve(musicBlob); } catch (cacheError) { reject(cacheError); } } else { reject(new Error(`خطای شبکه در دانلود موسیقی: ${xhr.statusText}`)); } };
                xhr.onerror = () => { reject(new Error('خطای شبکه در هنگام دانلود موسیقی.')); };
                xhr.send();
            });
        }
        async function handleBackgroundMusic() {
            const cachedVersion = localStorage.getItem(MUSIC_VERSION_KEY);
            try {
                if (cachedVersion === MUSIC_URL) {
                    const cache = await caches.open(MUSIC_CACHE_NAME);
                    const cachedResponse = await cache.match(MUSIC_URL);
                    if (cachedResponse) { const musicBlob = await cachedResponse.blob(); playMusicFromBlob(musicBlob); return; }
                }
                const musicBlob = await downloadAndCacheMusic((percent) => { const overallProgress = 20 + (percent * 0.4); updateProgress(overallProgress, `در حال دریافت موسیقی... ${percent}%`); });
                playMusicFromBlob(musicBlob);
            } catch (error) { console.error('فرایند مدیریت موسیقی با خطا مواجه شد:', error); statusMessage.textContent = 'خطا در دریافت موسیقی پس‌زمینه.'; }
        }
        
        // --- [MODIFIED] Function to handle smooth transition from suspension to game ---
        async function transitionToGame(displayName) {
            suspensionPanel.style.display = 'none';
            bottomLoader.style.display = 'flex'; // Show the bottom loader again
            
            updateProgress(100, `مسدودیت شما رفع شد. خوش آمدید، ${displayName}!`);
            await delay(2000);
            window.location.href = './main.html';
        }

        // --- Suspension Panel Functions ---
        function showSuspensionPanel(config, auth, db) {
            bottomLoader.style.display = 'none'; // [MODIFIED] Hide loader
            suspensionPanel.style.display = 'block';

            const displayName = config.displayName || 'کاربر';
            document.getElementById('suspension-avatar').src = config.avatarUrl || DEFAULT_AVATAR;
            document.getElementById('suspension-username').textContent = displayName;
            document.getElementById('suspension-reason').textContent = `دلیل: ${config.banReason || 'نامشخص'}`;
            
            startSuspensionCountdown(config.banExpiresAt.toDate(), auth, db, displayName);
            
            logoutBtn.onclick = () => {
                signOut(auth).then(() => {
                    window.location.href = './login.html';
                }).catch(err => {
                    console.error('Logout error:', err);
                    alert('خطا در خروج از حساب.');
                });
            };
        }
        
        function startSuspensionCountdown(targetDate, auth, db, displayName) {
            const countdownElements = { days: document.getElementById('s-days'), hours: document.getElementById('s-hours'), minutes: document.getElementById('s-minutes'), seconds: document.getElementById('s-seconds') };
            const interval = setInterval(async () => {
                const distance = targetDate.getTime() - new Date().getTime();

                if (distance < 0) {
                    clearInterval(interval);
                    try {
                        const userDocRef = doc(db, 'users', auth.currentUser.uid);
                        await updateDoc(userDocRef, { isBanned: false, banReason: null, banExpiresAt: null });
                        console.log("مسدودیت کاربر به صورت خودکار رفع شد.");
                    } catch(e) {
                        console.error("خطا در رفع خودکار مسدودیت:", e);
                    }
                    await transitionToGame(displayName); 
                    return;
                }
                const f = (n) => String(Math.floor(n)).padStart(2, '0');
                countdownElements.days.textContent = f(distance / (1000 * 60 * 60 * 24));
                countdownElements.hours.textContent = f((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                countdownElements.minutes.textContent = f((distance % (1000 * 60 * 60)) / (1000 * 60));
                countdownElements.seconds.textContent = f((distance % (1000 * 60)) / 1000);
            }, 1000);
        }

        // --- Main Loading Logic ---
        async function startNormalLoading(auth, db) {
            updateProgress(10, '...برقراری ارتباط با سرورهای شهر');
            const authPromise = new Promise((resolve, reject) => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        try {
                            const userDocRef = doc(db, 'users', user.uid);
                            const userDocSnap = await getDoc(userDocRef);
                            
                            if (userDocSnap.exists()) {
                                const userData = userDocSnap.data();
                                if (userData.isBanned === true && userData.banExpiresAt && userData.banExpiresAt.toDate() > new Date()) {
                                    reject({ type: 'BANNED', config: userData, db: db }); 
                                    return;
                                }
                            }
                            updateProgress(70, '...در حال واکشی اطلاعات بازیکن');
                            const displayName = (userDocSnap.exists() && userDocSnap.data().displayName) || user.displayName || 'بازیکن';
                            resolve(displayName);
                        } catch (error) { reject({ type: 'ERROR', error }); }
                    } else { reject({ type: 'NO_USER' }); }
                });
            });
            const musicPromise = handleBackgroundMusic();
            try {
                const [displayName] = await Promise.all([authPromise, musicPromise]);
                updateProgress(100, `خوش آمدید، ${displayName}!`);
                await delay(1500); 
                window.location.href = './main.html';
            } catch (rejection) {
                if (rejection.type === 'BANNED') {
                    showSuspensionPanel(rejection.config, auth, rejection.db);
                } else if (rejection.type === 'NO_USER') {
                    updateProgress(100, 'احراز هویت انجام نشد، در حال هدایت به صفحه ورود...');
                    await delay(2000);
                    window.location.href = './login.html';
                } else {
                    console.error("خطای جدی در فرآیند بارگذاری:", rejection.error);
                    updateProgress(100);
                    statusMessage.innerHTML = 'خطا در بارگذاری اطلاعات.<br>لطفاً صفحه را مجدداً بارگذاری کنید.';
                    progressBarFill.style.background = 'linear-gradient(90deg, #c0392b, #e74c3c)';
                }
            }
        }

        // --- Maintenance & Initializer ---
        function showMaintenancePanel(config, auth, db) {
            bottomLoader.style.display = 'none'; // [MODIFIED] Hide loader
            const maintenancePanel = document.getElementById('maintenance-panel');
            maintenancePanel.style.display = 'block';
            const bannerContainer = document.getElementById('maintenance-banner-container');
            if (config.imageUrl) { document.getElementById('maintenance-banner').src = config.imageUrl; bannerContainer.style.display = 'block'; } else { bannerContainer.style.display = 'none'; }
            const titleEl = document.getElementById('maintenance-title');
            titleEl.textContent = config.title || "در حال بروزرسانی";
            if (config.titleColor) { titleEl.style.color = config.titleColor; }
            const messageEl = document.getElementById('maintenance-message');
            messageEl.textContent = config.message || "به زودی باز خواهیم گشت.";
            if (config.textColor) { messageEl.style.color = config.textColor; }
            if (config.endTime && typeof config.endTime.toDate === 'function') { startCountdown(config.endTime.toDate(), auth, db); } else { document.querySelector('#maintenance-panel .countdown-timer').innerHTML = "<p>زمان پایان مشخص نشده است.</p>"; }
        }
        function startCountdown(targetDate, auth, db) {
            const countdownElements = { days: document.getElementById('days'), hours: document.getElementById('hours'), minutes: document.getElementById('minutes'), seconds: document.getElementById('seconds') };
            const interval = setInterval(() => {
                const distance = targetDate.getTime() - new Date().getTime();
                if (distance < 0) {
                    clearInterval(interval);
                    document.getElementById('maintenance-panel').style.display = 'none';
                    bottomLoader.style.display = 'flex'; // [MODIFIED] Show loader
                    startNormalLoading(auth, db);
                    return;
                }
                const f = (n) => String(Math.floor(n)).padStart(2, '0');
                countdownElements.days.textContent = f(distance / (1000 * 60 * 60 * 24));
                countdownElements.hours.textContent = f((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                countdownElements.minutes.textContent = f((distance % (1000 * 60 * 60)) / (1000 * 60));
                countdownElements.seconds.textContent = f((distance % (1000 * 60)) / 1000);
            }, 1000);
        }
        async function main() {
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                const maintenanceDocRef = doc(db, 'settings', 'maintenance');
                const docSnap = await getDoc(maintenanceDocRef);

                if (docSnap.exists() && docSnap.data().enabled === true) {
                    showMaintenancePanel(docSnap.data(), auth, db);
                } else {
                    startNormalLoading(auth, db);
                }
            } catch (error) {
                console.error("خطا در اتصال اولیه:", error);
                statusMessage.textContent = 'خطا در اتصال! اینترنت خود را بررسی کنید.';
            }
        }
        
        main();
    </script>
</body>
</html>
