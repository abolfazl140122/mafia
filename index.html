<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهر مافیا - در حال اتصال...</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ==================== THEME: DARK WOOD & NEON GOLD ==================== */
        :root {
            --wood-dark: #1a140f;
            --wood-texture-url: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            --panel-bg-gradient: linear-gradient(145deg, #4a3a2a, #2c2218);
            --panel-border: #5c4a3a;
            --text-gold: #ffc947;
            --text-gold-dark: #e5a500;
            --text-light: #e0dacc;
            --glow-green: #39ff14;
            --glow-red: #ff3131;
            --logo-glow-main: #ffdd00;
            --progress-bar-bg: #2a1f15;
            --progress-bar-fill-start: #1eff00;
            --progress-bar-fill-end: #00ff87;
            --progress-bar-error-start: #ff416c;
            --progress-bar-error-end: #ff4b2b;
            --success-color: #28a745;
            --error-color: #dc3545;
        }

        @keyframes panel-intro {
            from { opacity: 0; transform: translateY(50px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes dual-glow-pulse {
            0% { transform: rotate(0deg) scale(1); opacity: 0.7; }
            50% { transform: rotate(180deg) scale(1.1); opacity: 1; }
            100% { transform: rotate(360deg) scale(1); opacity: 0.7; }
        }
        @keyframes logo-glow {
            0%, 100% { filter: drop-shadow(0 0 8px var(--logo-glow-main)) drop-shadow(0 0 16px rgba(255, 221, 0, 0.5)); }
            50% { filter: drop-shadow(0 0 16px var(--logo-glow-main)) drop-shadow(0 0 32px rgba(255, 221, 0, 0.7)); }
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--wood-dark);
            background-image: var(--wood-texture-url);
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #loading-panel {
            width: 100%;
            max-width: 480px;
            background: var(--panel-bg-gradient);
            border-radius: 24px;
            border: 2px solid var(--panel-border);
            padding: 30px 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            text-align: center;
            animation: panel-intro 1s cubic-bezier(0.25, 1, 0.5, 1);
        }

        #logo-container {
            position: relative; margin: 0 auto 25px auto; width: 180px; height: 180px;
            display: flex; align-items: center; justify-content: center;
        }
        #logo-container::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: conic-gradient(var(--glow-green), var(--glow-red), var(--glow-green));
            filter: blur(40px); animation: dual-glow-pulse 6s linear infinite;
        }
        #logo {
            width: 100%; height: auto; position: relative; z-index: 1;
            animation: logo-glow 3s ease-in-out infinite;
        }
        
        #title {
            font-size: 3rem; font-weight: 900; color: var(--text-gold); margin-bottom: 30px;
            text-shadow: 0 0 5px rgba(255, 201, 71, 0.5), 2px 2px 4px rgba(0,0,0,0.5);
        }

        #progress-bar-container {
            width: 100%; height: 20px; background-color: var(--progress-bar-bg);
            border-radius: 10px; padding: 3px; margin-bottom: 15px;
        }
        #progress-bar-fill {
            width: 0%; height: 100%; border-radius: 7px;
            background: linear-gradient(90deg, var(--progress-bar-fill-start), var(--progress-bar-fill-end));
            transition: width 0.5s cubic-bezier(0.65, 0, 0.35, 1), background 0.5s ease;
        }
        #progress-bar-fill.error {
            background: linear-gradient(90deg, var(--progress-bar-error-start), var(--progress-bar-error-end));
        }

        #status-message { font-size: 1rem; font-weight: 700; min-height: 24px; }
        
        #action-button {
            display: none; /* مخفی در ابتدا */
            margin-top: 25px; padding: 12px 40px; font-family: 'Vazirmatn', sans-serif;
            font-size: 1.2rem; font-weight: 700; color: var(--wood-dark);
            background: linear-gradient(180deg, var(--text-gold), var(--text-gold-dark));
            border: 2px solid #a07200; border-radius: 12px; cursor: pointer;
            box-shadow: 0 5px 0 #a07200; transition: all 0.15s ease-out;
            animation: fade-in-up 0.5s 0.2s ease-out forwards;
        }
        #action-button:hover { transform: translateY(-2px); box-shadow: 0 7px 0 #a07200; }
        #action-button:active { transform: translateY(3px); box-shadow: 0 2px 0 #a07200; }
    </style>
</head>
<body>

    <div id="loading-panel">
        <div id="logo-container">
            <img id="logo" src="https://up.20script.ir/file/40b6-Copilot-20250812-110015-removebg-preview.png" alt="لوگوی شهر مافیا">
        </div>
        <h1 id="title">شهر مافیا</h1>
        <div id="progress-bar-container">
            <div id="progress-bar-fill"></div>
        </div>
        <p id="status-message">در حال آماده سازی...</p>
        <button id="action-button"></button>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // КОНФИГУРАЦИЯ FIREBASE ВАШЕГО ВЕБ-ПРИЛОЖЕНИЯ
        const firebaseConfig = {
            apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
            authDomain: "mafia-9fcbf.firebaseapp.com",
            projectId: "mafia-9fcbf",
            storageBucket: "mafia-9fcbf.appspot.com",
            messagingSenderId: "471627157488",
            appId: "1:471627157488:web:92f008548a5596619a5735",
            measurementId: "G-0PDHDWC6NV"
        };
        
        // ВЫБОР ЭЛЕМЕНТОВ DOM
        const progressBarFill = document.getElementById('progress-bar-fill');
        const statusMessage = document.getElementById('status-message');
        const actionButton = document.getElementById('action-button');

        /**
         * تابع برای به‌روزرسانی نوار پیشرفت و پیام
         */
        function updateProgress(percent, message) {
            progressBarFill.style.width = `${percent}%`;
            statusMessage.textContent = message;
        }

        /**
         * تابع اصلی برای شروع فرآیند لودینگ واقعی
         */
        async function initLoadingSequence() {
            try {
                // مرحله 1: شروع اتصال
                updateProgress(20, '...در حال راه‌اندازی سیستم');
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                updateProgress(50, '...برقراری ارتباط با سرورهای شهر');
                
                // مرحله 2: بررسی وضعیت احراز هویت کاربر
                const user = await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        unsubscribe(); // فقط یکبار اجرا شود
                        resolve(user);
                    }, (error) => {
                        unsubscribe();
                        reject(error);
                    });
                    // تایم‌اوت برای جلوگیری از انتظار بی‌نهایت
                    setTimeout(() => reject(new Error("Connection timed out")), 10000);
                });

                // مرحله 3: تصمیم‌گیری بر اساس وضعیت کاربر
                updateProgress(100, 'اتصال با موفقیت برقرار شد!');
                
                if (user) {
                    // کاربر وارد شده است
                    statusMessage.textContent = `خوش آمدید، ${user.email || 'بازیکن'}!`;
                    actionButton.textContent = 'ورود به بازی';
                    actionButton.style.display = 'block';
                    actionButton.onclick = () => {
                        // **مهم:** آدرس صفحه اصلی بازی را اینجا قرار دهید
                         window.location.href = './شهر مافیا رفع باگ.txt'; // <-- اینجا را ویرایش کنید
                    };
                } else {
                    // کاربر وارد نشده است
                    statusMessage.textContent = 'برای ورود به شهر آماده شوید.';
                    actionButton.textContent = 'ورود / ثبت نام';
                    actionButton.style.display = 'block';
                    actionButton.onclick = () => {
                        window.location.href = './login.html';
                    };
                }

            } catch (error) {
                // مدیریت خطا در فرآیند لودینگ
                console.error("Loading sequence failed:", error);
                progressBarFill.classList.add('error');
                updateProgress(100, 'خطا در اتصال به سرور!');
                statusMessage.textContent = 'امکان اتصال به سرورهای بازی وجود ندارد.';
                actionButton.textContent = 'تلاش مجدد';
                actionButton.style.display = 'block';
                actionButton.onclick = () => {
                    window.location.reload();
                };
            }
        }

        // شروع فرآیند لودینگ پس از بارگذاری کامل صفحه
        document.addEventListener('DOMContentLoaded', initLoadingSequence);
    </script>

</body>
</html>
