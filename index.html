<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>در حال بارگذاری بازی...</title>
    <style>
        /* استایل‌های کلی */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            overflow: hidden; /* جلوگیری از اسکرول */
        }

        /* صفحه لودینگ */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        /* انیمیشن اسپینر */
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #444;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* متن وضعیت */
        #status-text {
            font-size: 1.2em;
            color: #cccccc;
        }
        
        #status-text.error {
            color: #e74c3c; /* رنگ قرمز برای خطا */
        }

        /* محفظه خطا و دکمه تلاش مجدد */
        #error-container {
            margin-top: 20px;
            text-align: center;
        }

        #retry-button {
            padding: 10px 20px;
            font-size: 1em;
            color: #ffffff;
            background-color: #3498db;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #retry-button:hover {
            background-color: #2980b9;
        }

        /* محتوای اصلی بازی (در ابتدا مخفی است) */
        #game-content {
            padding: 20px;
            text-align: center;
        }

        /* کلاس کمکی برای مخفی کردن عناصر */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <!-- صفحه لودینگ -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <p id="status-text">در حال آماده سازی...</p>
        <div id="error-container" class="hidden">
            <button id="retry-button">تلاش مجدد</button>
        </div>
    </div>

    <!-- محتوای اصلی بازی -->
    <div id="game-content" class="hidden">
        <h1>بازی مافیا</h1>
        <p>محتوای اصلی بازی شما در اینجا قرار می‌گیرد.</p>
        <!-- بقیه اجزای بازی -->
    </div>

    <!-- استفاده از type="module" برای ایمپورت کردن ماژول‌های Firebase الزامی است -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        // برای بررسی اتصال واقعی به سرور، ما از سرویس Realtime Database استفاده می‌کنیم
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
            authDomain: "mafia-9fcbf.firebaseapp.com",
            projectId: "mafia-9fcbf",
            storageBucket: "mafia-9fcbf.firebasestorage.app",
            messagingSenderId: "471627157488",
            appId: "1:471627157488:web:92f008548a5596619a5735",
            measurementId: "G-0PDHDWC6NV"
        };

        // دریافت ارجاع به عناصر HTML
        const loadingScreen = document.getElementById('loading-screen');
        const statusText = document.getElementById('status-text');
        const errorContainer = document.getElementById('error-container');
        const retryButton = document.getElementById('retry-button');
        const gameContent = document.getElementById('game-content');
        const spinner = document.querySelector('.spinner');

        // تابع برای به‌روزرسانی متن وضعیت
        function updateStatus(message, isError = false) {
            statusText.textContent = message;
            if (isError) {
                statusText.classList.add('error');
            } else {
                statusText.classList.remove('error');
            }
        }

        // تابع اصلی برای شروع فرآیند اتصال
        async function startConnectionProcess() {
            // ریست کردن UI برای تلاش مجدد
            spinner.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            updateStatus('در حال آماده سازی...');

            // مرحله ۱: بررسی اتصال اینترنت دستگاه کاربر
            await new Promise(resolve => setTimeout(resolve, 500)); // تاخیر کوتاه برای نمایش پیام
            updateStatus('بررسی اتصال اینترنت...');

            if (!navigator.onLine) {
                updateStatus('شما به اینترنت متصل نیستید!', true);
                spinner.classList.add('hidden');
                errorContainer.classList.remove('hidden');
                return; // پایان فرآیند
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000)); // تاخیر

            // مرحله ۲: اتصال به سرور Firebase
            try {
                updateStatus('در حال اتصال به سرور...');

                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                const analytics = getAnalytics(app);
                const database = getDatabase(app);

                // بهترین راه برای تست اتصال، خواندن یک داده ساده از دیتابیس است.
                // .info/connected یک مسیر ویژه در Firebase Realtime Database است که وضعیت اتصال کلاینت را نشان می‌دهد.
                const connectedRef = ref(database, '.info/connected');
                const snapshot = await get(connectedRef);

                if (snapshot.val() === true) {
                    updateStatus('اتصال با موفقیت برقرار شد!');
                    await new Promise(resolve => setTimeout(resolve, 1500));

                    // محو کردن صفحه لودینگ و نمایش محتوای بازی
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                        gameContent.classList.remove('hidden');
                    }, 500); // منتظر می‌مانیم تا انیمیشن محو شدن تمام شود
                } else {
                    // این حالت به ندرت اتفاق می‌افتد اما ممکن است
                    throw new Error('Firebase reports disconnected status.');
                }
            } catch (error) {
                console.error("خطا در اتصال به Firebase:", error);
                updateStatus('خطا در برقراری ارتباط با سرور!', true);
                spinner.classList.add('hidden');
                errorContainer.classList.remove('hidden');
            }
        }

        // افزودن رویداد کلیک به دکمه "تلاش مجدد"
        retryButton.addEventListener('click', startConnectionProcess);

        // شروع فرآیند به محض بارگذاری کامل صفحه
        document.addEventListener('DOMContentLoaded', startConnectionProcess);

    </script>
</body>
</html>
