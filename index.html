<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهر مافیا - در حال بارگذاری</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --wood-dark: #0c0a09; /* Darker base for new background */
            --text-gold: #ffc947;
            --text-light: #e0dacc;
            --logo-glow-main: #ffdd00;
            --progress-bar-bg: rgba(0,0,0,0.4);
            --progress-bar-fill-start: #8c4843;
            --progress-bar-fill-end: #ffc947;
            --countdown-bg: rgba(0,0,0,0.3);
            --panel-glow: rgba(255, 201, 71, 0.5);
            /* Suspension styles */
            --suspension-red: #e74c3c;
            --suspension-border: #c0392b;
            --suspension-glow: rgba(231, 76, 60, 0.5);
            /* [NEW] Viewport height variable for mobile browsers */
            --vh: 1vh; 
        }
        @keyframes panel-intro { from { opacity: 0; transform: translateY(50px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            width: 100%;
            height: 100%; 
            overflow: hidden; 
        }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--wood-dark);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #preloader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: calc(var(--vh, 1vh) * 100);
            background-color: var(--wood-dark);
            z-index: 9999;
            transition: opacity 0.7s ease-in-out;
        }

        #bottom-loader {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px 40px 30px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px; /* Increased gap */
            z-index: 100;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
        }
        
        /* [MODIFIED] Progress bar is now thicker */
        #bottom-loader #progress-bar-container {
            width: 100%;
            max-width: 480px;
            height: 12px; /* Increased from 8px */
            background-color: var(--progress-bar-bg);
            border-radius: 6px; /* Increased from 4px */
            overflow: hidden;
            padding: 2px;
            border: 1px solid rgba(255, 201, 71, 0.2);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
        }
        #bottom-loader #progress-bar-fill {
            width: 0%;
            height: 100%;
            border-radius: 4px; /* Increased from 2px */
            background: linear-gradient(90deg, var(--progress-bar-fill-start), var(--progress-bar-fill-end));
            transition: width 0.4s cubic-bezier(0.65, 0, 0.35, 1);
        }
        
        /* [NEW] Container for status message and percentage */
        #status-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 480px;
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--text-light);
            opacity: 0.9;
            min-height: 1.2em;
        }
        #status-message {
             /* Styles are now mainly on the container */
        }
        #status-percentage {
            font-weight: 700;
            font-variant-numeric: tabular-nums; /* Keeps width of numbers consistent */
            direction: ltr; /* Percentages should be LTR */
        }
        
        .panel {
            width: 90%;
            max-width: 480px;
            background: rgba(10, 5, 2, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 1px solid rgba(255, 201, 71, 0.25);
            padding: 30px 40px;
            text-align: center;
            animation: panel-intro 1s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }
        
        #maintenance-panel { box-shadow: 0 0 25px var(--panel-glow), 0 15px 45px rgba(0, 0, 0, 0.7); padding: 25px; }
        #maintenance-banner-container { width: 100%; margin-bottom: 25px; border-radius: 16px; overflow: hidden; background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255, 201, 71, 0.2); }
        #maintenance-banner { width: 100%; height: auto; display: block; }
        #maintenance-title { font-size: 2rem; font-weight: 900; color: var(--text-gold); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #maintenance-message { font-size: 1rem; line-height: 1.8; margin-bottom: 30px; color: var(--text-light); padding: 0 15px; }
        
        .countdown-timer { display: flex; flex-direction: row-reverse; justify-content: center; gap: 15px; }
        .time-block { background-color: var(--countdown-bg); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 201, 71, 0.15); min-width: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .time-value { font-size: 3rem; font-weight: 900; color: white; line-height: 1; }
        .time-label { font-size: 0.8rem; font-weight: 400; color: var(--text-light); margin-top: 8px; }

        #suspension-panel { border-color: var(--suspension-border); box-shadow: 0 0 25px var(--suspension-glow), 0 15px 45px rgba(0, 0, 0, 0.7); padding: 35px; }
        
        #suspension-user-info { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        #suspension-avatar { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 3px solid var(--suspension-red); box-shadow: 0 5px 15px rgba(0,0,0,0.5); margin-bottom: 15px; }
        #suspension-username { font-size: 1.5rem; font-weight: 700; color: var(--text-light); text-shadow: 1px 1px 3px #000; }
        
        #suspension-title { font-size: 2rem; color: var(--suspension-red); margin-bottom: 15px; font-weight: 900; }
        #suspension-reason { font-size: 1.1rem; margin-bottom: 25px; padding: 12px; background-color: rgba(0,0,0,0.3); border-radius: 8px; font-style: italic; border: 1px solid rgba(255,255,255,0.1); }
        #suspension-message { margin-bottom: 20px; font-size: 1rem; color: var(--text-light); }
        
        #suspension-countdown-timer { margin-bottom: 35px; }
        #suspension-countdown-timer .time-block { border-color: var(--suspension-border); background-color: rgba(231, 76, 60, 0.1); }
        #suspension-countdown-timer .time-value { color: #f8d7da; }
        #suspension-countdown-timer .time-label { color: #f5c6cb; }

        #logout-btn { background: linear-gradient(145deg, #616161, #3a3a3a); border: 1px solid #777; color: var(--text-light); padding: 12px 30px; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        #logout-btn:hover { background: linear-gradient(145deg, #757575, #4f4f4f); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        #logout-btn:active { transform: translateY(0); }
    </style>
</head>
<body>

    <div id="preloader-overlay"></div>

    <div id="bottom-loader" style="display: flex;">
        <div id="progress-bar-container">
            <div id="progress-bar-fill"></div>
        </div>
        <div id="status-container">
            <span id="status-message">در حال آماده سازی...</span>
            <span id="status-percentage"></span>
        </div>
    </div>

    <div id="maintenance-panel" class="panel" style="display: none;">
        <div id="maintenance-banner-container"><img id="maintenance-banner" src="" alt="بنر بروزرسانی"></div>
        <h1 id="maintenance-title"></h1>
        <p id="maintenance-message"></p>
        <div class="countdown-timer">
            <div class="time-block"><div id="days" class="time-value">00</div><div class="time-label">روز</div></div>
            <div class="time-block"><div id="hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
            <div class="time-block"><div id="minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
            <div class="time-block"><div id="seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
    </div>

    <div id="suspension-panel" class="panel" style="display: none;">
        <div id="suspension-user-info">
            <img id="suspension-avatar" src="" alt="آواتار کاربر">
            <h3 id="suspension-username"></h3>
        </div>
        <h1 id="suspension-title">حساب کاربری مسدود است</h1>
        <p id="suspension-reason"></p>
        <p id="suspension-message">زمان باقی‌مانده تا رفع مسدودیت:</p>
        <div id="suspension-countdown-timer" class="countdown-timer">
             <div class="time-block"><div id="s-days" class="time-value">00</div><div class="time-label">روز</div></div>
             <div class="time-block"><div id="s-hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
             <div class="time-block"><div id="s-minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
             <div class="time-block"><div id="s-seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
        <button id="logout-btn">خروج از حساب</button>
    </div>
    
    <audio id="background-music" loop></audio>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =================================================================
            // CONFIGURATION - تنظیمات اصلی
            // =================================================================
            const API_ENDPOINT = 'https://miko.freehost.io/mafianovin.php'; // آدرس فایل واسط PHP شما
            const API_SECRET_KEY = 'sjnrsontORFBioerrt4651renttn'; // کلید امنیتی که در mafianovin.php تعریف کردید

            const MUSIC_URL = "https://raw.githubusercontent.com/abolfazl140122/mafia/main/dark-music-249503.mp3";
            const MUSIC_CACHE_NAME = 'mafia-music-cache-v1';
            const MUSIC_VERSION_KEY = 'mafia-music-version';
            const DEFAULT_AVATAR = 'https://i.imgur.com/T2bT1tG.png';

            // =================================================================
            // DOM ELEMENTS - المنت‌های HTML
            // =================================================================
            const progressBarFill = document.getElementById('progress-bar-fill');
            const statusMessageEl = document.getElementById('status-message');
            const statusPercentageEl = document.getElementById('status-percentage');
            const backgroundMusic = document.getElementById('background-music');
            const bottomLoader = document.getElementById('bottom-loader');
            const maintenancePanel = document.getElementById('maintenance-panel');
            const suspensionPanel = document.getElementById('suspension-panel');
            const logoutBtn = document.getElementById('logout-btn');
            const allViews = [bottomLoader, maintenancePanel, suspensionPanel];

            // =================================================================
            // API HELPER FUNCTION - تابع کمکی برای ارتباط با واسط PHP
            // =================================================================
            /**
             * ارسال درخواست به واسط PHP برای تعامل با Firebase
             * @param {string} action - عملیات مورد نظر (get, set, update, delete, push)
             * @param {string} path - مسیر در Realtime Database (مثلاً /users/userId)
             * @param {object|null} data - داده‌ها برای عملیات‌های set, update, push
             * @returns {Promise<any>} - پاسخ سرور
             */
            async function callApi(action, path, data = null) {
                try {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            secret_key: API_SECRET_KEY,
                            action: action,
                            path: path,
                            data: data
                        })
                    });

                    if (!response.ok) {
                        const errorBody = await response.json().catch(() => ({ message: response.statusText }));
                        throw new Error(`خطای شبکه: ${response.status} - ${errorBody.message || 'پاسخ نامشخص از سرور'}`);
                    }

                    const result = await response.json();

                    if (result.status === 'error') {
                        throw new Error(result.message);
                    }

                    return result.data;
                } catch (error) {
                    console.error(`خطا در فراخوانی API برای اکشن '${action}' در مسیر '${path}':`, error);
                    throw error; // خطا را دوباره پرتاب می‌کنیم تا فرآیند بارگذاری متوقف شود
                }
            }
            
            // =================================================================
            // UI & LOGIC FUNCTIONS - توابع رابط کاربری و منطق
            // =================================================================

            // تنظیم ارتفاع ویوپورت برای موبایل
            const setVh = () => {
                document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            };
            window.addEventListener('resize', setVh);
            setVh(); 

            // نمایش یک ویو خاص و مخفی کردن بقیه
            function showView(viewName) {
                allViews.forEach(view => view.style.display = 'none');
                switch (viewName) {
                    case 'loading': bottomLoader.style.display = 'flex'; break;
                    case 'maintenance': maintenancePanel.style.display = 'block'; break;
                    case 'suspended': suspensionPanel.style.display = 'block'; break;
                    default: console.error(`Unknown view: ${viewName}`);
                }
            }
            
            // به‌روزرسانی نوار پیشرفت کلی
            const updateOverallProgress = (percentage) => {
                progressBarFill.style.width = `${percentage}%`;
            };

            // به‌روزرسانی پیام و درصد وضعیت وظیفه
            const updateTaskStatus = (message, percentage) => {
                statusMessageEl.textContent = message;
                if (percentage !== null && percentage !== undefined) {
                    statusPercentageEl.textContent = `${Math.round(percentage)}%`;
                    statusPercentageEl.style.display = 'inline';
                } else {
                    statusPercentageEl.style.display = 'none';
                    statusPercentageEl.textContent = '';
                }
            };
            
            // نمایش خطای بارگذاری
            const showLoadingError = (message) => {
                updateOverallProgress(100);
                updateTaskStatus(message, null);
                progressBarFill.style.background = 'linear-gradient(90deg, #c0392b, #e74c3c)';
            };

            // تأخیر زمانی
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            
            // پخش موسیقی از Blob
            function playMusicFromBlob(blob) {
                try {
                    const objectUrl = URL.createObjectURL(blob);
                    backgroundMusic.src = objectUrl;
                    backgroundMusic.volume = 0.4;
                    backgroundMusic.play().catch(e => console.warn("پخش خودکار موسیقی توسط مرورگر مسدود شد.", e));
                } catch (error) {
                    console.error("خطا در ایجاد URL برای پخش موسیقی:", error);
                }
            }

            // دانلود و کش کردن موسیقی
            function downloadAndCacheMusic(progressCallback) {
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', MUSIC_URL, true);
                    xhr.responseType = 'blob';
                    xhr.onprogress = (event) => {
                        if (event.lengthComputable) {
                            const percentComplete = Math.round((event.loaded / event.total) * 100);
                            progressCallback(percentComplete);
                        }
                    };
                    xhr.onload = async () => {
                        if (xhr.status === 200) {
                            const musicBlob = xhr.response;
                            try {
                                const cache = await caches.open(MUSIC_CACHE_NAME);
                                await cache.put(MUSIC_URL, new Response(musicBlob));
                                localStorage.setItem(MUSIC_VERSION_KEY, MUSIC_URL);
                                resolve(musicBlob);
                            } catch (cacheError) {
                                reject(cacheError);
                            }
                        } else {
                            reject(new Error(`خطای شبکه در دانلود موسیقی: ${xhr.statusText}`));
                        }
                    };
                    xhr.onerror = () => {
                        reject(new Error('خطای شبکه در هنگام دانلود موسیقی.'));
                    };
                    xhr.send();
                });
            }
            
            // مدیریت موسیقی پس‌زمینه
            async function handleBackgroundMusic(onProgress) {
                const cachedVersion = localStorage.getItem(MUSIC_VERSION_KEY);
                try {
                    if (cachedVersion === MUSIC_URL) {
                        const cache = await caches.open(MUSIC_CACHE_NAME);
                        const cachedResponse = await cache.match(MUSIC_URL);
                        if (cachedResponse) {
                            onProgress(50);
                            const musicBlob = await cachedResponse.blob();
                            playMusicFromBlob(musicBlob);
                            onProgress(100);
                            return;
                        }
                    }
                    const musicBlob = await downloadAndCacheMusic(onProgress);
                    playMusicFromBlob(musicBlob);
                } catch (error) {
                    console.error('فرایند مدیریت موسیقی با خطا مواجه شد:', error);
                    // موسیقی حیاتی نیست، فقط خطا را لاگ می‌کنیم.
                }
            }

            // انتقال به صفحه اصلی بازی
            async function transitionToGame(displayName) {
                showView('loading');
                updateOverallProgress(100);
                updateTaskStatus(`خوش آمدید، ${displayName}!`, null);
                await delay(2000);
                window.location.href = './main.html'; // آدرس صفحه اصلی بازی
            }
            
            // پر کردن پنل مسدودیت کاربر
            function populateSuspensionPanel(config, currentUserId) {
                const displayName = config.displayName || 'کاربر';
                document.getElementById('suspension-avatar').src = config.avatarUrl || DEFAULT_AVATAR;
                document.getElementById('suspension-username').textContent = displayName;
                document.getElementById('suspension-reason').textContent = `دلیل: ${config.banReason || 'نامشخص'}`;
                
                // زمان banExpiresAt از PHP به صورت رشته ISO Format می‌آید
                const targetDate = new Date(config.banExpiresAt);
                startSuspensionCountdown(targetDate, currentUserId, displayName);
                
                logoutBtn.onclick = () => {
                    // شبیه‌سازی خروج از حساب: پاک کردن localStorage و ریدایرکت
                    localStorage.removeItem('userId');
                    window.location.href = './login.html'; // آدرس صفحه ورود
                };
            }

            // شروع شمارش معکوس مسدودیت
            function startSuspensionCountdown(targetDate, currentUserId, displayName) {
                const countdownElements = {
                    days: document.getElementById('s-days'),
                    hours: document.getElementById('s-hours'),
                    minutes: document.getElementById('s-minutes'),
                    seconds: document.getElementById('s-seconds')
                };
                const interval = setInterval(async () => {
                    const distance = targetDate.getTime() - new Date().getTime();
                    if (distance < 0) {
                        clearInterval(interval);
                        try {
                            // رفع خودکار مسدودیت از طریق واسط PHP
                            await callApi('update', `/users/${currentUserId}/suspension`, { isBanned: false, banReason: null, banExpiresAt: null });
                            console.log("مسدودیت کاربر به صورت خودکار رفع شد.");
                        } catch(e) {
                            console.error("خطا در رفع خودکار مسدودیت:", e);
                        }
                        await transitionToGame(displayName);
                        return;
                    }
                    const f = (n) => String(Math.floor(n)).padStart(2, '0');
                    countdownElements.days.textContent = f(distance / (1000 * 60 * 60 * 24));
                    countdownElements.hours.textContent = f((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    countdownElements.minutes.textContent = f((distance % (1000 * 60 * 60)) / (1000 * 60));
                    countdownElements.seconds.textContent = f((distance % (1000 * 60)) / 1000);
                }, 1000);
            }

            // پر کردن پنل تعمیرات
            function populateMaintenancePanel(config) {
                const bannerContainer = document.getElementById('maintenance-banner-container');
                if (config.imageUrl) {
                    document.getElementById('maintenance-banner').src = config.imageUrl;
                    bannerContainer.style.display = 'block';
                } else {
                    bannerContainer.style.display = 'none';
                }
                const titleEl = document.getElementById('maintenance-title');
                titleEl.textContent = config.title || "در حال بروزرسانی";
                if (config.titleColor) { titleEl.style.color = config.titleColor; }
                const messageEl = document.getElementById('maintenance-message');
                messageEl.textContent = config.message || "به زودی باز خواهیم گشت.";
                if (config.textColor) { messageEl.style.color = config.textColor; }
            }

            // مدیریت اتمام زمان تعمیرات
            function handleMaintenanceFinish() {
                document.getElementById('maintenance-title').textContent = "بروزرسانی به پایان رسید";
                document.getElementById('maintenance-message').textContent = "در حال هدایت شما به بازی...";
                const countdownElements = {
                    days: document.getElementById('days'),
                    hours: document.getElementById('hours'),
                    minutes: document.getElementById('minutes'),
                    seconds: document.getElementById('seconds')
                };
                Object.values(countdownElements).forEach(el => el.textContent = '00');
                setTimeout(() => {
                    showView('loading');
                    startNewLoadingSequence().catch(err => console.error("Error after maintenance:", err));
                }, 2500);
            }

            // شروع شمارش معکوس تعمیرات
            function startMaintenanceCountdown(targetDate) {
                const countdownElements = {
                    days: document.getElementById('days'),
                    hours: document.getElementById('hours'),
                    minutes: document.getElementById('minutes'),
                    seconds: document.getElementById('seconds')
                };
                const interval = setInterval(() => {
                    const distance = targetDate.getTime() - new Date().getTime();
                    if (distance < 0) {
                        clearInterval(interval);
                        handleMaintenanceFinish();
                        return;
                    }
                    const f = (n) => String(Math.floor(n)).padStart(2, '0');
                    countdownElements.days.textContent = f(distance / (1000 * 60 * 60 * 24));
                    countdownElements.hours.textContent = f((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    countdownElements.minutes.textContent = f((distance % (1000 * 60 * 60)) / (1000 * 60));
                    countdownElements.seconds.textContent = f((distance % (1000 * 60)) / 1000);
                }, 1000);
            }

            // =================================================================
            // CORE APPLICATION LOGIC - منطق اصلی برنامه
            // =================================================================

            // تابع کمکی برای شبیه‌سازی پیشرفت برای عملیات‌های سریع و غیرقابل ردیابی
            async function withSimulatedProgress(promise, onProgress) {
                let progress = 0;
                const interval = setInterval(() => {
                    if (progress < 95) {
                        progress += Math.random() * 8 + 2; // افزایش تصادفی
                        onProgress(Math.min(progress, 95));
                    }
                }, 120);

                try {
                    return await promise;
                } finally {
                    clearInterval(interval);
                    onProgress(100);
                }
            }
            
            // اجرای دنباله‌ای از وظایف بارگذاری
            async function runTaskSequence(tasks) {
                const totalTasks = tasks.length;
                let context = {}; // کانتکس مشترک برای وظایف

                for (let i = 0; i < totalTasks; i++) {
                    const task = tasks[i];
                    
                    const result = await task.action(
                        (progress) => updateTaskStatus(`${task.name}...`, progress),
                        context
                    );

                    context = { ...context, ...result };
                    updateOverallProgress(((i + 1) / totalTasks) * 100);
                    await delay(200); // تأخیر کوتاه برای تجربه کاربری بهتر
                }
                return context;
            }
            
            // شروع دنباله جدید بارگذاری
            async function startNewLoadingSequence() {
                const loadingTasks = [
                    {
                        name: "احراز هویت کاربر",
                        action: async (onProgress, context) => {
                            const promise = new Promise(async (resolve, reject) => {
                                const userId = localStorage.getItem('userId');
                                if (!userId) {
                                    reject({ type: 'NO_USER' });
                                    return;
                                }
                                try {
                                    // تلاش برای دریافت اطلاعات کاربر برای اعتبارسنجی userId
                                    const userData = await callApi('get', `/users/${userId}`);
                                    if (userData) {
                                        resolve({ userId, userData });
                                    } else {
                                        // اگر userId در localStorage بود اما در Firebase یافت نشد
                                        localStorage.removeItem('userId'); // پاک کردن userId نامعتبر
                                        reject({ type: 'NO_USER' });
                                    }
                                } catch (error) {
                                    // اگر خطایی در ارتباط با API رخ داد (مثلاً کاربر حذف شده)
                                    localStorage.removeItem('userId');
                                    reject({ type: 'ERROR', error });
                                }
                            });
                            return await withSimulatedProgress(promise, onProgress);
                        }
                    },
                    {
                        name: "دریافت اطلاعات بازیکن",
                        action: async (onProgress, context) => {
                            // اطلاعات کاربر در مرحله قبل (احراز هویت) دریافت شده است
                            if (!context.userData) {
                                // اگر به هر دلیلی userData از قبل نبود (نباید اتفاق بیفتد)
                                const userData = await withSimulatedProgress(callApi('get', `/users/${context.userId}`), onProgress);
                                if (!userData) {
                                    throw new Error('اطلاعات کاربر یافت نشد.');
                                }
                                return { userData, displayName: userData.displayName || context.user.displayName };
                            }
                            return { displayName: context.userData.displayName || 'بازیکن جدید' };
                        }
                    },
                    {
                        name: "بررسی وضعیت حساب",
                        action: async (onProgress, context) => {
                            const promise = new Promise((resolve, reject) => {
                                const userData = context.userData;
                                if (userData && userData.suspension && userData.suspension.isBanned === true && userData.suspension.banExpiresAt) {
                                    const banExpiresAt = new Date(userData.suspension.banExpiresAt); // تبدیل رشته به تاریخ
                                    if (banExpiresAt.getTime() > new Date().getTime()) {
                                        reject({ type: 'BANNED', config: userData.suspension, userId: context.userId, displayName: context.displayName });
                                    } else {
                                        // مسدودیت منقضی شده، به صورت خودکار آن را در Firebase غیرفعال می‌کنیم
                                        callApi('update', `/users/${context.userId}/suspension`, { isBanned: false, banReason: null, banExpiresAt: null })
                                            .then(() => resolve())
                                            .catch(e => { console.error("خطا در رفع خودکار مسدودیت منقضی شده:", e); resolve(); }); // ادامه می‌دهیم حتی اگر خطا داد
                                    }
                                } else {
                                    resolve();
                                }
                            });
                            return await withSimulatedProgress(promise, onProgress);
                        }
                    },
                    {
                        name: "بارگذاری منابع",
                        action: async (onProgress) => {
                            await handleBackgroundMusic(onProgress);
                            return {};
                        }
                    }
                ];

                try {
                    const finalContext = await runTaskSequence(loadingTasks);
                    await transitionToGame(finalContext.displayName);
                } catch (rejection) {
                    if (rejection.type === 'BANNED') {
                        populateSuspensionPanel(rejection.config, rejection.userId); // userId هم پاس داده می‌شود
                        showView('suspended');
                    } else if (rejection.type === 'NO_USER') {
                        showLoadingError('احراز هویت ناموفق بود. در حال انتقال به صفحه ورود...');
                        await delay(2500);
                        window.location.href = './login.html'; // آدرس صفحه لاگین شما
                    } else {
                        console.error("خطای جدی در فرآیند بارگذاری:", rejection.error || rejection);
                        showLoadingError('خطا در بارگذاری. لطفاً صفحه را رفرش کنید.');
                    }
                }
            }
            
            // اجرای اولیه برنامه (بررسی تعمیرات)
            async function runAppInitialization() {
                try {
                    const maintenanceConfig = await callApi('get', '/settings/maintenance');

                    if (maintenanceConfig && maintenanceConfig.enabled === true) {
                        populateMaintenancePanel(maintenanceConfig);
                        showView('maintenance');
                        if (maintenanceConfig.endTime) {
                            const targetDate = new Date(maintenanceConfig.endTime); // تبدیل رشته به تاریخ
                            if (targetDate.getTime() - new Date().getTime() < 0) {
                                handleMaintenanceFinish();
                            } else {
                                startMaintenanceCountdown(targetDate);
                            }
                        } else {
                            document.querySelector('#maintenance-panel .countdown-timer').innerHTML = "<p>زمان پایان مشخص نشده است.</p>";
                        }
                    } else {
                        showView('loading');
                        updateTaskStatus('در حال آماده سازی...', null);
                        await startNewLoadingSequence();
                    }
                } catch (error) {
                    console.error("خطا در اتصال اولیه یا دریافت تنظیمات تعمیرات:", error);
                    showView('loading');
                    showLoadingError('خطا در اتصال! اینترنت خود را بررسی کنید.');
                }
            }
            
            // تابع اصلی شروع کننده
            async function main() {
                const preloaderOverlay = document.getElementById('preloader-overlay');
                const body = document.body;
                const imageUrl = 'https://cdn.imgurl.ir/uploads/q9812_file_6917756f1e1d68.57033147.jpg'; // آدرس تصویر پس‌زمینه

                const startApp = () => {
                    preloaderOverlay.style.opacity = '0';
                    preloaderOverlay.addEventListener('transitionend', () => preloaderOverlay.style.display = 'none', { once: true });
                    runAppInitialization();
                };

                const img = new Image();
                img.src = imageUrl;

                if (img.complete) {
                    body.style.backgroundImage = `url(${imageUrl})`;
                    startApp();
                } else {
                    img.onload = () => { body.style.backgroundImage = `url(${imageUrl})`; startApp(); };
                    img.onerror = () => { console.warn('تصویر پس‌زمینه دانلود نشد.'); startApp(); };
                }
            }

            main();
        });
    </script>
</body>
</html>
