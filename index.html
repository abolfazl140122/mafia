<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهر مافیا - در حال بارگذاری</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --wood-dark: #0c0a09; --text-gold: #ffc947; --text-light: #e0dacc; --logo-glow-main: #ffdd00; --progress-bar-bg: rgba(0,0,0,0.4); --progress-bar-fill-start: #8c4843; --progress-bar-fill-end: #ffc947; --countdown-bg: rgba(0,0,0,0.3); --panel-glow: rgba(255, 201, 71, 0.5); --suspension-red: #e74c3c; --suspension-border: #c0392b; --suspension-glow: rgba(231, 76, 60, 0.5); --vh: 1vh; } @keyframes panel-intro { from { opacity: 0; transform: translateY(50px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } } * { margin: 0; padding: 0; box-sizing: border-box; } html, body { width: 100%; height: 100%; overflow: hidden; } body { font-family: 'Vazirmatn', sans-serif; background-color: var(--wood-dark); background-size: cover; background-position: center; background-repeat: no-repeat; color: var(--text-light); display: flex; align-items: center; justify-content: center; } #preloader-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: calc(var(--vh, 1vh) * 100); background-color: var(--wood-dark); z-index: 9999; transition: opacity 0.7s ease-in-out; } #bottom-loader { position: fixed; bottom: 0; left: 0; width: 100%; padding: 20px 40px 30px 40px; display: flex; flex-direction: column; align-items: center; gap: 15px; z-index: 100; transition: opacity 0.5s ease; backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); background: linear-gradient(to top, rgba(0,0,0,0.5), transparent); } #bottom-loader #progress-bar-container { width: 100%; max-width: 480px; height: 12px; background-color: var(--progress-bar-bg); border-radius: 6px; overflow: hidden; padding: 2px; border: 1px solid rgba(255, 201, 71, 0.2); box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); } #bottom-loader #progress-bar-fill { width: 0%; height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(--progress-bar-fill-start), var(--progress-bar-fill-end)); transition: width 0.4s cubic-bezier(0.65, 0, 0.35, 1); } #status-container { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 480px; font-size: 0.85rem; font-weight: 400; color: var(--text-light); opacity: 0.9; min-height: 1.2em; } #status-percentage { font-weight: 700; font-variant-numeric: tabular-nums; direction: ltr; } .panel { width: 90%; max-width: 480px; background: rgba(10, 5, 2, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 24px; border: 1px solid rgba(255, 201, 71, 0.25); padding: 30px 40px; text-align: center; animation: panel-intro 1s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5); } #maintenance-panel { box-shadow: 0 0 25px var(--panel-glow), 0 15px 45px rgba(0, 0, 0, 0.7); padding: 25px; } #maintenance-banner-container { width: 100%; margin-bottom: 25px; border-radius: 16px; overflow: hidden; background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255, 201, 71, 0.2); } #maintenance-banner { width: 100%; height: auto; display: block; } #maintenance-title { font-size: 2rem; font-weight: 900; color: var(--text-gold); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; } #maintenance-message { font-size: 1rem; line-height: 1.8; margin-bottom: 30px; color: var(--text-light); padding: 0 15px; } .countdown-timer { display: flex; flex-direction: row-reverse; justify-content: center; gap: 15px; } .time-block { background-color: var(--countdown-bg); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 201, 71, 0.15); min-width: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; } .time-value { font-size: 3rem; font-weight: 900; color: white; line-height: 1; } .time-label { font-size: 0.8rem; font-weight: 400; color: var(--text-light); margin-top: 8px; } #suspension-panel { border-color: var(--suspension-border); box-shadow: 0 0 25px var(--suspension-glow), 0 15px 45px rgba(0, 0, 0, 0.7); padding: 35px; } #suspension-user-info { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; } #suspension-avatar { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 3px solid var(--suspension-red); box-shadow: 0 5px 15px rgba(0,0,0,0.5); margin-bottom: 15px; } #suspension-username { font-size: 1.5rem; font-weight: 700; color: var(--text-light); text-shadow: 1px 1px 3px #000; } #suspension-title { font-size: 2rem; color: var(--suspension-red); margin-bottom: 15px; font-weight: 900; } #suspension-reason { font-size: 1.1rem; margin-bottom: 25px; padding: 12px; background-color: rgba(0,0,0,0.3); border-radius: 8px; font-style: italic; border: 1px solid rgba(255,255,255,0.1); } #suspension-message { margin-bottom: 20px; font-size: 1rem; color: var(--text-light); } #suspension-countdown-timer { margin-bottom: 35px; } #suspension-countdown-timer .time-block { border-color: var(--suspension-border); background-color: rgba(231, 76, 60, 0.1); } #suspension-countdown-timer .time-value { color: #f8d7da; } #suspension-countdown-timer .time-label { color: #f5c6cb; } #logout-btn { background: linear-gradient(145deg, #616161, #3a3a3a); border: 1px solid #777; color: var(--text-light); padding: 12px 30px; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; } #logout-btn:hover { background: linear-gradient(145deg, #757575, #4f4f4f); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); } #logout-btn:active { transform: translateY(0); }
    </style>
</head>
<body>

    <div id="preloader-overlay"></div>
    <div id="bottom-loader" style="display: flex;">
        <div id="progress-bar-container"><div id="progress-bar-fill"></div></div>
        <div id="status-container">
            <span id="status-message">در حال آماده سازی...</span>
            <span id="status-percentage"></span>
        </div>
    </div>
    <div id="maintenance-panel" class="panel" style="display: none;">
        <div id="maintenance-banner-container"><img id="maintenance-banner" src="" alt="بنر بروزرسانی"></div>
        <h1 id="maintenance-title"></h1>
        <p id="maintenance-message"></p>
        <div class="countdown-timer">
            <div class="time-block"><div id="days" class="time-value">00</div><div class="time-label">روز</div></div>
            <div class="time-block"><div id="hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
            <div class="time-block"><div id="minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
            <div class="time-block"><div id="seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
    </div>
    <div id="suspension-panel" class="panel" style="display: none;">
        <div id="suspension-user-info">
            <img id="suspension-avatar" src="" alt="آواتار کاربر">
            <h3 id="suspension-username"></h3>
        </div>
        <h1 id="suspension-title">حساب کاربری مسدود است</h1>
        <p id="suspension-reason"></p>
        <p id="suspension-message">زمان باقی‌مانده تا رفع مسدودیت:</p>
        <div id="suspension-countdown-timer" class="countdown-timer">
             <div class="time-block"><div id="s-days" class="time-value">00</div><div class="time-label">روز</div></div>
             <div class="time-block"><div id="s-hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
             <div class="time-block"><div id="s-minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
             <div class="time-block"><div id="s-seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
        <button id="logout-btn">خروج از حساب</button>
    </div>
    
    <audio id="background-music" loop></audio>
    
    <script>
        // --- START OF MODIFIED SCRIPT ---

        // --- Core API Communication ---
        // [FIXED] Pointing to the absolute URL of your PHP server on ParsPack
        const API_ENDPOINT = 'https://miko.freehost.io/mafianovin.php';

        async function apiCall(payload) {
            const authToken = localStorage.getItem('firebaseAuthToken');
            if (authToken) {
                payload.authToken = authToken;
            }

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorText;
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || `Request failed with status ${response.status}`;
                    } catch (e) {
                        errorText = `Request failed with status ${response.status}: ${response.statusText}`;
                    }
                    console.error('API Error:', errorText);
                    throw new Error(errorText);
                }

                const responseText = await response.text();
                return responseText ? JSON.parse(responseText) : {};

            } catch (error) {
                console.error('Fetch Error:', error);
                throw error;
            }
        }

        // --- DOM Elements & Constants (mostly unchanged) ---
        const progressBarFill = document.getElementById('progress-bar-fill');
        const statusMessageEl = document.getElementById('status-message');
        const statusPercentageEl = document.getElementById('status-percentage');
        const backgroundMusic = document.getElementById('background-music');
        const bottomLoader = document.getElementById('bottom-loader');
        const maintenancePanel = document.getElementById('maintenance-panel');
        const suspensionPanel = document.getElementById('suspension-panel');
        const logoutBtn = document.getElementById('logout-btn');
        const allViews = [bottomLoader, maintenancePanel, suspensionPanel];
        const MUSIC_URL = "https://raw.githubusercontent.com/abolfazl140122/mafia/main/dark-music-249503.mp3";
        const MUSIC_CACHE_NAME = 'mafia-music-cache-v1';
        const MUSIC_VERSION_KEY = 'mafia-music-version';
        const DEFAULT_AVATAR = 'https://i.imgur.com/T2bT1tG.png';

        // --- UI & Helper Functions (Unchanged) ---
        const setVh = () => { document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); };
        window.addEventListener('resize', setVh);
        setVh();
        function showView(viewName) { allViews.forEach(view => view.style.display = 'none'); switch (viewName) { case 'loading': bottomLoader.style.display = 'flex'; break; case 'maintenance': maintenancePanel.style.display = 'block'; break; case 'suspended': suspensionPanel.style.display = 'block'; break; default: console.error(`Unknown view: ${viewName}`); } }
        const updateOverallProgress = (percentage) => { progressBarFill.style.width = `${percentage}%`; };
        const updateTaskStatus = (message, percentage) => { statusMessageEl.textContent = message; if (percentage !== null && percentage !== undefined) { statusPercentageEl.textContent = `${Math.round(percentage)}%`; statusPercentageEl.style.display = 'inline'; } else { statusPercentageEl.style.display = 'none'; statusPercentageEl.textContent = ''; } };
        const showLoadingError = (message) => { updateOverallProgress(100); updateTaskStatus(message, null); progressBarFill.style.background = 'linear-gradient(90deg, #c0392b, #e74c3c)'; };
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        function playMusicFromBlob(blob) { try { const objectUrl = URL.createObjectURL(blob); backgroundMusic.src = objectUrl; backgroundMusic.volume = 0.4; backgroundMusic.play().catch(e => console.warn("Auto-play blocked.", e)); } catch (error) { console.error("Error playing music from blob:", error); } }
        function downloadAndCacheMusic(progressCallback) { return new Promise((resolve, reject) => { const xhr = new XMLHttpRequest(); xhr.open('GET', MUSIC_URL, true); xhr.responseType = 'blob'; xhr.onprogress = (event) => { if (event.lengthComputable) { const percentComplete = Math.round((event.loaded / event.total) * 100); progressCallback(percentComplete); } }; xhr.onload = async () => { if (xhr.status === 200) { try { const cache = await caches.open(MUSIC_CACHE_NAME); await cache.put(MUSIC_URL, new Response(xhr.response)); localStorage.setItem(MUSIC_VERSION_KEY, MUSIC_URL); resolve(xhr.response); } catch (e) { reject(e); } } else { reject(new Error(`Network error: ${xhr.statusText}`)); } }; xhr.onerror = () => { reject(new Error('Network error during download.')); }; xhr.send(); }); }
        async function handleBackgroundMusic(onProgress) { const cachedVersion = localStorage.getItem(MUSIC_VERSION_KEY); try { if (cachedVersion === MUSIC_URL) { const cache = await caches.open(MUSIC_CACHE_NAME); const cachedResponse = await cache.match(MUSIC_URL); if (cachedResponse) { onProgress(50); const musicBlob = await cachedResponse.blob(); playMusicFromBlob(musicBlob); onProgress(100); return; } } const musicBlob = await downloadAndCacheMusic(onProgress); playMusicFromBlob(musicBlob); } catch (error) { console.error('Music handling failed:', error); } }
        async function transitionToGame(displayName) { showView('loading'); updateOverallProgress(100); updateTaskStatus(`خوش آمدید، ${displayName}!`, null); await delay(2000); window.location.href = './main.html'; }
        
        // --- View Population & Countdown Logic (MODIFIED to use apiCall) ---
        function populateSuspensionPanel(config) {
            const displayName = config.displayName || 'کاربر';
            document.getElementById('suspension-avatar').src = config.avatarUrl || DEFAULT_AVATAR;
            document.getElementById('suspension-username').textContent = displayName;
            document.getElementById('suspension-reason').textContent = `دلیل: ${config.banReason || 'نامشخص'}`;
            const banExpiresDate = new Date(config.banExpiresAt);
            startSuspensionCountdown(banExpiresDate, displayName);
            logoutBtn.onclick = () => {
                localStorage.removeItem('firebaseAuthToken');
                localStorage.removeItem('firebaseUserUid');
                window.location.href = './login.html';
            };
        }

        function startSuspensionCountdown(targetDate, displayName) {
            const countdownElements = { days: document.getElementById('s-days'), hours: document.getElementById('s-hours'), minutes: document.getElementById('s-minutes'), seconds: document.getElementById('s-seconds') };
            const interval = setInterval(async () => {
                const distance = targetDate.getTime() - new Date().getTime();
                if (distance < 0) {
                    clearInterval(interval);
                    try {
                        const userUid = localStorage.getItem('firebaseUserUid');
                        await apiCall({
                            action: 'update_document',
                            collection: 'users',
                            docId: userUid,
                            data: { isBanned: false, banReason: null, banExpiresAt: null }
                        });
                        console.log("Suspension automatically lifted.");
                    } catch(e) {
                        console.error("Error automatically lifting suspension:", e);
                    }
                    await transitionToGame(displayName);
                    return;
                }
                const f = (n) => String(Math.floor(n)).padStart(2, '0');
                countdownElements.days.textContent = f(distance / 86400000);
                countdownElements.hours.textContent = f((distance % 86400000) / 3600000);
                countdownElements.minutes.textContent = f((distance % 3600000) / 60000);
                countdownElements.seconds.textContent = f((distance % 60000) / 1000);
            }, 1000);
        }
        
        // --- Unchanged View Population Functions ---
        function populateMaintenancePanel(config) { /* ... same as before ... */ }
        function handleMaintenanceFinish() { /* ... same as before ... */ }
        function startMaintenanceCountdown(targetDate) { /* ... same as before ... */ }

        // --- Core Application Logic with Task Runner (MODIFIED to use apiCall) ---
        async function withSimulatedProgress(promise, onProgress) { let p = 0; const i = setInterval(() => { if (p < 95) { p += Math.random() * 8 + 2; onProgress(Math.min(p, 95)); } }, 120); try { return await promise; } finally { clearInterval(i); onProgress(100); } }
        async function runTaskSequence(tasks) { const totalTasks = tasks.length; let context = {}; for (let i = 0; i < totalTasks; i++) { const task = tasks[i]; const result = await task.action((progress) => updateTaskStatus(`${task.name}...`, progress), context); context = { ...context, ...result }; updateOverallProgress(((i + 1) / totalTasks) * 100); await delay(200); } return context; }
        
        async function startLoadingSequence() {
            const loadingTasks = [
                {
                    name: "احراز هویت کاربر",
                    action: async (onProgress) => {
                        const promise = new Promise((resolve, reject) => {
                            const userUid = localStorage.getItem('firebaseUserUid');
                            const authToken = localStorage.getItem('firebaseAuthToken');
                            if (userUid && authToken) {
                                resolve({ user: { uid: userUid } });
                            } else {
                                reject({ type: 'NO_USER' });
                            }
                        });
                        return await withSimulatedProgress(promise, onProgress);
                    }
                },
                {
                    name: "دریافت اطلاعات بازیکن",
                    action: async (onProgress, context) => {
                        const userDoc = await withSimulatedProgress(
                            apiCall({ action: 'get_document', collection: 'users', docId: context.user.uid }),
                            onProgress
                        );
                        if (!userDoc) {
                           return { displayName: 'بازیکن جدید' };
                        }
                        return { userData: userDoc, displayName: userDoc.displayName || 'بازیکن' };
                    }
                },
                {
                    name: "بررسی وضعیت حساب",
                    action: async (onProgress, context) => {
                        const promise = new Promise((resolve, reject) => {
                            const userData = context.userData;
                            if (userData && userData.isBanned === true && userData.banExpiresAt && new Date(userData.banExpiresAt) > new Date()) {
                                reject({ type: 'BANNED', config: userData });
                            } else {
                                resolve();
                            }
                        });
                        return await withSimulatedProgress(promise, onProgress);
                    }
                },
                {
                    name: "بارگذاری منابع",
                    action: async (onProgress) => {
                        await handleBackgroundMusic(onProgress);
                        return {};
                    }
                }
            ];

            try {
                const finalContext = await runTaskSequence(loadingTasks);
                await transitionToGame(finalContext.displayName);
            } catch (rejection) {
                if (rejection.type === 'BANNED') {
                    populateSuspensionPanel(rejection.config);
                    showView('suspended');
                } else if (rejection.type === 'NO_USER') {
                    showLoadingError('احراز هویت ناموفق بود. در حال انتقال به صفحه ورود...');
                    await delay(2500);
                    window.location.href = './login.html';
                } else {
                    console.error("Critical loading error:", rejection);
                    showLoadingError('خطا در بارگذاری. لطفاً صفحه را رفرش کنید.');
                }
            }
        }
        
        async function runAppInitialization() {
            try {
                const maintenanceSettings = await apiCall({
                    action: 'get_document',
                    collection: 'settings',
                    docId: 'maintenance'
                });

                if (maintenanceSettings && maintenanceSettings.enabled === true) {
                    populateMaintenancePanel(maintenanceSettings);
                    showView('maintenance');
                } else {
                    showView('loading');
                    updateTaskStatus('در حال آماده سازی...', null);
                    await startLoadingSequence();
                }
            } catch (error) {
                console.error("Initial connection error:", error);
                showView('loading');
                showLoadingError('خطا در اتصال! اینترنت خود را بررسی کنید.');
            }
        }
        
        async function main() {
            const preloaderOverlay = document.getElementById('preloader-overlay');
            const body = document.body;
            const imageUrl = 'https://cdn.imgurl.ir/uploads/q9812_file_6917756f1e1d68.57033147.jpg';
            const startApp = () => { preloaderOverlay.style.opacity = '0'; preloaderOverlay.addEventListener('transitionend', () => preloaderOverlay.style.display = 'none', { once: true }); runAppInitialization(); };
            const img = new Image();
            img.src = imageUrl;
            if (img.complete) { body.style.backgroundImage = `url(${imageUrl})`; startApp(); } else { img.onload = () => { body.style.backgroundImage = `url(${imageUrl})`; startApp(); }; img.onerror = () => { console.warn('Background image failed to load.'); startApp(); }; }
        }

        main();
        // --- END OF MODIFIED SCRIPT ---
    </script>
</body>
</html>
