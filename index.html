<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهر مافیا - در حال اتصال...</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ==================== THEME: DARK WOOD & NEON GOLD ==================== */
        :root {
            --wood-dark: #1a140f;
            --wood-texture-url: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            --panel-bg-gradient: linear-gradient(145deg, #4a3a2a, #2c2218);
            --panel-border: #5c4a3a;
            --text-gold: #ffc947;
            --text-light: #e0dacc;
            --glow-green: #39ff14;
            --glow-red: #ff3131;
            --logo-glow-main: #ffdd00;
            --progress-bar-bg: #2a1f15;
            --progress-bar-fill-start: #1eff00; /* Green for success */
            --progress-bar-fill-end: #00ff87;
            --progress-bar-error-start: #ff416c; /* Red for error */
            --progress-bar-error-end: #ff4b2b;
        }

        @keyframes panel-intro {
            from { opacity: 0; transform: translateY(50px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes dual-glow-pulse {
            0% { transform: rotate(0deg) scale(1); opacity: 0.7; }
            50% { transform: rotate(180deg) scale(1.1); opacity: 1; }
            100% { transform: rotate(360deg) scale(1); opacity: 0.7; }
        }
        @keyframes logo-glow {
            0%, 100% { filter: drop-shadow(0 0 8px var(--logo-glow-main)) drop-shadow(0 0 16px rgba(255, 221, 0, 0.5)); }
            50% { filter: drop-shadow(0 0 16px var(--logo-glow-main)) drop-shadow(0 0 32px rgba(255, 221, 0, 0.7)); }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--wood-dark);
            background-image: var(--wood-texture-url);
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #loading-panel {
            width: 100%;
            max-width: 480px;
            background: var(--panel-bg-gradient);
            border-radius: 24px;
            border: 2px solid var(--panel-border);
            padding: 30px 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            text-align: center;
            animation: panel-intro 1s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* The original image used a different logo, I've used a placeholder that matches the style. */
        /* Please replace "YOUR_LOGO_URL.png" with the actual URL to your logo. */
        #logo-container {
            position: relative; margin: 0 auto 25px auto; width: 180px; height: 180px;
            display: flex; align-items: center; justify-content: center;
        }
        #logo-container::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: conic-gradient(var(--glow-green), var(--glow-red), var(--glow-green));
            filter: blur(40px); animation: dual-glow-pulse 6s linear infinite;
        }
        #logo {
            /* This is a generated logo to match the image. Replace with your own if you have it. */
            content: url('https://i.ibb.co/6y40Wd4/escort-game-logo.png');
            width: 100%; height: auto; position: relative; z-index: 1;
            filter: drop-shadow(0 0 8px var(--logo-glow-main));
            animation: logo-glow 3s ease-in-out infinite;
        }
        
        #title {
            font-size: 3rem; font-weight: 900; color: var(--text-gold); margin-bottom: 30px;
            text-shadow: 0 0 5px rgba(255, 201, 71, 0.5), 2px 2px 4px rgba(0,0,0,0.5);
        }

        #progress-bar-container {
            width: 100%; height: 14px; background-color: var(--progress-bar-bg);
            border-radius: 10px; padding: 3px; margin-bottom: 15px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.4);
        }
        #progress-bar-fill {
            width: 0%; height: 100%; border-radius: 7px;
            background: linear-gradient(90deg, var(--progress-bar-fill-start), var(--progress-bar-fill-end));
            transition: width 0.4s cubic-bezier(0.65, 0, 0.35, 1), background 0.5s ease;
        }
        #progress-bar-fill.error {
            background: linear-gradient(90deg, var(--progress-bar-error-start), var(--progress-bar-error-end));
        }

        #status-message { 
            font-size: 1rem; 
            font-weight: 400; 
            min-height: 24px; 
            color: var(--text-light);
            transition: color 0.5s ease;
        }
        #status-message.error {
            color: var(--progress-bar-error-start);
            font-weight: 700;
        }
    </style>
</head>
<body>

    <div id="loading-panel">
        <div id="logo-container">
            <div id="logo"></div>
        </div>
        <h1 id="title">شهر مافیا</h1>
        <div id="progress-bar-container">
            <div id="progress-bar-fill"></div>
        </div>
        <p id="status-message">در حال آماده سازی...</p>
    </div>
    
    <script type="module">
        // --- وارد کردن ماژول‌های لازم از Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, enableNetwork } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- کانفیگ Firebase شما ---
        // !!! توجه: این اطلاعات حساس نیستند و عمومی محسوب می‌شوند
        const firebaseConfig = {
            apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
            authDomain: "mafia-9fcbf.firebaseapp.com",
            projectId: "mafia-9fcbf",
            storageBucket: "mafia-9fcbf.appspot.com",
            messagingSenderId: "471627157488",
            appId: "1:471627157488:web:92f008548a5596619a5735",
            measurementId: "G-0PDHDWC6NV"
        };
        
        // --- انتخاب عناصر DOM ---
        const progressBarFill = document.getElementById('progress-bar-fill');
        const statusMessage = document.getElementById('status-message');

        /**
         * تابع برای به‌روزرسانی نوار پیشرفت و پیام
         * @param {number} percent - درصد پیشرفت
         * @param {string} message - پیام جدید برای کاربر
         * @param {boolean} [isError=false] - آیا این پیام یک خطاست؟
         */
        function updateProgress(percent, message, isError = false) {
            progressBarFill.style.width = `${percent}%`;
            statusMessage.textContent = message;
            if (isError) {
                progressBarFill.classList.add('error');
                statusMessage.classList.add('error');
            } else {
                progressBarFill.classList.remove('error');
                statusMessage.classList.remove('error');
            }
        }

        /**
         * تابع اصلی برای شروع فرآیند لودینگ
         */
        async function initLoadingSequence() {
            // مرحله 1: بررسی اتصال اولیه اینترنت در مرورگر
            if (!navigator.onLine) {
                updateProgress(100, 'امکان اتصال وجود ندارد. لطفاً اتصال اینترنت خود را بررسی کنید.', true);
                return;
            }

            try {
                // مرحله 2: راه‌اندازی Firebase
                updateProgress(15, '...در حال راه‌اندازی سیستم');
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                await enableNetwork(db); // اطمینان از فعال بودن شبکه برای Firestore
                
                updateProgress(30, '...برقراری ارتباط با سرورهای شهر');

                // مرحله 3: بررسی وضعیت ورود کاربر با onAuthStateChanged
                // این تابع بهترین راه برای چک کردن وضعیت کاربر است
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // کاربر وارد شده است
                        updateProgress(60, '...خوش آمدید! در حال واکشی اطلاعات');
                        
                        try {
                            // واکشی اطلاعات پروفایل از Firestore
                            const userDocRef = doc(db, "users", user.uid); // فرض بر این است که اطلاعات در کالکشن users ذخیره شده
                            const userDocSnap = await getDoc(userDocRef);
                            let displayName = user.email.split('@')[0]; // نام پیش‌فرض

                            if (userDocSnap.exists() && userDocSnap.data().displayName) {
                                displayName = userDocSnap.data().displayName;
                            }
                            
                            updateProgress(100, `!${displayName} عزیز، در حال ورود به بازی`);
                            
                            // تاخیر کوتاه برای نمایش پیام و سپس هدایت
                            setTimeout(() => {
                                window.location.href = './main.html'; // هدایت به صفحه اصلی بازی
                            }, 1500);

                        } catch (firestoreError) {
                            console.error("خطا در واکشی اطلاعات Firestore:", firestoreError);
                            updateProgress(100, 'خطا در دریافت اطلاعات بازیکن!', true);
                        }

                    } else {
                        // کاربر وارد نشده است
                        updateProgress(100, 'در حال هدایت به صفحه ورود...');
                        
                        // تاخیر کوتاه برای نمایش پیام و سپس هدایت
                        setTimeout(() => {
                            window.location.href = './login.html'; // هدایت به صفحه ورود/ثبت‌نام
                        }, 2000);
                    }
                }, (authError) => {
                    // این بخش برای خطاهایی است که در خود onAuthStateChanged رخ می‌دهد
                    console.error("خطای احراز هویت Firebase:", authError);
                    updateProgress(100, 'خطا در سیستم احراز هویت!', true);
                });

            } catch (initializationError) {
                // مدیریت خطا در فرآیند اولیه راه‌اندازی Firebase
                console.error("خطا در راه‌اندازی اولیه Firebase:", initializationError);
                updateProgress(100, 'امکان اتصال وجود ندارد. لطفاً اتصال اینترنت خود را بررسی کنید.', true);
            }
        }

        // شروع فرآیند لودینگ پس از بارگذاری کامل صفحه
        document.addEventListener('DOMContentLoaded', initLoadingSequence);
    </script>

</body>
</html>
