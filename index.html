<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهر مافیا</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- MAFIA CITY - CLASSIC BROWN THEME --- */

        :root {
            --mafia-brown-darkest: #1a1613;
            --mafia-brown-dark: #2c2521;
            --mafia-brown-medium: #4a3f37;
            --mafia-gold: #e0c9a6;
            --mafia-gold-dark: #b89e7c;
            --mafia-text-light: #f0e6d8;
            --mafia-text-dark: #2c2521;
            --mafia-red: #a63c3c;
            --mafia-red-dark: #7a2c2c;
            --mafia-green: #5a8a5a;
            --mafia-green-dark: #416641;
            --mafia-glow: rgba(224, 201, 166, 0.4);
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes panel-intro {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 0 var(--mafia-gold-dark); }
            50% { transform: scale(1.03); box-shadow: 0 6px 10px rgba(0,0,0,0.4), 0 5px 0 var(--mafia-gold-dark); }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeInScaleUp {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes pulseGlow {
            0%, 100% { filter: drop-shadow(0 0 10px var(--mafia-glow)); }
            50% { filter: drop-shadow(0 0 20px rgba(224, 201, 166, 0.7)); }
        }
        
        @keyframes tipFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            color: var(--mafia-text-light);
            background-color: var(--mafia-brown-darkest);
            background-image: radial-gradient(circle at center, var(--mafia-brown-dark) 0%, var(--mafia-brown-darkest) 80%), url('https://www.transparenttextures.com/patterns/dark-wood.png');
            overflow: hidden;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            -webkit-user-select: none;
            user-select: none;
        }

        .panel-mafia {
            background-color: rgba(26, 22, 19, 0.85); /* Slightly transparent dark brown */
            backdrop-filter: blur(8px);
            border: 2px solid var(--mafia-brown-medium);
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5), inset 0 1px 2px rgba(240, 230, 216, 0.1);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            position: relative;
        }

        .panel-hidden {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
            pointer-events: none;
            visibility: hidden;
        }

        .panel-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
            animation: panel-intro 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .btn-mafia {
            border-radius: 10px;
            font-weight: bold;
            transition: all 0.15s ease-out;
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
        }
        .btn-mafia:disabled {
            filter: grayscale(80%) brightness(0.8);
            cursor: not-allowed;
            box-shadow: 0 2px 0 #555 !important;
            transform: translateY(0) !important;
        }
        
        .btn-mafia-primary {
            background: linear-gradient(to bottom, var(--mafia-gold), var(--mafia-gold-dark));
            border: 1px solid #c8b08f;
            color: var(--mafia-text-dark);
            box-shadow: 0 4px 0 #8a7458;
            padding: 12px 30px;
            font-size: 1.2rem;
        }
        .btn-mafia-primary:hover:not(:disabled) {
            background: linear-gradient(to bottom, #f0d9b6, #c8ae8c);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #8a7458;
        }
        .btn-mafia-primary:active:not(:disabled) {
            transform: translateY(2px) !important;
            box-shadow: 0 2px 0 #8a7458 !important;
            transition-duration: 0.05s;
        }
        
        #start-game-btn.breathing {
            animation: breathe 2.5s ease-in-out infinite;
        }

        .btn-mafia-secondary {
            background-color: var(--mafia-brown-medium);
            border: 1px solid var(--mafia-gold-dark);
            box-shadow: 0 4px 0 #332a23;
            color: var(--mafia-text-light);
            padding: 10px 22px;
            font-size: 1rem;
        }
        .btn-mafia-secondary:hover:not(:disabled) {
            background-color: #5c4e45;
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #332a23;
        }
        .btn-mafia-secondary:active:not(:disabled) {
            transform: translateY(2px) !important;
            box-shadow: 0 2px 0 #332a23 !important;
            transition-duration: 0.05s;
        }

        .input-mafia {
            background-color: var(--mafia-brown-dark);
            border: 1px solid var(--mafia-brown-medium);
            color: var(--mafia-text-light);
            border-radius: 8px;
            padding: 12px;
            font-size: 1rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
            transition: all 0.2s ease;
            -webkit-user-select: auto;
            user-select: auto;
            touch-action: manipulation;
        }
        .input-mafia:focus {
            outline: none;
            border-color: var(--mafia-gold);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4), 0 0 10px var(--mafia-glow);
        }
        .input-mafia.invalid { border-color: var(--mafia-red); }
        .input-mafia:read-only { background-color: #312822; cursor: default; }

        .loader {
            border: 6px solid var(--mafia-brown-medium);
            border-top: 6px solid var(--mafia-gold);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--mafia-brown-dark); }
        ::-webkit-scrollbar-thumb { background: var(--mafia-gold-dark); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--mafia-gold); }

        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100vh;
            padding: 15px;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            z-index: 1;
        }
        .screen.active { opacity: 1; visibility: visible; position: relative; }
        
        #loading-screen { 
            justify-content: center; 
            background: radial-gradient(circle, rgba(44, 37, 33, 0.5) 0%, rgba(26, 22, 19, 0.8) 70%);
        }
        
        #loading-content-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            max-width: 450px;
        }
        #loading-logo {
            max-width: 320px;
            width: 80%;
            margin-bottom: 1.5rem;
            animation: fadeInScaleUp 1s ease-out, pulseGlow 3.5s infinite 1s;
        }
        #loading-title {
            font-size: 3.5rem;
            color: var(--mafia-gold);
            font-weight: 700;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
            margin-bottom: 2rem;
            animation: fadeInScaleUp 1.2s ease-out;
        }
        #loading-progress-bar-container {
            width: 100%;
            max-width: 350px;
            background-color: var(--mafia-brown-dark);
            border: 1px solid var(--mafia-brown-medium);
            border-radius: 50px;
            padding: 5px;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.6);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        #loading-progress-bar-fill {
            height: 15px;
            width: 0%; /* JS Controlled */
            background: linear-gradient(to right, var(--mafia-gold-dark), var(--mafia-gold));
            border-radius: 50px;
            transition: width 0.4s ease-out;
            box-shadow: 0 0 12px var(--mafia-glow);
        }
        #loading-message {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--mafia-text-light);
            text-shadow: 1px 1px 2px #000;
            min-height: 28px;
            transition: all 0.3s ease;
        }
        #loading-tip {
            margin-top: 2.5rem;
            font-size: 0.95rem;
            color: var(--mafia-gold);
            font-style: italic;
            background-color: rgba(0,0,0,0.3);
            padding: 10px 15px;
            border-radius: 12px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: tipFadeIn 0.8s ease-out 1.5s backwards;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    
    <!-- Mafia-themed Loading Screen -->
    <div id="loading-screen" class="screen active">
        <div id="loading-content-box">
            <div id="loading-logo">
                <!-- SVG Logo inspired by the user's image -->
                <svg viewBox="0 0 300 170" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="color: var(--mafia-gold);">
                    <defs>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="3.5" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <g style="filter: url(#glow);">
                        <!-- Central Figure -->
                        <path d="M150 20 C135 20 125 30 125 45 L125 85 Q125 95 130 100 L170 100 Q175 95 175 85 L175 45 C175 30 165 20 150 20 Z M150 25 A 20 20 0 0 1 170 45 V 50 H 130 V 45 A 20 20 0 0 1 150 25 Z"/>
                        <rect x="110" y="90" width="80" height="40" rx="5"/>
                        <!-- Left Figure -->
                        <path opacity="0.7" d="M90 40 C80 40 70 50 70 60 L70 90 Q70 95 75 98 L110 98 Q115 95 115 90 L115 60 C115 50 105 40 90 40 Z M90 45 A 15 15 0 0 1 105 60 V 65 H 75 V 60 A 15 15 0 0 1 90 45 Z"/>
                        <rect opacity="0.7" x="50" y="95" width="70" height="35" rx="5"/>
                        <!-- Right Figure -->
                        <path opacity="0.7" d="M210 40 C200 40 190 50 190 60 L190 90 Q190 95 195 98 L230 98 Q235 95 235 90 L235 60 C235 50 225 40 210 40 Z M210 45 A 15 15 0 0 1 225 60 V 65 H 195 V 60 A 15 15 0 0 1 210 45 Z"/>
                        <rect opacity="0.7" x="180" y="95" width="70" height="35" rx="5"/>
                        <!-- Text Box -->
                        <rect x="70" y="135" width="160" height="30" rx="5"/>
                        <text x="150" y="156" font-family="Vazirmatn, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#2c2521">ESCORT GAME</text>
                    </g>
                </svg>
            </div>
            <h1 id="loading-title">شهر مافیا</h1>
            
            <div id="loading-progress-bar-container">
                <div id="loading-progress-bar-fill"></div>
            </div>
            
            <p id="loading-message">در حال آماده سازی...</p>
            
            <p id="loading-tip" class="hidden">✨ در حال جستجو در آرشیوهای مخفی... ✨</p>
        </div>
    </div>

    <!-- The rest of your game screens will go here -->
    <!-- For demonstration, I'm adding a simple placeholder main screen -->
    <div id="main-screen" class="screen">
        <div class="panel-mafia p-8 max-w-lg w-full panel-visible">
            <h1 class="text-4xl font-bold text-center mb-4" style="color: var(--mafia-gold);">به شهر مافیا خوش آمدید</h1>
            <p class="text-center mb-6">لودینگ با موفقیت انجام شد و شما به سرور متصل شدید.</p>
            <button id="restart-btn" class="btn-mafia btn-mafia-primary w-full">شروع مجدد</button>
        </div>
    </div>


    <script type="module">
        // --- JAVASCRIPT LOGIC ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- USER'S NEW FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
            authDomain: "mafia-9fcbf.firebaseapp.com",
            projectId: "mafia-9fcbf",
            storageBucket: "mafia-9fcbf.appspot.com",
            messagingSenderId: "471627157488",
            appId: "1:471627157488:web:92f008548a5596619a5735",
            measurementId: "G-0PDHDWC6NV"
        };
        
        let app;
        let auth;
        // let db; // Firestore can be enabled later if needed
        let isAuthReady = false;

        // --- DOM Elements ---
        let loadingScreen, loadingProgressBarFill, loadingMessage, loadingTip;
        let mainScreen;
        let tipInterval;

        function showScreen(screenElement) {
            if (!screenElement) return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');
        }

        // --- ENHANCED LOADING SIMULATION & LOGIC ---
        function updateLoadingProgress(percentage, message, tip = null) {
            if (loadingProgressBarFill) {
                loadingProgressBarFill.style.width = `${percentage}%`;
            }
            if (loadingMessage) {
                loadingMessage.textContent = message;
            }
            if (tip && loadingTip) {
                loadingTip.classList.remove('hidden');
                loadingTip.innerHTML = tip;
            }
        }
        
        function startLoadingSequence() {
            const tips = [
                "✨ آیا می‌دانستید «آل کاپون» سرانجام به خاطر فرار مالیاتی دستگیر شد؟",
                "✨ در سناریوی «شب‌های مافیا»، نقش «دکتر لکتر» فقط یک بار می‌تواند خودش را نجات دهد.",
                "✨ اصطلاح «Omertà» به قانون سکوت در بین اعضای مافیا اشاره دارد.",
                "✨ فیلم «پدرخوانده» بر اساس رمانی به همین نام از «ماریو پوزو» ساخته شده است.",
                "✨ شهر «کورلئونه» در سیسیل، به عنوان زادگاه خانواده‌های مافیایی معروف است."
            ];
            let currentTipIndex = Math.floor(Math.random() * tips.length);
            
            // Show the first tip immediately
            if (loadingTip) {
                 loadingTip.classList.remove('hidden');
                 loadingTip.style.animation = 'none';
                 loadingTip.offsetHeight;
                 loadingTip.style.animation = 'tipFadeIn 0.8s ease-out';
                 loadingTip.innerHTML = tips[currentTipIndex];
            }
            
            // Start changing tips
            tipInterval = setInterval(() => {
                currentTipIndex = (currentTipIndex + 1) % tips.length;
                if (loadingTip) {
                    loadingTip.style.animation = 'none';
                    loadingTip.offsetHeight; // Trigger reflow
                    loadingTip.style.animation = 'tipFadeIn 0.8s ease-out';
                    loadingTip.innerHTML = tips[currentTipIndex];
                }
            }, 5000);

            // Initial state
            updateLoadingProgress(10, 'در حال آماده سازی...');
        }

        async function initFirebase() {
            try {
                updateLoadingProgress(30, 'در حال برقراری ارتباط با سرور...');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                // db = getFirestore(app); // Can be enabled later
                console.log("Firebase Initialized.");

                onAuthStateChanged(auth, async (user) => {
                    updateLoadingProgress(60, 'احراز هویت انجام شد...');
                    if (user) {
                        console.log("User is signed in anonymously:", user.uid);
                        // Here you could load user data if you had any
                    } else {
                        console.log("No user found, attempting to sign in anonymously.");
                        await signInAnonymously(auth);
                    }
                    isAuthReady = true;

                    // Final stage of loading
                    updateLoadingProgress(100, 'خوش آمدید!');
                    clearInterval(tipInterval); // Stop changing tips
                    
                    setTimeout(() => {
                        if(mainScreen) showScreen(mainScreen);
                    }, 1200); // Wait a moment to show "Welcome"
                });

            } catch (error) {
                console.error("Firebase initialization error:", error);
                updateLoadingProgress(100, "خطا در اتصال به سرور!", "⚠️ لطفاً اتصال اینترنت خود را بررسی کنید.");
                if(loadingProgressBarFill) loadingProgressBarFill.style.background = 'var(--mafia-red)';
                clearInterval(tipInterval);
            }
        }
        
        function setupEventListeners() {
            // Placeholder for future buttons
            const restartBtn = document.getElementById('restart-btn');
            if(restartBtn) {
                restartBtn.addEventListener('click', () => {
                    window.location.reload();
                });
            }
        }

        function initializeGame() {
            // Query DOM elements
            loadingScreen = document.getElementById('loading-screen');
            loadingProgressBarFill = document.getElementById('loading-progress-bar-fill');
            loadingMessage = document.getElementById('loading-message');
            loadingTip = document.getElementById('loading-tip');
            mainScreen = document.getElementById('main-screen');

            if (!navigator.onLine) {
                 updateLoadingProgress(100, "عدم اتصال به اینترنت", "⚠️ لطفاً اتصال خود را بررسی کرده و صفحه را رفرش کنید.");
                 if(loadingProgressBarFill) loadingProgressBarFill.style.background = 'var(--mafia-red)';
                return;
            }

            // Start the whole process
            startLoadingSequence();
            setupEventListeners();
            initFirebase();
        }

        // Run the game
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGame);
        } else {
            initializeGame();
        }

    </script>
</body>
</html>