<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهر مافیا - در حال بارگذاری</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --wood-dark: #0c0a09;
            --text-gold: #ffc947;
            --text-light: #e0dacc;
            --logo-glow-main: #ffdd00;
            --progress-bar-bg: rgba(0,0,0,0.4);
            --progress-bar-fill-start: #8c4843;
            --progress-bar-fill-end: #ffc947;
            --countdown-bg: rgba(0,0,0,0.3);
            --panel-glow: rgba(255, 201, 71, 0.5);
            --suspension-red: #e74c3c;
            --suspension-border: #c0392b;
            --suspension-glow: rgba(231, 76, 60, 0.5);
            --vh: 1vh; 
        }
        @keyframes panel-intro { from { opacity: 0; transform: translateY(50px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            width: 100%;
            height: 100%; 
            overflow: hidden; 
        }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--wood-dark);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #preloader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: calc(var(--vh, 1vh) * 100);
            background-color: var(--wood-dark);
            z-index: 9999;
            transition: opacity 0.7s ease-in-out;
        }

        #bottom-loader {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px 40px 30px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 100;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
        }
        
        #bottom-loader #progress-bar-container {
            width: 100%;
            max-width: 480px;
            height: 12px;
            background-color: var(--progress-bar-bg);
            border-radius: 6px;
            overflow: hidden;
            padding: 2px;
            border: 1px solid rgba(255, 201, 71, 0.2);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
        }
        #bottom-loader #progress-bar-fill {
            width: 0%;
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--progress-bar-fill-start), var(--progress-bar-fill-end));
            transition: width 0.4s cubic-bezier(0.65, 0, 0.35, 1);
        }
        
        #status-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 480px;
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--text-light);
            opacity: 0.9;
            min-height: 1.2em;
        }
        #status-percentage {
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            direction: ltr;
        }
        
        .panel {
            width: 90%;
            max-width: 480px;
            background: rgba(10, 5, 2, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 1px solid rgba(255, 201, 71, 0.25);
            padding: 30px 40px;
            text-align: center;
            animation: panel-intro 1s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }
        
        #maintenance-panel { box-shadow: 0 0 25px var(--panel-glow), 0 15px 45px rgba(0, 0, 0, 0.7); padding: 25px; }
        #maintenance-banner-container { width: 100%; margin-bottom: 25px; border-radius: 16px; overflow: hidden; background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255, 201, 71, 0.2); }
        #maintenance-banner { width: 100%; height: auto; display: block; }
        #maintenance-title { font-size: 2rem; font-weight: 900; color: var(--text-gold); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #maintenance-message { font-size: 1rem; line-height: 1.8; margin-bottom: 30px; color: var(--text-light); padding: 0 15px; }
        
        .countdown-timer { display: flex; flex-direction: row-reverse; justify-content: center; gap: 15px; }
        .time-block { background-color: var(--countdown-bg); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 201, 71, 0.15); min-width: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .time-value { font-size: 3rem; font-weight: 900; color: white; line-height: 1; }
        .time-label { font-size: 0.8rem; font-weight: 400; color: var(--text-light); margin-top: 8px; }

        #suspension-panel { border-color: var(--suspension-border); box-shadow: 0 0 25px var(--suspension-glow), 0 15px 45px rgba(0, 0, 0, 0.7); padding: 35px; }
        #suspension-user-info { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        #suspension-avatar { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 3px solid var(--suspension-red); box-shadow: 0 5px 15px rgba(0,0,0,0.5); margin-bottom: 15px; }
        #suspension-username { font-size: 1.5rem; font-weight: 700; color: var(--text-light); text-shadow: 1px 1px 3px #000; }
        #suspension-title { font-size: 2rem; color: var(--suspension-red); margin-bottom: 15px; font-weight: 900; }
        #suspension-reason { font-size: 1.1rem; margin-bottom: 25px; padding: 12px; background-color: rgba(0,0,0,0.3); border-radius: 8px; font-style: italic; border: 1px solid rgba(255,255,255,0.1); }
        #suspension-message { margin-bottom: 20px; font-size: 1rem; color: var(--text-light); }
        #suspension-countdown-timer { margin-bottom: 35px; }
        #suspension-countdown-timer .time-block { border-color: var(--suspension-border); background-color: rgba(231, 76, 60, 0.1); }
        #suspension-countdown-timer .time-value { color: #f8d7da; }
        #suspension-countdown-timer .time-label { color: #f5c6cb; }

        #logout-btn { background: linear-gradient(145deg, #616161, #3a3a3a); border: 1px solid #777; color: var(--text-light); padding: 12px 30px; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        #logout-btn:hover { background: linear-gradient(145deg, #757575, #4f4f4f); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        #logout-btn:active { transform: translateY(0); }
    </style>
</head>
<body>

    <div id="preloader-overlay"></div>

    <div id="bottom-loader" style="display: flex;">
        <div id="progress-bar-container">
            <div id="progress-bar-fill"></div>
        </div>
        <div id="status-container">
            <span id="status-message">در حال آماده سازی...</span>
            <span id="status-percentage"></span>
        </div>
    </div>

    <div id="maintenance-panel" class="panel" style="display: none;">
        <div id="maintenance-banner-container"><img id="maintenance-banner" src="" alt="بنر بروزرسانی"></div>
        <h1 id="maintenance-title"></h1>
        <p id="maintenance-message"></p>
        <div class="countdown-timer">
            <div class="time-block"><div id="days" class="time-value">00</div><div class="time-label">روز</div></div>
            <div class="time-block"><div id="hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
            <div class="time-block"><div id="minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
            <div class="time-block"><div id="seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
    </div>

    <div id="suspension-panel" class="panel" style="display: none;">
        <div id="suspension-user-info">
            <img id="suspension-avatar" src="" alt="آواتار کاربر">
            <h3 id="suspension-username"></h3>
        </div>
        <h1 id="suspension-title">حساب کاربری مسدود است</h1>
        <p id="suspension-reason"></p>
        <p id="suspension-message">زمان باقی‌مانده تا رفع مسدودیت:</p>
        <div id="suspension-countdown-timer" class="countdown-timer">
             <div class="time-block"><div id="s-days" class="time-value">00</div><div class="time-label">روز</div></div>
             <div class="time-block"><div id="s-hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
             <div class="time-block"><div id="s-minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
             <div class="time-block"><div id="s-seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
        <button id="logout-btn">خروج از حساب</button>
    </div>
    
    <audio id="background-music" loop></audio>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // این کانفیگ برای احراز هویت کاربر در مرورگر ضروری است و اطلاعات حساسی ندارد
        const firebaseConfig = {
            apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
            authDomain: "mafia-9fcbf.firebaseapp.com",
            projectId: "mafia-9fcbf",
            storageBucket: "mafia-9fcbf.appspot.com",
            messagingSenderId: "471627157488",
            appId: "1:471627157488:web:92f008548a5596619a5735",
            measurementId: "G-0PDHDWC6NV"
        };
        
        // --- DOM Elements & Helpers ---
        const progressBarFill = document.getElementById('progress-bar-fill');
        const statusMessageEl = document.getElementById('status-message');
        const statusPercentageEl = document.getElementById('status-percentage');
        const backgroundMusic = document.getElementById('background-music');
        const bottomLoader = document.getElementById('bottom-loader');
        const maintenancePanel = document.getElementById('maintenance-panel');
        const suspensionPanel = document.getElementById('suspension-panel');
        const logoutBtn = document.getElementById('logout-btn');
        const allViews = [bottomLoader, maintenancePanel, suspensionPanel];
        
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // --- View Management ---
        function showView(viewName) {
            allViews.forEach(view => view.style.display = 'none');
            const viewMap = {
                'loading': bottomLoader,
                'maintenance': maintenancePanel,
                'suspended': suspensionPanel
            };
            if (viewMap[viewName]) {
                viewMap[viewName].style.display = viewName === 'loading' ? 'flex' : 'block';
            }
        }
        
        // --- Progress & Status UI ---
        const updateOverallProgress = (percentage) => {
            progressBarFill.style.width = `${percentage}%`;
        };
        const updateTaskStatus = (message, percentage) => {
            statusMessageEl.textContent = message;
            if (percentage !== null && percentage !== undefined) {
                statusPercentageEl.textContent = `${Math.round(percentage)}%`;
                statusPercentageEl.style.display = 'inline';
            } else {
                statusPercentageEl.style.display = 'none';
                statusPercentageEl.textContent = '';
            }
        };
        const showLoadingError = (message) => {
            updateOverallProgress(100);
            updateTaskStatus(message, null);
            progressBarFill.style.background = 'linear-gradient(90deg, #c0392b, #e74c3c)';
        };

        // --- Music Handling ---
        const MUSIC_URL = "https://raw.githubusercontent.com/abolfazl140122/mafia/main/dark-music-249503.mp3";
        function playMusicFromBlob(blob) { try { const objectUrl = URL.createObjectURL(blob); backgroundMusic.src = objectUrl; backgroundMusic.volume = 0.4; backgroundMusic.play().catch(e => console.warn("Auto-play blocked", e)); } catch (error) { console.error("Error playing music blob", error); } }
        async function handleBackgroundMusic(onProgress) {
             try {
                const cache = await caches.open('mafia-music-cache-v1');
                let cachedResponse = await cache.match(MUSIC_URL);
                if (cachedResponse) {
                    onProgress(50);
                    const musicBlob = await cachedResponse.blob();
                    playMusicFromBlob(musicBlob);
                    onProgress(100);
                    return;
                }
                const xhr = new XMLHttpRequest();
                xhr.open('GET', MUSIC_URL, true);
                xhr.responseType = 'blob';
                xhr.onprogress = (event) => event.lengthComputable && onProgress(Math.round((event.loaded / event.total) * 100));
                xhr.onload = async () => {
                    if (xhr.status === 200) {
                        await cache.put(MUSIC_URL, new Response(xhr.response));
                        playMusicFromBlob(xhr.response);
                    }
                };
                xhr.send();
            } catch (error) {
                console.error('Music handler failed:', error);
            }
        }

        // --- Game Transition ---
        async function transitionToGame(displayName) {
            showView('loading');
            updateOverallProgress(100);
            updateTaskStatus(`خوش آمدید، ${displayName}!`, null);
            await delay(2000);
            window.location.href = './main.html';
        }
        
        // --- Countdown & Panel Population ---
        function startCountdown(targetDate, elements, onFinish) {
            const interval = setInterval(() => {
                const distance = targetDate.getTime() - new Date().getTime();
                if (distance < 0) {
                    clearInterval(interval);
                    if (onFinish) onFinish();
                    return;
                }
                const f = (n) => String(Math.floor(n)).padStart(2, '0');
                elements.days.textContent = f(distance / 86400000); // (1000 * 60 * 60 * 24)
                elements.hours.textContent = f((distance % 86400000) / 3600000); // (1000 * 60 * 60)
                elements.minutes.textContent = f((distance % 3600000) / 60000); // (1000 * 60)
                elements.seconds.textContent = f((distance % 60000) / 1000);
            }, 1000);
        }

        function populateSuspensionPanel(config, auth) {
            document.getElementById('suspension-avatar').src = config.avatarUrl || 'https://i.imgur.com/T2bT1tG.png';
            document.getElementById('suspension-username').textContent = config.displayName || 'کاربر';
            document.getElementById('suspension-reason').textContent = `دلیل: ${config.banReason || 'نامشخص'}`;
            logoutBtn.onclick = () => signOut(auth).then(() => window.location.href = './login.html');
            
            const countdownElements = {
                days: document.getElementById('s-days'),
                hours: document.getElementById('s-hours'),
                minutes: document.getElementById('s-minutes'),
                seconds: document.getElementById('s-seconds')
            };
            const targetDate = new Date(config.banExpiresAt); // <-- PHP sends string
            startCountdown(targetDate, countdownElements, () => {
                // Ban expired, just reload to re-check status.
                // The PHP script will now return 'ok' status.
                window.location.reload();
            });
        }
        
        function populateMaintenancePanel(config) {
            const bannerContainer = document.getElementById('maintenance-banner-container');
            if (config.imageUrl) {
                document.getElementById('maintenance-banner').src = config.imageUrl;
                bannerContainer.style.display = 'block';
            } else {
                bannerContainer.style.display = 'none';
            }
            document.getElementById('maintenance-title').textContent = config.title || "در حال بروزرسانی";
            document.getElementById('maintenance-message').textContent = config.message || "به زودی باز خواهیم گشت.";
        }
        
        // --- Core Application Logic (Using PHP middleware) ---

        async function startLoadingSequence(auth) {
            try {
                // 1. Authenticate user on client-side
                updateTaskStatus('احراز هویت کاربر...', null);
                updateOverallProgress(10);
                const user = await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, u => {
                        unsubscribe();
                        if (u) resolve(u);
                        else reject({ type: 'NO_USER' });
                    }, error => reject({ type: 'ERROR', error }));
                });
                updateOverallProgress(25);

                // 2. Check user status via our PHP server
                updateTaskStatus('بررسی وضعیت حساب...', null);
                const response = await fetch(`./mafianovin.php?action=checkUser&uid=${user.uid}`);
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                updateOverallProgress(50);
                
                if (data.status === 'banned') {
                    populateSuspensionPanel(data.config, auth);
                    showView('suspended');
                    return; // Stop loading process
                }

                // 3. Load game assets
                updateTaskStatus('بارگذاری منابع...', 0);
                await handleBackgroundMusic((progress) => {
                    updateTaskStatus('بارگذاری منابع...', progress);
                    updateOverallProgress(50 + (progress / 4)); // 50% to 75%
                });
                updateOverallProgress(75);
                await delay(200);

                // 4. Finalize and transition to game
                updateTaskStatus('آماده سازی نهایی...', null);
                updateOverallProgress(100);
                const displayName = data.userData.displayName || user.displayName || 'بازیکن';
                await transitionToGame(displayName);

            } catch (rejection) {
                if (rejection.type === 'NO_USER') {
                    showLoadingError('احراز هویت ناموفق بود. در حال انتقال...');
                    await delay(2500);
                    window.location.href = './login.html';
                } else {
                    console.error("Loading sequence failed:", rejection);
                    showLoadingError('خطا در بارگذاری. صفحه را رفرش کنید.');
                }
            }
        }
        
        async function runAppInitialization() {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            
            try {
                // Fetch initial status from our PHP server
                const response = await fetch('./mafianovin.php?action=getStatus');
                if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                if (data.status === 'maintenance') {
                    populateMaintenancePanel(data.config);
                    showView('maintenance');
                    
                    if (data.config.endTime) {
                        const countdownElements = {
                            days: document.getElementById('days'), hours: document.getElementById('hours'),
                            minutes: document.getElementById('minutes'), seconds: document.getElementById('seconds')
                        };
                        const targetDate = new Date(data.config.endTime); // <-- PHP sends string
                        if (targetDate > new Date()) {
                            startCountdown(targetDate, countdownElements, () => window.location.reload());
                        } else {
                            // Maintenance time has passed, reload to re-check
                            window.location.reload();
                        }
                    }
                } else {
                    // Game is OK, start the user-specific loading sequence
                    showView('loading');
                    await startLoadingSequence(auth);
                }
            } catch (error) {
                console.error("Initialization failed:", error);
                showView('loading');
                showLoadingError('خطا در اتصال به سرور! اینترنت را بررسی کنید.');
            }
        }
        
        // --- Main Execution ---
        async function main() {
            const setVh = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            window.addEventListener('resize', setVh);
            setVh();
        
            const preloaderOverlay = document.getElementById('preloader-overlay');
            const body = document.body;
            const imageUrl = 'https://cdn.imgurl.ir/uploads/q9812_file_6917756f1e1d68.57033147.jpg';

            const startApp = () => {
                preloaderOverlay.style.opacity = '0';
                preloaderOverlay.addEventListener('transitionend', () => preloaderOverlay.style.display = 'none', { once: true });
                runAppInitialization();
            };

            const img = new Image();
            img.src = imageUrl;

            if (img.complete) {
                body.style.backgroundImage = `url(${imageUrl})`;
                startApp();
            } else {
                img.onload = () => { body.style.backgroundImage = `url(${imageUrl})`; startApp(); };
                img.onerror = () => { console.warn('Background image failed to load.'); startApp(); };
            }
        }

        main();
    </script>
</body>
</html>
