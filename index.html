<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهر مافیا - در حال بارگذاری</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #101010;
            --text-gold: #ffc947;
            --text-light: #e0dacc;
            --panel-bg: rgba(20, 20, 20, 0.85);
            --panel-border: rgba(255, 201, 71, 0.3);
            --panel-glow: rgba(255, 201, 71, 0.4);
            --progress-bar-bg: rgba(0,0,0,0.4);
            --progress-bar-fill: linear-gradient(90deg, #ff512f 0%, #dd2476 100%);
            --countdown-bg: rgba(0,0,0,0.3);
            --suspension-red: #e74c3c;
            --suspension-border: #c0392b;
            --suspension-glow: rgba(231, 76, 60, 0.5);
            --vh: 1vh; 
        }

        @keyframes panel-intro { 
            from { opacity: 0; transform: translateY(50px) scale(0.95); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }

        @keyframes progress-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        html, body { 
            width: 100%;
            height: 100%; 
            overflow: hidden; 
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
        }

        #preloader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: calc(var(--vh, 1vh) * 100);
            background: url('https://images.unsplash.com/photo-1587270613359-22445129528b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1974&q=80') center center / cover no-repeat;
            filter: blur(5px) brightness(0.5);
            transform: scale(1.1);
            z-index: -1;
        }

        #bottom-loader {
            position: fixed;
            bottom: 5vh;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
            transition: opacity 0.5s ease-out;
        }

        #progress-bar-container {
            width: 100%;
            height: 12px;
            background-color: var(--progress-bar-bg);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            box-shadow: 0 0 15px rgba(0,0,0,0.5) inset;
        }

        #progress-bar-fill {
            width: 0%;
            height: 100%;
            background: var(--progress-bar-fill);
            background-size: 200% 200%;
            border-radius: 10px;
            transition: width 0.3s ease-in-out;
            animation: progress-animation 3s ease infinite;
        }

        #status-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 0.9rem;
            color: var(--text-light);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        .panel {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px var(--panel-glow);
            animation: panel-intro 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        .panel h1 {
            font-size: 1.8rem;
            color: var(--text-gold);
            margin-bottom: 15px;
            font-weight: 900;
        }

        .panel p {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        #maintenance-banner-container {
            width: 100%;
            margin-bottom: 20px;
        }
        #maintenance-banner {
            width: 100%;
            height: auto;
            max-height: 200px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid var(--panel-border);
        }

        .countdown-timer {
            display: flex;
            gap: 15px;
            justify-content: center;
            width: 100%;
        }

        .time-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--countdown-bg);
            padding: 10px;
            border-radius: 8px;
            min-width: 65px;
        }

        .time-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-gold);
        }

        .time-label {
            font-size: 0.8rem;
            color: var(--text-light);
            opacity: 0.8;
        }
        
        /* Suspension Panel Specifics */
        #suspension-panel {
            border-color: var(--suspension-border);
            box-shadow: 0 0 30px var(--suspension-glow);
        }
        #suspension-panel h1 {
            color: var(--suspension-red);
        }
        #suspension-user-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }
        #suspension-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--suspension-border);
        }
        #suspension-username {
            font-size: 1.2rem;
            font-weight: 700;
        }
        .reason-text {
            background-color: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 5px;
            font-style: italic;
            border-right: 3px solid var(--suspension-red);
        }
        .action-button {
            background-color: var(--suspension-red);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s, transform 0.2s;
        }
        .action-button:hover {
            background-color: var(--suspension-border);
            transform: scale(1.05);
        }
    </style>
</head>
<body>

    <div id="preloader-overlay"></div>

    <div id="bottom-loader">
        <div id="progress-bar-container">
            <div id="progress-bar-fill"></div>
        </div>
        <div id="status-container">
            <span id="status-message">در حال آماده سازی...</span>
            <span id="status-percentage">0%</span>
        </div>
    </div>

    <div id="maintenance-panel" class="panel">
        <div id="maintenance-banner-container">
            <img id="maintenance-banner" src="" alt="بنر بروزرسانی">
        </div>
        <h1 id="maintenance-title">بازی در حال تعمیرات است</h1>
        <p id="maintenance-message">ما در حال بهبود سرورها هستیم. لطفاً کمی صبر کنید، به زودی باز خواهیم گشت!</p>
        <div class="countdown-timer">
            <div class="time-block"><div id="days" class="time-value">00</div><div class="time-label">روز</div></div>
            <div class="time-block"><div id="hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
            <div class="time-block"><div id="minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
            <div class="time-block"><div id="seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
    </div>

    <div id="suspension-panel" class="panel">
        <div id="suspension-user-info">
            <img id="suspension-avatar" src="https://via.placeholder.com/80" alt="آواتار کاربر">
            <h3 id="suspension-username">نام کاربری</h3>
        </div>
        <h1 id="suspension-title">حساب کاربری مسدود است</h1>
        <p>دلیل مسدودیت:</p>
        <p id="suspension-reason" class="reason-text"></p>
        <p id="suspension-message">زمان باقی‌مانده تا رفع مسدودیت:</p>
        <div id="suspension-countdown-timer" class="countdown-timer">
             <div class="time-block"><div id="s-days" class="time-value">00</div><div class="time-label">روز</div></div>
             <div class="time-block"><div id="s-hours" class="time-value">00</div><div class="time-label">ساعت</div></div>
             <div class="time-block"><div id="s-minutes" class="time-value">00</div><div class="time-label">دقیقه</div></div>
             <div class="time-block"><div id="s-seconds" class="time-value">00</div><div class="time-label">ثانیه</div></div>
        </div>
        <button id="logout-btn" class="action-button">خروج از حساب</button>
    </div>
    
    <audio id="background-music" loop></audio>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // =================================================================
            // CONFIGURATION
            // =================================================================
            const API_ENDPOINT = 'https://miko.freehost.io/mafianovin.php'; // آدرس فایل واسط PHP
            const API_SECRET_KEY = 'sjnrsontORFBioerrt4651renttn'; // کلید امنیتی که در PHP تعریف کردید

            // =================================================================
            // DOM ELEMENTS
            // =================================================================
            const progressBarFill = document.getElementById('progress-bar-fill');
            const statusMessage = document.getElementById('status-message');
            const statusPercentage = document.getElementById('status-percentage');
            const bottomLoader = document.getElementById('bottom-loader');
            const maintenancePanel = document.getElementById('maintenance-panel');
            const suspensionPanel = document.getElementById('suspension-panel');
            const backgroundMusic = document.getElementById('background-music');

            let countdownIntervals = {}; // برای نگهداری تایمرها

            // =================================================================
            // API HELPER FUNCTION
            // =================================================================
            /**
             * A helper function to send requests to our PHP proxy.
             * @param {string} action - The action to perform (get, set, etc.).
             * @param {string} path - The database path.
             * @param {object|null} data - The data to send (for set, update, push).
             * @returns {Promise<any>} - The data from the server.
             */
            async function callApi(action, path, data = null) {
                try {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            secret_key: API_SECRET_KEY,
                            action: action,
                            path: path,
                            data: data
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`خطای شبکه: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.status === 'error') {
                        throw new Error(result.message);
                    }

                    return result.data;
                } catch (error) {
                    console.error(`خطا در فراخوانی API برای اکشن '${action}' در مسیر '${path}':`, error);
                    updateProgress(null, `خطا در ارتباط با سرور...`);
                    // Here you might want to show an error message to the user
                    throw error; // Re-throw the error to stop the loading process
                }
            }
            
            // =================================================================
            // UI & LOGIC FUNCTIONS
            // =================================================================

            // Function to handle viewport height for mobile browsers
            function setViewportHeight() {
                let vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            // Update progress bar and status message
            function updateProgress(percentage, message) {
                if (percentage !== null) {
                    progressBarFill.style.width = `${percentage}%`;
                    statusPercentage.textContent = `${percentage}%`;
                }
                if (message) {
                    statusMessage.textContent = message;
                }
            }

            // Start a countdown timer
            function startCountdown(elementId, endTime, onEnd) {
                if (countdownIntervals[elementId]) {
                    clearInterval(countdownIntervals[elementId]);
                }
                
                const daysEl = document.querySelector(`#${elementId} #days, #${elementId} #s-days`);
                const hoursEl = document.querySelector(`#${elementId} #hours, #${elementId} #s-hours`);
                const minutesEl = document.querySelector(`#${elementId} #minutes, #${elementId} #s-minutes`);
                const secondsEl = document.querySelector(`#${elementId} #seconds, #${elementId} #s-seconds`);
                
                if (!daysEl || !hoursEl || !minutesEl || !secondsEl) return;

                function update() {
                    const now = new Date().getTime();
                    const distance = endTime - now;

                    if (distance < 0) {
                        clearInterval(countdownIntervals[elementId]);
                        daysEl.textContent = '00';
                        hoursEl.textContent = '00';
                        minutesEl.textContent = '00';
                        secondsEl.textContent = '00';
                        if (onEnd) onEnd();
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    daysEl.textContent = String(days).padStart(2, '0');
                    hoursEl.textContent = String(hours).padStart(2, '0');
                    minutesEl.textContent = String(minutes).padStart(2, '0');
                    secondsEl.textContent = String(seconds).padStart(2, '0');
                }
                
                update();
                countdownIntervals[elementId] = setInterval(update, 1000);
            }
            
            // Show the maintenance panel
            function showMaintenance(data) {
                bottomLoader.style.display = 'none';
                maintenancePanel.style.display = 'flex';
                document.getElementById('maintenance-title').textContent = data.title;
                document.getElementById('maintenance-message').textContent = data.message;
                const banner = document.getElementById('maintenance-banner');
                if (data.bannerUrl) {
                    banner.src = data.bannerUrl;
                    banner.parentElement.style.display = 'block';
                } else {
                    banner.parentElement.style.display = 'none';
                }
                const endTime = new Date(data.endTime).getTime();
                startCountdown('maintenance-panel .countdown-timer', endTime, () => {
                    // Optional: reload the page when the countdown finishes
                    window.location.reload();
                });
            }

            // Show the suspension panel
            function showSuspension(suspensionData, userData) {
                bottomLoader.style.display = 'none';
                suspensionPanel.style.display = 'flex';
                document.getElementById('suspension-username').textContent = userData.username || 'کاربر';
                document.getElementById('suspension-avatar').src = userData.avatarUrl || 'https://via.placeholder.com/80';
                document.getElementById('suspension-reason').textContent = suspensionData.reason;
                const endTime = new Date(suspensionData.endTime).getTime();
                startCountdown('suspension-countdown-timer', endTime, () => {
                     window.location.reload();
                });
                document.getElementById('logout-btn').addEventListener('click', () => {
                    // Logic to log out the user
                    console.log("Logging out...");
                    // Example: clear local storage and redirect
                    localStorage.clear();
                    window.location.href = '/login.html'; // Or wherever your login page is
                });
            }

            // =================================================================
            // MAIN APPLICATION FLOW
            // =================================================================
            async function main() {
                try {
                    // 1. Check server status (maintenance mode)
                    updateProgress(10, 'بررسی وضعیت سرور...');
                    const serverStatus = await callApi('get', '/server/status');
                    
                    if (serverStatus && serverStatus.maintenance.enabled) {
                        const now = new Date().getTime();
                        const endTime = new Date(serverStatus.maintenance.endTime).getTime();
                        if (now < endTime) {
                            showMaintenance(serverStatus.maintenance);
                            return; // Stop execution
                        }
                    }

                    // 2. Get user ID from local storage or wherever it's stored
                    updateProgress(25, 'احراز هویت کاربر...');
                    const userId = localStorage.getItem('userId'); // فرض می‌کنیم شناسه کاربر اینجا ذخیره شده
                    if (!userId) {
                        // Redirect to login page if no user ID is found
                        window.location.href = '/login.html'; // آدرس صفحه لاگین
                        return;
                    }

                    // 3. Fetch user data
                    updateProgress(40, 'دریافت اطلاعات کاربری...');
                    const userData = await callApi('get', `/users/${userId}`);
                    if (!userData) {
                        throw new Error('اطلاعات کاربر یافت نشد.');
                    }

                    // 4. Check if user is suspended
                    if (userData.suspension && userData.suspension.isSuspended) {
                        const now = new Date().getTime();
                        const endTime = new Date(userData.suspension.endTime).getTime();
                        if (now < endTime) {
                            showSuspension(userData.suspension, userData);
                            return; // Stop execution
                        } else {
                           // Suspension has expired, let's clear it (optional)
                           await callApi('update', `/users/${userId}/suspension`, { isSuspended: false });
                        }
                    }

                    // 5. Fetch game settings
                    updateProgress(60, 'بارگذاری تنظیمات بازی...');
                    const gameSettings = await callApi('get', '/game/settings');
                    if (gameSettings.musicUrl) {
                        backgroundMusic.src = gameSettings.musicUrl;
                        backgroundMusic.volume = gameSettings.musicVolume || 0.5;
                        backgroundMusic.play().catch(e => console.warn("پخش خودکار موسیقی ممکن است توسط مرورگر مسدود شده باشد."));
                    }

                    // 6. Preload game assets (example)
                    updateProgress(80, 'بارگذاری منابع بازی...');
                    // Simulate asset loading
                    await new Promise(resolve => setTimeout(resolve, 1500)); 

                    // 7. Finalizing
                    updateProgress(100, 'آماده سازی برای ورود به بازی...');
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Hide loader and redirect to the main game page
                    bottomLoader.style.opacity = '0';
                    setTimeout(() => {
                        window.location.href = '/game.html'; // آدرس صفحه اصلی بازی
                    }, 500);

                } catch (error) {
                    console.error('یک خطای اساسی در فرآیند بارگذاری رخ داد:', error);
                    // You can display a generic error message to the user here
                    statusMessage.textContent = 'خطا! لطفاً صفحه را مجدداً بارگذاری کنید.';
                    statusMessage.style.color = 'var(--suspension-red)';
                }
            }

            // Initialize
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            main();
        });
    </script>
</body>
</html>
