<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>لابی بازی - شهر مافیا</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- افزودن کتابخانه PeerJS برای چت صوتی -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peer.min.js"></script>
    <style>
        :root {
            --primary-gold: #ffc947;
            --dark-red: #8c4843;
            --darker-red: #5a2c2a;
            --text-light: #f0e6d2;
            --text-secondary: #c5a687;
            --bg-dark: #1a140e;
            --border-color: #5c4a3a;
            --green-ready: #2ecc71;
            --red-kick: #e74c3c;
            --slot-bg: linear-gradient(160deg, #2a2118, var(--bg-dark));
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; background-color: var(--bg-dark); }
        body {
            font-family: 'Vazirmatn', sans-serif;
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #background-blurry {
            position: fixed; top: -20px; left: -20px; width: calc(100% + 40px); height: calc(100% + 40px);
            background-image: url('https://up.20script.ir/file/6195-file-000000001500622f9419de6c322df297-1-.jpg');
            background-size: cover; background-position: center center; filter: blur(8px) brightness(0.6); z-index: -1;
        }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 2000; transition: opacity 0.5s ease;
        }
        .loader {
            border: 6px solid #f3f3f330; border-top: 6px solid var(--primary-gold);
            border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-text { margin-top: 20px; font-size: 1.1rem; font-weight: 700; }
        
        .lobby-container { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 10px; gap: 10px; }
        .lobby-header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; background-color: rgba(0,0,0,0.4); padding: 8px 12px; border-radius: 12px; border: 1px solid var(--border-color); }
        #lobby-name { font-size: 1.3rem; font-weight: 900; color: var(--primary-gold); text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .leave-button { background: linear-gradient(145deg, #a13d3d, #7c1f1f); border: 1px solid #ff8f8f; color: white; padding: 6px 12px; border-radius: 8px; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; }
        .leave-button:hover { transform: scale(1.05); box-shadow: 0 2px 10px rgba(0,0,0,0.4); }

        .players-area { flex-grow: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 5px; overflow: hidden; }
        .players-column { display: flex; flex-direction: column; gap: 8px; height: 100%; }
        .player-slot { flex: 1; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px; text-align: center; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; overflow: hidden; animation: slot-fade-in 0.6s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; min-height: 0; }
        .player-slot.empty { background: rgba(0,0,0,0.2); border: 2px dashed var(--border-color); opacity: 0.7; backdrop-filter: blur(2px); cursor: default; }
        .player-slot.empty:hover { background: rgba(0,0,0,0.3); border-color: var(--primary-gold); }
        .player-slot.filled { background: var(--slot-bg); border: 2px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.5), inset 0 0 10px rgba(0,0,0,0.3); }
        .player-avatar { width: 55%; max-width: 70px; aspect-ratio: 1/1; border-radius: 50%; object-fit: cover; border: 3px solid var(--text-secondary); margin-bottom: 5px; transition: all 0.3s ease; box-shadow: 0 3px 8px rgba(0,0,0,0.5); }
        .player-name { font-size: clamp(0.65rem, 2.2vw, 0.8rem); font-weight: 700; width: 100%; white-space: normal; word-break: break-word; line-height: 1.2; padding: 0 2px; text-shadow: 0 1px 3px #000; height: 2.5em; display: flex; align-items: center; justify-content: center; }
        .empty-text { font-size: clamp(0.7rem, 2.5vw, 0.8rem); color: var(--text-secondary); font-weight: 700; }
        .host-crown { position: absolute; top: -1px; right: -1px; width: 28px; height: 28px; background-color: var(--primary-gold); color: var(--darker-red); border-radius: 0 10px 0 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: 900; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .ready-indicator { position: absolute; bottom: 4px; right: 4px; width: 18px; height: 18px; background-color: var(--green-ready); border-radius: 50%; border: 2px solid var(--bg-dark); display: flex; align-items: center; justify-content: center; color: white; font-weight: 900; font-size: 0.8rem; transform: scale(0); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-shadow: 0 1px 2px rgba(0,0,0,0.4); }
        .player-slot.ready .ready-indicator { transform: scale(1); }
        .player-slot.ready .player-avatar { border-color: var(--green-ready); }
        .player-slot.ready { border-color: var(--green-ready); box-shadow: 0 0 15px rgba(46, 204, 113, 0.7), 0 0 25px rgba(46, 204, 113, 0.4), inset 0 0 10px rgba(0,0,0,0.3); transform: scale(1.02); }
        
        /* --- START: UI Changes for Action Buttons --- */
        .lobby-actions { padding-top: 10px; flex-shrink: 0; display: flex; gap: 10px; align-items: stretch; }
        
        .action-button {
            padding: 14px; font-size: 1.2rem; font-weight: 900;
            border-radius: 12px; border: none; cursor: pointer; transition: all 0.3s ease;
            color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
        }
        
        /* Button اصلی (آماده/شروع) که حالا فضای بیشتری دارد */
        #action-btn {
            flex-grow: 1; /* این دکمه فضای باقی‌مانده را پر می‌کند */
        }

        /* دکمه دایره‌ای میکروفون */
        #mic-btn {
            flex-shrink: 0; /* جلوی کوچک شدن این دکمه را می‌گیرد */
            width: 58px; /* عرض ثابت برای دایره‌ای شدن */
            height: 58px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, #7f8c8d, #626567);
            border: 2px solid #95a5a6;
        }
        #mic-btn.permission-granted {
             background: linear-gradient(145deg, #2980b9, #2471a3);
             border-color: #5dade2;
        }
        #mic-btn.speaking {
            background: linear-gradient(145deg, var(--green-ready), #27ae60);
            border-color: #a9dfbf;
            animation: pulse-mic 1s infinite;
        }
        #mic-btn svg { width: 28px; height: 28px; fill: white; transition: all 0.2s; }
        #mic-btn.speaking svg { transform: scale(1.1); }
        
        @keyframes pulse-mic {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }

        .action-button::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(to bottom, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 20%); transform: rotate(25deg); }
        .action-button.ready-btn { background: linear-gradient(145deg, #27ae60, #229954); border: 2px solid #58d68d; }
        .action-button.unready-btn { background: linear-gradient(145deg, #c0392b, #a93226); border: 2px solid #e67e22; }
        .action-button.start-btn { background: linear-gradient(145deg, var(--dark-red), var(--darker-red)); border: 2px solid var(--primary-gold); }
        .action-button:disabled { background: linear-gradient(145deg, #7f8c8d, #626567); border-color: #95a5a6; cursor: not-allowed; opacity: 0.6; }
        .action-button:not(:disabled):hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .action-button.start-btn:not(:disabled) { animation: pulse-start 2s infinite; }
        
        @keyframes pulse-start { 0% { box-shadow: 0 0 0 0 rgba(255, 201, 71, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 201, 71, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 201, 71, 0); } }
        /* --- END: UI Changes for Action Buttons --- */

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-content { background: linear-gradient(145deg, #3c3022, var(--bg-dark)); border: 2px solid var(--border-color); border-radius: 16px; padding: 25px; width: 90%; max-width: 380px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.5rem; font-weight: 900; color: var(--primary-gold); margin-bottom: 20px; }
        .modal-message { font-size: 1rem; line-height: 1.6; margin-bottom: 25px; }
        .modal-buttons { display: flex; gap: 15px; }
        .modal-button { flex-grow: 1; padding: 12px; font-size: 1rem; font-weight: 700; border-radius: 8px; cursor: pointer; border: 1px solid; }
        .modal-button.primary { color: white; background: linear-gradient(145deg, var(--dark-red), var(--darker-red)); border-color: var(--primary-gold); }
        .modal-button.secondary { color: var(--text-light); background: linear-gradient(145deg, #504436, #332a20); border-color: var(--border-color); }
    </style>
</head>
<body>

    <div id="background-blurry"></div>
    <div id="loading-overlay">
        <div class="loader"></div>
        <p id="loading-text">در حال ورود به لابی...</p>
    </div>

    <div class="lobby-container" style="display: none;">
        <header class="lobby-header">
            <h1 id="lobby-name">نام لابی...</h1>
            <button id="leave-lobby-btn" class="leave-button">خروج</button>
        </header>

        <main class="players-area">
            <div id="left-players" class="players-column"></div>
            <div id="right-players" class="players-column"></div>
        </main>

        <!-- START: HTML Change -->
        <footer class="lobby-actions">
            <button id="action-btn" class="action-button ready-btn">آماده</button>
            <button id="mic-btn" class="action-button" title="میکروفون">
                <!-- آیکون میکروفون -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M192 0C139 0 96 43 96 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-21.9-10.3-42.4-27.6-56.1C13.2 143.1 0 119.5 0 96C0 43 43 0 96 0h0s0 0 0 0c11.5 0 22.4 1.9 32.7 5.4c-4.4 16.5-7.8 33.3-10 50.5c-7.3 1.2-14.2 3.8-20.4 7.8c-14.1 9-22.3 24.3-22.3 40.3V256c0 35.3 28.7 64 64 64s64-28.7 64-64v-42.3c0-16-8.2-31.3-22.3-40.3c-6.2-4-13.2-6.6-20.4-7.8c-2.2-17.2-5.6-34-10-50.5C269.6 1.9 280.5 0 288 0s0 0 0 0c53 0 96 43 96 96c0 23.5-13.2 47.1-36.4 63.9C330.3 173.6 320 194.1 320 216v40c0 89.1-66.3 164.1-153.2 174.5C98.3 439.6 48.7 394.5 40.2 334.2c-2.4-16.9-3.1-34.1-2.2-51.5L64 256V216z"/></svg>
            </button>
        </footer>
        <!-- END: HTML Change -->
    </div>
    
    <!-- Modals (no change here) -->
    <div id="confirm-modal" class="modal-overlay"> ... </div>
    <div id="notification-modal" class="modal-overlay"> ... </div>
    
    <!-- Container for remote audio streams -->
    <div id="voice-chat-streams"></div>

    <!-- Audio Elements for UI sounds -->
    <audio id="sound-player-join" src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3" preload="auto"></audio>
    <audio id="sound-player-leave" src="https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3" preload="auto"></audio>
    <audio id="sound-ready" src="https://assets.mixkit.co/sfx/preview/mixkit-quick-positive-video-game-notification-interface-265.mp3" preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, runTransaction, getDoc, collection, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Config & Elements ---
        const firebaseConfig = { /* ... Your Config ... */ };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ... existing elements ...
        const micBtn = document.getElementById('mic-btn');
        const audioStreamsContainer = document.getElementById('voice-chat-streams');

        // --- NEW: Voice Chat State ---
        let peer;
        let localMediaStream;
        let hasMicPermission = false;
        let isSpeaking = false;
        const remoteConnections = new Map(); // Stores peerId -> {call, audioEl}
        let unsubscribeVoiceSignals = null;

        // ... all existing variables ...

        function main() {
            // ... existing main logic ...
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // ... existing user logic ...
                    await joinLobby();
                    listenToLobbyChanges();
                    setupEventListeners();
                    // NEW: Initialize voice chat after joining
                    initializeVoiceChat(); 
                } else {
                    window.location.href = './login.html';
                }
            });
        }

        // --- NEW: Voice Chat Functions ---

        async function initializeVoiceChat() {
            // 1. Initialize PeerJS
            // The user's UID is used as their unique PeerJS ID
            peer = new Peer(currentUser.uid, {
                host: 'peerjs-server-dns.onrender.com',
                path: '/peerjs',
                secure: true
            });

            peer.on('open', (id) => {
                console.log('My PeerJS ID is: ' + id);
                // 2. Announce our PeerJS ID in Firestore so others can call us
                const signalDocRef = doc(db, `lobby_signals/${lobbyId}/users`, currentUser.uid);
                setDoc(signalDocRef, { peerId: id, uid: currentUser.uid });
            });

            // 3. Listen for incoming calls from others
            peer.on('call', (call) => {
                // Answer the call, but only if we have microphone permission
                if (localMediaStream) {
                    call.answer(localMediaStream);
                    console.log(`Answering call from ${call.peer}`);
                    handleRemoteStream(call);
                } else {
                    console.warn(`Incoming call from ${call.peer} but no local stream to answer with.`);
                }
            });

            peer.on('error', (err) => {
                console.error("PeerJS Error:", err);
                showNotificationModal("خطای صوتی", "ارتباط صوتی با سرور برقرار نشد.");
            });

            // 4. Listen for other players' PeerJS IDs in Firestore
            const signalsCollectionRef = collection(db, `lobby_signals/${lobbyId}/users`);
            unsubscribeVoiceSignals = onSnapshot(signalsCollectionRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    if (data.uid === currentUser.uid) return; // Ignore ourself

                    if (change.type === "added") {
                        console.log(`New player signal found: ${data.uid}. Calling them.`);
                        callPlayer(data.peerId);
                    }
                    if (change.type === "removed") {
                        console.log(`Player signal removed: ${data.uid}. Closing connection.`);
                        closeConnection(data.peerId);
                    }
                });
            });
        }
        
        async function handleMicClick() {
            if (!hasMicPermission) {
                try {
                    // Request microphone access
                    localMediaStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    console.log("Microphone access granted!");
                    hasMicPermission = true;
                    micBtn.classList.add('permission-granted');
                    micBtn.title = "برای صحبت کردن نگه دارید";
                    // After getting permission, call everyone who is already in the lobby
                    callAllPlayers();
                } catch (err) {
                    console.error("Error getting microphone access:", err);
                    showNotificationModal("خطا", "دسترسی به میکروفون داده نشد. چت صوتی غیرفعال است.");
                }
            }
        }
        
        function callPlayer(peerId) {
            if (!localMediaStream || !peer || remoteConnections.has(peerId)) {
                return; // Don't call if we don't have mic, or already connected
            }
            console.log(`Calling peer: ${peerId}`);
            const call = peer.call(peerId, localMediaStream);
            handleRemoteStream(call);
        }

        function callAllPlayers() {
            // This function is for when we get mic permission after others have joined
            const signalsCollectionRef = collection(db, `lobby_signals/${lobbyId}/users`);
            getDocs(signalsCollectionRef).then(snapshot => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.uid !== currentUser.uid) callPlayer(data.peerId);
                });
            });
        }
        
        function handleRemoteStream(call) {
            call.on('stream', (remoteStream) => {
                console.log(`Receiving stream from ${call.peer}`);
                if (remoteConnections.has(call.peer)) return; // Already have this stream

                const audioEl = document.createElement('audio');
                audioEl.srcObject = remoteStream;
                audioEl.autoplay = true;
                audioStreamsContainer.appendChild(audioEl);
                
                remoteConnections.set(call.peer, { call: call, audioEl: audioEl });
            });

            call.on('close', () => {
                console.log(`Connection closed with ${call.peer}`);
                closeConnection(call.peer);
            });
        }
        
        function closeConnection(peerId) {
            if (remoteConnections.has(peerId)) {
                const conn = remoteConnections.get(peerId);
                conn.call.close();
                conn.audioEl.remove();
                remoteConnections.delete(peerId);
            }
        }
        
        function cleanupVoiceChat() {
            // Stop mic track
            if(localMediaStream) {
                localMediaStream.getTracks().forEach(track => track.stop());
            }
            // Close all connections
            for (const peerId of remoteConnections.keys()) {
                closeConnection(peerId);
            }
            // Disconnect from PeerJS server
            if (peer) peer.destroy();
            // Unsubscribe from Firestore listener
            if (unsubscribeVoiceSignals) unsubscribeVoiceSignals();
            // Remove our signal from Firestore
            if (lobbyId && currentUser) {
                const signalDocRef = doc(db, `lobby_signals/${lobbyId}/users`, currentUser.uid);
                deleteDoc(signalDocRef);
            }
        }
        
        function toggleSpeak(shouldSpeak) {
            if (!hasMicPermission || !localMediaStream) return;
            
            isSpeaking = shouldSpeak;
            localMediaStream.getAudioTracks()[0].enabled = isSpeaking;
            micBtn.classList.toggle('speaking', isSpeaking);
            console.log(isSpeaking ? "Speaking..." : "Muted.");
        }


        // --- Modified Existing Functions ---

        async function handleLeaveLobby() {
            cleanupVoiceChat(); // NEW: Clean up voice chat on leave
            // ... existing leave lobby logic ...
        }

        function setupEventListeners() {
            actionBtn.addEventListener('click', handleActionClick);
            leaveLobbyBtn.addEventListener('click', showLeaveConfirm);
            
            // NEW: Mic button event listeners for Push-to-Talk
            micBtn.addEventListener('click', handleMicClick); // First click is for permission
            micBtn.addEventListener('mousedown', () => toggleSpeak(true));
            micBtn.addEventListener('mouseup', () => toggleSpeak(false));
            micBtn.addEventListener('touchstart', (e) => { e.preventDefault(); toggleSpeak(true); });
            micBtn.addEventListener('touchend', (e) => { e.preventDefault(); toggleSpeak(false); });

            window.addEventListener('beforeunload', () => { 
                if (currentUser) handleLeaveLobby(); 
            });
        }

        // --- Unchanged Functions ---
        // joinLobby, listenToLobbyChanges, renderLobby, handleActionClick, toggleReadyStatus, etc.
        // ... (copy all your other functions here without change)
        
        main();
    </script>
</body>
</html>
