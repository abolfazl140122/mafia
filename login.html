<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهر مافیا - ورود به حساب</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-text: #f0e6d2;
            --accent-gold: #ffc947;
            --dark-bg-start: rgba(60, 48, 34, 0.85);
            --dark-bg-end: rgba(30, 23, 15, 0.9);
            --border-color: #5c4a3a;
            --button-grad-start: #8c4843;
            --button-grad-end: #5a2c2a;
            --error-bg: rgba(217, 83, 79, 0.2);
            --error-border: rgba(217, 83, 79, 0.5);
            --error-text: #ff9e9e;
            --success-bg: rgba(79, 217, 79, 0.2);
            --success-border: rgba(79, 217, 79, 0.5);
            --success-text: #a0e0a0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-image: url('https://up.20script.ir/file/6195-file-000000001500622f9419de6c322df297-1-.jpg');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: var(--primary-text);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-container {
            width: 100%;
            max-width: 400px;
            background: linear-gradient(145deg, var(--dark-bg-start), var(--dark-bg-end));
            backdrop-filter: blur(8px);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid var(--border-color);
            text-align: center;
        }

        .auth-title {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--accent-gold);
            margin-bottom: 10px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.7);
        }

        .auth-subtitle {
            font-size: 1rem;
            color: #d1c8b7;
            margin-bottom: 35px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .input-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            color: #e0dacc;
        }

        .auth-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1rem;
            background-color: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--border-color);
            color: var(--primary-text);
            border-radius: 8px;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: 'Vazirmatn', sans-serif;
        }

        .auth-input::placeholder {
            color: rgba(240, 230, 210, 0.5);
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 10px rgba(255, 201, 71, 0.3);
        }

        .auth-button {
            width: 100%;
            padding: 14px;
            font-size: 1.1rem;
            font-weight: 700;
            color: #ffffff;
            background: linear-gradient(145deg, var(--button-grad-start), var(--button-grad-end));
            border: 2px solid var(--accent-gold);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        .auth-button:hover {
            background: linear-gradient(145deg, #a1534d, #6b3431);
            box-shadow: 0 6px 15px rgba(255, 201, 71, 0.2);
        }

        .auth-button:disabled {
            background: var(--border-color);
            border-color: #88786a;
            color: #a19385;
            cursor: not-allowed;
            box-shadow: none;
        }

        .auth-link {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #d1c8b7;
        }

        .auth-link a {
            color: var(--accent-gold);
            font-weight: 700;
            text-decoration: none;
            transition: color 0.2s;
            cursor: pointer;
        }
        
        .auth-link a:hover {
            color: #fff;
        }
        
        .message-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
            line-height: 1.6;
            display: none; /* Hidden by default */
        }

        .error-message {
            color: var(--error-text);
            background-color: var(--error-bg);
            border: 1px solid var(--error-border);
        }
        
        .success-message {
            color: var(--success-text);
            background-color: var(--success-bg);
            border: 1px solid var(--success-border);
        }

        /* --- START: Modal Styles for Spam Guide --- */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: linear-gradient(145deg, var(--dark-bg-start), var(--dark-bg-end));
            margin: 10% auto;
            padding: 30px;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 550px;
            text-align: right;
            box-shadow: 0 8px 30px rgba(0,0,0,0.6);
            position: relative;
            animation: slideIn 0.4s ease;
        }
        
        .modal-content h2 {
            color: var(--accent-gold);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal-content h3 {
             color: #e0dacc;
             margin-top: 20px;
             margin-bottom: 10px;
             border-bottom: 1px solid var(--border-color);
             padding-bottom: 5px;
        }
        
        .modal-content p {
            line-height: 1.7;
            margin-bottom: 15px;
            font-size: 0.95rem;
            color: #d1c8b7;
        }
        
        .modal-content strong {
            color: var(--accent-gold);
            font-weight: 700;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            left: 20px;
            top: 15px;
            font-size: 32px;
            font-weight: bold;
            transition: color 0.2s;
        }

        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        /* --- END: Modal Styles --- */
    </style>
</head>
<body>
    <div class="auth-container">
        <h1 class="auth-title">ورود به شهر</h1>
        <p class="auth-subtitle">خوش آمدید! لطفاً اطلاعات خود را وارد کنید.</p>
        
        <form id="login-form">
            <div class="input-group">
                <label for="email">ایمیل</label>
                <input type="email" id="email" class="auth-input" required placeholder="example@email.com">
            </div>
            <div class="input-group">
                <label for="password">رمز عبور</label>
                <input type="password" id="password" class="auth-input" required placeholder="••••••••">
            </div>
            <button type="submit" id="login-button" class="auth-button">ورود</button>
        </form>

        <div id="message-box" class="message-box"></div>

        <p class="auth-link">
            <a id="forgot-password-link">رمز عبور خود را فراموش کرده‌اید؟</a>
        </p>
        <p class="auth-link">
            هنوز عضو نشده‌اید؟ <a href="./Registration.html">ثبت‌نام کنید</a>
        </p>
    </div>

    <!-- START: Modal for Spam Guide -->
    <div id="spam-guide-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal-button" class="close-button">&times;</span>
            <h2>راهنمای پیدا کردن ایمیل بازیابی</h2>
            <p>ایمیل بازیابی رمز عبور به صورت خودکار از طرف سیستم ارسال می‌شود. گاهی اوقات ممکن است این ایمیل به جای صندوق ورودی (Inbox)، به پوشه دیگری برود. در ادامه راهنمای کاملی ارائه شده است.</p>
            
            <h3>پوشه اسپم (Spam) یا هرزنامه چیست؟</h3>
            <p>سرویس‌های ایمیل (مانند Gmail) یک فیلتر هوشمند دارند که ایمیل‌های مشکوک یا تبلیغاتی را جدا کرده و در پوشه‌ای به نام <strong>Spam (اسپم)</strong> یا <strong>Junk (هرزنامه)</strong> قرار می‌دهند تا صندوق ورودی شما مرتب بماند. گاهی این فیلترها به اشتباه ایمیل‌های مهمی مانند ایمیل بازیابی رمز عبور را هم اسپم تشخیص می‌دهند.</p>

            <h3>چرا باید آن را چک کنم و آیا امن است؟</h3>
            <p><strong>بله، کاملاً امن است.</strong> ایمیلی که از طرف ما برای شما ارسال شده، حاوی یک لینک امن و یکتاست که فقط برای شما کار می‌کند. با کلیک روی آن می‌توانید یک رمز عبور جدید برای حساب خودتان بسازید. بررسی پوشه اسپم صرفاً یکی از مراحل پیدا کردن ایمیل‌های گمشده است.</p>
            <p><strong>نکته مهم:</strong> پس از پیدا کردن ایمیل در پوشه اسپم، آن را انتخاب کرده و روی دکمه <strong>"Not Spam"</strong> یا <strong>"هرزنامه نیست"</strong> کلیک کنید تا ایمیل‌های بعدی ما مستقیم به صندوق ورودی شما بیایند.</p>
        </div>
    </div>
    <!-- END: Modal for Spam Guide -->

    <script type="module">
        // --- START: Firebase Configuration ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyA91ul95j34bRUlvdA-8NljDrJBb_DWmcY", // Your provided API key
          authDomain: "mafia-9fcbf.firebaseapp.com",
          projectId: "mafia-9fcbf",
          storageBucket: "mafia-9fcbf.appspot.com",
          messagingSenderId: "471627157488",
          appId: "1:471627157488:web:92f008548a5596619a5735",
          measurementId: "G-0PDHDWC6NV"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        // --- END: Firebase Configuration ---


        // --- START: Element Selection ---
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('login-button');
        const messageBox = document.getElementById('message-box');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const spamGuideModal = document.getElementById('spam-guide-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        // --- END: Element Selection ---


        // --- START: Event Listeners ---
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showMessage("لطفاً ایمیل و رمز عبور را وارد کنید.", 'error'); 
                return;
            }

            setLoading(true);

            try {
                await signInWithEmailAndPassword(auth, email, password);
                window.location.href = './index.html';
            } catch (error) {
                let friendlyMessage = "ایمیل یا رمز عبور اشتباه است.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    friendlyMessage = "ایمیل یا رمز عبور وارد شده صحیح نمی‌باشد.";
                }
                console.error("Login Error:", error.code, error.message);
                showMessage(friendlyMessage, 'error');
            } finally {
                setLoading(false);
            }
        });

        forgotPasswordLink.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();

            if (!email) {
                showMessage("برای بازیابی رمز، ابتدا ایمیل خود را در کادر بالا وارد کنید.", 'error');
                emailInput.focus();
                return;
            }

            setLoading(true, 'در حال ارسال ایمیل...');

            try {
                await sendPasswordResetEmail(auth, email);
                const successHtml = `لینک بازیابی رمز عبور به ایمیل شما ارسال شد. (پوشه اسپم را نیز بررسی کنید) <br> <a id="open-spam-guide-link">راهنمای پیدا کردن ایمیل</a>`;
                showMessage(successHtml, 'success');
            } catch (error) {
                let friendlyMessage = "خطایی در ارسال ایمیل بازیابی رخ داد. لطفاً بعدا تلاش کنید.";
                if (error.code === 'auth/user-not-found') {
                    friendlyMessage = "حسابی با این ایمیل در سیستم ثبت نشده است.";
                } else if (error.code === 'auth/invalid-email') {
                    friendlyMessage = "فرمت ایمیل وارد شده صحیح نمی‌باشد.";
                }
                console.error("Password Reset Error:", error.code, error.message);
                showMessage(friendlyMessage, 'error');
            } finally {
                setLoading(false);
            }
        });

        // Event listener for opening the modal (using event delegation)
        messageBox.addEventListener('click', (e) => {
            if (e.target.id === 'open-spam-guide-link') {
                e.preventDefault();
                spamGuideModal.style.display = 'block';
            }
        });
        
        // Event listeners for closing the modal
        closeModalButton.addEventListener('click', () => {
            spamGuideModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target == spamGuideModal) {
                spamGuideModal.style.display = 'none';
            }
        });
        // --- END: Event Listeners ---


        // --- START: Helper Functions ---

        function showMessage(htmlContent, type) {
            messageBox.innerHTML = htmlContent;
            messageBox.className = `message-box ${type}-message`;
            messageBox.style.display = 'block';
        }

        function setLoading(isLoading, loadingText = 'در حال بررسی...') {
            loginButton.disabled = isLoading;
            loginButton.textContent = isLoading ? loadingText : 'ورود';
            // Clear previous non-success messages when a new action starts
            if (isLoading && !messageBox.classList.contains('success-message')) {
                messageBox.style.display = 'none';
            }
        }
        // --- END: Helper Functions ---

    </script>
</body>
</html>
