<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>لابی - شهر مافیا</title>
    
    <!-- Google Fonts (Consistent with other pages) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&family=Lalezar&display=swap" rel="stylesheet">

    <style>
        /* 
        ==========================================================================
         MAFIA CITY - MAIN LOBBY STYLING
         - Mobile-first design
         - Consistent theme with Login/Register pages
         - Advanced animations and effects for a premium feel
        ==========================================================================
        */

        /* --- THEME COLOR & FONT VARIABLES (Consistent across the app) --- */
        :root {
            --mafia-dark-wood: #1e1a17;
            --mafia-panel-brown: #3a322d;
            --mafia-panel-border: #2c2521;
            --mafia-gold-accent: #e6b800;
            --mafia-gold-glow: rgba(230, 184, 0, 0.6);
            --mafia-gold-dark: #a88700;
            --mafia-text-light: #e8e0d9;
            --mafia-text-dark: #1a1a1a;
            --mafia-error-red: #dc3545;
            --mafia-red-dark: #8a3435;

            /* New animated gradient colors */
            --anim-grad-1: #ffc947;
            --anim-grad-2: #e6b800;
            --anim-grad-3: #a88700;
            
            --font-display: 'Lalezar', cursive;
            --font-body: 'Vazirmatn', sans-serif;
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        @keyframes backgroundSmoke {
            0% { transform: translate(0, 0); opacity: 0; }
            25% { opacity: 0.06; }
            75% { opacity: 0.06; }
            100% { transform: translate(-20%, -20%); opacity: 0; }
        }
        
        @keyframes pulseGlow {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 15px var(--mafia-gold-glow), 0 0 25px rgba(230, 184, 0, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 25px var(--mafia-gold-glow), 0 0 45px rgba(230, 184, 0, 0.5);
            }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes modal-slide-in {
            from {
                opacity: 0;
                transform: translateY(100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes modal-slide-out {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(100%);
            }
        }

        /* --- GENERAL & BODY STYLES --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent scrolling on mobile */
        }

        body {
            font-family: var(--font-body);
            background-color: var(--mafia-dark-wood);
            background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            color: var(--mafia-text-light);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100vh; /* Full viewport height */
            position: relative;
        }

        /* Atmospheric smoke effect */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 150%; height: 150%;
            background-image: url('https://www.transparenttextures.com/patterns/foggy-birds.png');
            opacity: 0;
            z-index: 0;
            animation: backgroundSmoke 25s linear infinite;
        }

        /* --- LOADING OVERLAY --- */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: var(--mafia-dark-wood);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            transition: opacity 0.5s ease;
        }
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(230, 184, 0, 0.3);
            border-top-color: var(--mafia-gold-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        #loading-overlay p {
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--mafia-gold-accent);
        }

        /* --- MAIN APP CONTAINER (holds all content) --- */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: relative;
            z-index: 1;
            padding: 1.5rem;
            opacity: 0; /* Hidden until loaded */
            animation: fadeIn 1s 0.5s forwards;
        }

        /* --- HEADER SECTION --- */
        #main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: linear-gradient(180deg, rgba(0,0,0,0.4), transparent);
            border-radius: 12px 12px 0 0;
            margin: -1.5rem -1.5rem 0 -1.5rem;
            padding: 1.5rem 2rem;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            background: var(--mafia-panel-brown);
            border: 3px solid var(--mafia-gold-accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display);
            font-size: 1.8rem;
            color: var(--mafia-gold-accent);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .user-info .welcome-text {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .user-info #username-display {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--mafia-text-light);
            text-shadow: 0 0 5px rgba(255,255,255,0.3);
        }

        /* --- MAIN CONTENT (for the Start button) --- */
        #main-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #start-game-btn {
            font-family: var(--font-display);
            font-size: 2.2rem;
            color: var(--mafia-text-light);
            background: linear-gradient(145deg, var(--mafia-gold-dark), var(--mafia-gold-accent));
            border: none;
            border-radius: 20px;
            padding: 1.5rem 3.5rem;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            animation: pulseGlow 3s ease-in-out infinite;
            border: 4px solid transparent;
        }

        /* Animated border effect */
        #start-game-btn::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: conic-gradient(
                transparent,
                rgba(230, 184, 0, 0.8),
                transparent 30%
            );
            animation: spin 4s linear infinite;
        }
        
        #start-game-btn:active {
            transform: scale(0.95);
            animation: none; /* Pause glow on click */
        }
        
        /* --- FOOTER SECTION (for logout button) --- */
        #main-footer {
            padding: 1rem;
            text-align: center;
        }
        
        #logout-btn {
            background: transparent;
            border: 2px solid var(--mafia-red-dark);
            color: var(--mafia-red-dark);
            font-family: var(--font-body);
            font-weight: 700;
            font-size: 1rem;
            padding: 0.6rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #logout-btn:hover {
            background: var(--mafia-red-dark);
            color: var(--mafia-text-light);
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }
        
        /* --- GAME MODE SELECTION MODAL --- */
        #game-mode-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(15, 12, 10, 0.7);
            backdrop-filter: blur(8px);
            z-index: 500;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s, visibility 0s 0.4s;
        }
        
        #game-mode-modal.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.4s, visibility 0s;
        }

        #modal-panel {
            background: linear-gradient(160deg, var(--mafia-panel-brown), #312a25);
            border-top: 4px solid var(--mafia-gold-accent);
            width: 100%;
            max-width: 500px;
            padding: 2rem 1.5rem 2.5rem 1.5rem;
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
            text-align: center;
            animation: modal-slide-in 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        #game-mode-modal.closing #modal-panel {
            animation: modal-slide-out 0.5s cubic-bezier(0.7, 0, 0.84, 0) forwards;
        }
        
        #modal-panel h2 {
            font-family: var(--font-display);
            font-size: 2rem;
            margin-bottom: 2rem;
            color: var(--mafia-text-light);
            text-shadow: 0 0 8px var(--mafia-gold-glow);
        }
        
        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }
        
        .modal-btn {
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid var(--mafia-panel-border);
            background-color: var(--mafia-input-bg, #2a2420);
            color: var(--mafia-text-light);
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
        }
        
        .modal-btn:hover {
            border-color: var(--mafia-gold-accent);
            background-color: #3f3730;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .modal-btn.primary {
             background: linear-gradient(to top, var(--mafia-gold-dark), var(--mafia-gold-accent));
             color: var(--mafia-text-dark);
             border-color: #816600;
        }
        
        #modal-close-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: var(--mafia-panel-border);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            color: var(--mafia-text-light);
            font-size: 1.5rem;
            line-height: 35px;
            cursor: pointer;
        }

        /* --- UTILITY CLASSES --- */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <!-- Loading overlay shown until auth state is confirmed -->
    <div id="loading-overlay">
        <div class="loader"></div>
        <p>در حال اتصال...</p>
    </div>

    <!-- Main application container -->
    <div id="app-container" class="hidden">
        
        <header id="main-header">
            <div class="user-profile">
                <div id="user-avatar" class="user-avatar">?</div>
                <div class="user-info">
                    <p class="welcome-text">خوش آمدی،</p>
                    <h1 id="username-display">...</h1>
                </div>
            </div>
            <!-- Future icons like settings can go here -->
        </header>

        <main id="main-content">
            <button id="start-game-btn">شروع بازی</button>
        </main>

        <footer id="main-footer">
            <button id="logout-btn">خروج از حساب</button>
        </footer>
    </div>
    
    <!-- Game Mode Selection Modal -->
    <div id="game-mode-modal">
        <div id="modal-panel">
            <button id="modal-close-btn">&times;</button>
            <h2>انتخاب نوع بازی</h2>
            <div class="modal-options">
                <button id="ranked-game-btn" class="modal-btn primary">بازی امتیازی</button>
                <button id="friendly-game-btn" class="modal-btn">بازی دوستانه</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Import necessary Firebase functions for authentication
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
            authDomain: "mafia-9fcbf.firebaseapp.com",
            projectId: "mafia-9fcbf",
            storageBucket: "mafia-9fcbf.appspot.com",
            messagingSenderId: "471627157488",
            appId: "1:471627157488:web:92f008548a5596619a5735",
            measurementId: "G-0PDHDWC6NV"
        };
        
        /**
         * ==================================================================
         *  LOBBY LOGIC & STATE MANAGEMENT
         * ==================================================================
         * This class handles Firebase authentication state, UI updates,
         * and modal interactions for the main game lobby.
         */
        class LobbyManager {
            constructor() {
                // Firebase services
                this.app = null;
                this.auth = null;

                // DOM Elements
                this.loadingOverlay = document.getElementById('loading-overlay');
                this.appContainer = document.getElementById('app-container');
                this.usernameDisplay = document.getElementById('username-display');
                this.userAvatar = document.getElementById('user-avatar');
                this.startGameBtn = document.getElementById('start-game-btn');
                this.logoutBtn = document.getElementById('logout-btn');
                
                // Modal Elements
                this.gameModeModal = document.getElementById('game-mode-modal');
                this.modalPanel = document.getElementById('modal-panel');
                this.modalCloseBtn = document.getElementById('modal-close-btn');
                this.rankedGameBtn = document.getElementById('ranked-game-btn');
                this.friendlyGameBtn = document.getElementById('friendly-game-btn');
            }
            
            /**
             * Initializes the lobby, sets up Firebase, and attaches event listeners.
             */
            initialize() {
                try {
                    this.app = initializeApp(firebaseConfig);
                    this.auth = getAuth(this.app);
                    console.log("Firebase initialized successfully in lobby.");
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    this.showFatalError();
                    return;
                }
                
                this.listenForAuthState();
                this.setupEventListeners();
            }

            /**
             * The core of the page. Listens for user login/logout status.
             */
            listenForAuthState() {
                onAuthStateChanged(this.auth, user => {
                    if (user) {
                        // User is signed in
                        console.log("User is signed in:", user.uid);
                        this.updateUIForUser(user);
                    } else {
                        // User is signed out
                        console.log("No user signed in. Redirecting to login.");
                        window.location.replace('login.html'); // Use replace to prevent back button
                    }
                });
            }
            
            /**
             * Updates the screen with the logged-in user's information.
             * @param {object} user - The Firebase user object.
             */
            updateUIForUser(user) {
                const displayName = user.displayName || 'مهمان';
                this.usernameDisplay.textContent = displayName;
                
                // Set avatar to the first letter of the name
                this.userAvatar.textContent = displayName.charAt(0).toUpperCase();

                // Hide loading overlay and show the main app
                this.loadingOverlay.style.opacity = '0';
                this.loadingOverlay.addEventListener('transitionend', () => {
                    this.loadingOverlay.classList.add('hidden');
                }, { once: true });
                
                this.appContainer.classList.remove('hidden');
            }

            /**
             * Attaches all necessary event listeners for the page.
             */
            setupEventListeners() {
                // Main page buttons
                this.logoutBtn.addEventListener('click', () => this.handleLogout());
                this.startGameBtn.addEventListener('click', () => this.showGameModeModal());

                // Modal buttons and interactions
                this.modalCloseBtn.addEventListener('click', () => this.hideGameModeModal());
                this.gameModeModal.addEventListener('click', (event) => {
                    // Close modal if backdrop is clicked
                    if (event.target === this.gameModeModal) {
                        this.hideGameModeModal();
                    }
                });

                this.rankedGameBtn.addEventListener('click', () => {
                    alert('بازی امتیازی در حال حاضر غیرفعال است. منتظر بروزرسانی‌های بعدی باشید!');
                });
                
                this.friendlyGameBtn.addEventListener('click', () => {
                     alert('قابلیت بازی دوستانه به زودی اضافه می‌شود...');
                });
            }

            /**
             * Signs the user out and lets the auth listener handle the redirect.
             */
            async handleLogout() {
                try {
                    await signOut(this.auth);
                    console.log("User signed out successfully.");
                } catch (error) {
                    console.error("Sign out error:", error);
                    alert("خطایی در هنگام خروج از حساب رخ داد.");
                }
            }

            /**
             * Displays the game mode selection modal with an animation.
             */
            showGameModeModal() {
                this.gameModeModal.classList.remove('closing');
                this.gameModeModal.style.visibility = 'visible';
                this.gameModeModal.style.opacity = '1';
                this.modalPanel.style.animation = 'modal-slide-in 0.5s cubic-bezier(0.16, 1, 0.3, 1)';
            }

            /**
             * Hides the game mode selection modal with an animation.
             */
            hideGameModeModal() {
                this.modalPanel.style.animation = 'modal-slide-out 0.5s cubic-bezier(0.7, 0, 0.84, 0) forwards';
                this.gameModeModal.style.opacity = '0';
                // Wait for animation to finish before hiding
                setTimeout(() => {
                    this.gameModeModal.style.visibility = 'hidden';
                }, 500);
            }
            
            /**
             * Displays a critical error if Firebase fails to load.
             */
            showFatalError() {
                this.loadingOverlay.innerHTML = `<p style="color: var(--mafia-error-red); text-align: center; padding: 20px;">
                                                    خطای بحرانی در اتصال به سرور.<br>لطفاً صفحه را دوباره بارگذاری کنید.
                                                 </p>`;
            }
        }
        
        // --- Entry Point ---
        document.addEventListener('DOMContentLoaded', () => {
            const lobby = new LobbyManager();
            lobby.initialize();
        });

    </script>
</body>
</html>
