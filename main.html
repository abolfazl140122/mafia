<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی مافیا</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- CLASH OF CLANS / CLASH ROYALE THEME (FROM YOUR PROVIDED CODE) --- */
        :root {
            --clash-blue-dark: #3a5b8a; --clash-blue-light: #5c88c8; --clash-gold: #ffc83a;
            --clash-gold-dark: #e5a500; --clash-brown-dark: #5b3a29; --clash-text-light: #ffffff;
            --clash-text-dark: #333333; --clash-green: #59a845; --clash-green-dark: #3a752b;
            --clash-red: #c74243; --clash-red-dark: #8f2a2b; --clash-panel-bg: #4468a0;
            --clash-panel-border: #9dc2ff; --clاش-panel-border-dark: #2a4166;
        }
        @keyframes clash-panel-intro { 0% { opacity: 0; transform: scale(0.8) translateY(-30px); } 70% { opacity: 1; transform: scale(1.05) translateY(0); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes breathe { 0%, 100% { transform: scale(1); box-shadow: 0 6px 0 #a07200; } 50% { transform: scale(1.04); box-shadow: 0 8px 12px rgba(0,0,0,0.3), 0 8px 0 #a07200; } }
        @keyframes subtle-pan { 0% { background-position: 0% 0%; } 100% { background-position: 200% 200%; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        body {
            font-family: 'Vazirmatn', sans-serif; color: var(--clash-text-light);
            background-color: #1a283e; background-image: url('https://www.transparenttextures.com/patterns/dark-stone-wall.png');
            overflow: hidden; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); position: relative; user-select: none;
        }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 200%; height: 200%; background-image: url('https://www.transparenttextures.com/patterns/dust.png'); opacity: 0.15; z-index: 0; animation: subtle-pan 120s linear infinite; }
        .clash-font { font-family: 'Lilita One', cursive; letter-spacing: 1px; }
        .panel-clash { background-color: var(--clash-panel-bg); border: 4px solid var(--clash-panel-border-dark); border-top-color: var(--clash-panel-border); border-left-color: var(--clash-panel-border); border-radius: 16px; box-shadow: 0 8px 15px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255, 255, 255, 0.2); transition: opacity 0.3s ease-in-out; position: relative; }
        .panel-clash::before, .panel-clash::after { content: ''; position: absolute; width: 12px; height: 12px; background: var(--clash-gold); border-radius: 50%; border: 2px solid var(--clash-brown-dark); box-shadow: 0 0 3px #000; top: 10px; }
        .panel-clash::before { left: 10px; } .panel-clash::after { right: 10px; }
        .panel-hidden { opacity: 0; transform: scale(0.9) translateY(-20px); pointer-events: none; visibility: hidden; }
        .panel-visible { opacity: 1; transform: scale(1) translateY(0); visibility: visible; animation: clash-panel-intro 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-clash { border-radius: 12px; font-weight: bold; text-transform: uppercase; transition: all 0.1s ease-out; cursor: pointer; position: relative; white-space: nowrap; display: inline-flex; align-items: center; justify-content: center; color: var(--clash-text-dark); text-shadow: 1px 1px 1px rgba(255,255,255,0.4); }
        .btn-clash:disabled { filter: grayscale(80%); cursor: not-allowed; box-shadow: 0 4px 0 #555 !important; transform: translateY(0) !important; }
        .btn-clash-primary { background: linear-gradient(to bottom, #ffe47a, var(--clash-gold)); border: 2px solid var(--clash-brown-dark); box-shadow: 0 6px 0 #a07200; padding: 12px 30px; font-size: 1.25rem; }
        .btn-clash-primary:hover { background: linear-gradient(to bottom, #fff0a0, #ffda5a); transform: translateY(-2px); box-shadow: 0 8px 0 #a07200; }
        .btn-clash-primary:active { transform: translateY(4px) !important; box-shadow: 0 2px 0 #a07200 !important; }
        #start-game-btn.breathing { animation: breathe 2.5s ease-in-out infinite; }
        .btn-clash-secondary { background: linear-gradient(to bottom, #7da8e8, var(--clash-blue-light)); border: 2px solid var(--clash-panel-border-dark); box-shadow: 0 5px 0 #2e5185; padding: 10px 22px; font-size: 1rem; color: var(--clash-text-light); text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        .btn-clash-secondary:hover { background: linear-gradient(to bottom, #9dc2ff, #6c98d8); transform: translateY(-2px); box-shadow: 0 7px 0 #2e5185; }
        .btn-clash-secondary:active { transform: translateY(3px) !important; box-shadow: 0 2px 0 #2e5185 !important; }
        .input-clash { background-color: var(--clash-panel-border-dark); border: 2px solid #2a4166; color: #fff; border-radius: 10px; padding: 12px; font-size: 1rem; box-shadow: inset 0 3px 6px rgba(0,0,0,0.4); user-select: auto; touch-action: manipulation; }
        .input-clash:focus { outline: none; border-color: var(--clash-gold); box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 0 10px var(--clash-gold); }
        .option-btn { background: linear-gradient(to bottom, #7da8e8, #5c88c8); border: 2px solid #2a4166; box-shadow: 0 4px 0 #2e5185; color: white; transition: all 0.15s ease; font-size: 1rem; padding: 12px; border-radius: 12px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .option-btn:hover:not(:disabled) { background: linear-gradient(to bottom, #9dc2ff, #6c98d8); transform: translateY(-2px); box-shadow: 0 6px 0 #2e5185; }
        .option-btn.correct { background: linear-gradient(to bottom, #8fdd7d, var(--clash-green)) !important; border-color: #2e6221 !important; box-shadow: 0 4px 0 var(--clash-green-dark) !important; }
        .option-btn.incorrect { background: linear-gradient(to bottom, #e87b7c, var(--clash-red)) !important; border-color: #7c2425 !important; box-shadow: 0 4px 0 var(--clash-red-dark) !important; }
        .option-btn:disabled { opacity: 0.8; cursor: not-allowed; }
        .loader { border: 8px solid #3a5b8a; border-top: 8px solid var(--clash-gold); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100vh; padding: 20px; box-sizing: border-box; opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in-out, visibility 0.5s; display: flex; flex-direction: column; align-items: center; z-index: 1; }
        .screen.active { opacity: 1; visibility: visible; position: relative; }
        .screen-content-wrapper { width: 100%; max-width: 800px; margin: auto; display: flex; flex-direction: column; flex-grow: 1; justify-content: space-between; min-height: calc(100vh - 40px); }
        #user-profile-area { position: fixed; z-index: 100; display: flex; align-items: center; gap: 10px; transition: opacity 0.4s ease-out, transform 0.4s ease; top: 20px; right: 20px; }
        #user-profile-area.profile-area-hidden { opacity: 0; transform: translateY(-150%); }
        #user-info-box { background-color: rgba(91, 58, 41, 0.85); border: 4px solid #4a2f20; border-top-color: #c89673; border-left-color: #c89673; border-radius: 12px; padding: 12px 15px; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column; align-items: stretch; gap: 10px; min-width: 180px; max-width: 200px; }
        .user-info-item { background-color: rgba(60,40,30,0.7); padding: 4px 7px; border-radius: 6px; border: 1px solid #4a2f20; }
        .user-info-item .label { font-size: 0.9em; color: #f0d5bf; }
        .user-info-item .value { font-size: 1.1em; font-weight: bold; }
        #display-name-output-box .value { color: var(--clash-gold); font-size: 1.2em; }
        #user-email-output-box .value { color: #eee; font-size: 0.9em; }
        #edit-name-btn { cursor: pointer; font-size: 1em; color: var(--clash-gold); transition: color 0.3s ease; } #edit-name-btn:hover { color: #fff8a8; }
        #avatar-container { width: 80px; height: 80px; border-radius: 50%; border: 5px solid; border-image: linear-gradient(to bottom, #ffd700, #c89820) 1; background-color: #333; cursor: pointer; overflow: hidden; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 8px rgba(0,0,0,0.5); flex-shrink: 0; }
        #avatar-image { width: 100%; height: 100%; object-fit: cover; }
        #main-screen-header { display: flex; justify-content: center; align-items: center; width: 100%; padding: 0.5rem; margin-bottom: 1.5rem; background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png'); background-color: #6e4a31; border-radius: 12px; border: 4px solid #4a2f20; box-shadow: 0 6px 10px rgba(0,0,0,0.5); }
        #main-title { text-align: center; flex-grow: 1; font-size: 5rem; color: var(--clash-gold); text-shadow: -3px -3px 0 var(--clash-brown-dark), 3px -3px 0 var(--clash-brown-dark), -3px 3px 0 var(--clash-brown-dark), 3px 3px 0 var(--clash-brown-dark), -3px 0 0 var(--clash-brown-dark), 3px 0 0 var(--clash-brown-dark), 0 -3px 0 var(--clash-brown-dark), 0 3px 0 var(--clash-brown-dark), 6px 6px 8px rgba(0,0,0,0.7); }
        #main-screen-buttons-layout { display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: auto; padding-top: 1rem; }
        #top-action-buttons { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 1rem; width: 100%; }
        #change-name-error-message, #avatar-error-message { color: #ffdddd; font-size: 0.9rem; text-align: center; min-height: 1.2rem; margin-top: 0.5rem; font-weight: bold; background-color: rgba(200, 60, 60, 0.7); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--clash-red); }
        .hidden { display: none !important; }
        .popup-panel-container { background-color: rgba(10, 10, 10, 0.85); position: fixed; inset-0; flex-items: center; justify-content: center; z-index: 51; }
        .close-popup-btn { position: absolute; top: 12px; right: 12px; width: 40px; height: 40px; background: linear-gradient(to bottom, #e87b7c, var(--clash-red)); border: 2px solid #7c2425; box-shadow: 0 4px 0 #8f2a2b; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; line-height: 1; cursor: pointer; transition: all 0.2s ease; }
        .close-popup-btn:hover { transform: scale(1.1) rotate(90deg); }
        #leaderboard-item { display: flex; align-items: center; background-color: rgba(42, 65, 102, 0.9); padding: 0.75rem; border-radius: 12px; border: 2px solid rgba(157, 194, 255, 0.4); gap: 1rem; transition: all 0.2s ease; }
        #leaderboard-rank { font-family: 'Lilita One', cursive; font-size: 1.75rem; color: var(--clash-gold); -webkit-text-stroke: 1.5px var(--clash-brown-dark); width: 40px; text-align: center; }
        #leaderboard-avatar { width: 50px; height: 50px; border-radius: 50%; border: 3px solid var(--clash-gold-dark); object-fit: cover; background-color: #2a4166; }
        #leaderboard-name { font-family: 'Lilita One', cursive; font-size: 1.2rem; }
        #leaderboard-stage-value { color: var(--clash-gold); font-family: 'Lilita One', cursive; font-size: 1.1em; margin-right: 4px; }
        #avatar-preview-container { margin: 1rem auto; width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--clash-gold); overflow: hidden; background-color: var(--clash-panel-border-dark); display: flex; align-items: center; justify-content: center; }
        #avatar-preview-image { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>
    <!-- User Profile Area -->
    <div id="user-profile-area" class="hidden">
        <div id="avatar-container" title="تغییر آواتار">
            <img id="avatar-image" src="https://placehold.co/80x80/333333/777777?text=?" alt="آواتار کاربر">
        </div>
        <div id="user-info-box">
            <div id="display-name-output-box" class="user-info-item">
                <div class="label flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-300"><path d="M12 2C9.243 2 7 4.243 7 7s2.243 5 5 5 5-2.243 5-5S14.757 2 12 2zm0 8c-1.654 0-3-1.346-3-3s1.346-3 3-3 3 1.346 3 3-1.346 3-3 3zm9 11v-1c0-3.859-3.141-7-7-7h-4c-3.86 0-7 3.141-7 7v1h2v-1c0-2.757 2.243-5 5-5h4c2.757 0 5 2.243 5 5v1h2z"></path></svg>
                    <span>بازیکن:</span>
                </div>
                <div id="display-name-output-container" class="flex items-center gap-2">
                    <span id="edit-name-btn" title="تغییر نام">✏️</span>
                    <div id="display-name-output" class="value clash-font">...</div>
                </div>
            </div>
            <div id="user-email-output-box" class="user-info-item">
                <div class="label flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-gray-300"><path d="M20 4H4c-1.103 0-2 .897-2 2v12c0 1.103.897 2 2 2h16c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm0 2v.511l-8 6.223-8-6.223V6h16zM4 18V9.044l7.386 5.764a.998.998 0 0 0 1.228 0L20 9.044V18H4z"></path></svg>
                    <span>ایمیل:</span>
                </div>
                <div id="user-email-output" class="value">...</div>
            </div>
        </div>
    </div>

    <!-- Main Screen -->
    <div id="main-screen" class="screen active">
        <div class="screen-content-wrapper">
            <div id="main-screen-header">
                <h1 id="main-title" class="clash-font">شهر مافیا</h1>
            </div>
            <div id="main-screen-buttons-layout">
                <div id="top-action-buttons">
                    <button id="leaderboard-btn" class="btn-clash btn-clash-secondary clash-font">🏆 رتبه‌بندی</button>
                    <button id="start-game-btn" class="btn-clash btn-clash-primary clash-font breathing">شروع بازی</button>
                    <button id="developers-btn" class="btn-clash btn-clash-secondary clash-font">👥 سازندگان</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen">
        <!-- Game content will be dynamically inserted here by JS -->
    </div>
    
    <!-- Generic Modal -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 panel-hidden z-50">
        <div class="panel-clash p-6 sm:p-8 rounded-lg max-w-md md:max-w-lg w-full text-center">
            <h3 id="modal-title" class="text-2xl sm:text-3xl font-bold mb-4 clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">توجه</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-3 text-base"></p>
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="نام نمایشی جدید (فقط انگلیسی)" class="input-clash w-full mb-1 p-3 text-lg clash-font" maxlength="20">
                    <p id="change-name-error-message" class="hidden"></p>
                </div>
                <div id="avatar-upload-ui-container" class="hidden">
                    <div class="flex flex-col sm:flex-row items-stretch gap-2 my-4">
                        <input type="url" id="avatar-url-input" placeholder="لینک مستقیم تصویر را اینجا وارد کنید" class="input-clash w-full p-3 text-base" style="direction: ltr; text-align: left;">
                        <button id="preview-avatar-btn" class="btn-clash btn-clash-secondary clash-font whitespace-nowrap px-4">پیش‌نمایش</button>
                    </div>
                    <div id="avatar-preview-container" class="hidden">
                        <img id="avatar-preview-image" src="#" alt="پیش نمایش آواتار">
                    </div>
                    <p id="avatar-error-message" class="hidden"></p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-4 mt-5">
                <button id="modal-confirm-btn" class="btn-clash btn-clash-primary clash-font">تایید</button>
                <button id="modal-cancel-btn" class="btn-clash btn-clash-secondary clash-font">لغو</button>
            </div>
        </div>
    </div>

    <!-- Other Popups (Leaderboard, etc.) would go here -->
    <div id="leaderboard-panel-container" class="popup-panel-container panel-hidden flex items-center justify-center p-4">
        <div id="leaderboard-panel" class="panel-clash p-5 sm:p-7 rounded-xl max-w-lg md:max-w-2xl w-full relative">
            <button id="close-leaderboard-panel-btn" class="close-popup-btn">×</button>
            <h3 class="text-3xl sm:text-4xl font-bold mb-8 text-center clash-font text-[var(--clash-gold)]" style="text-shadow: 2px 2px 3px #000;">کاربران برتر شهر</h3>
            <div id="leaderboard-list" class="space-y-2 max-h-[calc(85vh-150px)] overflow-y-auto pr-3 pl-1">
                <!-- Leaderboard items will be injected here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK and Game Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, collection, query, where, limit, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // IMPORTANT: Use the Firebase config from your Registration/Login pages
        const firebaseConfig = {
          apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
          authDomain: "mafia-9fcbf.firebaseapp.com",
          projectId: "mafia-9fcbf",
          storageBucket: "mafia-9fcbf.appspot.com",
          messagingSenderId: "471627157488",
          appId: "1:471627157488:web:92f008548a5596619a5735",
          measurementId: "G-0PDHDWC6NV"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State & DOM Elements ---
        let currentUser = null;
        let gameState = { displayName: '', email: '', currentStage: 1, avatarUrl: '' };
        let modalConfirmCallback = null;
        
        const userProfileArea = document.getElementById('user-profile-area');
        const avatarContainer = document.getElementById('avatar-container');
        const avatarImage = document.getElementById('avatar-image');
        const displayNameOutput = document.getElementById('display-name-output');
        const userEmailOutput = document.getElementById('user-email-output');
        const editNameBtn = document.getElementById('edit-name-btn');
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const changeNameInputContainer = document.getElementById('change-name-input-container');
        const newDisplayNameInput = document.getElementById('new-display-name-input');
        const changeNameErrorMessage = document.getElementById('change-name-error-message');
        const avatarUploadUiContainer = document.getElementById('avatar-upload-ui-container');
        const avatarUrlInput = document.getElementById('avatar-url-input');
        const previewAvatarBtn = document.getElementById('preview-avatar-btn');
        const avatarPreviewContainer = document.getElementById('avatar-preview-container');
        const avatarPreviewImage = document.getElementById('avatar-preview-image');
        const avatarErrorMessage = document.getElementById('avatar-error-message');
        const leaderboardPanelContainer = document.getElementById('leaderboard-panel-container');
        const closeLeaderboardPanelBtn = document.getElementById('close-leaderboard-panel-btn');
        const leaderboardList = document.getElementById('leaderboard-list');

        // --- Auth State Change Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in.
                currentUser = user;
                await loadUserData(user);
                updateUI();
                userProfileArea.classList.remove('hidden');
            } else {
                // No user is signed in. Redirect to login page.
                console.log("No user found. Redirecting to login.");
                window.location.href = './login.html';
            }
        });

        async function loadUserData(user) {
            const userDocRef = doc(db, 'users', user.uid);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    gameState.displayName = data.displayName || user.displayName;
                    gameState.email = data.email || user.email;
                    gameState.currentStage = data.currentStage || 1;
                    gameState.avatarUrl = data.avatarUrl || '';
                } else {
                    // This can happen if user registers but Firestore doc fails to create.
                    // We'll create it here with default data.
                    console.log("User document not found, creating one.");
                    const newUserDoc = {
                        uid: user.uid,
                        displayName: user.displayName,
                        email: user.email,
                        createdAt: serverTimestamp(),
                        currentStage: 1,
                        avatarUrl: ''
                    };
                    await setDoc(userDocRef, newUserDoc);
                    Object.assign(gameState, newUserDoc);
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showModal("خطا", "مشکلی در بارگذاری اطلاعات شما پیش آمد.");
            }
        }
        
        function updateUI() {
            displayNameOutput.textContent = gameState.displayName || 'بی‌نام';
            userEmailOutput.textContent = gameState.email || 'ایمیل نامشخص';
            if (gameState.avatarUrl) {
                avatarImage.src = gameState.avatarUrl;
            } else {
                avatarImage.src = `https://placehold.co/80x80/333333/777777?text=${(gameState.displayName || 'N').charAt(0).toUpperCase()}`;
            }
        }

        function showModal(title, message, confirmText = "تایید", cancelText = null, onConfirm = null, modalType = "generic") {
            modalContainer.classList.remove('panel-hidden');
            modalContainer.querySelector('.panel-clash').classList.add('panel-visible');

            modalTitle.textContent = title;
            modalMessage.innerHTML = message;

            // Hide all specific UI elements first
            changeNameInputContainer.classList.add('hidden');
            avatarUploadUiContainer.classList.add('hidden');
            
            if (modalType === "changeName") {
                changeNameInputContainer.classList.remove('hidden');
                newDisplayNameInput.value = gameState.displayName;
                changeNameErrorMessage.classList.add('hidden');
            } else if (modalType === "avatar") {
                avatarUploadUiContainer.classList.remove('hidden');
                avatarUrlInput.value = '';
                avatarPreviewContainer.classList.add('hidden');
                avatarErrorMessage.classList.add('hidden');
                modalConfirmBtn.disabled = true; // Disable confirm until preview is successful
            }

            modalConfirmBtn.textContent = confirmText;
            modalCancelBtn.style.display = cancelText ? 'inline-flex' : 'none';
            if(cancelText) modalCancelBtn.textContent = cancelText;

            modalConfirmCallback = onConfirm;
        }

        function hideModal() {
            modalContainer.classList.add('panel-hidden');
            modalConfirmCallback = null;
        }

        function validateName(name) {
            const trimmedName = name.trim();
            if (!/^[a-zA-Z0-9_.]+$/.test(trimmedName)) {
                return "نام نمایشی فقط می‌تواند شامل حروف و اعداد انگلیسی، نقطه و آندرلاین باشد.";
            }
            if (trimmedName.length < 3 || trimmedName.length > 20) {
                return "نام نمایشی باید بین ۳ تا ۲۰ کاراکتر باشد.";
            }
            return null; // No error
        }

        async function handleChangeDisplayName() {
            const newName = newDisplayNameInput.value;
            const validationError = validateName(newName);

            if (validationError) {
                changeNameErrorMessage.textContent = validationError;
                changeNameErrorMessage.classList.remove('hidden');
                return;
            }
            
            // Check for uniqueness
            const q = query(collection(db, "users"), where("displayName", "==", newName), limit(1));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty && querySnapshot.docs[0].id !== currentUser.uid) {
                changeNameErrorMessage.textContent = "این نام قبلا توسط شخص دیگری گرفته شده است.";
                changeNameErrorMessage.classList.remove('hidden');
                return;
            }

            // Update Firestore
            const userDocRef = doc(db, 'users', currentUser.uid);
            await updateDoc(userDocRef, { displayName: newName });
            
            // Update Auth profile (optional but good practice)
            // await updateProfile(currentUser, { displayName: newName });
            
            gameState.displayName = newName;
            updateUI();
            hideModal();
        }

        async function saveAvatarFromUrl() {
            const newUrl = avatarUrlInput.value.trim();
            if (!newUrl.startsWith('http') || !/\.(jpg|jpeg|png|gif|webp)$/i.test(newUrl)) {
                 avatarErrorMessage.textContent = 'لینک وارد شده معتبر نیست.';
                 avatarErrorMessage.classList.remove('hidden');
                 return;
            }

            const userDocRef = doc(db, 'users', currentUser.uid);
            await updateDoc(userDocRef, { avatarUrl: newUrl });
            
            gameState.avatarUrl = newUrl;
            updateUI();
            hideModal();
        }
        
        async function fetchAndDisplayLeaderboard() {
            leaderboardList.innerHTML = `<div class="loader mx-auto"></div>`;
            const q = query(collection(db, "users"), orderBy("currentStage", "desc"), limit(20));
            const querySnapshot = await getDocs(q);
            
            let rank = 1;
            const leaderboardHTML = querySnapshot.docs.map(doc => {
                const user = doc.data();
                const avatarSrc = user.avatarUrl || `https://placehold.co/50x50/2a4166/ffffff?text=${(user.displayName || 'N').charAt(0).toUpperCase()}`;
                
                return `
                    <div class="leaderboard-item flex items-center gap-4 p-3 bg-blue-900/50 rounded-lg border-2 border-blue-400/30" id="leaderboard-item">
                        <span class="leaderboard-rank w-10 text-center text-2xl font-bold text-yellow-400" id="leaderboard-rank">${rank++}</span>
                        <img src="${avatarSrc}" alt="Avatar" class="leaderboard-avatar w-12 h-12 rounded-full object-cover border-2 border-yellow-500" id="leaderboard-avatar">
                        <div class="flex-grow">
                            <div class="leaderboard-name text-lg font-bold" id="leaderboard-name">${user.displayName || 'بی‌نام'}</div>
                            <div class="leaderboard-stage text-sm text-gray-300">مرحله: <span class="font-bold text-yellow-300" id="leaderboard-stage-value">${user.currentStage || 1}</span></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            leaderboardList.innerHTML = leaderboardHTML || '<p class="text-center">هنوز کسی در جدول امتیازات نیست!</p>';
        }

        // --- Event Listeners ---
        editNameBtn.addEventListener('click', () => {
            showModal('تغییر نام نمایشی', 'نام جدید خود را وارد کنید.', 'ذخیره', 'لغو', handleChangeDisplayName, 'changeName');
        });

        avatarContainer.addEventListener('click', () => {
            showModal('تغییر آواتار', 'لینک مستقیم تصویر خود را وارد کنید.', 'ذخیره', 'لغو', saveAvatarFromUrl, 'avatar');
        });
        
        previewAvatarBtn.addEventListener('click', () => {
            const url = avatarUrlInput.value.trim();
            if (url) {
                avatarPreviewImage.src = url;
                avatarPreviewContainer.classList.remove('hidden');
                modalConfirmBtn.disabled = false;
                avatarErrorMessage.classList.add('hidden');
                avatarPreviewImage.onerror = () => {
                    avatarErrorMessage.textContent = 'خطا در بارگذاری تصویر. لینک را بررسی کنید.';
                    avatarErrorMessage.classList.remove('hidden');
                    modalConfirmBtn.disabled = true;
                }
            }
        });

        leaderboardBtn.addEventListener('click', () => {
            leaderboardPanelContainer.classList.remove('panel-hidden');
            fetchAndDisplayLeaderboard();
        });
        
        closeLeaderboardPanelBtn.addEventListener('click', () => {
            leaderboardPanelContainer.classList.add('panel-hidden');
        });

        modalConfirmBtn.addEventListener('click', () => {
            if (modalConfirmCallback) modalConfirmCallback();
        });

        modalCancelBtn.addEventListener('click', hideModal);

    </script>
</body>
</html>
