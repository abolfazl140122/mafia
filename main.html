<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ÿ¥Ÿáÿ± ŸÖÿßŸÅ€åÿß - ÿ®ÿßÿ≤€å ÿ¢ŸÜŸÑÿß€åŸÜ ŸÖÿßŸÅ€åÿß ÿ®ÿß ⁄Øÿ±ÿßŸÅ€å⁄© ÿ≠ÿ±ŸÅŸá‚Äåÿß€å">
    <meta name="theme-color" content="#0c0a09">
    <title>ÿ¥Ÿáÿ± ŸÖÿßŸÅ€åÿß - ŸÑÿßÿ®€å ÿßÿµŸÑ€å</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== CSS Variables ===== */
        :root {
            --primary-bg: #0c0a09;
            --secondary-bg: #1a140e;
            --accent-gold: #ffc947;
            --accent-red: #8c4843;
            --accent-dark-red: #5a2c2a;
            --text-primary: #f0e6d2;
            --text-secondary: #c5a687;
            --border-color: #5c4a3a;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --gradient-gold: linear-gradient(145deg, #ffc947, #e6b13a);
            --gradient-red: linear-gradient(145deg, #8c4843, #5a2c2a);
            --gradient-dark: linear-gradient(145deg, #3c3022, #1e170f);
        }

        /* ===== Reset & Base Styles ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* ===== Background Layers ===== */
        #background-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--primary-bg);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.8s ease-out;
        }

        #background-animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            animation: kenBurnsEffect 40s ease-in-out infinite alternate;
        }

        @keyframes kenBurnsEffect {
            0% { transform: scale(1) translate(0, 0); }
            100% { transform: scale(1.15) translate(-2%, 2%); }
        }

        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(12, 10, 9, 0.7), rgba(12, 10, 9, 0.9));
            z-index: -1;
        }

        /* ===== Particle Effect ===== */
        #particle-effect-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity 1s ease;
        }

        #particle-effect-canvas.visible {
            opacity: 0.7;
        }

        /* ===== Loading Screens ===== */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1002;
            transition: opacity 0.5s ease;
        }

        .loader-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin-bottom: 30px;
        }

        .loader {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 6px solid transparent;
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
        }

        .loader::before {
            content: '';
            position: absolute;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            border: 6px solid transparent;
            border-top-color: var(--accent-red);
            border-radius: 50%;
            animation: spin 2s linear infinite reverse;
        }

        .loading-text-container {
            text-align: center;
        }

        #loading-text {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .loading-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: var(--accent-gold);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* ===== Music Download Overlay ===== */
        #music-download-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        #music-download-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .download-panel {
            width: 90%;
            max-width: 400px;
            text-align: center;
            background: var(--gradient-dark);
            padding: 40px 30px;
            border-radius: var(--border-radius);
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .download-icon {
            font-size: 3rem;
            color: var(--accent-gold);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .download-title {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--accent-gold);
            margin-bottom: 25px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.7);
        }

        .progress-container {
            width: 100%;
            height: 24px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background: var(--gradient-gold);
            border-radius: 12px;
            transition: width 0.3s ease-out;
            position: relative;
            overflow: hidden;
        }

        #progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            100% { left: 100%; }
        }

        #progress-text {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-secondary);
            direction: ltr;
        }

        /* ===== Main Content Structure ===== */
        .main-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            position: relative;
            z-index: 1;
        }

        body.loaded .main-content {
            opacity: 1;
            visibility: visible;
        }

        body.loaded #loading-overlay {
            opacity: 0;
            visibility: hidden;
        }

        /* ===== Header Section ===== */
        .header-container {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .user-info-card {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 201, 71, 0.2);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .user-info-card:hover {
            border-color: var(--accent-gold);
            box-shadow: 0 0 20px rgba(255, 201, 71, 0.2);
        }

        .avatar-container {
            position: relative;
            cursor: pointer;
        }

        #user-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid var(--accent-gold);
            object-fit: cover;
            transition: var(--transition);
        }

        .avatar-container:hover #user-avatar {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 0 25px rgba(255, 201, 71, 0.5);
        }

        .avatar-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 24px;
            height: 24px;
            background: var(--accent-red);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            border: 2px solid var(--primary-bg);
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #user-display-name {
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }

        .user-stats {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .gems-display {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255, 201, 71, 0.3);
        }

        .gems-icon {
            font-size: 1.4rem;
            color: var(--accent-gold);
            filter: drop-shadow(0 0 5px rgba(255, 201, 71, 0.5));
        }

        #user-gems-count {
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--accent-gold);
            direction: ltr;
            font-feature-settings: "tnum";
        }

        .level-display {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid rgba(92, 74, 58, 0.3);
        }

        .level-icon {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        #user-level {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* ===== Navigation Menu ===== */
        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
        }

        .nav-button {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            width: 180px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            text-align: right;
        }

        .nav-button:hover {
            background: rgba(255, 201, 71, 0.1);
            border-color: var(--accent-gold);
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(255, 201, 71, 0.2);
        }

        .nav-button i {
            font-size: 1.2rem;
            color: var(--accent-gold);
        }

        .nav-button.admin-only {
            background: rgba(139, 0, 0, 0.2);
            border-color: #8b0000;
        }

        .nav-button.admin-only:hover {
            background: rgba(139, 0, 0, 0.3);
            border-color: #ff0000;
        }

        /* ===== Main Game Actions ===== */
        .game-actions-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            padding-bottom: 30px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            width: 100%;
            max-width: 800px;
        }

        .secondary-action {
            width: 160px;
            height: 60px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .secondary-action:hover {
            background: rgba(92, 74, 58, 0.3);
            border-color: var(--accent-gold);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 201, 71, 0.2);
        }

        #start-game-button {
            min-width: 220px;
            height: 80px;
            background: var(--gradient-red);
            border: 3px solid var(--accent-gold);
            border-radius: calc(var(--border-radius) + 4px);
            color: white;
            font-size: 1.5rem;
            font-weight: 900;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
        }

        #start-game-button::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -60%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to right,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transform: rotate(30deg);
            transition: 0.8s;
        }

        #start-game-button:hover {
            background: linear-gradient(145deg, #9d524c, #6b3431);
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 30px rgba(255, 201, 71, 0.3);
        }

        #start-game-button:hover::before {
            left: 100%;
        }

        #start-game-button:active {
            transform: translateY(-2px) scale(0.98);
        }

        /* ===== Modals & Overlays ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--gradient-dark);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.8);
            transform: translateY(30px) scale(0.95);
            transition: var(--transition);
            position: relative;
        }

        .modal-overlay.visible .modal-content {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.7);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 2.5rem;
            cursor: pointer;
            transition: var(--transition);
            line-height: 1;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            color: var(--accent-gold);
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(90deg);
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .modal-footer {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--gradient-red);
            color: white;
            border: 1px solid var(--accent-gold);
        }

        .btn-primary:hover {
            background: linear-gradient(145deg, #9d524c, #6b3431);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 201, 71, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--text-secondary);
        }

        /* ===== Profile Modal ===== */
        .profile-modal .modal-content {
            max-width: 450px;
            padding: 0;
            overflow: hidden;
        }

        .profile-header {
            background: linear-gradient(145deg, var(--accent-dark-red), #3a2220);
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .profile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100" opacity="0.1"><path d="M0,0 L100,100 M100,0 L0,100" stroke="white" stroke-width="1"/></svg>');
        }

        .profile-avatar {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 5px solid var(--accent-gold);
            object-fit: cover;
            margin-bottom: 25px;
            position: relative;
            z-index: 1;
            box-shadow: 0 0 30px rgba(255, 201, 71, 0.4);
        }

        .profile-name {
            font-size: 2rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
            position: relative;
            z-index: 1;
        }

        .profile-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--accent-gold);
            color: var(--primary-bg);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            z-index: 1;
        }

        .profile-body {
            padding: 30px;
            background: var(--secondary-bg);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .stat-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stat-label i {
            color: var(--accent-gold);
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            direction: ltr;
            text-align: left;
        }

        /* ===== Ranking Modal ===== */
        .ranking-modal .modal-content {
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .ranking-list {
            flex: 1;
            overflow-y: auto;
            margin: 20px 0;
            padding-right: 10px;
        }

        .ranking-list::-webkit-scrollbar {
            width: 8px;
        }

        .ranking-list::-webkit-scrollbar-track {
            background: var(--secondary-bg);
            border-radius: 4px;
        }

        .ranking-list::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 4px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid transparent;
            transition: var(--transition);
        }

        .ranking-item:hover {
            background: rgba(255, 201, 71, 0.1);
            border-color: var(--accent-gold);
        }

        .ranking-item.current-user {
            background: rgba(255, 201, 71, 0.15);
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px rgba(255, 201, 71, 0.2);
        }

        .rank-number {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--accent-gold);
            width: 60px;
            text-align: center;
        }

        .rank-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--accent-gold);
            object-fit: cover;
            margin-left: 15px;
        }

        .rank-info {
            flex: 1;
            text-align: right;
        }

        .rank-name {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .rank-gems {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* ===== Tutorial & Guide ===== */
        #tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            pointer-events: none;
            opacity: 0;
            transition: var(--transition);
        }

        #tutorial-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        .tutorial-spotlight {
            position: absolute;
            border-radius: var(--border-radius);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.9);
            border: 3px solid var(--accent-gold);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tutorial-card {
            position: absolute;
            width: 320px;
            background: var(--gradient-dark);
            border: 2px solid var(--accent-gold);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            transform: translateY(20px);
            opacity: 0;
            transition: var(--transition);
        }

        .tutorial-card.visible {
            transform: translateY(0);
            opacity: 1;
        }

        /* ===== Responsive Design ===== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header-container {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .user-info-card {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .user-stats {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .nav-menu {
                align-items: stretch;
            }
            
            .nav-button {
                width: 100%;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .secondary-action, #start-game-button {
                width: 100%;
                max-width: 300px;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            #user-avatar {
                width: 60px;
                height: 60px;
            }
            
            #user-display-name {
                font-size: 1.1rem;
            }
            
            .gems-display, .level-display {
                padding: 6px 12px;
                font-size: 0.9rem;
            }
            
            #start-game-button {
                font-size: 1.3rem;
                height: 70px;
            }
            
            .download-panel {
                padding: 30px 20px;
            }
            
            .download-title {
                font-size: 1.5rem;
            }
        }

        /* ===== Animations ===== */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 201, 71, 0.5); }
            50% { box-shadow: 0 0 25px rgba(255, 201, 71, 0.8); }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        .glow-animation {
            animation: glow 2s ease-in-out infinite;
        }

        /* ===== Utility Classes ===== */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-1 { margin-bottom: 10px; }
        .mb-2 { margin-bottom: 20px; }
        .mb-3 { margin-bottom: 30px; }

        .mt-1 { margin-top: 10px; }
        .mt-2 { margin-top: 20px; }
        .mt-3 { margin-top: 30px; }

        /* ===== Status Indicators ===== */
        .status-online {
            color: #10b981;
        }

        .status-offline {
            color: #ef4444;
        }

        .status-busy {
            color: #f59e0b;
        }

        /* ===== Loading States ===== */
        .loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--accent-gold);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Background Layers -->
    <div id="background-loader">
        <div class="loader-container">
            <div class="loader"></div>
        </div>
        <div class="loading-text-container">
            <p id="loading-text">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ¥Ÿáÿ± ŸÖÿßŸÅ€åÿß...</p>
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>
    
    <div id="background-animation-container"></div>
    <div class="background-overlay"></div>
    <canvas id="particle-effect-canvas"></canvas>
    
    <!-- Music Download Overlay -->
    <div id="music-download-overlay">
        <div class="download-panel">
            <div class="download-icon">
                <i class="fas fa-music"></i>
            </div>
            <h2 class="download-title">ÿ¢ŸÖÿßÿØŸá‚Äåÿ≥ÿßÿ≤€å ŸÖŸàÿ≥€åŸÇ€å</h2>
            <div class="progress-container">
                <div id="progress-bar"></div>
            </div>
            <p id="progress-text">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å... 0%</p>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header-container">
            <!-- User Info Card -->
            <div class="user-info-card">
                <div class="avatar-container">
                    <img id="user-avatar" src="" alt="ÿ¢Ÿàÿßÿ™ÿßÿ± ⁄©ÿßÿ±ÿ®ÿ±">
                    <div class="avatar-badge">
                        <i class="fas fa-crown"></i>
                    </div>
                </div>
                <div class="user-details">
                    <h2 id="user-display-name">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...</h2>
                    <div class="user-stats">
                        <div class="gems-display">
                            <span class="gems-icon">üíé</span>
                            <span id="user-gems-count">0</span>
                        </div>
                        <div class="level-display">
                            <span class="level-icon">üéØ</span>
                            <span id="user-level">ÿ≥ÿ∑ÿ≠ €±</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Menu -->
            <div class="nav-menu">
                <button class="nav-button" id="creators-button">
                    <span>ÿ≥ÿßÿ≤ŸÜÿØ⁄ØÿßŸÜ</span>
                    <i class="fas fa-users"></i>
                </button>
                <button class="nav-button" id="ranking-button">
                    <span>ÿ±ÿØŸá‚Äåÿ®ŸÜÿØ€å</span>
                    <i class="fas fa-trophy"></i>
                </button>
                <button class="nav-button" id="clan-button">
                    <span>⁄©ŸÑŸÜ‚ÄåŸáÿß</span>
                    <i class="fas fa-shield-alt"></i>
                </button>
                <button class="nav-button admin-only" id="admin-button">
                    <span>ŸÖÿØ€åÿ±€åÿ™</span>
                    <i class="fas fa-user-shield"></i>
                </button>
            </div>
        </div>
        
        <!-- Main Game Actions -->
        <div class="game-actions-container">
            <div class="action-buttons">
                <button class="secondary-action" id="shop-button">
                    <i class="fas fa-store"></i>
                    ŸÅÿ±Ÿàÿ¥⁄ØÿßŸá
                </button>
                
                <button id="start-game-button" class="glow-animation">
                    <i class="fas fa-play-circle"></i>
                    ÿ¥ÿ±Ÿàÿπ ÿ®ÿßÿ≤€å
                </button>
                
                <button class="secondary-action" id="friends-button">
                    <i class="fas fa-user-friends"></i>
                    ÿØŸàÿ≥ÿ™ÿßŸÜ
                </button>
            </div>
            
            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="stat-item">
                    <span class="stat-label">ÿ®ÿßÿ≤€å⁄©ŸÜÿßŸÜ ÿ¢ŸÜŸÑÿß€åŸÜ:</span>
                    <span class="stat-value" id="online-count">€∞</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ÿ®ÿßÿ≤€å‚ÄåŸáÿß€å ŸÅÿπÿßŸÑ:</span>
                    <span class="stat-value" id="active-games">€∞</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Audio Element -->
    <audio id="background-music" loop></audio>
    
    <!-- Modals -->
    <!-- Profile Modal -->
    <div id="profile-modal" class="modal-overlay profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ÿæÿ±ŸàŸÅÿß€åŸÑ ⁄©ÿßÿ±ÿ®ÿ±</h2>
                <button class="modal-close" id="profile-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Profile content will be loaded here dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Ranking Modal -->
    <div id="ranking-modal" class="modal-overlay ranking-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ÿ±ÿØŸá‚Äåÿ®ŸÜÿØ€å ÿ®ÿßÿ≤€å⁄©ŸÜÿßŸÜ</h2>
                <button class="modal-close" id="ranking-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="ranking-list" id="ranking-list">
                    <!-- Ranking items will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="refresh-ranking">ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å</button>
            </div>
        </div>
    </div>
    
    <!-- Game Mode Selection Modal -->
    <div id="game-mode-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ÿßŸÜÿ™ÿÆÿßÿ® ŸÜŸàÿπ ÿ®ÿßÿ≤€å</h2>
                <button class="modal-close" id="game-mode-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mode-selection">
                    <button class="mode-option" id="friendly-mode">
                        <i class="fas fa-user-friends"></i>
                        <h3>ÿ®ÿßÿ≤€å ÿØŸàÿ≥ÿ™ÿßŸÜŸá</h3>
                        <p>ÿ®ÿßÿ≤€å ÿ∫€åÿ±ÿ±ÿ≥ŸÖ€å ÿ®ÿß ÿØŸàÿ≥ÿ™ÿßŸÜ</p>
                    </button>
                    <button class="mode-option" id="ranked-mode">
                        <i class="fas fa-trophy"></i>
                        <h3>ÿ®ÿßÿ≤€å ÿ±ŸÇÿßÿ®ÿ™€å</h3>
                        <p>⁄©ÿ≥ÿ® ÿßŸÖÿ™€åÿßÿ≤ Ÿà ÿ±ÿ™ÿ®Ÿá</p>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay">
        <div class="tutorial-spotlight" id="tutorial-spotlight"></div>
        <div class="tutorial-card" id="tutorial-card">
            <h3 id="tutorial-title"></h3>
            <p id="tutorial-text"></p>
            <div class="tutorial-buttons">
                <button class="btn btn-secondary" id="tutorial-skip">ÿ±ÿØ ⁄©ÿ±ÿØŸÜ</button>
                <button class="btn btn-primary" id="tutorial-next">ÿ®ÿπÿØ€å</button>
            </div>
        </div>
    </div>
    
    <!-- Notification System -->
    <div id="notification-container"></div>

    <script type="module">
        // ===== Firebase Configuration =====
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            getDoc,
            onSnapshot,
            collection,
            getDocs,
            updateDoc,
            query,
            orderBy,
            limit,
            where,
            serverTimestamp,
            increment
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADQNadPyy43TmSR2yCiKjoLBVMeAqT4Zg",
            authDomain: "mafia-9fcbf.firebaseapp.com",
            projectId: "mafia-9fcbf",
            storageBucket: "mafia-9fcbf.appspot.com",
            messagingSenderId: "471627157488",
            appId: "1:471627157488:web:92f008548a5596619a5735",
            measurementId: "G-0PDHDWC6NV"
        };

        // ===== Global Variables =====
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let currentUserData = null;
        let firestoreListeners = [];
        let particles = [];
        let particleAnimationId = null;

        // ===== Constants =====
        const DEFAULT_AVATAR = 'https://i.imgur.com/T2bT1tG.png';
        const BACKGROUND_IMAGE = 'https://cdn.imgurl.ir/uploads/j60503_IMG-20251112-WA0013.jpg';
        const BACKGROUND_MUSIC = "https://raw.githubusercontent.com/abolfazl140122/mafia/main/dark-music-249503.mp3";
        
        // ===== DOM Elements =====
        const elements = {
            // Background & Loading
            backgroundLoader: document.getElementById('background-loader'),
            backgroundContainer: document.getElementById('background-animation-container'),
            particleCanvas: document.getElementById('particle-effect-canvas'),
            loadingText: document.getElementById('loading-text'),
            
            // Music
            backgroundMusic: document.getElementById('background-music'),
            musicDownloadOverlay: document.getElementById('music-download-overlay'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            
            // User Interface
            userAvatar: document.getElementById('user-avatar'),
            userDisplayName: document.getElementById('user-display-name'),
            userGemsCount: document.getElementById('user-gems-count'),
            userLevel: document.getElementById('user-level'),
            
            // Buttons
            startGameButton: document.getElementById('start-game-button'),
            shopButton: document.getElementById('shop-button'),
            clanButton: document.getElementById('clan-button'),
            creatorsButton: document.getElementById('creators-button'),
            rankingButton: document.getElementById('ranking-button'),
            adminButton: document.getElementById('admin-button'),
            friendsButton: document.getElementById('friends-button'),
            
            // Modals
            profileModal: document.getElementById('profile-modal'),
            rankingModal: document.getElementById('ranking-modal'),
            gameModeModal: document.getElementById('game-mode-modal'),
            profileClose: document.getElementById('profile-close'),
            rankingClose: document.getElementById('ranking-close'),
            gameModeClose: document.getElementById('game-mode-close'),
            
            // Game Modes
            friendlyMode: document.getElementById('friendly-mode'),
            rankedMode: document.getElementById('ranked-mode'),
            
            // Tutorial
            tutorialOverlay: document.getElementById('tutorial-overlay'),
            tutorialSpotlight: document.getElementById('tutorial-spotlight'),
            tutorialCard: document.getElementById('tutorial-card'),
            tutorialTitle: document.getElementById('tutorial-title'),
            tutorialText: document.getElementById('tutorial-text'),
            tutorialSkip: document.getElementById('tutorial-skip'),
            tutorialNext: document.getElementById('tutorial-next'),
            
            // Stats
            onlineCount: document.getElementById('online-count'),
            activeGames: document.getElementById('active-games'),
            
            // Ranking
            rankingList: document.getElementById('ranking-list'),
            refreshRanking: document.getElementById('refresh-ranking')
        };

        // ===== Utility Functions =====
        class Utils {
            static async sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            static formatNumber(num) {
                return new Intl.NumberFormat('fa-IR').format(num);
            }
            
            static formatDate(date) {
                return new Intl.DateTimeFormat('fa-IR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            }
            
            static debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            static showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                    <button class="notification-close"><i class="fas fa-times"></i></button>
                `;
                
                container.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 10);
                
                notification.querySelector('.notification-close').addEventListener('click', () => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                });
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }
            
            static async confirm(message) {
                return new Promise((resolve) => {
                    const overlay = document.createElement('div');
                    overlay.className = 'modal-overlay';
                    overlay.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">ÿ™ÿß€å€åÿØ ÿπŸÖŸÑ€åÿßÿ™</h2>
                            </div>
                            <div class="modal-body">
                                <p>${message}</p>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="confirm-cancel">ÿßŸÜÿµÿ±ÿßŸÅ</button>
                                <button class="btn btn-primary" id="confirm-ok">ÿ™ÿß€å€åÿØ</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(overlay);
                    setTimeout(() => overlay.classList.add('visible'), 10);
                    
                    overlay.querySelector('#confirm-cancel').addEventListener('click', () => {
                        overlay.classList.remove('visible');
                        setTimeout(() => overlay.remove(), 300);
                        resolve(false);
                    });
                    
                    overlay.querySelector('#confirm-ok').addEventListener('click', () => {
                        overlay.classList.remove('visible');
                        setTimeout(() => overlay.remove(), 300);
                        resolve(true);
                    });
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) {
                            overlay.classList.remove('visible');
                            setTimeout(() => overlay.remove(), 300);
                            resolve(false);
                        }
                    });
                });
            }
        }

        // ===== Background Management =====
        class BackgroundManager {
            static async loadBackgroundImage() {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.src = BACKGROUND_IMAGE + '?t=' + Date.now();
                    
                    img.onload = () => {
                        elements.backgroundContainer.style.backgroundImage = `url(${img.src})`;
                        resolve();
                    };
                    
                    img.onerror = () => {
                        console.warn('Failed to load background image, using fallback');
                        elements.backgroundContainer.style.backgroundColor = '#0c0a09';
                        resolve();
                    };
                });
            }
            
            static async loadBackgroundMusic() {
                return new Promise(async (resolve, reject) => {
                    try {
                        elements.musicDownloadOverlay.classList.add('visible');
                        
                        const response = await fetch(BACKGROUND_MUSIC);
                        const contentLength = response.headers.get('content-length');
                        const total = parseInt(contentLength, 10);
                        let loaded = 0;
                        
                        const reader = response.body.getReader();
                        const chunks = [];
                        
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            chunks.push(value);
                            loaded += value.length;
                            
                            const percent = Math.round((loaded / total) * 100);
                            elements.progressBar.style.width = percent + '%';
                            elements.progressText.textContent = `ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å... ${percent}%`;
                        }
                        
                        const blob = new Blob(chunks);
                        const url = URL.createObjectURL(blob);
                        elements.backgroundMusic.src = url;
                        
                        // Set volume from localStorage or default
                        const savedVolume = localStorage.getItem('musicVolume');
                        elements.backgroundMusic.volume = savedVolume ? savedVolume / 100 : 0.4;
                        
                        elements.musicDownloadOverlay.classList.remove('visible');
                        resolve();
                    } catch (error) {
                        console.error('Failed to load background music:', error);
                        elements.musicDownloadOverlay.classList.remove('visible');
                        Utils.showNotification('ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÖŸàÿ≥€åŸÇ€å', 'error');
                        resolve();
                    }
                });
            }
            
            static initializeParticles() {
                const canvas = elements.particleCanvas;
                const ctx = canvas.getContext('2d');
                
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                
                class Particle {
                    constructor() {
                        this.x = Math.random() * canvas.width;
                        this.y = Math.random() * canvas.height;
                        this.size = Math.random() * 3 + 1;
                        this.speedX = Math.random() * 1 - 0.5;
                        this.speedY = Math.random() * 1 - 0.5;
                        this.color = `rgba(255, 201, 71, ${Math.random() * 0.3 + 0.2})`;
                    }
                    
                    update() {
                        this.x += this.speedX;
                        this.y += this.speedY;
                        
                        if (this.x > canvas.width) this.x = 0;
                        if (this.x < 0) this.x = canvas.width;
                        if (this.y > canvas.height) this.y = 0;
                        if (this.y < 0) this.y = canvas.height;
                    }
                    
                    draw() {
                        ctx.fillStyle = this.color;
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
                
                // Create particles
                particles = [];
                const particleCount = Math.min(Math.floor((canvas.width * canvas.height) / 15000), 150);
                
                for (let i = 0; i < particleCount; i++) {
                    particles.push(new Particle());
                }
                
                // Animation loop
                function animate() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    particles.forEach(particle => {
                        particle.update();
                        particle.draw();
                    });
                    
                    particleAnimationId = requestAnimationFrame(animate);
                }
                
                animate();
                canvas.classList.add('visible');
                
                // Handle resize
                window.addEventListener('resize', () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                });
            }
            
            static stopParticles() {
                if (particleAnimationId) {
                    cancelAnimationFrame(particleAnimationId);
                    particleAnimationId = null;
                }
                elements.particleCanvas.classList.remove('visible');
            }
        }

        // ===== User Management =====
        class UserManager {
            static async updateUserDisplay() {
                if (!currentUserData) return;
                
                // Update avatar
                elements.userAvatar.src = currentUserData.avatarUrl || DEFAULT_AVATAR;
                
                // Update display name
                elements.userDisplayName.textContent = currentUserData.displayName || '⁄©ÿßÿ±ÿ®ÿ± ŸÜÿßÿ¥ŸÜÿßÿ≥';
                
                // Update gems
                const gems = currentUserData.game || 0;
                elements.userGemsCount.textContent = Utils.formatNumber(gems);
                
                // Update level (calculate from gems)
                const level = Math.floor(gems / 1000) + 1;
                elements.userLevel.textContent = `ÿ≥ÿ∑ÿ≠ ${level}`;
                
                // Show/hide admin button
                elements.adminButton.classList.toggle('hidden', !currentUserData.isAdmin);
            }
            
            static async loadProfileModal() {
                if (!currentUserData) return;
                
                const modalBody = elements.profileModal.querySelector('.modal-body');
                modalBody.innerHTML = `
                    <div class="profile-header">
                        <div class="profile-badge">
                            ${currentUserData.isAdmin ? 'ŸÖÿØ€åÿ±' : 'ÿ®ÿßÿ≤€å⁄©ŸÜ'}
                        </div>
                        <img class="profile-avatar" src="${currentUserData.avatarUrl || DEFAULT_AVATAR}" alt="ÿ¢Ÿàÿßÿ™ÿßÿ±">
                        <h2 class="profile-name">${currentUserData.displayName || '⁄©ÿßÿ±ÿ®ÿ± ŸÜÿßÿ¥ŸÜÿßÿ≥'}</h2>
                    </div>
                    <div class="profile-body">
                        <div class="stat-grid">
                            <div class="stat-item">
                                <div class="stat-label">
                                    <i class="fas fa-gem"></i>
                                    <span>ÿßŸÑŸÖÿßÿ≥‚ÄåŸáÿß:</span>
                                </div>
                                <div class="stat-value">${Utils.formatNumber(currentUserData.game || 0)}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">
                                    <i class="fas fa-calendar"></i>
                                    <span>ÿ≥ŸÜ:</span>
                                </div>
                                <div class="stat-value">${currentUserData.old || 'ŸÜÿßŸÖÿ¥ÿÆÿµ'}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">
                                    <i class="fas fa-user-plus"></i>
                                    <span>ÿ™ÿßÿ±€åÿÆ ÿπÿ∂Ÿà€åÿ™:</span>
                                </div>
                                <div class="stat-value">
                                    ${currentUserData.createdAt ? 
                                        Utils.formatDate(currentUserData.createdAt.toDate()) : 
                                        'ŸÜÿßŸÖÿ¥ÿÆÿµ'}
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">
                                    <i class="fas fa-envelope"></i>
                                    <span>ÿß€åŸÖ€åŸÑ:</span>
                                </div>
                                <div class="stat-value">${currentUserData.email || 'ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá'}</div>
                            </div>
                        </div>
                        
                        <div class="profile-actions">
                            <button class="btn btn-primary" id="edit-profile">
                                <i class="fas fa-edit"></i>
                                Ÿà€åÿ±ÿß€åÿ¥ Ÿæÿ±ŸàŸÅÿß€åŸÑ
                            </button>
                            <button class="btn btn-secondary" id="logout-button">
                                <i class="fas fa-sign-out-alt"></i>
                                ÿÆÿ±Ÿàÿ¨ ÿßÿ≤ ÿ≠ÿ≥ÿßÿ®
                            </button>
                        </div>
                    </div>
                `;
                
                // Add event listeners for profile actions
                modalBody.querySelector('#edit-profile').addEventListener('click', () => {
                    Utils.showNotification('ÿß€åŸÜ ŸÇÿßÿ®ŸÑ€åÿ™ ÿ®Ÿá ÿ≤ŸàÿØ€å ÿßÿ∂ÿßŸÅŸá ÿÆŸàÿßŸáÿØ ÿ¥ÿØ', 'info');
                });
                
                modalBody.querySelector('#logout-button').addEventListener('click', async () => {
                    const confirm = await Utils.confirm('ÿ¢€åÿß ÿßÿ≤ ÿÆÿ±Ÿàÿ¨ ÿßÿ≤ ÿ≠ÿ≥ÿßÿ® ⁄©ÿßÿ±ÿ®ÿ±€å ÿßÿ∑ŸÖ€åŸÜÿßŸÜ ÿØÿßÿ±€åÿØÿü');
                    if (confirm) {
                        await signOut(auth);
                        window.location.href = './login.html';
                    }
                });
                
                UserManager.showModal(elements.profileModal);
            }
            
            static showModal(modal) {
                modal.classList.add('visible');
            }
            
            static hideModal(modal) {
                modal.classList.remove('visible');
            }
            
            static async checkMaintenance() {
                try {
                    const maintenanceDoc = await getDoc(doc(db, 'settings', 'maintenance'));
                    if (maintenanceDoc.exists() && maintenanceDoc.data().enabled) {
                        Utils.showNotification('ÿ≥ÿ±Ÿàÿ± ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿßÿ≥ÿ™. ŸÑÿ∑ŸÅÿßŸã ÿ®ÿπÿØÿßŸã ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.', 'error');
                        setTimeout(() => {
                            window.location.href = './index.html';
                        }, 3000);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error checking maintenance:', error);
                    return false;
                }
            }
        }

        // ===== Game Management =====
        class GameManager {
            static async loadRankings() {
                try {
                    const usersRef = collection(db, 'users');
                    const q = query(
                        usersRef, 
                        where('game', '>', 0),
                        orderBy('game', 'desc'),
                        limit(100)
                    );
                    
                    const snapshot = await getDocs(q);
                    const rankings = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (!data.isBannedFromRanking) {
                            rankings.push({
                                id: doc.id,
                                ...data
                            });
                        }
                    });
                    
                    // Update ranking list
                    elements.rankingList.innerHTML = rankings.map((user, index) => `
                        <div class="ranking-item ${user.id === currentUser?.uid ? 'current-user' : ''}">
                            <div class="rank-number">${index + 1}</div>
                            <img class="rank-avatar" src="${user.avatarUrl || DEFAULT_AVATAR}" alt="ÿ¢Ÿàÿßÿ™ÿßÿ±">
                            <div class="rank-info">
                                <div class="rank-name">${user.displayName || 'ÿ®ÿØŸàŸÜ ŸÜÿßŸÖ'}</div>
                                <div class="rank-gems">
                                    <i class="fas fa-gem"></i>
                                    ${Utils.formatNumber(user.game || 0)} ÿßŸÑŸÖÿßÿ≥
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                } catch (error) {
                    console.error('Error loading rankings:', error);
                    elements.rankingList.innerHTML = `
                        <div class="text-center">
                            <p>ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ±ÿØŸá‚Äåÿ®ŸÜÿØ€å</p>
                            <button class="btn btn-secondary" onclick="GameManager.loadRankings()">
                                ÿ™ŸÑÿßÿ¥ ŸÖÿ¨ÿØÿØ
                            </button>
                        </div>
                    `;
                }
            }
            
            static async updateOnlineStats() {
                try {
                    // Simulate online count (in real app, you would have a proper online tracking system)
                    const onlineCount = Math.floor(Math.random() * 100) + 50;
                    const activeGames = Math.floor(Math.random() * 20) + 5;
                    
                    elements.onlineCount.textContent = Utils.formatNumber(onlineCount);
                    elements.activeGames.textContent = Utils.formatNumber(activeGames);
                } catch (error) {
                    console.error('Error updating stats:', error);
                }
            }
            
            static initializeGameModes() {
                // Listen for game mode settings
                const gameModesListener = onSnapshot(doc(db, 'settings', 'gameModes'), (doc) => {
                    if (doc.exists()) {
                        const modes = doc.data();
                        
                        // Update friendly mode button
                        elements.friendlyMode.disabled = !modes.friendlyEnabled;
                        elements.friendlyMode.querySelector('p').textContent = 
                            modes.friendlyEnabled ? 'ÿ®ÿßÿ≤€å ÿ∫€åÿ±ÿ±ÿ≥ŸÖ€å ÿ®ÿß ÿØŸàÿ≥ÿ™ÿßŸÜ' : 'ÿ®Ÿá ÿ≤ŸàÿØ€å ŸÅÿπÿßŸÑ ŸÖ€å‚Äåÿ¥ŸàÿØ';
                        
                        // Update ranked mode button
                        elements.rankedMode.disabled = !modes.rankedEnabled;
                        elements.rankedMode.querySelector('p').textContent = 
                            modes.rankedEnabled ? '⁄©ÿ≥ÿ® ÿßŸÖÿ™€åÿßÿ≤ Ÿà ÿ±ÿ™ÿ®Ÿá' : 'ÿ®Ÿá ÿ≤ŸàÿØ€å ŸÅÿπÿßŸÑ ŸÖ€å‚Äåÿ¥ŸàÿØ';
                    }
                });
                
                firestoreListeners.push(gameModesListener);
            }
        }

        // ===== Tutorial System =====
        class TutorialSystem {
            static steps = [
                {
                    element: '.user-info-card',
                    title: 'ÿ≥ŸÑÿßŸÖ ÿ®Ÿá ÿ¥Ÿáÿ± ŸÖÿßŸÅ€åÿß!',
                    text: 'ÿß€åŸÜÿ¨ÿß ŸæŸÜŸÑ Ÿæÿ±ŸàŸÅÿß€åŸÑ ÿ¥ŸÖÿßÿ≥ÿ™. ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿ¢Ÿàÿßÿ™ÿßÿ±ÿå ŸÜÿßŸÖ Ÿà ÿßŸÖÿ™€åÿßÿ≤ÿßÿ™ ÿÆŸàÿØ ÿ±ÿß ŸÖÿ¥ÿßŸáÿØŸá ⁄©ŸÜ€åÿØ.',
                    position: 'bottom-left'
                },
                {
                    element: '.nav-menu',
                    title: 'ŸÖŸÜŸà€å ÿßÿµŸÑ€å',
                    text: 'ÿßÿ≤ ÿß€åŸÜ ŸÖŸÜŸà ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿ®Ÿá ÿ®ÿÆÿ¥‚ÄåŸáÿß€å ŸÖÿÆÿ™ŸÑŸÅ ÿ®ÿßÿ≤€å ŸÖÿßŸÜŸÜÿØ ÿ±ÿØŸá‚Äåÿ®ŸÜÿØ€åÿå ⁄©ŸÑŸÜ‚ÄåŸáÿß Ÿà ŸÖÿØ€åÿ±€åÿ™ (ÿß⁄Øÿ± ŸÖÿØ€åÿ± ÿ®ÿßÿ¥€åÿØ) ÿØÿ≥ÿ™ÿ±ÿ≥€å Ÿæ€åÿØÿß ⁄©ŸÜ€åÿØ.',
                    position: 'bottom-right'
                },
                {
                    element: '#start-game-button',
                    title: 'ÿ¥ÿ±Ÿàÿπ ÿ®ÿßÿ≤€å',
                    text: 'ÿ®ÿß ÿß€åŸÜ ÿØ⁄©ŸÖŸá ÿ®ÿßÿ≤€å ÿ±ÿß ÿ¥ÿ±Ÿàÿπ ⁄©ŸÜ€åÿØ. ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿ®€åŸÜ ÿ≠ÿßŸÑÿ™ ÿØŸàÿ≥ÿ™ÿßŸÜŸá Ÿà ÿ±ŸÇÿßÿ®ÿ™€å ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ.',
                    position: 'top-center'
                }
            ];
            
            static currentStep = 0;
            
            static async start() {
                const tutorialCompleted = localStorage.getItem('tutorialCompleted');
                if (tutorialCompleted) return;
                
                await Utils.sleep(1000);
                this.showStep(0);
            }
            
            static showStep(stepIndex) {
                if (stepIndex >= this.steps.length) {
                    this.complete();
                    return;
                }
                
                this.currentStep = stepIndex;
                const step = this.steps[stepIndex];
                const element = document.querySelector(step.element);
                
                if (!element) {
                    this.showStep(stepIndex + 1);
                    return;
                }
                
                // Calculate position for spotlight
                const rect = element.getBoundingClientRect();
                elements.tutorialSpotlight.style.width = `${rect.width + 20}px`;
                elements.tutorialSpotlight.style.height = `${rect.height + 20}px`;
                elements.tutorialSpotlight.style.top = `${rect.top - 10}px`;
                elements.tutorialSpotlight.style.left = `${rect.left - 10}px`;
                
                // Position tutorial card
                elements.tutorialTitle.textContent = step.title;
                elements.tutorialText.textContent = step.text;
                
                let cardTop, cardLeft;
                const cardRect = elements.tutorialCard.getBoundingClientRect();
                
                switch (step.position) {
                    case 'bottom-left':
                        cardTop = rect.bottom + 20;
                        cardLeft = rect.left;
                        break;
                    case 'bottom-right':
                        cardTop = rect.bottom + 20;
                        cardLeft = rect.right - cardRect.width;
                        break;
                    case 'top-center':
                        cardTop = rect.top - cardRect.height - 20;
                        cardLeft = rect.left + rect.width / 2 - cardRect.width / 2;
                        break;
                }
                
                // Adjust if card goes out of viewport
                if (cardTop < 20) cardTop = 20;
                if (cardTop + cardRect.height > window.innerHeight - 20) {
                    cardTop = window.innerHeight - cardRect.height - 20;
                }
                if (cardLeft < 20) cardLeft = 20;
                if (cardLeft + cardRect.width > window.innerWidth - 20) {
                    cardLeft = window.innerWidth - cardRect.width - 20;
                }
                
                elements.tutorialCard.style.top = `${cardTop}px`;
                elements.tutorialCard.style.left = `${cardLeft}px`;
                
                elements.tutorialOverlay.classList.add('visible');
                setTimeout(() => elements.tutorialCard.classList.add('visible'), 100);
            }
            
            static complete() {
                elements.tutorialOverlay.classList.remove('visible');
                elements.tutorialCard.classList.remove('visible');
                localStorage.setItem('tutorialCompleted', 'true');
                Utils.showNotification('ÿ¢ŸÖŸàÿ≤ÿ¥ ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿ™⁄©ŸÖ€åŸÑ ÿ¥ÿØ!', 'success');
            }
            
            static reset() {
                localStorage.removeItem('tutorialCompleted');
                Utils.showNotification('ÿ¢ŸÖŸàÿ≤ÿ¥ ÿ±€åÿ≥ÿ™ ÿ¥ÿØ. ÿØÿ± Ÿàÿ±ŸàÿØ ÿ®ÿπÿØ€å ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ.', 'info');
            }
        }

        // ===== Event Listeners =====
        class EventManager {
            static initialize() {
                // User avatar click
                elements.userAvatar.addEventListener('click', async () => {
                    if (await UserManager.checkMaintenance()) return;
                    await UserManager.loadProfileModal();
                });
                
                // Start game button
                elements.startGameButton.addEventListener('click', async () => {
                    if (await UserManager.checkMaintenance()) return;
                    UserManager.showModal(elements.gameModeModal);
                });
                
                // Shop button
                elements.shopButton.addEventListener('click', async () => {
                    if (await UserManager.checkMaintenance()) return;
                    window.location.href = './Avatar shop.html';
                });
                
                // Clan button
                elements.clanButton.addEventListener('click', async () => {
                    if (await UserManager.checkMaintenance()) return;
                    window.location.href = './clan_list.html';
                });
                
                // Ranking button
                elements.rankingButton.addEventListener('click', async () => {
                    if (await UserManager.checkMaintenance()) return;
                    await GameManager.loadRankings();
                    UserManager.showModal(elements.rankingModal);
                });
                
                // Admin button
                elements.adminButton.addEventListener('click', async () => {
                    if (await UserManager.checkMaintenance()) return;
                    if (currentUserData?.isAdmin) {
                        window.location.href = './admin_panel.html';
                    } else {
                        Utils.showNotification('ÿ¥ŸÖÿß ÿØÿ≥ÿ™ÿ±ÿ≥€å ŸÖÿØ€åÿ±€åÿ™€å ŸÜÿØÿßÿ±€åÿØ', 'error');
                    }
                });
                
                // Game mode selection
                elements.friendlyMode.addEventListener('click', async () => {
                    if (!elements.friendlyMode.disabled) {
                        window.location.href = './Lobby page.html';
                    }
                });
                
                elements.rankedMode.addEventListener('click', async () => {
                    if (!elements.rankedMode.disabled) {
                        window.location.href = './users search.html';
                    }
                });
                
                // Modal close buttons
                elements.profileClose.addEventListener('click', () => 
                    UserManager.hideModal(elements.profileModal));
                elements.rankingClose.addEventListener('click', () => 
                    UserManager.hideModal(elements.rankingModal));
                elements.gameModeClose.addEventListener('click', () => 
                    UserManager.hideModal(elements.gameModeModal));
                
                // Modal backdrop clicks
                [elements.profileModal, elements.rankingModal, elements.gameModeModal].forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            UserManager.hideModal(modal);
                        }
                    });
                });
                
                // Tutorial buttons
                elements.tutorialNext.addEventListener('click', () => 
                    TutorialSystem.showStep(TutorialSystem.currentStep + 1));
                elements.tutorialSkip.addEventListener('click', () => 
                    TutorialSystem.complete());
                
                // Refresh ranking
                elements.refreshRanking.addEventListener('click', () => 
                    GameManager.loadRankings());
                
                // Background music controls
                document.addEventListener('click', () => {
                    if (elements.backgroundMusic.paused) {
                        elements.backgroundMusic.play().catch(() => {});
                    }
                });
                
                // Handle window resize
                window.addEventListener('resize', Utils.debounce(() => {
                    if (elements.tutorialOverlay.classList.contains('visible')) {
                        TutorialSystem.showStep(TutorialSystem.currentStep);
                    }
                }, 250));
                
                // Online stats update interval
                setInterval(() => GameManager.updateOnlineStats(), 30000);
            }
        }

        // ===== Initialization =====
        class AppInitializer {
            static async initialize() {
                try {
                    // Start loading sequence
                    await this.loadResources();
                    
                    // Initialize Firebase auth listener
                    this.initializeAuth();
                    
                    // Initialize event listeners
                    EventManager.initialize();
                    
                    // Initialize game systems
                    GameManager.initializeGameModes();
                    GameManager.updateOnlineStats();
                    
                    // Mark app as loaded
                    setTimeout(() => {
                        document.body.classList.add('loaded');
                        elements.backgroundLoader.style.opacity = '0';
                        setTimeout(() => {
                            elements.backgroundLoader.style.display = 'none';
                        }, 500);
                    }, 1000);
                    
                    Utils.showNotification('ÿ®Ÿá ÿ¥Ÿáÿ± ŸÖÿßŸÅ€åÿß ÿÆŸàÿ¥ ÿ¢ŸÖÿØ€åÿØ!', 'success');
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    elements.loadingText.textContent = 'ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ®ÿ±ŸÜÿßŸÖŸá';
                    Utils.showNotification('ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ®ÿ±ŸÜÿßŸÖŸá', 'error');
                }
            }
            
            static async loadResources() {
                // Load background image
                await BackgroundManager.loadBackgroundImage();
                
                // Load background music (in background)
                BackgroundManager.loadBackgroundMusic();
                
                // Initialize particles if enabled
                const particlesEnabled = localStorage.getItem('particlesEnabled') !== 'false';
                if (particlesEnabled) {
                    BackgroundManager.initializeParticles();
                }
            }
            
            static initializeAuth() {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        
                        // Listen to user document
                        const userListener = onSnapshot(doc(db, 'users', user.uid), (doc) => {
                            if (doc.exists()) {
                                currentUserData = doc.data();
                                
                                // Check if user is banned
                                if (currentUserData.isBanned && 
                                    currentUserData.banExpiresAt?.toDate() > new Date()) {
                                    Utils.showNotification('ÿ≠ÿ≥ÿßÿ® ÿ¥ŸÖÿß ŸÖÿ≥ÿØŸàÿØ ÿ¥ÿØŸá ÿßÿ≥ÿ™', 'error');
                                    setTimeout(() => {
                                        window.location.href = './index.html';
                                    }, 3000);
                                    return;
                                }
                                
                                UserManager.updateUserDisplay();
                                
                                // Start tutorial on first load
                                if (!localStorage.getItem('appInitialized')) {
                                    TutorialSystem.start();
                                    localStorage.setItem('appInitialized', 'true');
                                }
                            }
                        });
                        
                        firestoreListeners.push(userListener);
                        
                    } else {
                        // User is not logged in, redirect to login
                        window.location.href = './login.html';
                    }
                });
            }
            
            static cleanup() {
                // Stop all firestore listeners
                firestoreListeners.forEach(unsubscribe => unsubscribe());
                firestoreListeners = [];
                
                // Stop particles
                BackgroundManager.stopParticles();
                
                // Pause music
                elements.backgroundMusic.pause();
            }
        }

        // ===== Initialize Application =====
        AppInitializer.initialize();

        // ===== Handle Page Unload =====
        window.addEventListener('beforeunload', () => {
            AppInitializer.cleanup();
        });

        // ===== Global Error Handler =====
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            Utils.showNotification('ÿÆÿ∑ÿß€å ÿ≥€åÿ≥ÿ™ŸÖ€å ÿ±ÿÆ ÿØÿßÿØ', 'error');
        });

        // ===== Make Utils available globally for debugging =====
        window.appUtils = Utils;
    </script>
</body>
</html>
